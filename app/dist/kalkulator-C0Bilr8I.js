const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunks/appLogic-D0cZThVV.js","chunks/supabase-client-C25D-rrn.js","chunks/modulepreload-polyfill-B5Qt9EMX.js","chunks/bootstrap-supa-C1PZRnWu.js","assets/login-k1m9iPeb.css","chunks/runtime-config-D7xitdne.js","chunks/apiBase-C8RWFuli.js","chunks/error-handling-BcaxJS6j.js"])))=>i.map(i=>d[i]);
import"./chunks/modulepreload-polyfill-B5Qt9EMX.js";import"./chunks/bootstrap-supa-C1PZRnWu.js";import"./chunks/runtime-config-D7xitdne.js";import{A as q}from"./chunks/apiBase-C8RWFuli.js";import"./chunks/error-handling-BcaxJS6j.js";import{s as P,_ as le}from"./chunks/supabase-client-C25D-rrn.js";class X{constructor(){this.cache=new Map,this.cacheExpiry=new Map,this.cacheDuration=300*1e3,this.fallbacks={employees:!0}}async getFeatureFlags(){const e="feature_flags",a=Date.now();if(this.cache.has(e)&&this.cacheExpiry.get(e)>a)return this.cache.get(e);try{const c=typeof window<"u"&&window.CONFIG?.apiBase||"/api",p=await fetch(`${c}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!p.ok)throw new Error(`HTTP ${p.status}: ${p.statusText}`);const d=(await p.json()).features||{},u={...this.fallbacks,...d};return this.cache.set(e,u),this.cacheExpiry.set(e,a+this.cacheDuration),u}catch(c){return console.warn("Failed to fetch feature flags, using fallbacks:",c.message),this.cache.has(e)?this.cache.get(e):{...this.fallbacks}}}async isFeatureEnabled(e){return(await this.getFeatureFlags())[e]??this.fallbacks[e]??!1}clearCache(){this.cache.clear(),this.cacheExpiry.clear()}setCacheDuration(e){this.cacheDuration=e}}const K=new X;async function se(){return await K.getFeatureFlags()}async function ae(r){return await K.isFeatureEnabled(r)}typeof module<"u"&&module.exports?module.exports={FeatureFlags:X,useFeatureFlags:se,useFeature:ae,featureFlags:K}:typeof window<"u"&&(window.FeatureFlags=X,window.useFeatureFlags=se,window.useFeature=ae,window.featureFlags=K);const de=window.CONFIG?.apiBase||"/api",W=window.CONFIG?.apiStreamBase||(typeof window<"u"&&/kkarlsen\.dev$/i.test(window.location.hostname)?"https://server.kkarlsen.dev":de);P.auth.getSession().then(({data:r,error:e})=>{console.log("[debug] supabase session",r?.session,e)});function F(){if(document.body.classList.contains("chatbox-view"))return;const r=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-height",r+"px"),document.documentElement.style.setProperty("--dvh",r+"px")}function ue(){const r=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,e=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches;r&&e&&(document.documentElement.classList.add("ios-pwa"),F())}function he(){console.log("Theme colors are now managed by the theme system")}function Y(){if(document.body.classList.contains("chatbox-view"))return;const r=document.querySelector(".dashboard-month-nav"),e=document.querySelector(".shift-section .month-navigation-container");!r||!e||document.body.classList.add("force-dashboard-nav")}F();he();ue();Y();window.addEventListener("resize",()=>{F(),Y()});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{F(),Y()});window.addEventListener("orientationchange",()=>{setTimeout(()=>{F(),Y()},100)});let ie;window.addEventListener("scroll",()=>{document.body.classList.contains("chatbox-view")||(clearTimeout(ie),ie=setTimeout(()=>{F()},50))});function pe(){if(!window.visualViewport)return;let r=window.visualViewport.height,e=!1;function a(){if(document.body.classList.contains("chatbox-view")){const E=window.visualViewport.height,$=r-E,y=e;e=$>150,e!==y&&(e?document.body.classList.add("keyboard-visible"):document.body.classList.remove("keyboard-visible"));return}const d=window.visualViewport.height,u=r-d,b=e;e=u>150,e!==b&&(document.getElementById("chatboxPill"),document.getElementById("chatboxInput"),e?(document.body.classList.add("keyboard-visible"),c()):(document.body.classList.remove("keyboard-visible"),p()))}function c(){if(document.body.classList.contains("chatbox-view"))return;const d=document.querySelector(".shift-section .month-navigation-container"),u=document.querySelector(".dashboard-month-nav");d&&(d.style.transition="opacity 0.2s ease, transform 0.2s ease",d.style.opacity="0",d.style.transform="translateY(-20px)",d.style.pointerEvents="none"),u&&(u.style.transition="opacity 0.2s ease, transform 0.2s ease",u.style.opacity="0",u.style.transform="translateY(-20px)",u.style.pointerEvents="none")}function p(){if(document.body.classList.contains("chatbox-view"))return;const d=document.querySelector(".shift-section .month-navigation-container"),u=document.querySelector(".dashboard-month-nav");d&&(d.style.opacity="",d.style.transform="",d.style.pointerEvents=""),u&&(u.style.opacity="",u.style.transform="",u.style.pointerEvents="")}window.visualViewport.addEventListener("resize",a),window.addEventListener("orientationchange",()=>{setTimeout(()=>{r=window.visualViewport.height,e=!1,document.body.classList.remove("keyboard-visible"),p()},500)}),document.addEventListener("focusin",d=>{if(d.target.matches("input, textarea, select")){if(d.target.id==="chatboxInput"){const u=window.pageYOffset||document.documentElement.scrollTop,b=window.pageXOffset||document.documentElement.scrollLeft;setTimeout(()=>{window.scrollTo(b,u)},0);return}document.body.classList.contains("chatbox-view")||setTimeout(()=>{if(e){const u=d.target.getBoundingClientRect(),b=window.visualViewport?window.visualViewport.height:window.innerHeight;if(u.bottom>b-20){const E=Math.min(u.bottom-b+40,100);window.scrollBy({top:E,behavior:"smooth"})}}},300)}}),document.addEventListener("focusout",d=>{d.target.matches("input, textarea, select")&&d.target.id==="chatboxInput"&&setTimeout(()=>{T()},100)});function T(){if(!document.body.classList.contains("chatbox-view"))return;const d=document.getElementById("chatboxLog"),u=document.querySelector(".chatbox-view .dashboard-content");d&&(d.style.maxHeight="",d.style.height="",u&&(u.style.marginBottom="",u.style.gap="",u.style.paddingBottom=""))}}window.innerWidth<=768&&pe();function re(){document.querySelectorAll("input, textarea, select").forEach(e=>{e.type!=="file"&&(e.style.fontSize="16px"),e.addEventListener("focus",()=>{e.style.transition="border-color 0.2s ease, box-shadow 0.2s ease"}),e.tagName.toLowerCase()==="textarea"&&(e.id==="chatboxInput"?(e.addEventListener("focus",a=>{a.preventDefault();const c=window.pageYOffset||document.documentElement.scrollTop,p=window.pageXOffset||document.documentElement.scrollLeft;setTimeout(()=>{window.scrollTo(p,c)},0)}),e.addEventListener("input",()=>{e.style.height="auto";const a=Math.min(e.scrollHeight,80);e.style.height=a+"px"})):e.addEventListener("input",()=>{e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"}))})}function me(){if(window.location.search.includes("debug=viewport")){let r=window.visualViewport?window.visualViewport.height:window.innerHeight,e=0;const a=()=>{const c=window.visualViewport?window.visualViewport.height:window.innerHeight;Math.abs(c-r)>5&&(e++,console.log(`Viewport change #${e}: ${r}px â†’ ${c}px`,{isChatboxView:document.body.classList.contains("chatbox-view"),isKeyboardVisible:document.body.classList.contains("keyboard-visible"),activeElement:document.activeElement?.id||"none"}),r=c)};window.visualViewport&&window.visualViewport.addEventListener("resize",a),window.addEventListener("resize",a)}}window.innerWidth<=768&&(document.addEventListener("DOMContentLoaded",()=>{re(),me()}),new MutationObserver(()=>{re()}).observe(document.body,{childList:!0,subtree:!0}));document.addEventListener("DOMContentLoaded",async()=>{document.body.classList.add("skeleton-active");const r=document.getElementById("app");r&&r.style.setProperty("display","block","important"),window.supa=supa;try{const o=h=>{if(!h)return"";const g=String(h);return g.length<=8?g[0]+"â€¦"+g[g.length-1]:g.slice(0,4)+"â€¦"+g.slice(-4)},w=(()=>{try{return new URL(window.CONFIG.supabase.url).host}catch{return window.CONFIG.supabase.url}})();console.log(`[boot] supabase client url=${w} key=${o(window.CONFIG.supabase.anonKey)}`)}catch{}let e=null,a=0;const c=3;try{const{data:{session:o}}=await supa.auth.getSession();o?(e=o,console.log("Quick session check: Session found")):console.log("Quick session check: No session yet; will retry before redirecting")}catch(o){console.log("Quick session check failed, proceeding with retry logic:",o)}async function p(){try{const{data:{user:o}}=await supa.auth.getUser();if(!o)return;window.themeManager&&window.themeManager.loadThemeFromDatabase&&await window.themeManager.loadThemeFromDatabase();const w=document.getElementById("userNickname");if(w){const n=o.user_metadata?.first_name||o.email?.split("@")[0]||"Bruker";w.textContent=n}window.chatbox&&window.chatbox.updateText&&window.chatbox.updateText();let h="";try{const{data:{session:n}}=await supa.auth.getSession(),s=n?.access_token;if(s){const i=await fetch(`${window.CONFIG.apiBase}/settings`,{headers:{Authorization:`Bearer ${s}`}});i.ok&&(h=(await i.json())?.profile_picture_url||"")}}catch{}if(!h)try{const n=o?.id;if(!n)return;const{data:s}=await supa.from("user_settings").select("profile_picture_url").eq("user_id",n).maybeSingle();h=s?.profile_picture_url||""}catch{}h||(h=o.user_metadata?.avatar_url||"");const g=document.getElementById("userAvatarImg"),t=document.querySelector(".profile-icon");g&&(h?(g.onload=()=>{g.style.display="block",t&&(t.style.display="none")},g.onerror=()=>{g.style.display="none",t&&(t.style.display="block")},g.src=h):(g.style.display="none",t&&(t.style.display="block")))}catch(o){console.error("Error loading profile info:",o)}}async function T(){const o=document.getElementById("app");o&&o.classList.add("app-ready"),o&&o.classList.add("animations-complete"),document.body.classList.remove("skeleton-active")}let d=!1,u=!1;async function b(){if(u&&d){try{await E()}catch{}await new Promise(o=>setTimeout(o,50)),await T()}}async function E(){let h=0;for(;h<5e3;){const g=document.querySelector(".total-card"),t=g&&g.dataset.populated==="1",n=document.getElementById("nextShiftContent"),s=n&&!n.querySelector(".skeleton")&&(n.children.length>0||n.querySelector(".next-shift-empty")),i=document.getElementById("nextPayrollContent"),f=i&&!i.querySelector(".skeleton")&&(i.children.length>0||i.querySelector(".next-payroll-empty")),m=document.querySelector(".month-display"),l=m&&m.textContent&&m.textContent!=="";if(t&&s&&f&&l){console.log("All content is ready, proceeding with skeleton removal");break}await new Promise(S=>setTimeout(S,100)),h+=100}h>=5e3&&console.warn("Content readiness check timed out, proceeding anyway")}for(p().then(()=>{d=!0,b()}).catch(o=>{console.error("Error loading profile info:",o),d=!0,b()});!e&&a<c;){console.log(`App.html: Checking session (attempt ${a+1}/${c})`);const{data:{session:o}}=await supa.auth.getSession();if(e=o,e)console.log("App.html: Session found for user:",e.user.email);else if(a++,a<c)console.log("App.html: No session found, waiting 200ms before retry..."),await new Promise(w=>setTimeout(w,200));else{console.log(`App.html: No session after ${c} attempts, redirecting to login`),console.log("[login] no session â€“ redirecting to login page"),window.location.href="login.html";return}}if(e?.user){const o=e.user,w=location.pathname.endsWith("/onboarding.html");if(!o.user_metadata?.finishedOnboarding&&!w){console.log("â†’ redirect to onboarding (finishedOnboarding=false)"),location.replace("/onboarding.html?from="+encodeURIComponent(location.pathname));return}}window.logout=async()=>{window.chatbox&&window.chatbox.clear&&window.chatbox.clear();try{await supa.auth.signOut()}catch(o){console.warn("signOut error:",o?.message||o)}try{const{data:{session:o}}=await supa.auth.getSession();console.log("[logout] session after signOut:",o?"still present":"null")}catch{}try{window.localStorage&&(localStorage.removeItem("appState"),localStorage.removeItem("employeeCache")),window.sessionStorage&&sessionStorage.removeItem("supabase_recovery_flow")}catch{}window.location.href="login.html"};let $;try{$=await le(()=>import("./chunks/appLogic-D0cZThVV.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]))}catch(o){console.error("Failed to load appLogic module:",o)}const y=$?.app;window.app=y;try{document.addEventListener("subscription:updated",async()=>{if(window.app&&typeof window.app.updateTabBarVisibility=="function")try{await window.app.updateTabBarVisibility()}catch{}})}catch{}await p();let V=!1;if(y&&typeof y.init=="function")try{await y.init(),u=!0,b()}catch(o){V=!0,console.error("App initialization failed:",o);try{y.loadFromLocalStorage?.()}catch(w){console.error("Fallback to local storage failed:",w)}u=!0,b()}else V=!0,console.error("App module not available or missing init()"),u=!0,b();const N=document.getElementById("app");if(N){N.style.setProperty("display","block","important"),N.classList.add("animations-complete");try{const o=document.querySelector(".app-container");if(o){const w=h=>{h&&(h.style.visibility="visible",h.style.opacity="1",h.style.transform="none")};w(o.querySelector(".tab-bar-container")),w(o.querySelector(".content"))}}catch(o){console.warn("Ensure-visible encountered an error:",o)}if(V){const o=document.createElement("div");o.className="nonblocking-warning",o.style.cssText="margin:12px 16px;padding:10px;border-radius:8px;background:#332e00;color:#ffd666;font-size:14px;",o.textContent="Noe gikk galt under innlasting. Viser tilgjengelig data â€“ prÃ¸v Ã¥ oppdatere siden.",N.prepend(o)}}document.querySelectorAll("[onclick]").forEach(o=>{const w=o.getAttribute("onclick");w&&(o.addEventListener("click",h=>{try{if(w.includes("app.")){const g=w.match(/app\.(\w+)\((.*?)\)/);if(g){const[,t,n]=g;let s=[];if(n.trim())if(n.includes("'")||n.includes('"'))s=[n.replace(/['"]/g,"")];else if(n.includes("event.stopPropagation()")){h.stopPropagation();const i=w.match(/app\.deleteShift\((\d+)\)/);if(i){y.deleteShift(parseInt(i[1]));return}}else n.includes("this")?s=[o]:n.match(/^\d+$/)&&(s=[parseInt(n)]);y[t]&&(console.log(`Executing ${t} with params:`,s),y[t](...s))}}else w.includes("logout()")&&logout()}catch(g){console.error("Error executing onclick handler:",g,"Original onclick:",w)}}),o.removeAttribute("onclick"))}),document.querySelectorAll("[onchange]").forEach(o=>{const w=o.getAttribute("onchange");w&&(o.addEventListener("change",h=>{try{if(w.includes("app.")){const g=w.match(/app\.(\w+)\((.*?)\)/);if(g){const[,t,n]=g;let s=[];const i=n.trim();i&&(/this\.value/.test(i)?s=[h.target?.value]:/this\.checked/.test(i)?s=[!!h.target?.checked]:i.includes("'")||i.includes('"')?s=[i.replace(/['"]/g,"")]:/^\d+$/.test(i)?s=[parseInt(i)]:i.includes("this")&&(s=[h.target])),y[t]&&(console.log(`Executing ${t} with params:`,s),y[t](...s))}}}catch(g){console.error("Error executing onchange handler:",g,"Original onchange:",w)}}),o.removeAttribute("onchange"))});let A=!1;function U(){A||(document.body.addEventListener("click",o=>{const w=o.target.closest(".delete-shift-btn");if(w){o.stopPropagation();const s=parseInt(w.getAttribute("data-shift-index"));y.deleteShift(s).then(()=>{y.closeShiftDetails()});return}const h=o.target.closest(".edit-shift-btn");if(h){o.stopPropagation();const s=h.getAttribute("data-shift-id");y.editShift(s);return}if(o.target.closest(".close-shift-details")){o.stopPropagation(),y.closeShiftDetails();return}const t=o.target.closest(".remove-bonus");if(t){o.stopPropagation(),y.removeBonusSlot(t);return}const n=o.target.closest(".modal");if(n&&o.target===n){const s=n.id;s==="addShiftModal"?y.closeAddShiftModal():s==="editShiftModal"?y.closeEditShift():s==="settingsModal"&&y.closeSettings();return}if(!o.target.closest(".btn")){const s=o.target.closest("[data-shift-id]");if(s){const i=s.getAttribute("data-shift-id");y.showShiftDetails(i)}}}),document.addEventListener("keydown",o=>{if(o.key==="Escape"){const w={addShiftModal:()=>y.closeAddShiftModal(),editShiftModal:()=>y.closeEditShift(),settingsModal:()=>y.closeSettings()};for(const[h,g]of Object.entries(w)){const t=document.getElementById(h);if(t&&t.style.display==="block"){g();break}}}}),A=!0)}U();const j=document.querySelector(".snap-container"),H=document.querySelector(".floating-action-bar"),B=document.querySelector(".floating-action-bar-backdrop"),G=document.querySelector(".shift-section");if(j&&H&&B&&G){let g=function(){const t=G.getBoundingClientRect(),n=window.innerHeight,s=Math.max(0,t.top),i=Math.min(n,t.bottom),l=Math.max(0,i-s)/n>=.6;l&&!o?(o=!0,clearTimeout(w),H.style.display="flex",H.style.animation="fadeInUp 0.3s ease-out forwards",H.style.opacity="1",B.style.opacity="1"):!l&&o&&(o=!1,clearTimeout(w),H.style.animation="fadeOutDown 0.3s ease-out forwards",H.style.opacity="0",B.style.opacity="0",w=setTimeout(()=>{o||(H.style.display="none")},300)),h=!1};H.style.display="none",H.style.opacity="0",B.style.opacity="0";let o=!1,w=null,h=!1;j.addEventListener("scroll",()=>{h||(requestAnimationFrame(g),h=!0)}),g()}});(function(){let r=[],e={},a=!1,c=!1;function p(){if(e={pill:document.getElementById("chatboxPill"),expandedContent:document.getElementById("chatboxExpandedContent"),close:document.getElementById("chatboxClose"),newChat:document.getElementById("chatboxNewChat"),log:document.getElementById("chatboxLog"),input:document.getElementById("chatboxInput"),send:document.getElementById("chatboxSend"),pillText:document.getElementById("chatboxPillPlaceholder")},!e.pill||!e.expandedContent){console.warn("Chatbox elements not found");return}d(),T()}async function T(){try{if(!window.supa||!window.supa.auth){console.log("Supabase client not yet available, using default text"),e.pillText&&(e.pillText.textContent="Trenger du hjelp?");return}const{data:{user:t}}=await window.supa.auth.getUser();if(!t||!e.pillText)return;const n=t.user_metadata?.first_name||t.email?.split("@")[0]||"Bruker";e.pillText.textContent=`Trenger du hjelp, ${n}?`}catch(t){console.error("Error updating chatbox text:",t),e.pillText&&(e.pillText.textContent="Trenger du hjelp, Bruker?")}}function d(){e.pill.addEventListener("click",function(t){!t.target.closest(".chatbox-close")&&!a&&b()}),e.close&&e.close.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),E()}),e.newChat&&e.newChat.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),$()}),e.send&&e.send.addEventListener("click",B),e.input&&(e.input.addEventListener("keydown",function(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),B())}),e.input.addEventListener("input",y))}async function u(){try{const n=new Date().getHours();let s;n>=5&&n<12?s="God morgen":n>=12&&n<17?s="God dag":n>=17&&n<22?s="God kveld":s="God natt";let i="Bruker";try{if(window.supa&&window.supa.auth){const{data:{user:l}}=await window.supa.auth.getUser();l&&(i=l.user_metadata?.first_name||l.email?.split("@")[0]||"Bruker")}}catch(l){console.log("Could not get user info for greeting:",l)}const f=[`${s}, ${i}! ðŸ‘‹ Jeg er her for Ã¥ hjelpe deg med Ã¥ registrere skift og holde oversikt over arbeidstiden din. Hva kan jeg hjelpe deg med i dag?`,`${s}! ðŸŒŸ Klar for Ã¥ gjÃ¸re arbeidsdagen din enklere? Jeg kan hjelpe deg registrere skift, legge til serier, eller svare pÃ¥ spÃ¸rsmÃ¥l om appen.`,`Hei ${i}! ${s} âœ¨ Jeg er din personlige assistent for skiftregistrering. SpÃ¸r meg om hva som helst - fra Ã¥ legge til nye skift til Ã¥ forstÃ¥ statistikkene dine!`],m=f[Math.floor(Math.random()*f.length)];A("assistant",m,{streaming:!0,streamSpeed:25})}catch(t){console.error("Error creating greeting message:",t),A("assistant","Hei! ðŸ‘‹ Jeg er her for Ã¥ hjelpe deg med Ã¥ registrere skift og holde oversikt over arbeidstiden din. Hva kan jeg hjelpe deg med?",{streaming:!0,streamSpeed:25})}}function b(){a=!0,V(),e.pill.classList.add("expanded"),e.expandedContent.style.display="block",e.close.style.display="flex",e.newChat&&(e.newChat.style.display="flex"),document.body.classList.add("chatbox-expanded-active"),setTimeout(()=>{if(e.input){const t=window.pageYOffset||document.documentElement.scrollTop,n=window.pageXOffset||document.documentElement.scrollLeft;e.input.focus({preventScroll:!0}),setTimeout(()=>{window.scrollTo(n,t)},0)}},300)}function E(){a=!1,c=!1,N(),e.pill.classList.remove("expanded"),e.expandedContent.style.display="none",e.close.style.display="none",e.newChat&&(e.newChat.style.display="none"),document.body.classList.remove("chatbox-expanded-active"),e.log&&(e.log.innerHTML=""),r=[]}function $(){r=[],e.log&&(e.log.innerHTML=""),c=!1,u(),setTimeout(()=>{if(e.input){const t=window.pageYOffset||document.documentElement.scrollTop,n=window.pageXOffset||document.documentElement.scrollLeft;e.input.focus({preventScroll:!0}),setTimeout(()=>{window.scrollTo(n,t)},0)}},100)}function y(){const t=e.input;if(!t)return;t.style.height="auto";const s=document.body.classList.contains("keyboard-visible")?80:100,i=Math.min(t.scrollHeight,s);t.style.height=i+"px"}function V(){const t=document.body,n=document.querySelector(".dashboard-content"),s=document.querySelector(".chatbox-container");if(!n||!s)return;t.classList.add("chatbox-view");const i=document.querySelector(".total-card"),f=document.querySelector(".next-shift-card"),m=document.querySelector(".next-payroll-card"),l=document.querySelector(".dashboard-month-nav"),S=document.querySelector(".floating-action-bar");if(i&&(i.style.display="none"),f&&(f.style.display="none"),m&&(m.style.display="none"),l&&(l.style.display="none",l.style.visibility="hidden",l.style.height="0",l.style.margin="0",l.style.padding="0",l.style.opacity="0"),S&&(S.style.display="none"),s&&n&&!n.contains(s)){const k=document.createElement("div");k.className="dashboard-chatbox-container",k.style.order="1",k.appendChild(s),n.appendChild(k)}}function N(){const t=document.body,n=document.querySelector(".chatbox-container");t.classList.remove("chatbox-view");const s=document.querySelector(".total-card"),i=document.querySelector(".next-shift-card"),f=document.querySelector(".next-payroll-card"),m=document.querySelector(".dashboard-month-nav"),l=document.querySelector(".floating-action-bar");s&&(s.style.display=""),i&&(i.style.display=""),f&&(f.style.display=""),m&&(m.style.display="",m.style.visibility="",m.style.height="",m.style.margin="",m.style.padding="",m.style.opacity="",m.style.width="",m.style.position="",m.style.left=""),l&&(l.style.display="");const S=document.querySelector(".dashboard-chatbox-container"),k=document.querySelector(".app-container");S&&n&&k&&(k.appendChild(n),S.remove())}function A(t,n,s={}){!c&&!a&&(c=!0,b());const i=document.createElement("div");if(i.className=`chatbox-message ${t}`,n.includes('<span class="dots">'))i.innerHTML=n;else if(t==="assistant"){if(s.streaming)return i.innerHTML="",e.log.appendChild(i),e.log.scrollTop=e.log.scrollHeight,U(i,n,s.streamSpeed||75),i;{const f=DOMPurify.sanitize(marked.parse(n));i.innerHTML=f}}else i.textContent=n;return e.log.appendChild(i),e.log.scrollTop=e.log.scrollHeight,i}function U(t,n,s=25){const i=j(n);let f=0,m="";const l=document.createElement("span");l.className="typing-cursor",l.textContent="â–Š",l.style.opacity="0.7";function S(){if(f<i.length){m+=i[f],f++;const k=DOMPurify.sanitize(marked.parse(m)),M=document.createElement("div");M.innerHTML=k;const v=M.lastElementChild||M;v.tagName==="P"?v.appendChild(l.cloneNode(!0)):M.appendChild(l.cloneNode(!0)),t.innerHTML=M.innerHTML,e.log.scrollTop=e.log.scrollHeight;const x=i[f-1];let O=s;x===" "?O=s*.5:x.match(/[.!?]/)?O=s*2:x.length>3&&(O=s*1.2),O+=Math.random()*10,setTimeout(S,O)}else{l.remove();const k=DOMPurify.sanitize(marked.parse(n));t.innerHTML=k,e.log.scrollTop=e.log.scrollHeight}}setTimeout(S,100)}function j(t){const n=[];let s="";for(let i=0;i<t.length;i++){const f=t[i];f.match(/\s/)||f.match(/[.!?,:;]/)||f.match(/[()[\]{}]/)?(s&&(n.push(s),s=""),n.push(f)):(s+=f,s.length>=2&&Math.random()>.6&&(n.push(s),s=""))}return s&&n.push(s),n}function H(t){let n=0;const s=25;function i(){if(!t.isStreaming&&n>=t.fullText.length){t.streamingActive=!1;const m=DOMPurify.sanitize(marked.parse(t.fullText));t.innerHTML=m,t.classList.remove("streaming-text"),e.log.scrollTop=e.log.scrollHeight;return}const f=t.fullText;if(n<f.length){const m=Math.min(Math.floor(Math.random()*3)+2,f.length-n);n+=m;const l=f.substring(0,n),S=document.createElement("div");S.innerHTML=DOMPurify.sanitize(marked.parse(l));const k=document.createElement("span");k.className="typing-cursor",k.textContent="â–Š",k.style.opacity="0.7",S.appendChild(k),t.innerHTML=S.innerHTML,e.log.scrollTop=e.log.scrollHeight;const M=s+Math.random()*10;setTimeout(i,M)}else setTimeout(i,50)}i()}async function B(){const t=e.input.value.trim();t&&(e.input.value="",y(),await G(t))}async function G(t){e.send&&(e.send.disabled=!0),A("user",t),r.push({role:"user",content:t});const n=A("assistant",'<span class="dots"><span>.</span><span>.</span><span>.</span></span>');let s;try{const{data:{session:i}}=await window.supa.auth.getSession();if(s=i?.access_token,!s){n.remove(),A("system","Du mÃ¥ vÃ¦re innlogget for Ã¥ bruke chat-funksjonen.");return}}catch(i){console.error("Auth error:",i),n.textContent="âš ï¸ Autentiseringsfeil.";return}try{const i=await fetch(`${W}/chat/start`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({messages:r,currentMonth:window.app?.currentMonth||new Date().getMonth()+1,currentYear:window.app?.currentYear||new Date().getFullYear()})});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const{sid:f}=await i.json();if(!f)throw new Error("Missing session id");const m=await fetch(`${W}/chat/stream?sid=${encodeURIComponent(f)}`,{method:"GET",headers:{Accept:"text/event-stream",Authorization:`Bearer ${s}`}});if(!m.ok||!m.body)throw new Error(`HTTP ${m.status}: ${m.statusText}`);const l=m.body.getReader(),S=new TextDecoder;let k="",M=null;for(;;){const{done:I,value:C}=await l.read();if(I)break;k+=S.decode(C,{stream:!0});const ne=k.split(`
`);k=ne.pop();for(const oe of ne)if(oe.startsWith("data: ")){const J=oe.slice(6);if(J==="[DONE]")break;try{const z=JSON.parse(J);w(z,n),z.type==="complete"?M=z:z.type==="text_stream_end"&&(M={assistant:null,shifts:[]})}catch{console.warn("Failed to parse streaming data:",J)}}}const v=M;if(!v)throw new Error("No data received from streaming response");console.debug("[/chat response]",v);const x=v.assistant??(v.error&&`âš ï¸ ${v.error}`)??"âš ï¸ Ukjent svar fra serveren.";if(v.assistant&&n&&n.parentNode){const I=DOMPurify.sanitize(marked.parse(x));n.innerHTML=I}else!v.assistant&&x&&n&&n.parentNode&&(n.textContent=x);v.assistant&&r.push({role:"assistant",content:v.assistant});const O=v.shifts||[],ee=[],te=new Set;for(const I of O){const C=`${I.shift_date}|${I.start_time}|${I.end_time}`;te.has(C)||(te.add(C),ee.push(I))}if(window.app&&window.app.refreshUI){const I=ee.map(C=>({id:C.id||Date.now()+Math.random(),date:new Date(C.date||C.shift_date),startTime:C.startTime||C.start_time,endTime:C.endTime||C.end_time,type:C.type!==void 0?C.type:C.shift_type,seriesId:C.seriesId||C.series_id||null}));window.app.shifts&&window.app.userShifts&&(window.app.shifts=[...I],window.app.userShifts=[...I]),window.app.refreshUI(I)}}catch(i){console.error("Chat error:",i);try{console.log("Streaming failed, falling back to regular request...");const f=await fetch(`${W}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({messages:r,stream:!1})});if(f.ok){const m=await f.json(),l=m.assistant??(m.error&&`âš ï¸ ${m.error}`)??"âš ï¸ Ukjent svar fra serveren.";if(m.assistant){const v=DOMPurify.sanitize(marked.parse(l));n.innerHTML=v}else n.textContent=l;m.assistant&&r.push({role:"assistant",content:m.assistant});const S=m.shifts||[],k=[],M=new Set;for(const v of S){const x=`${v.shift_date}|${v.start_time}|${v.end_time}`;M.has(x)||(M.add(x),k.push(v))}if(window.app&&window.app.refreshUI){const v=k.map(x=>({id:x.id||Date.now()+Math.random(),date:new Date(x.date||x.shift_date),startTime:x.startTime||x.start_time,endTime:x.endTime||x.end_time,type:x.type!==void 0?x.type:x.shift_type,seriesId:x.seriesId||x.series_id||null}));window.app.shifts&&window.app.userShifts&&(window.app.shifts=[...v],window.app.userShifts=[...v]),window.app.refreshUI(v)}}else throw new Error("Fallback request also failed")}catch(f){console.error("Fallback error:",f),n.textContent="âš ï¸ Kunne ikke koble til serveren."}}finally{e.send&&(e.send.disabled=!1)}}let o=null;function w(t,n){switch(t.type){case"status":h(n,t.message);break;case"gpt_response":if(t.tool_calls&&t.tool_calls.length>0){const s=t.tool_calls.map(i=>i.name).join(", ");h(n,`GPT planlegger: ${s}`)}else h(n,"Venter pÃ¥ svar");break;case"tool_calls_start":if(t.message)h(n,t.message);else{const s=Number(t.count)||0,i=s<=1?"KjÃ¸rer 1 verktÃ¸y":`KjÃ¸rer ${s} verktÃ¸y`;h(n,i)}break;case"tool_call_start":h(n,t.message||"KjÃ¸rer verktÃ¸y");break;case"tool_call_complete":h(n,(t.message||"VerktÃ¸y ferdig")+" âœ“");break;case"tool_call":t.name?h(n,`KjÃ¸rer: ${t.name}`):h(n,"KjÃ¸rer verktÃ¸y");break;case"tool_result":if(t.name){const s=t.ok?"âœ“":"âœ—";h(n,`${t.name} ${s}`)}else h(n,t.ok?"VerktÃ¸y fullfÃ¸rt âœ“":"VerktÃ¸y feilet âœ—");break;case"text_stream_start":o=document.createElement("div"),o.className="streaming-text",o.fullText="",o.isStreaming=!0,o.streamingActive=!1,n.parentNode.replaceChild(o,n);break;case"text_chunk":o&&o.isStreaming&&(o.fullText+=t.content,o.streamingActive||(o.streamingActive=!0,H(o)));break;case"text_stream_end":if(o){o.isStreaming=!1;const s=o.fullText;r.push({role:"assistant",content:s}),o=null}break;case"shifts_update":if(t.shifts&&window.app&&window.app.refreshUI){const s=t.shifts||[],i=[],f=new Set;for(const l of s){const S=`${l.shift_date}|${l.start_time}|${l.end_time}`;f.has(S)||(f.add(S),i.push(l))}const m=i.map(l=>({id:l.id||Date.now()+Math.random(),date:new Date(l.date||l.shift_date),startTime:l.startTime||l.start_time,endTime:l.endTime||l.end_time,type:l.type!==void 0?l.type:l.shift_type,seriesId:l.seriesId||l.series_id||null}));window.app.shifts&&window.app.userShifts&&(window.app.shifts=[...m],window.app.userShifts=[...m]),window.app.refreshUI(m)}break}}function h(t,n){t&&t.parentNode&&(t.innerHTML=`<span class="stream-status">${n}</span> <span class="dots"><span>.</span><span>.</span><span>.</span></span>`)}function g(){e.log&&(e.log.innerHTML=""),r=[],c=!1,a=!1,document.body.classList.remove("chatbox-expanded-active"),e.pill&&e.pill.classList.remove("expanded"),e.expandedContent&&(e.expandedContent.style.display="none"),e.close&&(e.close.style.display="none"),e.newChat&&(e.newChat.style.display="none")}window.chatbox={init:p,clear:g,expand:b,collapse:E,startNewChat:$,updateText:T,appendMessage:A,streamText:U,tokenizeText:j},window.streamText=U,window.tokenizeText=j,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p()})();const L={LIGHT:"light",DARK:"dark",SYSTEM:"system"},Q="user-theme-preference";class fe{constructor(){this.currentTheme=this.getStoredTheme()||L.SYSTEM,this.mediaQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.databaseThemeLoaded=!1,this.init()}init(){this.applyTheme(this.currentTheme),document.readyState==="loading"&&document.addEventListener("DOMContentLoaded",()=>{this.applyTheme(this.currentTheme)}),this.mediaQuery.addEventListener("change",e=>{this.currentTheme===L.SYSTEM&&this.applySystemTheme()}),window.addEventListener("storage",e=>{if(e.key===Q){const a=e.newValue||L.SYSTEM;this.setTheme(a,!1)}})}getStoredTheme(){try{return localStorage.getItem(Q)}catch(e){return console.warn("Failed to read theme preference from localStorage:",e),null}}saveTheme(e){try{localStorage.setItem(Q,e)}catch(a){console.warn("Failed to save theme preference to localStorage:",a)}}async loadThemeFromDatabase(){if(!this.databaseThemeLoaded)try{if(typeof window<"u"&&window.supa){const{data:{user:e}}=await window.supa.auth.getUser();if(!e?.id)return;let a=null;try{const{data:{session:c}}=await window.supa.auth.getSession(),p=c?.access_token;if(p){const T=await fetch(`${window.CONFIG.apiBase}/settings`,{headers:{Authorization:`Bearer ${p}`}});T.ok&&(a=(await T.json())?.theme)}}catch{}if(!a){const{data:c}=await window.supa.from("user_settings").select("theme").eq("user_id",e.id).maybeSingle();a=c?.theme}a&&Object.values(L).includes(a)&&(console.log(`Loading theme from database: ${a}`),this.currentTheme=a,this.applyTheme(a),this.saveTheme(a))}}catch(e){console.warn("Failed to load theme from database:",e)}finally{this.databaseThemeLoaded=!0}}async saveThemeToDatabase(e){try{if(typeof window<"u"&&window.supa){const{data:{user:a}}=await window.supa.auth.getUser();if(!a?.id)return;try{const{data:{session:p}}=await window.supa.auth.getSession(),T=p?.access_token;if(T&&(await fetch(`${window.CONFIG.apiBase}/settings`,{method:"PATCH",headers:{Authorization:`Bearer ${T}`,"Content-Type":"application/json"},body:JSON.stringify({theme:e})})).ok){console.log(`Theme saved to database via API: ${e}`);return}}catch{}const{error:c}=await window.supa.from("user_settings").upsert({user_id:a.id,theme:e},{onConflict:"user_id"});c?console.warn("Failed to save theme to database:",c):console.log(`Theme saved to database: ${e}`)}}catch(a){console.warn("Failed to save theme to database:",a)}}getSystemTheme(){return this.mediaQuery.matches?L.DARK:L.LIGHT}resolveTheme(e){return e===L.SYSTEM?this.getSystemTheme():e}applySystemTheme(){const e=this.getSystemTheme();this.applyThemeToDOM(e),this.notifyThemeChange(this.currentTheme,e)}applyTheme(e){const a=this.resolveTheme(e);this.applyThemeToDOM(a),this.notifyThemeChange(e,a)}applyThemeToDOM(e){const a=document.documentElement;a.classList.remove("theme-light","theme-dark"),a.classList.add(`theme-${e}`),this.updateMetaThemeColor(e)}updateMetaThemeColor(e){const a=e===L.LIGHT?"#ffffff":"#121212";document.querySelectorAll('meta[name="theme-color"]').forEach(p=>{p.setAttribute("content",a)})}setTheme(e,a=!0){Object.values(L).includes(e)||(console.warn(`Invalid theme: ${e}. Using system theme.`),e=L.SYSTEM),this.currentTheme=e,a&&(this.saveTheme(e),this.saveThemeToDatabase(e)),this.applyTheme(e)}getCurrentTheme(){return this.currentTheme}getCurrentResolvedTheme(){return this.resolveTheme(this.currentTheme)}toggleTheme(){const a=this.getCurrentResolvedTheme()===L.LIGHT?L.DARK:L.LIGHT;this.setTheme(a)}notifyThemeChange(e,a){const c=new CustomEvent("themeChange",{detail:{userTheme:e,resolvedTheme:a,isSystemTheme:e===L.SYSTEM}});document.dispatchEvent(c)}isDarkTheme(){return this.getCurrentResolvedTheme()===L.DARK}isLightTheme(){return this.getCurrentResolvedTheme()===L.LIGHT}isSystemTheme(){return this.currentTheme===L.SYSTEM}}const _=new fe;window.themeManager=_;class we{constructor(){this.initialized=!1,this.themeInputs=null}init(){this.initialized||(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.setupThemeUI()}):this.setupThemeUI(),this.initialized=!0)}setupThemeUI(){this.themeInputs={light:document.getElementById("themeLight"),dark:document.getElementById("themeDark"),system:document.getElementById("themeSystem")},this.updateThemeUI(_.getCurrentTheme()),Object.entries(this.themeInputs).forEach(([e,a])=>{a&&a.addEventListener("change",c=>{c.target.checked&&_.setTheme(e)})}),document.addEventListener("themeChange",e=>{this.updateThemeUI(e.detail.userTheme),this.handleThemeChange(e.detail)}),this.observeSkeletonLoading(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{_.isSystemTheme()&&this.updateSystemPreview()}),console.log("Theme integration initialized")}updateThemeUI(e){this.themeInputs&&(Object.entries(this.themeInputs).forEach(([a,c])=>{c&&(c.checked=a===e)}),this.updateSystemPreview())}updateSystemPreview(){const e=document.querySelector(".theme-preview-system");if(!e)return;const a=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";e.setAttribute("data-system-theme",a)}observeSkeletonLoading(){new MutationObserver(a=>{a.forEach(c=>{if(c.type==="attributes"&&c.attributeName==="class"&&c.target===document.body){const p=c.oldValue&&c.oldValue.includes("skeleton-active"),T=document.body.classList.contains("skeleton-active");p&&!T&&(console.log("Skeleton loading completed, reapplying theme..."),setTimeout(()=>{_.applyTheme(_.getCurrentTheme())},100))}})}).observe(document.body,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{_.applyTheme(_.getCurrentTheme())},200)})}handleThemeChange(e){document.documentElement.classList.add("theme-switching"),setTimeout(()=>{document.documentElement.classList.remove("theme-switching")},100),this.updateThemeDependentElements(e.resolvedTheme),this.notifyApplicationThemeChange(e),console.log(`Theme changed to: ${e.userTheme} (resolved: ${e.resolvedTheme})`)}updateThemeDependentElements(e){this.updateFavicon(e),this.updateChartThemes(e)}updateFavicon(e){document.querySelector('link[rel="icon"]')}updateChartThemes(e){const a=new CustomEvent("chartThemeUpdate",{detail:{theme:e}});document.dispatchEvent(a)}notifyApplicationThemeChange(e){typeof window<"u"&&window.app&&window.app.onThemeChange&&window.app.onThemeChange(e),typeof window<"u"&&window.app&&window.app.logEvent&&window.app.logEvent("theme_change",{theme:e.userTheme,resolved_theme:e.resolvedTheme,is_system:e.isSystemTheme})}setTheme(e){_.setTheme(e)}getCurrentTheme(){return _.getCurrentTheme()}getCurrentResolvedTheme(){return _.getCurrentResolvedTheme()}toggleTheme(){_.toggleTheme()}isDarkTheme(){return _.isDarkTheme()}isLightTheme(){return _.isLightTheme()}isSystemTheme(){return _.isSystemTheme()}}const ce=new we;ce.init();typeof window<"u"&&(window.themeIntegration=ce);async function ge(r,e={}){const{mode:a="subscription",quantity:c=1,redirect:p=!0}=e;if(!r||typeof r!="string"){const E=new Error("Missing priceId");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Klarte ikke Ã¥ starte betaling: mangler priceId."),E}const{data:{session:T}}=await P.auth.getSession(),d=T?.access_token;if(!d){const E=new Error("Not authenticated");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Du mÃ¥ vÃ¦re innlogget for Ã¥ starte et kjÃ¸p."),E}let u=await fetch(`${q}/api/checkout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({priceId:r,mode:a,quantity:c})});if(u.status===404)try{u=await fetch(`${q}/checkout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({priceId:r,mode:a,quantity:c})})}catch{}if(!u.ok){const E=await Z(u),$=u.status===404?"Kunne ikke starte kjÃ¸p (404). Tjenesten er ikke tilgjengelig her. PrÃ¸v Ã¥ oppdatere siden eller kontakt support.":`Kunne ikke starte Stripe Checkout (${u.status}).`;typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError($);const y=new Error(E||$);throw y.status=u.status,y}const{url:b}=await u.json();if(!b){const E=new Error("Ugyldig svar fra serveren (mangler url).");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Ugyldig svar fra serveren (mangler url)."),E}return p&&typeof window<"u"&&(window.location.href=b),b}async function ye(r={}){const{redirect:e=!0}=r,{data:{session:a}}=await P.auth.getSession(),c=a?.access_token;if(!c){const d=new Error("Not authenticated");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Du mÃ¥ vÃ¦re innlogget for Ã¥ administrere abonnementet."),d}let p=await fetch(`${q}/api/stripe/create-portal-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`}});if(p.status===404)try{p=await fetch(`${q}/stripe/create-portal-session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`}})}catch{}if(!p.ok){const d=await Z(p),u=`Kunne ikke Ã¥pne administrasjonssiden (${p.status}).`;typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError(u);const b=new Error(d||u);throw b.status=p.status,b}const{url:T}=await p.json();if(!T){const d=new Error("Ugyldig svar fra serveren (mangler url).");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Ugyldig svar fra serveren (mangler url)."),d}return e&&typeof window<"u"&&(window.location.href=T),T}async function be(r={}){const{redirect:e=!0}=r,{data:{session:a}}=await P.auth.getSession(),c=a?.access_token;if(!c){const d=new Error("Not authenticated");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Du mÃ¥ vÃ¦re innlogget for Ã¥ oppgradere."),d}let p=await fetch(`${q}/api/portal/upgrade`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`}});if(p.status===404)try{p=await fetch(`${q}/portal/upgrade`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`}})}catch{}if(!p.ok){const d=await Z(p),u=p.status===400?"Ingen aktivt abonnement Ã¥ oppgradere.":`Kunne ikke Ã¥pne Stripe (${p.status}).`;typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError(u);const b=new Error(d||u);throw b.status=p.status,b}const{url:T}=await p.json();if(!T){const d=new Error("Ugyldig svar fra serveren (mangler url).");throw typeof window<"u"&&window.ErrorHelper&&window.ErrorHelper.showError("Ugyldig svar fra serveren (mangler url)."),d}return e&&typeof window<"u"&&(window.location.href=T),T}async function Z(r){try{return await r.text()}catch{return""}}typeof window<"u"&&(window.startCheckout=ge,window.startBillingPortal=ye,window.startPortalUpgrade=be);async function Te(r){if(!r)return console.warn("[sub] refresh: missing userId"),null;try{console.log("[sub] refresh start",{userId:r});const{data:e,error:a}=await P.from("subscription_tiers").select("status, price_id, tier, is_active, current_period_end, updated_at").eq("user_id",r).maybeSingle();if(a)return console.warn("[sub] refresh error",a),null;const c=e??{status:"none",price_id:null,tier:"free",is_active:!1,current_period_end:null,updated_at:null};return window.SubscriptionState=c,console.log("[sub] refresh data",c),document.dispatchEvent(new CustomEvent("subscription:updated",{detail:c})),c}catch(e){return console.warn("[sub] refresh exception",e),null}}let D=null,R=null;async function ve(){return D||R||(R=(async()=>{try{const{data:r}=await P.auth.getClaims(),e=r&&r.sub;if(e)return D=e,console.debug("[auth] userId (claims):",D),D;const{data:{user:a},error:c}=await P.auth.getUser();return c?(console.warn("[auth] getUser() error:",c.message||c),null):(D=a&&a.id?a.id:null,D&&console.debug("[auth] userId (user):",D),D)}catch(r){return console.warn("[auth] getUserId error:",r&&r.message?r.message:r),null}finally{R=null}})(),R)}if(typeof window<"u")try{const r=window.marked||(typeof marked<"u"?marked:null);r&&typeof r.setOptions=="function"&&r.setOptions({gfm:!0,breaks:!0})}catch{}typeof window<"u"&&!window.uuidv4&&(window.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const a=Math.random()*16|0;return(e==="x"?a:a&3|8).toString(16)})});typeof window<"u"&&window.addEventListener("DOMContentLoaded",()=>{try{const r=new URLSearchParams(window.location.search),e=r.get("checkout");e&&window.ErrorHelper&&(e==="success"?window.ErrorHelper.showSuccess("Betaling fullfÃ¸rt!"):(e==="cancel"||e==="error"||e==="failed")&&window.ErrorHelper.showError("Betaling ble avbrutt eller feilet."),r.delete("checkout"));const a=r.get("portal");if(a&&(a==="done"&&window.ErrorHelper&&window.ErrorHelper.showSuccess("Abonnement oppdatert!"),(async()=>{try{const c=await ve();c?await Te(c):console.warn("[sub] refresh skipped: no user")}catch(c){console.warn("[sub] refresh failed",c)}})(),r.delete("portal")),e||a){const c=window.location.origin+window.location.pathname+(r.toString()?`?${r}`:"");window.history.replaceState({},document.title,c)}}catch{}});export{ve as g,Te as r};
