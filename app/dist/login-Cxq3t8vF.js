import"./chunks/modulepreload-polyfill-B5Qt9EMX.js";import{L as Z}from"./chunks/legal-modal-BGYhwCIo.js";import"./chunks/error-handling-BcaxJS6j.js";import"./chunks/runtime-config-D7xitdne.js";import{s as $}from"./chunks/supabase-client-C25D-rrn.js";async function ee(){try{const{data:t,error:e}=await $.auth.signInWithOAuth({provider:"google",options:{queryParams:{prompt:"select_account"},redirectTo:`${window.location.origin}/index.html`}});if(e)throw e;return console.info("[oauth] google auth initiated",t),t?.url||null}catch(t){throw console.error("[oauth] google sign-in failed",t),t}}const te=window.CONFIG?.apiBase||"/api",a=$;window.supa=a;async function V(){window.supa=a,document.documentElement.classList.add("auth-mode"),document.body.classList.add("auth-mode"),await new Promise(t=>setTimeout(t,100)),await new Promise(t=>setTimeout(t,100));try{const{data:{session:t}}=await a.auth.getSession();if(t){try{if((await fetch(`${te}/settings`,{headers:{Authorization:`Bearer ${t.access_token}`}})).status===200){window.location.replace("index.html");return}}catch{}try{await a.auth.signOut()}catch(e){console.warn("signOut error:",e?.message||e)}console.log("Stale token removed; showing login.")}document.body.style.visibility="visible"}catch(t){console.error("Error checking session for immediate redirect:",t)}document.body.style.visibility="visible",ne(),ue(),document.body.style.visibility==="hidden"&&(console.warn("Fallback: Body was still hidden after initial setup, forcing visibility."),document.body.style.visibility="visible")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V):V();function ne(){const t=document.getElementById("auth-msg"),e=document.getElementById("email"),n=document.getElementById("password"),s=document.getElementById("login-btn"),i=document.getElementById("signup-btn"),l=document.getElementById("auth-box"),r=document.getElementById("signup-card"),p=document.getElementById("signup-email"),g=document.getElementById("signup-password"),w=document.getElementById("signup-name"),u=document.getElementById("create-account-btn"),y=document.getElementById("back-login-signup-btn"),W=document.getElementById("signup-msg"),H=document.getElementById("complete-profile-card"),E=document.getElementById("complete-name"),m=document.getElementById("complete-profile-btn"),k=document.getElementById("skip-profile-btn"),z=document.getElementById("complete-profile-msg"),v=document.getElementById("show-reset-btn"),J=document.getElementById("reset-form"),Q=document.getElementById("reset-step-1"),X=document.getElementById("reset-step-2"),B=document.getElementById("reset-email"),f=document.getElementById("reset-send"),b=document.getElementById("reset-code"),h=document.getElementById("reset-password"),c=document.getElementById("reset-confirm"),I=document.getElementById("reset-back"),C=document.getElementById("back-to-login-btn"),x=document.getElementById("reset-resend"),Y=document.getElementById("resend-timer"),S=document.getElementById("btn-google");window.authElements={authMsg:t,emailInp:e,passInp:n,loginBtn:s,signupBtn:i,authBox:l,signupCard:r,signupEmail:p,signupPassword:g,signupName:w,createAccountBtn:u,backLoginSignupBtn:y,signupMsg:W,completeProfileCard:H,completeName:E,completeProfileBtn:m,skipProfileBtn:k,completeProfileMsg:z,showResetBtn:v,resetForm:J,resetStep1:Q,resetStep2:X,resetEmailInp:B,resetSendBtn:f,resetCodeInp:b,resetPasswordInp:h,resetConfirmBtn:c,resetBackBtn:I,backToLoginBtn:C,resetResendBtn:x,resendTimer:Y,googleBtn:S},s&&(s.onclick=()=>R(e.value,n.value)),i&&(i.onclick=()=>oe()),u&&(u.onclick=()=>N()),y&&(y.onclick=()=>O());const M=document.getElementById("login-form");M&&M.addEventListener("submit",function(o){o.preventDefault(),R(e.value,n.value)});const A=document.getElementById("signup-form");A&&A.addEventListener("submit",function(o){o.preventDefault(),N()});const T=document.getElementById("reset-email-form");T&&T.addEventListener("submit",function(o){o.preventDefault(),_()});const D=document.getElementById("reset-code-form");D&&D.addEventListener("submit",function(o){o.preventDefault(),K()});const F=document.getElementById("complete-profile-form");F&&F.addEventListener("submit",function(o){o.preventDefault(),U()}),m&&(m.onclick=()=>U()),k&&(k.onclick=()=>le()),v&&(v.onclick=()=>ie()),C&&(C.onclick=()=>O()),I&&(I.onclick=()=>re()),f&&(f.onclick=()=>_()),c&&(c.onclick=()=>K()),x&&(x.onclick=()=>ce()),S&&(S.onclick=()=>se()),n&&s&&n.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),s.click())}),e&&s&&e.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),s.click())}),w&&u&&w.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),u.click())}),E&&m&&E.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),m.click())}),B&&f&&B.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),f.click())}),b&&c&&b.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),h.focus())}),h&&c&&h.addEventListener("keypress",function(o){o.key==="Enter"&&(o.preventDefault(),c.click())})}async function R(t,e){try{const{error:n}=await a.auth.signInWithPassword({email:t,password:e});window.authElements.authMsg.textContent=n?n.message:""}catch(n){console.error("Supabase error:",n),window.authElements.authMsg.textContent="Kunne ikke koble til autentiseringstjeneste"}}async function se(){try{await ee()}catch(t){console.error("[oauth] Google sign-in failed:",t),window.authElements.authMsg.textContent="Google innlogging feilet. Prøv igjen."}}function oe(){window.authElements.authBox.style.display="none",window.authElements.signupCard.style.display="flex",window.authElements.resetForm.style.display="none"}function O(){window.authElements.authBox.style.display="flex",window.authElements.signupCard.style.display="none",window.authElements.resetForm.style.display="none",window.authElements.completeProfileCard.style.display="none"}function ie(){window.authElements.authBox.style.display="none",window.authElements.signupCard.style.display="none",window.authElements.resetForm.style.display="flex",window.authElements.resetStep1.style.display="block",window.authElements.resetStep2.style.display="none",window.authElements.completeProfileCard.style.display="none";const t=document.getElementById("reset-msg");t&&(t.textContent=""),window.authElements.resetEmailInp&&(window.authElements.resetEmailInp.value="")}function re(){window.authElements.resetStep1.style.display="block",window.authElements.resetStep2.style.display="none",window.authElements.resetCodeInp&&(window.authElements.resetCodeInp.value=""),window.authElements.resetPasswordInp&&(window.authElements.resetPasswordInp.value="")}function ae(){window.authElements.resetStep1.style.display="none",window.authElements.resetStep2.style.display="block",window.authElements.resetCodeInp&&setTimeout(()=>window.authElements.resetCodeInp.focus(),100)}async function N(){const t=window.authElements.signupEmail.value,e=window.authElements.signupPassword.value,n=window.authElements.signupName.value;if(!t||!e||!n){window.authElements.signupMsg.textContent="Vennligst fyll ut alle påkrevde felt";return}try{const{data:s,error:i}=await a.auth.signUp({email:t,password:e,options:{data:{first_name:n.trim()}}});i?(console.error("[signup] failed",i),window.authElements.signupMsg.textContent="Kunne ikke opprette konto. Se konsollen."):s?.session?window.location.href=`${window.location.origin}/index.html`:(window.authElements.signupMsg.style.color="var(--success)",window.authElements.signupMsg.textContent="Registrering OK – sjekk e-post for bekreftelse!"),console.log("[signup]",{user:!!s?.user,session:!!s?.session,error:i})}catch(s){console.error("Supabase error:",s),window.authElements.signupMsg.textContent="Kunne ikke koble til autentiseringstjeneste"}}let d=!1;async function L(){const t=new Promise((n,s)=>{setTimeout(()=>s(new Error("checkAndShowProfileCompletion timeout")),1e4)}),e=async()=>{try{if(d)return;let n=null;try{const{data:{user:s},error:i}=await a.auth.getUser();if(n=s,i)throw console.error("Error getting user:",i),i}catch(s){console.error("Exception while getting user:",s);try{const{data:{session:i}}=await a.auth.getSession();n=i?.user||null}catch(i){console.error("Error getting session:",i)}}if(!n)return;d=!0,setTimeout(()=>{window.location.replace("index.html")},150)}catch(n){console.error("Error checking profile completion:",n),d||(d=!0,setTimeout(()=>{window.location.replace("index.html")},100))}};try{await Promise.race([e(),t])}catch(n){console.error("checkAndShowProfileCompletion timed out:",n),d||(d=!0,window.location.replace("index.html"))}}async function U(){const t=window.authElements.completeName.value;if(!t){window.authElements.completeProfileMsg.textContent="Vennligst fyll ut fornavn";return}try{const{error:e}=await a.auth.updateUser({data:{first_name:t.trim()}});if(e){window.authElements.completeProfileMsg.textContent="Feil ved oppdatering av profil",console.error("Profile update error:",e);return}window.location.href="index.html"}catch(e){console.error("Error completing profile:",e),window.authElements.completeProfileMsg.textContent="Kunne ikke oppdatere profil"}}async function le(){window.location.href="index.html"}async function _(){const t=window.authElements.resetEmailInp.value.trim();if(!t){const s=document.getElementById("reset-msg");s&&(s.style.color="var(--danger)",s.textContent="Vennligst skriv inn e-postadresse");return}const e=window.authElements.resetSendBtn;e&&(e.disabled=!0,e.textContent="Sender..."),await q(t)&&(ae(),G()),e&&(e.disabled=!1,e.textContent="Send kode")}async function K(){const t=window.authElements.resetEmailInp.value.trim(),e=window.authElements.resetCodeInp.value.trim(),n=window.authElements.resetPasswordInp.value;if(!t||!e||!n){const i=document.getElementById("reset-msg");i&&(i.style.color="var(--danger)",i.textContent="Vennligst fyll ut alle felt");return}const s=window.authElements.resetConfirmBtn;s&&(s.disabled=!0,s.textContent="Oppdaterer..."),await de(t,e,n)}async function ce(){const t=window.authElements.resetEmailInp.value.trim();if(!t)return;const e=window.authElements.resetResendBtn;e&&(e.disabled=!0,e.textContent="Sender..."),await q(t)&&G()}function G(){const t=window.authElements.resendTimer,e=window.authElements.resetResendBtn;if(!t||!e)return;let n=60;e.disabled=!0;const s=()=>{t.textContent=`Send ny kode (${n}s)`,n--,n<0?(t.textContent="",e.disabled=!1,e.textContent="Send ny kode"):setTimeout(s,1e3)};s()}function j(t){return/^\S+@\S+\.\S+$/.test(String(t||"").trim())}let P=0;async function q(t){const e=document.getElementById("reset-msg"),n=document.getElementById("reset-send");try{if(!j(t))throw new Error("Ugyldig e-postadresse");const s=Date.now();if(s<P){const l=Math.ceil((P-s)/1e3);throw new Error(`Vent ${l}s før du sender på nytt`)}const{error:i}=await a.auth.resetPasswordForEmail(t);if(i)throw i;return P=Date.now()+6e4,e&&(e.style.color="var(--success)",e.textContent="Kode sendt! Sjekk e-posten din."),!0}catch(s){return e&&(e.style.color="var(--danger)",e.textContent=s.message||"Kunne ikke sende kode"),!1}finally{n&&(n.disabled=!1)}}async function de(t,e,n){const s=document.getElementById("reset-msg"),i=document.getElementById("reset-confirm");try{if(!j(t))throw new Error("Ugyldig e-postadresse");if(!(e&&/^\d{6}$/.test(e)))throw new Error("Koden må være 6 sifre");if(!n||n.length<8)throw new Error("Passordet må ha minst 8 tegn");const{error:l}=await a.auth.verifyOtp({email:t,token:e,type:"recovery"});if(l)throw l;const{error:r}=await a.auth.updateUser({password:n});if(r)throw r;s&&(s.style.color="var(--success)",s.textContent="Passord oppdatert! Logg inn med det nye passordet."),await a.auth.signOut();const p=document.getElementById("auth-box"),g=document.getElementById("reset-form");return g&&(g.style.display="none"),p&&(p.style.display="flex"),!0}catch(l){return s&&(s.style.color="var(--danger)",s.textContent=l.message||"Kunne ikke oppdatere passord"),!1}finally{i&&(i.disabled=!1)}}function ue(){a.auth.onAuthStateChange(async(t,e)=>{t==="SIGNED_IN"?await L():e&&t!=="SIGNED_OUT"&&await L()}),(async()=>{const{data:{session:t}}=await a.auth.getSession();t&&await L()})()}class me{constructor(){this.legalModal=null,this.termsAccepted=!1,this.hasViewedTerms=!1,this.init()}init(){this.legalModal=new Z,this.bindEvents(),this.listenForLegalEvents(),this.updateCheckboxVisualState()}bindEvents(){const e=document.getElementById("show-terms-btn"),n=document.getElementById("show-privacy-btn"),s=document.getElementById("terms-accept"),i=document.getElementById("create-account-btn");e&&e.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),console.log("Terms button clicked"),this.showModal("terms")}),n&&n.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),console.log("Privacy button clicked"),this.showModal("privacy")}),s&&s.addEventListener("click",r=>{this.hasViewedTerms?(this.termsAccepted=r.target.checked,this.updateCreateAccountButton()):(r.preventDefault(),r.stopPropagation(),this.showModalForConsent())}),i&&i.addEventListener("click",r=>{if(!this.termsAccepted)return r.preventDefault(),this.showTermsRequiredMessage(),!1});const l=document.getElementById("signup-form");l&&l.addEventListener("submit",r=>{if(!this.termsAccepted)return r.preventDefault(),this.showTermsRequiredMessage(),!1})}listenForLegalEvents(){document.addEventListener("legalAccepted",e=>{this.hasViewedTerms=!0,this.termsAccepted=!0;const n=document.getElementById("terms-accept");n&&(n.checked=!0),this.updateCreateAccountButton()}),document.addEventListener("legalDeclined",e=>{this.hasViewedTerms=!0,this.termsAccepted=!1;const n=document.getElementById("terms-accept");n&&(n.checked=!1),this.updateCreateAccountButton()})}showModal(e){console.log(`showModal called with tab: ${e}`),this.legalModal.switchTab(e),this.legalModal.showInfo()}showModalForConsent(){this.legalModal.switchTab("privacy"),this.legalModal.showConsent()}updateCreateAccountButton(){const e=document.getElementById("create-account-btn");e&&(this.termsAccepted?(e.disabled=!1,e.classList.remove("btn-disabled"),e.classList.add("btn-primary")):(e.disabled=!0,e.classList.remove("btn-primary"),e.classList.add("btn-disabled"))),this.updateCheckboxVisualState()}updateCheckboxVisualState(){const e=document.querySelector(".checkmark");e&&(this.hasViewedTerms?e.classList.remove("must-read"):e.classList.add("must-read"))}showTermsRequiredMessage(){const e=document.getElementById("signup-msg");e&&(this.hasViewedTerms?e.textContent="Du må godta vilkår og betingelser for å opprette en konto.":e.textContent="Vennligst les vilkår og betingelser ved å klikke på avkrysningsboksen.",e.style.display="block",setTimeout(()=>{e.textContent="",e.style.display="none"},5e3));const n=document.getElementById("terms-accept");n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),n.focus())}isTermsAccepted(){return this.termsAccepted}resetTermsAcceptance(){this.termsAccepted=!1,this.hasViewedTerms=!1;const e=document.getElementById("terms-accept");e&&(e.checked=!1),this.updateCreateAccountButton()}destroy(){this.legalModal&&this.legalModal.destroy()}}document.addEventListener("DOMContentLoaded",()=>{new me});
