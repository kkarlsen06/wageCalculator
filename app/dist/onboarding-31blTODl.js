import"./chunks/modulepreload-polyfill-B5Qt9EMX.js";import"./chunks/bootstrap-supa-C1PZRnWu.js";import"./chunks/supabase-client-C25D-rrn.js";const c=window.supa;let s=1;const m=7;let n={},d=null;async function h(){const{data:{session:e}}=await c.auth.getSession();if(!e){window.location.href="/login.html";return}if(d=e.user,d.user_metadata?.finishedOnboarding){window.location.href="/index.html";return}await _(),p(),g()}async function _(){try{const{data:e,error:t}=await c.from("user_settings").select("*").eq("user_id",d.id).maybeSingle();if(t&&t.code!=="PGRST116"){console.error("Error loading existing settings:",t);return}if(d.user_metadata?.first_name&&(document.getElementById("firstName").value=d.user_metadata.first_name),(e?.profile_picture_url||d.user_metadata?.avatar_url)&&k(e?.profile_picture_url||d.user_metadata.avatar_url),e?.use_preset!==void 0&&(e.use_preset?(selectWageType("virke"),e.current_wage_level&&(document.getElementById("wageSelect").value=e.current_wage_level)):(selectWageType("custom"),e.custom_wage&&(document.getElementById("customWageInput").value=e.custom_wage),e.custom_bonuses&&v(e.custom_bonuses))),e?.pause_deduction_method==="none"?(document.getElementById("paidBreakToggle").checked=!0,togglePaidBreak()):(document.getElementById("paidBreakToggle").checked=!1,e?.pause_threshold_hours&&(document.getElementById("pauseThreshold").value=e.pause_threshold_hours),e?.pause_deduction_minutes&&(document.getElementById("pauseDuration").value=e.pause_deduction_minutes)),e?.monthly_goal&&(document.getElementById("monthlyGoal").value=e.monthly_goal),e?.tax_deduction_enabled&&(document.getElementById("taxDeductionToggle").checked=!0,toggleTaxDeduction(),e.tax_percentage&&(document.getElementById("taxPercentage").value=e.tax_percentage)),e?.payroll_day&&(document.getElementById("payrollDay").value=e.payroll_day),e?.theme){const o=document.querySelector(`input[name="theme"][value="${e.theme}"]`);o&&(o.checked=!0,previewTheme(e.theme))}}catch(e){console.error("Error loading existing settings:",e)}}function v(e){!e||typeof e!="object"||["weekday","saturday","sunday"].forEach(t=>{const o=e[t];Array.isArray(o)&&o.length>0&&o.forEach(a=>{if(a.from&&a.to&&a.rate){addBonusSlot(t);const i=document.getElementById(`${t}BonusSlots`).lastElementChild;if(i){const l=i.querySelectorAll("input");l.length>=3&&(l[0].value=a.from,l[1].value=a.to,l[2].value=a.rate)}}})})}function p(){const e=s/m*100;document.getElementById("progressFill").style.width=e+"%"}function g(){const e=document.getElementById("backBtn"),t=document.getElementById("nextBtn"),o=document.getElementById("skipLink");e.style.display=s===1?"none":"flex",s===m?(t.textContent="Gå til dashboard",t.innerHTML='Gå til dashboard <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 6 15 12 9 18"></polyline></svg>',o.style.display="none"):(t.innerHTML='Neste <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 6 15 12 9 18"></polyline></svg>',o.style.display=s===4||s===5?"inline":"none")}window.nextStep=async function(){if(!w())return;if(await E(),s===m){await b();return}const e=document.getElementById(`step${s}`);e.classList.add("slide-out-left"),setTimeout(()=>{e.classList.remove("active","slide-out-left"),s++,document.getElementById(`step${s}`).classList.add("active"),p(),g()},300)};window.previousStep=function(){if(s===1)return;const e=document.getElementById(`step${s}`);e.classList.add("slide-out-right"),setTimeout(()=>{e.classList.remove("active","slide-out-right"),s--,document.getElementById(`step${s}`).classList.add("active"),p(),g()},300)};window.skipStep=function(){(s===4||s===5)&&nextStep()};function w(){switch(document.querySelectorAll(".form-control.error").forEach(e=>e.classList.remove("error")),document.querySelectorAll(".form-error.show").forEach(e=>e.classList.remove("show")),s){case 1:if(!document.getElementById("firstName").value.trim())return f("firstName","firstNameError"),!1;break;case 2:const t=document.querySelector(".wage-option.selected");if(!t)return alert("Vennligst velg en lønnstype"),!1;if(t.dataset.value==="custom"){const o=document.getElementById("customWageInput").value;if(!o||parseFloat(o)<50||parseFloat(o)>1e3)return f("customWageInput","customWageError"),!1}break}return!0}function f(e,t){const o=document.getElementById(e),a=document.getElementById(t);o&&o.classList.add("error"),a&&a.classList.add("show"),o&&o.focus()}async function E(){switch(s){case 1:n.first_name=document.getElementById("firstName").value.trim();break;case 2:document.querySelector(".wage-option.selected")?.dataset.value==="virke"?(n.use_preset=!0,n.current_wage_level=parseInt(document.getElementById("wageSelect").value),n.custom_wage=null,n.custom_bonuses={weekday:[],saturday:[],sunday:[]}):(n.use_preset=!1,n.custom_wage=parseFloat(document.getElementById("customWageInput").value),n.current_wage_level=null,n.custom_bonuses=I());break;case 3:const t=document.getElementById("paidBreakToggle").checked;n.pause_deduction_method=t?"none":"proportional",t||(n.pause_threshold_hours=parseFloat(document.getElementById("pauseThreshold").value)||5.5,n.pause_deduction_minutes=parseInt(document.getElementById("pauseDuration").value)||30);break;case 4:const o=document.getElementById("monthlyGoal").value;n.monthly_goal=o?parseInt(o):null;break;case 5:n.tax_deduction_enabled=document.getElementById("taxDeductionToggle").checked,n.tax_deduction_enabled&&(n.tax_percentage=parseFloat(document.getElementById("taxPercentage").value)||25);const a=document.getElementById("payrollDay").value;n.payroll_day=a?parseInt(a):null;break;case 6:const r=document.querySelector('input[name="theme"]:checked').value;n.theme=r;break}}async function b(){try{const e={user_id:d.id,use_preset:n.use_preset!==void 0?n.use_preset:!0,custom_wage:n.custom_wage,current_wage_level:n.current_wage_level,pause_deduction_method:n.pause_deduction_method||"proportional",pause_threshold_hours:n.pause_threshold_hours||5.5,pause_deduction_minutes:n.pause_deduction_minutes||30,monthly_goal:n.monthly_goal,theme:n.theme||"system",tax_deduction_enabled:n.tax_deduction_enabled||!1,tax_percentage:n.tax_percentage,payroll_day:n.payroll_day,profile_picture_url:n.profile_picture_url,custom_bonuses:n.custom_bonuses||{weekday:[],saturday:[],sunday:[]}};Object.keys(e).forEach(r=>{(e[r]===null||e[r]===void 0||e[r]==="")&&delete e[r]}),(e.monthly_goal===void 0||e.monthly_goal==="")&&(e.monthly_goal=null),(e.payroll_day===void 0||e.payroll_day==="")&&(e.payroll_day=null),typeof e.profile_picture_url=="string"&&e.profile_picture_url.startsWith("data:")&&(console.warn("[onboarding] stripping inline profile picture data URL before save"),delete e.profile_picture_url);const{error:t}=await c.from("user_settings").upsert(e,{onConflict:"user_id"});if(t)throw console.error("Error saving settings:",t),t;const o={finishedOnboarding:!0};n.first_name&&(o.first_name=n.first_name);const{error:a}=await c.auth.updateUser({data:o});if(a)throw console.error("Error updating user metadata:",a),a;window.location.href="/index.html"}catch(e){console.error("Error completing onboarding:",e),alert("Det oppstod en feil ved lagring av innstillingene. Prøv igjen.")}}window.selectWageType=function(e){document.querySelectorAll(".wage-option").forEach(a=>a.classList.remove("selected")),document.querySelector(`[data-value="${e}"]`).classList.add("selected");const t=document.getElementById("virkeWageSection"),o=document.getElementById("customWageSection");e==="virke"?(t.classList.remove("hidden"),o.classList.add("hidden")):(t.classList.add("hidden"),o.classList.remove("hidden"))};document.getElementById("profilePicture").addEventListener("change",async function(e){const t=e.target.files[0];if(t){const o=new FileReader;o.onload=function(a){y(a.target.result)},o.readAsDataURL(t);try{const a=await B(t);a&&(n.profile_picture_url=a)}catch(a){console.error("Failed to upload profile picture:",a)}}});function y(e){const t=document.getElementById("profilePreview");document.getElementById("profilePlaceholder"),t.innerHTML=`<img src="${e}" alt="Profilbilde">`}function k(e){y(e),n.profile_picture_url=e}async function B(e){try{if(!d?.id)throw new Error("No user ID available");const t=e.name.split(".").pop(),o=`${d.id}/onboarding_${Date.now()}.${t}`,{error:a}=await c.storage.from("profile-pictures").upload(o,e,{contentType:e.type,upsert:!0});if(a)throw a;const{data:r}=c.storage.from("profile-pictures").getPublicUrl(o);if(r?.publicUrl)return r.publicUrl;throw new Error("Failed to get public URL")}catch(t){throw console.error("Error uploading profile picture:",t),t}}window.togglePaidBreak=function(){const e=document.getElementById("paidBreakToggle").checked,t=document.getElementById("breakAdvancedSection");t.style.display=e?"none":"block"};window.toggleAdvancedBreaks=function(){const e=document.getElementById("breakAdvancedContent"),t=document.querySelector(".advanced-toggle svg");e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("fade-in"),t.style.transform="rotate(90deg)"):(e.classList.add("hidden"),e.classList.remove("fade-in"),t.style.transform="rotate(0deg)")};window.toggleTaxDeduction=function(){const e=document.getElementById("taxDeductionToggle").checked,t=document.getElementById("taxPercentageSection");e?(t.classList.remove("hidden"),t.classList.add("fade-in")):(t.classList.add("hidden"),t.classList.remove("fade-in"))};window.previewTheme=function(e){if(e==="system"){const t=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.className=t?"theme-dark":"theme-light"}else document.documentElement.className=`theme-${e}`};window.addBonusSlot=function(e){const t=document.getElementById(`${e}BonusSlots`);if(t.querySelectorAll(".bonus-slot").length>=10)return;let a,r,i,l;switch(e){case"weekday":a="18:00",r="22:00",l="25.00",i=25;break;case"saturday":a="00:00",r="23:59",l="50.00",i=50;break;case"sunday":a="00:00",r="23:59",l="100.00",i=100;break}const u=`
        <div class="bonus-slot">
          <div class="bonus-slot-field">
            <label class="bonus-slot-label">Fra tid</label>
            <input type="time" value="${a}" required>
          </div>
          <div class="bonus-slot-field">
            <label class="bonus-slot-label">Til tid</label>
            <input type="time" value="${r}" required>
          </div>
          <div class="bonus-slot-field">
            <label class="bonus-slot-label">Tillegg (kr/t)</label>
            <input type="number" placeholder="${l}" value="${i}" step="0.01" min="0" max="500" required>
          </div>
          <button type="button" class="remove-bonus-btn" onclick="this.parentElement.remove()" title="Fjern tillegg">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      `;t.insertAdjacentHTML("beforeend",u)};function I(){const e={weekday:[],saturday:[],sunday:[]};return["weekday","saturday","sunday"].forEach(t=>{document.querySelectorAll(`#${t}BonusSlots .bonus-slot`).forEach(a=>{const r=a.querySelectorAll("input"),i=r[0].value,l=r[1].value,u=parseFloat(r[2].value);i&&l&&u&&e[t].push({from:i,to:l,rate:u})})}),e}document.addEventListener("DOMContentLoaded",h);
