name: Deploy to Azure Web App

on:
  push:
    branches: [ "main" ]
    paths:
      - "server/**"
  workflow_dispatch: {}

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "server/package-lock.json"

      - name: Install backend deps
        working-directory: ./server
        run: npm ci --no-fund --no-audit

      - name: Security scan - Check for leaked secrets in client code
        run: |
          if rg -n "(SUPABASE_SERVICE_ROLE_KEY|SUPABASE_ANON_KEY)" src/ kalkulator/ 2>/dev/null; then
            echo "‚ùå Sensitive key pattern detected in client code"
            echo "üîí Service role keys must never be exposed to the browser"
            exit 1
          else
            echo "‚úÖ No sensitive keys found in client code"
          fi

      - name: Smoke build (no-op for server)
        working-directory: ./server
        run: node -e "require('fs').accessSync('server.js')"

      - name: Azure Login (service principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set App Settings (from GitHub Secrets)
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az webapp config appsettings set -g rg-wageapp -n wageapp-prod --settings \
              NODE_ENV=production \
              SUPABASE_URL='${{ secrets.SUPABASE_URL }}' \
              SUPABASE_SERVICE_ROLE_KEY='${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}' \
              OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}' \
              ENABLE_STATIC='false' \
              STATIC_DIR='.'
            az webapp config appsettings set -g rg-wageapp -n wageapp-prod --settings \
              SCM_DO_BUILD_DURING_DEPLOYMENT=true
            az webapp config set -g rg-wageapp -n wageapp-prod --linux-fx-version "NODE|22-lts" --startup-file "npm start"
            az webapp config appsettings delete -g rg-wageapp -n wageapp-prod --setting-names WEBSITE_RUN_FROM_PACKAGE || true

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: wageapp-prod
          package: ./server