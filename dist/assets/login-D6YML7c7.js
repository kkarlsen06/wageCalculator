import"./modulepreload-polyfill-B5Qt9EMX.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";import"./error-handling-Do_n41nE.js";import"./runtime-config-CwEj8XBa.js";const q=window.CONFIG?.apiBase||"/api";let i,a=!1;document.addEventListener("DOMContentLoaded",async function(){i=window.supabase.createClient(window.CONFIG.supabase.url,window.CONFIG.supabase.anonKey),window.supa=i,document.documentElement.classList.add("auth-mode"),document.body.classList.add("auth-mode"),await new Promise(t=>setTimeout(t,100)),i.auth.onAuthStateChange(async(t,n)=>{if(t==="PASSWORD_RECOVERY"){a=!0,document.body.style.visibility="visible",setTimeout(()=>d(),50);return}if(t==="SIGNED_IN"&&(c()||sessionStorage.getItem("supabase_recovery_flow")==="true")){a=!0,document.body.style.visibility="visible",setTimeout(()=>d(),50);return}});try{const{data:{session:t}}=await i.auth.getSession();if(t&&(c()||sessionStorage.getItem("supabase_recovery_flow")==="true")){a=!0,document.body.style.visibility="visible",setTimeout(()=>d(),100);return}}catch(t){console.error("Error in immediate session check:",t)}await new Promise(t=>setTimeout(t,100));const e=c();try{const{data:{session:t}}=await i.auth.getSession();if(t&&!e&&!a){try{if((await fetch(`${q}/settings`,{headers:{Authorization:`Bearer ${t.access_token}`}})).status===200){window.location.replace("index.html");return}}catch{}await i.auth.signOut(),console.log("Stale token removed; showing login.")}else t&&e&&(a=!0);document.body.style.visibility="visible"}catch(t){console.error("Error checking session for immediate redirect:",t)}document.body.style.visibility="visible",j(),$(),z(),document.body.style.visibility==="hidden"&&(console.warn("Fallback: Body was still hidden after initial setup, forcing visibility."),document.body.style.visibility="visible")});function j(){const e=document.getElementById("auth-msg"),t=document.getElementById("email"),n=document.getElementById("password"),o=document.getElementById("login-btn"),s=document.getElementById("signup-btn"),u=document.getElementById("auth-box"),l=document.getElementById("signup-card"),y=document.getElementById("signup-email"),E=document.getElementById("signup-password"),p=document.getElementById("signup-name"),m=document.getElementById("create-account-btn"),k=document.getElementById("back-login-signup-btn"),O=document.getElementById("signup-msg"),A=document.getElementById("complete-profile-card"),v=document.getElementById("complete-name"),w=document.getElementById("complete-profile-btn"),b=document.getElementById("skip-profile-btn"),U=document.getElementById("complete-profile-msg"),I=document.getElementById("forgot-btn"),K=document.getElementById("forgot-card"),f=document.getElementById("forgot-email"),h=document.getElementById("send-reset-btn"),B=document.getElementById("send-magic-link-btn"),x=document.getElementById("back-login-btn");window.authElements={authMsg:e,emailInp:t,passInp:n,loginBtn:o,signupBtn:s,authBox:u,signupCard:l,signupEmail:y,signupPassword:E,signupName:p,createAccountBtn:m,backLoginSignupBtn:k,signupMsg:O,completeProfileCard:A,completeName:v,completeProfileBtn:w,skipProfileBtn:b,completeProfileMsg:U,forgotBtn:I,forgotCard:K,forgotEmailInp:f,sendResetBtn:h,sendMagicLinkBtn:B,backLoginBtn:x},o&&(o.onclick=()=>L(t.value,n.value)),s&&(s.onclick=()=>G()),m&&(m.onclick=()=>D()),k&&(k.onclick=()=>W());const S=document.getElementById("login-form");S&&S.addEventListener("submit",function(r){r.preventDefault(),L(t.value,n.value)});const P=document.getElementById("signup-form");P&&P.addEventListener("submit",function(r){r.preventDefault(),D()});const R=document.getElementById("forgot-form");R&&R.addEventListener("submit",function(r){r.preventDefault(),T(f.value)});const _=document.getElementById("complete-profile-form");_&&_.addEventListener("submit",function(r){r.preventDefault(),F()}),w&&(w.onclick=()=>F()),b&&(b.onclick=()=>H()),I&&(I.onclick=()=>M(!0)),x&&(x.onclick=()=>M(!1)),h&&(h.onclick=()=>T(f.value)),B&&(B.onclick=()=>V(f.value)),n&&o&&n.addEventListener("keypress",function(r){r.key==="Enter"&&(r.preventDefault(),o.click())}),t&&o&&t.addEventListener("keypress",function(r){r.key==="Enter"&&(r.preventDefault(),o.click())}),p&&m&&p.addEventListener("keypress",function(r){r.key==="Enter"&&(r.preventDefault(),m.click())}),v&&w&&v.addEventListener("keypress",function(r){r.key==="Enter"&&(r.preventDefault(),w.click())}),f&&h&&f.addEventListener("keypress",function(r){r.key==="Enter"&&(r.preventDefault(),h.click())})}async function L(e,t){try{const{error:n}=await i.auth.signInWithPassword({email:e,password:t});window.authElements.authMsg.textContent=n?n.message:""}catch(n){console.error("Supabase error:",n),window.authElements.authMsg.textContent="Kunne ikke koble til autentiseringstjeneste"}}function G(){window.authElements.authBox.style.display="none",window.authElements.signupCard.style.display="flex",window.authElements.forgotCard.style.display="none"}function W(){window.authElements.authBox.style.display="flex",window.authElements.signupCard.style.display="none",window.authElements.forgotCard.style.display="none",window.authElements.completeProfileCard.style.display="none"}async function D(){const e=window.authElements.signupEmail.value,t=window.authElements.signupPassword.value,n=window.authElements.signupName.value;if(!e||!t||!n){window.authElements.signupMsg.textContent="Vennligst fyll ut alle påkrevde felt";return}try{const{error:o,data:s}=await i.auth.signUp({email:e,password:t,options:{data:{first_name:n.trim()}}});if(o){window.authElements.signupMsg.textContent=o.message;return}window.authElements.signupMsg.style.color="var(--success)",window.authElements.signupMsg.textContent="Registrering OK – sjekk e-post for bekreftelse!"}catch(o){console.error("Supabase error:",o),window.authElements.signupMsg.textContent="Kunne ikke koble til autentiseringstjeneste"}}let g=!1;async function C(){const e=new Promise((n,o)=>{setTimeout(()=>o(new Error("checkAndShowProfileCompletion timeout")),1e4)}),t=async()=>{try{if(g)return;let n=null;try{const{data:{user:o},error:s}=await i.auth.getUser();if(n=o,s)throw console.error("Error getting user:",s),s}catch(o){console.error("Exception while getting user:",o);try{const{data:{session:s}}=await i.auth.getSession();n=s?.user||null}catch(s){console.error("Error getting session:",s)}}if(!n)return;g=!0,setTimeout(()=>{window.location.replace("index.html")},150)}catch(n){console.error("Error checking profile completion:",n),g||(g=!0,setTimeout(()=>{window.location.replace("index.html")},100))}};try{await Promise.race([t(),e])}catch(n){console.error("checkAndShowProfileCompletion timed out:",n),g||(g=!0,window.location.replace("index.html"))}}async function F(){const e=window.authElements.completeName.value;if(!e){window.authElements.completeProfileMsg.textContent="Vennligst fyll ut fornavn";return}try{const{error:t}=await i.auth.updateUser({data:{first_name:e.trim()}});if(t){window.authElements.completeProfileMsg.textContent="Feil ved oppdatering av profil",console.error("Profile update error:",t);return}window.location.href="index.html"}catch(t){console.error("Error completing profile:",t),window.authElements.completeProfileMsg.textContent="Kunne ikke oppdatere profil"}}async function H(){window.location.href="index.html"}function M(e){window.authElements.forgotCard.style.display=e?"flex":"none",window.authElements.authBox.style.display=e?"none":"flex"}async function T(e){try{const n=`${window.location.origin}/kalkulator/login.html`,{error:o}=await i.auth.resetPasswordForEmail(e,{redirectTo:n}),s=document.getElementById("forgot-msg");s.style.color=o?"var(--danger)":"var(--success)",s.textContent=o?o.message:"Sjekk e-posten din for lenke!"}catch(t){const n=document.getElementById("forgot-msg");n.style.color="var(--danger)",n.textContent="Kunne ikke sende e-post",console.error("Supabase reset error:",t)}}async function V(e){try{const n=`${window.location.origin}/kalkulator/login.html`,{error:o}=await i.auth.signInWithOtp({email:e,options:{emailRedirectTo:n}}),s=document.getElementById("forgot-msg");s.style.color=o?"var(--danger)":"var(--success)",s.textContent=o?o.message:"Magisk lenke sendt! Sjekk e-posten din."}catch(t){const n=document.getElementById("forgot-msg");n.style.color="var(--danger)",n.textContent="Kunne ikke sende magisk lenke",console.error("Supabase magic link error:",t)}}function c(){const e=window.location.hash,t=new URLSearchParams(window.location.search),n=e.includes("access_token")&&e.includes("type=recovery"),o=t.has("token")&&t.get("type")==="recovery",s=window.location.search.includes("access_token")&&window.location.search.includes("type=recovery"),u=e.includes("type=recovery")||window.location.search.includes("type=recovery"),l=document.referrer.includes("supabase.co/auth/v1/verify")||sessionStorage.getItem("supabase_recovery_flow")==="true";let y=null;if(e.startsWith("#")&&e.includes("access_token"))try{y=new URLSearchParams(e.substring(1))}catch(m){console.error("Error parsing hash fragment:",m)}const E=y&&y.get("type")==="recovery",p=n||o||s||u||l||E;return p&&sessionStorage.setItem("supabase_recovery_flow","true"),p}function $(){i.auth.onAuthStateChange(async(e,t)=>{e==="PASSWORD_RECOVERY"?(a=!0,d()):e==="SIGNED_IN"?c()||a?(a=!0,d()):await C():e==="TOKEN_REFRESHED"&&(c()||a)?(a=!0,d()):t&&!c()&&!a&&e!=="SIGNED_OUT"&&await C()}),(async()=>{if(!c()&&!a){const{data:{session:e}}=await i.auth.getSession();e&&await C()}else c()&&(a=!0,setTimeout(()=>d(),200))})()}async function z(){const e=c(),t=window.location.hash,n=t.includes("access_token")||t.includes("refresh_token");(e||n)&&(a=!0,document.body.style.visibility="visible",setTimeout(()=>{d()},100))}function d(){window.authElements?.authBox&&(window.authElements.authBox.style.display="none"),window.authElements?.signupCard&&(window.authElements.signupCard.style.display="none"),window.authElements?.forgotCard&&(window.authElements.forgotCard.style.display="none"),window.authElements?.completeProfileCard&&(window.authElements.completeProfileCard.style.display="none");let e=document.getElementById("reset-password-form");e||(e=Y(),document.body.appendChild(e)),e.style.display="flex"}function Y(){const e=document.createElement("div");e.id="reset-password-form",e.className="auth-center",e.innerHTML=`
        <div class="login-card">
            <form id="reset-password-form-element" novalidate>
                <h2 style="margin-bottom: 20px;">Sett nytt passord</h2>
                <label for="new-password" class="form-label">Nytt passord</label>
                <input id="new-password" name="new-password" type="password" placeholder="Nytt passord" required class="form-control" style="margin-bottom: 12px;" autocomplete="new-password" />
                <label for="confirm-password" class="form-label">Bekreft passord</label>
                <input id="confirm-password" name="confirm-password" type="password" placeholder="Bekreft passord" required class="form-control" style="margin-bottom: 18px;" autocomplete="new-password" />
                <button id="update-password-btn" type="submit" class="btn btn-primary" style="margin-bottom: 12px;">Oppdater passord</button>
            </form>
            <button id="cancel-reset-btn" class="btn btn-secondary">Avbryt</button>
            <p id="reset-msg" style="color: var(--danger); min-height: 24px; text-align: center; font-size: 15px;"></p>
        </div>
    `;const t=e.querySelector("#update-password-btn"),n=e.querySelector("#cancel-reset-btn"),o=e.querySelector("#new-password"),s=e.querySelector("#confirm-password"),u=e.querySelector("#reset-password-form-element");return t.onclick=()=>N(o.value,s.value),n.onclick=()=>Q(),u&&u.addEventListener("submit",function(l){l.preventDefault(),N(o.value,s.value)}),o.addEventListener("keypress",function(l){l.key==="Enter"&&(l.preventDefault(),s.focus())}),s.addEventListener("keypress",function(l){l.key==="Enter"&&(l.preventDefault(),t.click())}),e}async function N(e,t){const n=document.getElementById("reset-msg"),o=document.getElementById("update-password-btn");if(n.style.color="var(--danger)",!e||e.length<6){n.textContent="Passordet må være minst 6 tegn";return}if(e!==t){n.textContent="Passordene stemmer ikke overens";return}o.disabled=!0,o.textContent="Oppdaterer...",n.textContent="";try{const{data:{session:s}}=await i.auth.getSession();if(!s){n.textContent="Ugyldig eller utløpt tilbakestillingslenke. Prøv å be om en ny lenke.";return}c()||a||console.warn("Attempting password update without recovery context");const{error:l}=await i.auth.updateUser({password:e});l?(console.error("Password update error:",l),n.textContent=l.message||"Kunne ikke oppdatere passord"):(n.style.color="var(--success)",n.textContent="Passord oppdatert! Omdirigerer...",a=!1,window.location.hash="",sessionStorage.removeItem("supabase_recovery_flow"),setTimeout(async()=>{await i.auth.signOut(),setTimeout(()=>{window.location.href="login.html"},500)},1500))}catch(s){console.error("Password update exception:",s),n.textContent="Kunne ikke oppdatere passord. Prøv igjen."}finally{o.disabled=!1,o.textContent="Oppdater passord"}}function Q(){a=!1,window.location.hash="",sessionStorage.removeItem("supabase_recovery_flow");const e=document.getElementById("reset-password-form");e&&(e.style.display="none"),window.authElements?.authBox&&(window.authElements.authBox.style.display="flex"),window.authElements?.forgotCard&&(window.authElements.forgotCard.style.display="none"),window.authElements?.authMsg&&(window.authElements.authMsg.textContent="")}
