const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/appLogic-CqqQvfnH.js","assets/modulepreload-polyfill-B5Qt9EMX.js","assets/runtime-config-CwEj8XBa.js"])))=>i.map(i=>d[i]);
import"./modulepreload-polyfill-B5Qt9EMX.js";import"./runtime-config-CwEj8XBa.js";class z{constructor(){this.cache=new Map,this.cacheExpiry=new Map,this.cacheDuration=300*1e3,this.fallbacks={employees:!0}}async getFeatureFlags(){const e="feature_flags",f=Date.now();if(this.cache.has(e)&&this.cacheExpiry.get(e)>f)return this.cache.get(e);try{const w=typeof window<"u"&&window.CONFIG?.apiBase||"/api",x=await fetch(`${w}/config`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!x.ok)throw new Error(`HTTP ${x.status}: ${x.statusText}`);const d=(await x.json()).features||{},o={...this.fallbacks,...d};return this.cache.set(e,o),this.cacheExpiry.set(e,f+this.cacheDuration),o}catch(w){return console.warn("Failed to fetch feature flags, using fallbacks:",w.message),this.cache.has(e)?this.cache.get(e):{...this.fallbacks}}}async isFeatureEnabled(e){return(await this.getFeatureFlags())[e]??this.fallbacks[e]??!1}clearCache(){this.cache.clear(),this.cacheExpiry.clear()}setCacheDuration(e){this.cacheDuration=e}}const V=new z;async function R(){return await V.getFeatureFlags()}async function K(l){return await V.isFeatureEnabled(l)}typeof module<"u"&&module.exports?module.exports={FeatureFlags:z,useFeatureFlags:R,useFeature:K,featureFlags:V}:typeof window<"u"&&(window.FeatureFlags=z,window.useFeatureFlags=R,window.useFeature=K,window.featureFlags=V);const Q="modulepreload",X=function(l){return"/"+l},Y={},Z=function(e,f,w){let x=Promise.resolve();if(f&&f.length>0){let T=function(g){return Promise.all(g.map(M=>Promise.resolve(M).then(I=>({status:"fulfilled",value:I}),I=>({status:"rejected",reason:I}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),o=d?.nonce||d?.getAttribute("nonce");x=T(f.map(g=>{if(g=X(g),g in Y)return;Y[g]=!0;const M=g.endsWith(".css"),I=M?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${g}"]${I}`))return;const E=document.createElement("link");if(E.rel=M?"stylesheet":Q,M||(E.as="script"),E.crossOrigin="",E.href=g,o&&E.setAttribute("nonce",o),document.head.appendChild(E),M)return new Promise((D,L)=>{E.addEventListener("load",D),E.addEventListener("error",()=>L(new Error(`Unable to preload CSS for ${g}`)))})}))}function B(d){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=d,window.dispatchEvent(o),!o.defaultPrevented)throw d}return x.then(d=>{for(const o of d||[])o.status==="rejected"&&B(o.reason);return e().catch(B)})},G=window.CONFIG?.apiBase||"/api";function H(){if(document.body.classList.contains("chatbox-view"))return;const l=window.visualViewport?window.visualViewport.height:window.innerHeight;document.documentElement.style.setProperty("--app-height",l+"px"),document.documentElement.style.setProperty("--dvh",l+"px")}function ee(){const l=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,e=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches;l&&e&&(document.documentElement.classList.add("ios-pwa"),H())}function te(){const l=document.querySelector('meta[name="theme-color"]');l&&l.setAttribute("content","#000000");const e=document.querySelector('meta[name="theme-color"][media*="light"]');e&&e.setAttribute("content","#000000");const f=document.querySelector('meta[name="theme-color"][media*="dark"]');f&&f.setAttribute("content","#000000")}function $(){if(document.body.classList.contains("chatbox-view"))return;const l=document.querySelector(".dashboard-month-nav"),e=document.querySelector(".shift-section .month-navigation-container");!l||!e||document.body.classList.add("force-dashboard-nav")}H();te();ee();$();window.addEventListener("resize",()=>{H(),$()});window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{H(),$()});window.addEventListener("orientationchange",()=>{setTimeout(()=>{H(),$()},100)});let W;window.addEventListener("scroll",()=>{document.body.classList.contains("chatbox-view")||(clearTimeout(W),W=setTimeout(()=>{H()},50))});function ne(){if(!window.visualViewport)return;let l=window.visualViewport.height,e=!1;function f(){if(document.body.classList.contains("chatbox-view")){const g=window.visualViewport.height,M=l-g,I=e;e=M>150,e!==I&&(e?document.body.classList.add("keyboard-visible"):document.body.classList.remove("keyboard-visible"));return}const d=window.visualViewport.height,o=l-d,T=e;e=o>150,e!==T&&(document.getElementById("chatboxPill"),document.getElementById("chatboxInput"),e?(document.body.classList.add("keyboard-visible"),w()):(document.body.classList.remove("keyboard-visible"),x()))}function w(){if(document.body.classList.contains("chatbox-view"))return;const d=document.querySelector(".shift-section .month-navigation-container"),o=document.querySelector(".dashboard-month-nav");d&&(d.style.transition="opacity 0.2s ease, transform 0.2s ease",d.style.opacity="0",d.style.transform="translateY(-20px)",d.style.pointerEvents="none"),o&&(o.style.transition="opacity 0.2s ease, transform 0.2s ease",o.style.opacity="0",o.style.transform="translateY(-20px)",o.style.pointerEvents="none")}function x(){if(document.body.classList.contains("chatbox-view"))return;const d=document.querySelector(".shift-section .month-navigation-container"),o=document.querySelector(".dashboard-month-nav");d&&(d.style.opacity="",d.style.transform="",d.style.pointerEvents=""),o&&(o.style.opacity="",o.style.transform="",o.style.pointerEvents="")}window.visualViewport.addEventListener("resize",f),window.addEventListener("orientationchange",()=>{setTimeout(()=>{l=window.visualViewport.height,e=!1,document.body.classList.remove("keyboard-visible"),x()},500)}),document.addEventListener("focusin",d=>{if(d.target.matches("input, textarea, select")){if(d.target.id==="chatboxInput"){const o=window.pageYOffset||document.documentElement.scrollTop,T=window.pageXOffset||document.documentElement.scrollLeft;setTimeout(()=>{window.scrollTo(T,o)},0);return}document.body.classList.contains("chatbox-view")||setTimeout(()=>{if(e){const o=d.target.getBoundingClientRect(),T=window.visualViewport?window.visualViewport.height:window.innerHeight;if(o.bottom>T-20){const g=Math.min(o.bottom-T+40,100);window.scrollBy({top:g,behavior:"smooth"})}}},300)}}),document.addEventListener("focusout",d=>{d.target.matches("input, textarea, select")&&d.target.id==="chatboxInput"&&setTimeout(()=>{B()},100)});function B(){if(!document.body.classList.contains("chatbox-view"))return;const d=document.getElementById("chatboxLog"),o=document.querySelector(".chatbox-view .dashboard-content");d&&(d.style.maxHeight="",d.style.height="",o&&(o.style.marginBottom="",o.style.gap="",o.style.paddingBottom=""))}}window.innerWidth<=768&&ne();function J(){document.querySelectorAll("input, textarea, select").forEach(e=>{e.type!=="file"&&(e.style.fontSize="16px"),e.addEventListener("focus",()=>{e.style.transition="border-color 0.2s ease, box-shadow 0.2s ease"}),e.tagName.toLowerCase()==="textarea"&&(e.id==="chatboxInput"?(e.addEventListener("focus",f=>{f.preventDefault();const w=window.pageYOffset||document.documentElement.scrollTop,x=window.pageXOffset||document.documentElement.scrollLeft;setTimeout(()=>{window.scrollTo(x,w)},0)}),e.addEventListener("input",()=>{e.style.height="auto";const f=Math.min(e.scrollHeight,80);e.style.height=f+"px"})):e.addEventListener("input",()=>{e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"}))})}function oe(){if(window.location.search.includes("debug=viewport")){let l=window.visualViewport?window.visualViewport.height:window.innerHeight,e=0;const f=()=>{const w=window.visualViewport?window.visualViewport.height:window.innerHeight;Math.abs(w-l)>5&&(e++,console.log(`Viewport change #${e}: ${l}px → ${w}px`,{isChatboxView:document.body.classList.contains("chatbox-view"),isKeyboardVisible:document.body.classList.contains("keyboard-visible"),activeElement:document.activeElement?.id||"none"}),l=w)};window.visualViewport&&window.visualViewport.addEventListener("resize",f),window.addEventListener("resize",f)}}window.innerWidth<=768&&(document.addEventListener("DOMContentLoaded",()=>{J(),oe()}),new MutationObserver(()=>{J()}).observe(document.body,{childList:!0,subtree:!0}));document.addEventListener("DOMContentLoaded",async()=>{document.body.classList.add("skeleton-active");const l=document.getElementById("app");l&&l.style.setProperty("display","block","important");const e=window.supabase.createClient(window.CONFIG.supabase.url,window.CONFIG.supabase.anonKey);window.supa=e;let f=null,w=0;const x=3;try{const{data:{session:s}}=await e.auth.getSession();s?(f=s,console.log("Quick session check: Session found")):console.log("Quick session check: No session yet; will retry before redirecting")}catch(s){console.log("Quick session check failed, proceeding with retry logic:",s)}async function B(){try{const{data:{user:s}}=await e.auth.getUser();if(!s)return;const r=document.getElementById("userNickname");if(r){const t=s.user_metadata?.first_name||s.email?.split("@")[0]||"Bruker";r.textContent=t}window.chatbox&&window.chatbox.updateText&&window.chatbox.updateText();let m="";try{const{data:{session:t}}=await e.auth.getSession(),n=t?.access_token;if(n){const i=await fetch(`${window.CONFIG.apiBase}/settings`,{headers:{Authorization:`Bearer ${n}`}});i.ok&&(m=(await i.json())?.profile_picture_url||"")}}catch{}if(!m)try{const t=s?.id;if(!t)return;const{data:n}=await e.from("user_settings").select("profile_picture_url").eq("user_id",t).maybeSingle();m=n?.profile_picture_url||""}catch{}m||(m=s.user_metadata?.avatar_url||"");const y=document.getElementById("userAvatarImg"),v=document.querySelector(".profile-icon");y&&(m?(y.onload=()=>{y.style.display="block",v&&(v.style.display="none")},y.onerror=()=>{y.style.display="none",v&&(v.style.display=""),console.warn("Avatar image failed to load, showing placeholder")},y.src=m):(y.style.display="none",v&&(v.style.display="")))}catch(s){console.error("Error loading profile info:",s);const r=document.getElementById("userNickname");r&&(r.textContent="Bruker");const m=document.getElementById("userAvatarImg"),y=document.querySelector(".profile-icon");m&&(m.style.display="none"),y&&(y.style.display="")}}for(;!f&&w<x;){console.log(`App.html: Checking session (attempt ${w+1}/${x})`);const{data:{session:s}}=await e.auth.getSession();if(f=s,f)console.log("App.html: Session found for user:",f.user.email);else if(w++,w<x)console.log("App.html: No session found, waiting 200ms before retry..."),await new Promise(r=>setTimeout(r,200));else{console.log(`App.html: No session after ${x} attempts, redirecting to login`),console.log("[login] no session – redirecting to login page"),window.location.href="login.html";return}}window.logout=async()=>{window.chatbox&&window.chatbox.clear&&window.chatbox.clear(),await e.auth.signOut(),window.location.href="login.html"};let d;try{d=await Z(()=>import("./appLogic-CqqQvfnH.js"),__vite__mapDeps([0,1,2]))}catch(s){console.error("Failed to load appLogic module:",s)}const o=d?.app;window.app=o,await B();let T=!1;if(o&&typeof o.init=="function")try{await o.init()}catch(s){T=!0,console.error("App initialization failed:",s);try{o.loadFromLocalStorage?.()}catch(r){console.error("Fallback to local storage failed:",r)}}else T=!0,console.error("App module not available or missing init()");const g=document.getElementById("app");if(g){g.style.setProperty("display","block","important"),g.classList.add("animations-complete");try{const s=document.querySelector(".app-container");if(s){const r=m=>{m&&(m.style.visibility="visible",m.style.opacity="1",m.style.transform="none")};r(s.querySelector(".tab-bar-container")),r(s.querySelector(".content"))}}catch(s){console.warn("Ensure-visible encountered an error:",s)}if(T){const s=document.createElement("div");s.className="nonblocking-warning",s.style.cssText="margin:12px 16px;padding:10px;border-radius:8px;background:#332e00;color:#ffd666;font-size:14px;",s.textContent="Noe gikk galt under innlasting. Viser tilgjengelig data – prøv å oppdatere siden.",g.prepend(s)}}document.body.classList.remove("skeleton-active");const M=document.querySelector(".total-card .total-skeleton");M&&(M.style.display="none"),document.querySelectorAll("[onclick]").forEach(s=>{const r=s.getAttribute("onclick");r&&(s.addEventListener("click",m=>{try{if(r.includes("app.")){const y=r.match(/app\.(\w+)\((.*?)\)/);if(y){const[,v,t]=y;let n=[];if(t.trim())if(t.includes("'")||t.includes('"'))n=[t.replace(/['"]/g,"")];else if(t.includes("event.stopPropagation()")){m.stopPropagation();const i=r.match(/app\.deleteShift\((\d+)\)/);if(i){o.deleteShift(parseInt(i[1]));return}}else t.includes("this")?n=[s]:t.match(/^\d+$/)&&(n=[parseInt(t)]);o[v]&&(console.log(`Executing ${v} with params:`,n),o[v](...n))}}else r.includes("logout()")&&logout()}catch(y){console.error("Error executing onclick handler:",y,"Original onclick:",r)}}),s.setAttribute("onclick","return false;"))});let I=!1;function E(){I||(document.body.addEventListener("click",s=>{const r=s.target.closest(".delete-shift-btn");if(r){s.stopPropagation();const n=parseInt(r.getAttribute("data-shift-index"));o.deleteShift(n).then(()=>{o.closeShiftDetails()});return}const m=s.target.closest(".edit-shift-btn");if(m){s.stopPropagation();const n=m.getAttribute("data-shift-id");o.editShift(n);return}if(s.target.closest(".close-shift-details")){s.stopPropagation(),o.closeShiftDetails();return}const v=s.target.closest(".remove-bonus");if(v){s.stopPropagation(),o.removeBonusSlot(v);return}const t=s.target.closest(".modal");if(t&&s.target===t){const n=t.id;n==="addShiftModal"?o.closeAddShiftModal():n==="editShiftModal"?o.closeEditShift():n==="settingsModal"&&o.closeSettings();return}if(!s.target.closest(".btn")){const n=s.target.closest("[data-shift-id]");if(n){const i=n.getAttribute("data-shift-id");o.showShiftDetails(i)}}}),document.addEventListener("keydown",s=>{if(s.key==="Escape"){const r={addShiftModal:()=>o.closeAddShiftModal(),editShiftModal:()=>o.closeEditShift(),settingsModal:()=>o.closeSettings()};for(const[m,y]of Object.entries(r)){const v=document.getElementById(m);if(v&&v.style.display==="block"){y();break}}}}),I=!0)}E();const D=document.querySelector(".snap-container"),L=document.querySelector(".floating-action-bar"),q=document.querySelector(".floating-action-bar-backdrop"),N=document.querySelector(".shift-section");if(D&&L&&q&&N){let y=function(){const v=N.getBoundingClientRect(),t=window.innerHeight,n=Math.max(0,v.top),i=Math.min(t,v.bottom),u=Math.max(0,i-n)/t>=.6;u&&!s?(s=!0,clearTimeout(r),L.style.display="flex",L.style.animation="fadeInUp 0.3s ease-out forwards",L.style.opacity="1",q.style.opacity="1"):!u&&s&&(s=!1,clearTimeout(r),L.style.animation="fadeOutDown 0.3s ease-out forwards",L.style.opacity="0",q.style.opacity="0",r=setTimeout(()=>{s||(L.style.display="none")},300)),m=!1};L.style.display="none",L.style.opacity="0",q.style.opacity="0";let s=!1,r=null,m=!1;D.addEventListener("scroll",()=>{m||(requestAnimationFrame(y),m=!0)}),y()}});(function(){let l=[{role:"system",content:"Du er en chatbot som hjelper brukeren å registrere skift via addShift eller addSeries. Svar alltid på norsk."}],e={},f=!1,w=!1;function x(){if(e={pill:document.getElementById("chatboxPill"),expandedContent:document.getElementById("chatboxExpandedContent"),close:document.getElementById("chatboxClose"),log:document.getElementById("chatboxLog"),input:document.getElementById("chatboxInput"),send:document.getElementById("chatboxSend"),pillText:document.getElementById("chatboxPillPlaceholder")},!e.pill||!e.expandedContent){console.warn("Chatbox elements not found");return}d(),B()}async function B(){try{if(!window.supa||!window.supa.auth){console.log("Supabase client not yet available, using default text"),e.pillText&&(e.pillText.textContent="Trenger du hjelp?");return}const{data:{user:t}}=await window.supa.auth.getUser();if(!t||!e.pillText)return;const n=t.user_metadata?.first_name||t.email?.split("@")[0]||"Bruker";e.pillText.textContent=`Trenger du hjelp, ${n}?`}catch(t){console.error("Error updating chatbox text:",t),e.pillText&&(e.pillText.textContent="Trenger du hjelp, Bruker?")}}function d(){e.pill.addEventListener("click",function(t){!t.target.closest(".chatbox-close")&&!f&&o()}),e.close&&e.close.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),T()}),e.send&&e.send.addEventListener("click",N),e.input&&(e.input.addEventListener("keydown",function(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),N())}),e.input.addEventListener("input",g))}function o(){f=!0,M(),e.pill.classList.add("expanded"),e.expandedContent.style.display="block",e.close.style.display="flex",document.body.classList.add("chatbox-expanded-active"),setTimeout(()=>{if(e.input){const t=window.pageYOffset||document.documentElement.scrollTop,n=window.pageXOffset||document.documentElement.scrollLeft;e.input.focus({preventScroll:!0}),setTimeout(()=>{window.scrollTo(n,t)},0)}},300)}function T(){f=!1,w=!1,I(),e.pill.classList.remove("expanded"),e.expandedContent.style.display="none",e.close.style.display="none",document.body.classList.remove("chatbox-expanded-active"),e.log&&(e.log.innerHTML=""),l=[{role:"system",content:"Du er en chatbot som hjelper brukeren å registrere skift via addShift eller addSeries. Svar alltid på norsk."}]}function g(){const t=e.input;if(!t)return;t.style.height="auto";const i=document.body.classList.contains("keyboard-visible")?80:100,a=Math.min(t.scrollHeight,i);t.style.height=a+"px"}function M(){const t=document.body,n=document.querySelector(".dashboard-content"),i=document.querySelector(".chatbox-container");if(!n||!i)return;t.classList.add("chatbox-view");const a=document.querySelector(".total-card"),p=document.querySelector(".next-shift-card"),u=document.querySelector(".next-payroll-card"),c=document.querySelector(".dashboard-month-nav"),k=document.querySelector(".floating-action-bar");if(a&&(a.style.display="none"),p&&(p.style.display="none"),u&&(u.style.display="none"),c&&(c.style.display="none",c.style.visibility="hidden",c.style.height="0",c.style.margin="0",c.style.padding="0",c.style.opacity="0"),k&&(k.style.display="none"),i&&n&&!n.contains(i)){const h=document.createElement("div");h.className="dashboard-chatbox-container",h.style.order="1",h.appendChild(i),n.appendChild(h)}}function I(){const t=document.body,n=document.querySelector(".chatbox-container");t.classList.remove("chatbox-view");const i=document.querySelector(".total-card"),a=document.querySelector(".next-shift-card"),p=document.querySelector(".next-payroll-card"),u=document.querySelector(".dashboard-month-nav"),c=document.querySelector(".floating-action-bar");i&&(i.style.display=""),a&&(a.style.display=""),p&&(p.style.display=""),u&&(u.style.display="",u.style.visibility="",u.style.height="",u.style.margin="",u.style.padding="",u.style.opacity="",u.style.width="",u.style.position="",u.style.left=""),c&&(c.style.display="");const k=document.querySelector(".dashboard-chatbox-container"),h=document.querySelector(".app-container");k&&n&&h&&(h.appendChild(n),k.remove())}function E(t,n,i={}){!w&&!f&&(w=!0,o());const a=document.createElement("div");if(a.className=`chatbox-message ${t}`,n.includes('<span class="dots">'))a.innerHTML=n;else if(t==="assistant"){if(i.streaming)return a.innerHTML="",e.log.appendChild(a),e.log.scrollTop=e.log.scrollHeight,D(a,n,i.streamSpeed||75),a;{const p=DOMPurify.sanitize(marked.parse(n));a.innerHTML=p}}else a.textContent=n;return e.log.appendChild(a),e.log.scrollTop=e.log.scrollHeight,a}function D(t,n,i=25){const a=L(n);let p=0,u="";const c=document.createElement("span");c.className="typing-cursor",c.textContent="▊",c.style.opacity="0.7";function k(){if(p<a.length){u+=a[p],p++;const h=DOMPurify.sanitize(marked.parse(u)),_=document.createElement("div");_.innerHTML=h;const C=_.lastElementChild||_;C.tagName==="P"?C.appendChild(c.cloneNode(!0)):_.appendChild(c.cloneNode(!0)),t.innerHTML=_.innerHTML,e.log.scrollTop=e.log.scrollHeight;const b=a[p-1];let P=i;b===" "?P=i*.5:b.match(/[.!?]/)?P=i*2:b.length>3&&(P=i*1.2),P+=Math.random()*10,setTimeout(k,P)}else{c.remove();const h=DOMPurify.sanitize(marked.parse(n));t.innerHTML=h,e.log.scrollTop=e.log.scrollHeight}}setTimeout(k,100)}function L(t){const n=[];let i="";for(let a=0;a<t.length;a++){const p=t[a];p.match(/\s/)||p.match(/[.!?,:;]/)||p.match(/[()[\]{}]/)?(i&&(n.push(i),i=""),n.push(p)):(i+=p,i.length>=2&&Math.random()>.6&&(n.push(i),i=""))}return i&&n.push(i),n}function q(t){let n=0;const i=25;function a(){if(!t.isStreaming&&n>=t.fullText.length){t.streamingActive=!1;const u=DOMPurify.sanitize(marked.parse(t.fullText));t.innerHTML=u,t.classList.remove("streaming-text"),e.log.scrollTop=e.log.scrollHeight;return}const p=t.fullText;if(n<p.length){const u=Math.min(Math.floor(Math.random()*3)+2,p.length-n);n+=u;const c=p.substring(0,n),k=document.createElement("div");k.innerHTML=DOMPurify.sanitize(marked.parse(c));const h=document.createElement("span");h.className="typing-cursor",h.textContent="▊",h.style.opacity="0.7",k.appendChild(h),t.innerHTML=k.innerHTML,e.log.scrollTop=e.log.scrollHeight;const _=i+Math.random()*10;setTimeout(a,_)}else setTimeout(a,50)}a()}async function N(){const t=e.input.value.trim();t&&(e.input.value="",g(),await s(t))}async function s(t){e.send&&(e.send.disabled=!0),E("user",t),l.push({role:"user",content:t});const n=E("assistant",'<span class="dots"><span>.</span><span>.</span><span>.</span></span>');let i;try{const{data:{session:a}}=await window.supa.auth.getSession();if(i=a?.access_token,!i){n.remove(),E("system","Du må være innlogget for å bruke chat-funksjonen.");return}}catch(a){console.error("Auth error:",a),n.textContent="⚠️ Autentiseringsfeil.";return}try{const a=await fetch(`${G}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({messages:l,stream:!0,currentMonth:window.app?.currentMonth||new Date().getMonth()+1,currentYear:window.app?.currentYear||new Date().getFullYear()})});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const p=a.body.getReader(),u=new TextDecoder;let c="",k=null;for(;;){const{done:A,value:S}=await p.read();if(A)break;c+=u.decode(S,{stream:!0});const j=c.split(`
`);c=j.pop();for(const U of j)if(U.startsWith("data: ")){const O=U.slice(6);if(O==="[DONE]")break;try{const F=JSON.parse(O);m(F,n),F.type==="complete"?k=F:F.type==="text_stream_end"&&(k={assistant:"streamed",shifts:[]})}catch{console.warn("Failed to parse streaming data:",O)}}}const h=k;if(!h)throw new Error("No data received from streaming response");console.debug("[/chat response]",h);const _=h.assistant??(h.error&&`⚠️ ${h.error}`)??"⚠️ Ukjent svar fra serveren.";if(h.assistant){const A=DOMPurify.sanitize(marked.parse(_));n.innerHTML=A}else n.textContent=_;h.assistant&&l.push({role:"assistant",content:h.assistant});const C=h.shifts||[],b=[],P=new Set;for(const A of C){const S=`${A.shift_date}|${A.start_time}|${A.end_time}`;P.has(S)||(P.add(S),b.push(A))}if(window.app&&window.app.refreshUI){const A=b.map(S=>({id:S.id||Date.now()+Math.random(),date:new Date(S.date||S.shift_date),startTime:S.startTime||S.start_time,endTime:S.endTime||S.end_time,type:S.type!==void 0?S.type:S.shift_type,seriesId:S.seriesId||S.series_id||null}));window.app.shifts&&window.app.userShifts&&(window.app.shifts=[...A],window.app.userShifts=[...A]),window.app.refreshUI(A)}}catch(a){console.error("Chat error:",a);try{console.log("Streaming failed, falling back to regular request...");const p=await fetch(`${G}/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({messages:l,stream:!1})});if(p.ok){const u=await p.json(),c=u.assistant??(u.error&&`⚠️ ${u.error}`)??"⚠️ Ukjent svar fra serveren.";if(u.assistant){const C=DOMPurify.sanitize(marked.parse(c));n.innerHTML=C}else n.textContent=c;u.assistant&&l.push({role:"assistant",content:u.assistant});const k=u.shifts||[],h=[],_=new Set;for(const C of k){const b=`${C.shift_date}|${C.start_time}|${C.end_time}`;_.has(b)||(_.add(b),h.push(C))}if(window.app&&window.app.refreshUI){const C=h.map(b=>({id:b.id||Date.now()+Math.random(),date:new Date(b.date||b.shift_date),startTime:b.startTime||b.start_time,endTime:b.endTime||b.end_time,type:b.type!==void 0?b.type:b.shift_type,seriesId:b.seriesId||b.series_id||null}));window.app.shifts&&window.app.userShifts&&(window.app.shifts=[...C],window.app.userShifts=[...C]),window.app.refreshUI(C)}}else throw new Error("Fallback request also failed")}catch(p){console.error("Fallback error:",p),n.textContent="⚠️ Kunne ikke koble til serveren."}}finally{e.send&&(e.send.disabled=!1)}}let r=null;function m(t,n){switch(t.type){case"status":y(n,t.message);break;case"gpt_response":if(t.tool_calls&&t.tool_calls.length>0){const i=t.tool_calls.map(a=>a.name).join(", ");y(n,`GPT planlegger: ${i}`)}break;case"tool_calls_start":y(n,t.message);break;case"tool_call_start":y(n,t.message);break;case"tool_call_complete":y(n,t.message+" ✓");break;case"text_stream_start":r=document.createElement("div"),r.className="streaming-text",r.fullText="",r.isStreaming=!0,r.streamingActive=!1,n.parentNode.replaceChild(r,n);break;case"text_chunk":r&&r.isStreaming&&(r.fullText+=t.content,r.streamingActive||(r.streamingActive=!0,q(r)));break;case"text_stream_end":if(r){r.isStreaming=!1;const i=r.fullText;l.push({role:"assistant",content:i}),r=null}break;case"shifts_update":if(t.shifts&&window.app&&window.app.refreshUI){const i=t.shifts||[],a=[],p=new Set;for(const c of i){const k=`${c.shift_date}|${c.start_time}|${c.end_time}`;p.has(k)||(p.add(k),a.push(c))}const u=a.map(c=>({id:c.id||Date.now()+Math.random(),date:new Date(c.date||c.shift_date),startTime:c.startTime||c.start_time,endTime:c.endTime||c.end_time,type:c.type!==void 0?c.type:c.shift_type,seriesId:c.seriesId||c.series_id||null}));window.app.shifts&&window.app.userShifts&&(window.app.shifts=[...u],window.app.userShifts=[...u]),window.app.refreshUI(u)}break}}function y(t,n){t&&t.parentNode&&(t.innerHTML=`<span class="stream-status">${n}</span> <span class="dots"><span>.</span><span>.</span><span>.</span></span>`)}function v(){e.log&&(e.log.innerHTML=""),l=[{role:"system",content:"Du er en chatbot som hjelper brukeren å registrere skift via addShift eller addSeries. Svar alltid på norsk."}],w=!1,f=!1,document.body.classList.remove("chatbox-expanded-active"),e.pill&&e.pill.classList.remove("expanded"),e.expandedContent&&(e.expandedContent.style.display="none"),e.close&&(e.close.style.display="none")}window.chatbox={init:x,clear:v,expand:o,collapse:T,updateText:B,appendMessage:E,streamText:D,tokenizeText:L},window.streamText=D,window.tokenizeText=L,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",x):x()})();typeof window<"u"&&!window.uuidv4&&(window.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const f=Math.random()*16|0;return(e==="x"?f:f&3|8).toString(16)})});export{Z as _};
