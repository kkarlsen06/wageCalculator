const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/employeeCarousel-DHwHiZ0-.js","assets/kalkulator-C3sRTWD8.js","assets/modulepreload-polyfill-B5Qt9EMX.js","assets/runtime-config-CwEj8XBa.js","assets/kalkulator-BYzzdff5.css","assets/employeeModal-B0VnrISH.js"])))=>i.map(i=>d[i]);
import{_ as z}from"./kalkulator-C3sRTWD8.js";import"./modulepreload-polyfill-B5Qt9EMX.js";import"./runtime-config-CwEj8XBa.js";const fs=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>z(async()=>{const{default:n}=await Promise.resolve().then(()=>xe);return{default:n}},void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)};class pt extends Error{constructor(e,t="FunctionsError",n){super(e),this.name=t,this.context=n}}class ms extends pt{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class bt extends pt{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class St extends pt{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var tt;(function(s){s.Any="any",s.ApNortheast1="ap-northeast-1",s.ApNortheast2="ap-northeast-2",s.ApSouth1="ap-south-1",s.ApSoutheast1="ap-southeast-1",s.ApSoutheast2="ap-southeast-2",s.CaCentral1="ca-central-1",s.EuCentral1="eu-central-1",s.EuWest1="eu-west-1",s.EuWest2="eu-west-2",s.EuWest3="eu-west-3",s.SaEast1="sa-east-1",s.UsEast1="us-east-1",s.UsWest1="us-west-1",s.UsWest2="us-west-2"})(tt||(tt={}));var gs=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};class ys{constructor(e,{headers:t={},customFetch:n,region:i=tt.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=fs(n)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var n;return gs(this,void 0,void 0,function*(){try{const{headers:i,method:o,body:r}=t;let a={},{region:l}=t;l||(l=this.region);const c=new URL(`${this.url}/${e}`);l&&l!=="any"&&(a["x-region"]=l,c.searchParams.set("forceFunctionRegion",l));let d;r&&(i&&!Object.prototype.hasOwnProperty.call(i,"Content-Type")||!i)&&(typeof Blob<"u"&&r instanceof Blob||r instanceof ArrayBuffer?(a["Content-Type"]="application/octet-stream",d=r):typeof r=="string"?(a["Content-Type"]="text/plain",d=r):typeof FormData<"u"&&r instanceof FormData?d=r:(a["Content-Type"]="application/json",d=JSON.stringify(r)));const u=yield this.fetch(c.toString(),{method:o||"POST",headers:Object.assign(Object.assign(Object.assign({},a),this.headers),i),body:d}).catch(v=>{throw new ms(v)}),h=u.headers.get("x-relay-error");if(h&&h==="true")throw new bt(u);if(!u.ok)throw new St(u);let m=((n=u.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),f;return m==="application/json"?f=yield u.json():m==="application/octet-stream"?f=yield u.blob():m==="text/event-stream"?f=u:m==="multipart/form-data"?f=yield u.formData():f=yield u.text(),{data:f,error:null,response:u}}catch(i){return{data:null,error:i,response:i instanceof St||i instanceof bt?i.context:void 0}}})}}function vs(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function ws(s){if(Object.prototype.hasOwnProperty.call(s,"__esModule"))return s;var e=s.default;if(typeof e=="function"){var t=function n(){var i=!1;try{i=this instanceof n}catch{}return i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(s).forEach(function(n){var i=Object.getOwnPropertyDescriptor(s,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return s[n]}})}),t}var F={},fe={},me={},ge={},ye={},ve={},bs=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},De=bs();const Ss=De.fetch,Yt=De.fetch.bind(De),zt=De.Headers,_s=De.Request,ks=De.Response,xe=Object.freeze(Object.defineProperty({__proto__:null,Headers:zt,Request:_s,Response:ks,default:Yt,fetch:Ss},Symbol.toStringTag,{value:"Module"})),Es=ws(xe);var Ne={},_t;function Jt(){if(_t)return Ne;_t=1,Object.defineProperty(Ne,"__esModule",{value:!0});class s extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}}return Ne.default=s,Ne}var kt;function Qt(){if(kt)return ve;kt=1;var s=ve&&ve.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(ve,"__esModule",{value:!0});const e=s(Es),t=s(Jt());class n{constructor(o){this.shouldThrowOnError=!1,this.method=o.method,this.url=o.url,this.headers=o.headers,this.schema=o.schema,this.body=o.body,this.shouldThrowOnError=o.shouldThrowOnError,this.signal=o.signal,this.isMaybeSingle=o.isMaybeSingle,o.fetch?this.fetch=o.fetch:typeof fetch>"u"?this.fetch=e.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(o,r){return this.headers=Object.assign({},this.headers),this.headers[o]=r,this}then(o,r){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const a=this.fetch;let l=a(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async c=>{var d,u,h;let m=null,f=null,v=null,g=c.status,S=c.statusText;if(c.ok){if(this.method!=="HEAD"){const _=await c.text();_===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?f=_:f=JSON.parse(_))}const p=(d=this.headers.Prefer)===null||d===void 0?void 0:d.match(/count=(exact|planned|estimated)/),y=(u=c.headers.get("content-range"))===null||u===void 0?void 0:u.split("/");p&&y&&y.length>1&&(v=parseInt(y[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(f)&&(f.length>1?(m={code:"PGRST116",details:`Results contain ${f.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},f=null,v=null,g=406,S="Not Acceptable"):f.length===1?f=f[0]:f=null)}else{const p=await c.text();try{m=JSON.parse(p),Array.isArray(m)&&c.status===404&&(f=[],m=null,g=200,S="OK")}catch{c.status===404&&p===""?(g=204,S="No Content"):m={message:p}}if(m&&this.isMaybeSingle&&(!((h=m?.details)===null||h===void 0)&&h.includes("0 rows"))&&(m=null,g=200,S="OK"),m&&this.shouldThrowOnError)throw new t.default(m)}return{error:m,data:f,count:v,status:g,statusText:S}});return this.shouldThrowOnError||(l=l.catch(c=>{var d,u,h;return{error:{message:`${(d=c?.name)!==null&&d!==void 0?d:"FetchError"}: ${c?.message}`,details:`${(u=c?.stack)!==null&&u!==void 0?u:""}`,hint:"",code:`${(h=c?.code)!==null&&h!==void 0?h:""}`},data:null,count:null,status:0,statusText:""}})),l.then(o,r)}returns(){return this}overrideTypes(){return this}}return ve.default=n,ve}var Et;function Xt(){if(Et)return ye;Et=1;var s=ye&&ye.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(ye,"__esModule",{value:!0});const e=s(Qt());class t extends e.default{select(i){let o=!1;const r=(i??"*").split("").map(a=>/\s/.test(a)&&!o?"":(a==='"'&&(o=!o),a)).join("");return this.url.searchParams.set("select",r),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(i,{ascending:o=!0,nullsFirst:r,foreignTable:a,referencedTable:l=a}={}){const c=l?`${l}.order`:"order",d=this.url.searchParams.get(c);return this.url.searchParams.set(c,`${d?`${d},`:""}${i}.${o?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(i,{foreignTable:o,referencedTable:r=o}={}){const a=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(a,`${i}`),this}range(i,o,{foreignTable:r,referencedTable:a=r}={}){const l=typeof a>"u"?"offset":`${a}.offset`,c=typeof a>"u"?"limit":`${a}.limit`;return this.url.searchParams.set(l,`${i}`),this.url.searchParams.set(c,`${o-i+1}`),this}abortSignal(i){return this.signal=i,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:i=!1,verbose:o=!1,settings:r=!1,buffers:a=!1,wal:l=!1,format:c="text"}={}){var d;const u=[i?"analyze":null,o?"verbose":null,r?"settings":null,a?"buffers":null,l?"wal":null].filter(Boolean).join("|"),h=(d=this.headers.Accept)!==null&&d!==void 0?d:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${c}; for="${h}"; options=${u};`,c==="json"?this:this}rollback(){var i;return((i=this.headers.Prefer)!==null&&i!==void 0?i:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}return ye.default=t,ye}var Tt;function ft(){if(Tt)return ge;Tt=1;var s=ge&&ge.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(ge,"__esModule",{value:!0});const e=s(Xt());class t extends e.default{eq(i,o){return this.url.searchParams.append(i,`eq.${o}`),this}neq(i,o){return this.url.searchParams.append(i,`neq.${o}`),this}gt(i,o){return this.url.searchParams.append(i,`gt.${o}`),this}gte(i,o){return this.url.searchParams.append(i,`gte.${o}`),this}lt(i,o){return this.url.searchParams.append(i,`lt.${o}`),this}lte(i,o){return this.url.searchParams.append(i,`lte.${o}`),this}like(i,o){return this.url.searchParams.append(i,`like.${o}`),this}likeAllOf(i,o){return this.url.searchParams.append(i,`like(all).{${o.join(",")}}`),this}likeAnyOf(i,o){return this.url.searchParams.append(i,`like(any).{${o.join(",")}}`),this}ilike(i,o){return this.url.searchParams.append(i,`ilike.${o}`),this}ilikeAllOf(i,o){return this.url.searchParams.append(i,`ilike(all).{${o.join(",")}}`),this}ilikeAnyOf(i,o){return this.url.searchParams.append(i,`ilike(any).{${o.join(",")}}`),this}is(i,o){return this.url.searchParams.append(i,`is.${o}`),this}in(i,o){const r=Array.from(new Set(o)).map(a=>typeof a=="string"&&new RegExp("[,()]").test(a)?`"${a}"`:`${a}`).join(",");return this.url.searchParams.append(i,`in.(${r})`),this}contains(i,o){return typeof o=="string"?this.url.searchParams.append(i,`cs.${o}`):Array.isArray(o)?this.url.searchParams.append(i,`cs.{${o.join(",")}}`):this.url.searchParams.append(i,`cs.${JSON.stringify(o)}`),this}containedBy(i,o){return typeof o=="string"?this.url.searchParams.append(i,`cd.${o}`):Array.isArray(o)?this.url.searchParams.append(i,`cd.{${o.join(",")}}`):this.url.searchParams.append(i,`cd.${JSON.stringify(o)}`),this}rangeGt(i,o){return this.url.searchParams.append(i,`sr.${o}`),this}rangeGte(i,o){return this.url.searchParams.append(i,`nxl.${o}`),this}rangeLt(i,o){return this.url.searchParams.append(i,`sl.${o}`),this}rangeLte(i,o){return this.url.searchParams.append(i,`nxr.${o}`),this}rangeAdjacent(i,o){return this.url.searchParams.append(i,`adj.${o}`),this}overlaps(i,o){return typeof o=="string"?this.url.searchParams.append(i,`ov.${o}`):this.url.searchParams.append(i,`ov.{${o.join(",")}}`),this}textSearch(i,o,{config:r,type:a}={}){let l="";a==="plain"?l="pl":a==="phrase"?l="ph":a==="websearch"&&(l="w");const c=r===void 0?"":`(${r})`;return this.url.searchParams.append(i,`${l}fts${c}.${o}`),this}match(i){return Object.entries(i).forEach(([o,r])=>{this.url.searchParams.append(o,`eq.${r}`)}),this}not(i,o,r){return this.url.searchParams.append(i,`not.${o}.${r}`),this}or(i,{foreignTable:o,referencedTable:r=o}={}){const a=r?`${r}.or`:"or";return this.url.searchParams.append(a,`(${i})`),this}filter(i,o,r){return this.url.searchParams.append(i,`${o}.${r}`),this}}return ge.default=t,ge}var Dt;function Zt(){if(Dt)return me;Dt=1;var s=me&&me.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(me,"__esModule",{value:!0});const e=s(ft());class t{constructor(i,{headers:o={},schema:r,fetch:a}){this.url=i,this.headers=o,this.schema=r,this.fetch=a}select(i,{head:o=!1,count:r}={}){const a=o?"HEAD":"GET";let l=!1;const c=(i??"*").split("").map(d=>/\s/.test(d)&&!l?"":(d==='"'&&(l=!l),d)).join("");return this.url.searchParams.set("select",c),r&&(this.headers.Prefer=`count=${r}`),new e.default({method:a,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(i,{count:o,defaultToNull:r=!0}={}){const a="POST",l=[];if(this.headers.Prefer&&l.push(this.headers.Prefer),o&&l.push(`count=${o}`),r||l.push("missing=default"),this.headers.Prefer=l.join(","),Array.isArray(i)){const c=i.reduce((d,u)=>d.concat(Object.keys(u)),[]);if(c.length>0){const d=[...new Set(c)].map(u=>`"${u}"`);this.url.searchParams.set("columns",d.join(","))}}return new e.default({method:a,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:this.fetch,allowEmpty:!1})}upsert(i,{onConflict:o,ignoreDuplicates:r=!1,count:a,defaultToNull:l=!0}={}){const c="POST",d=[`resolution=${r?"ignore":"merge"}-duplicates`];if(o!==void 0&&this.url.searchParams.set("on_conflict",o),this.headers.Prefer&&d.push(this.headers.Prefer),a&&d.push(`count=${a}`),l||d.push("missing=default"),this.headers.Prefer=d.join(","),Array.isArray(i)){const u=i.reduce((h,m)=>h.concat(Object.keys(m)),[]);if(u.length>0){const h=[...new Set(u)].map(m=>`"${m}"`);this.url.searchParams.set("columns",h.join(","))}}return new e.default({method:c,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:this.fetch,allowEmpty:!1})}update(i,{count:o}={}){const r="PATCH",a=[];return this.headers.Prefer&&a.push(this.headers.Prefer),o&&a.push(`count=${o}`),this.headers.Prefer=a.join(","),new e.default({method:r,url:this.url,headers:this.headers,schema:this.schema,body:i,fetch:this.fetch,allowEmpty:!1})}delete({count:i}={}){const o="DELETE",r=[];return i&&r.push(`count=${i}`),this.headers.Prefer&&r.unshift(this.headers.Prefer),this.headers.Prefer=r.join(","),new e.default({method:o,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}return me.default=t,me}var Me={},Be={},xt;function Ts(){return xt||(xt=1,Object.defineProperty(Be,"__esModule",{value:!0}),Be.version=void 0,Be.version="0.0.0-automated"),Be}var Ct;function Ds(){if(Ct)return Me;Ct=1,Object.defineProperty(Me,"__esModule",{value:!0}),Me.DEFAULT_HEADERS=void 0;const s=Ts();return Me.DEFAULT_HEADERS={"X-Client-Info":`postgrest-js/${s.version}`},Me}var It;function xs(){if(It)return fe;It=1;var s=fe&&fe.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(fe,"__esModule",{value:!0});const e=s(Zt()),t=s(ft()),n=Ds();class i{constructor(r,{headers:a={},schema:l,fetch:c}={}){this.url=r,this.headers=Object.assign(Object.assign({},n.DEFAULT_HEADERS),a),this.schemaName=l,this.fetch=c}from(r){const a=new URL(`${this.url}/${r}`);return new e.default(a,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(r){return new i(this.url,{headers:this.headers,schema:r,fetch:this.fetch})}rpc(r,a={},{head:l=!1,get:c=!1,count:d}={}){let u;const h=new URL(`${this.url}/rpc/${r}`);let m;l||c?(u=l?"HEAD":"GET",Object.entries(a).filter(([v,g])=>g!==void 0).map(([v,g])=>[v,Array.isArray(g)?`{${g.join(",")}}`:`${g}`]).forEach(([v,g])=>{h.searchParams.append(v,g)})):(u="POST",m=a);const f=Object.assign({},this.headers);return d&&(f.Prefer=`count=${d}`),new t.default({method:u,url:h,headers:f,schema:this.schemaName,body:m,fetch:this.fetch,allowEmpty:!1})}}return fe.default=i,fe}var Mt;function Cs(){if(Mt)return F;Mt=1;var s=F&&F.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(F,"__esModule",{value:!0}),F.PostgrestError=F.PostgrestBuilder=F.PostgrestTransformBuilder=F.PostgrestFilterBuilder=F.PostgrestQueryBuilder=F.PostgrestClient=void 0;const e=s(xs());F.PostgrestClient=e.default;const t=s(Zt());F.PostgrestQueryBuilder=t.default;const n=s(ft());F.PostgrestFilterBuilder=n.default;const i=s(Xt());F.PostgrestTransformBuilder=i.default;const o=s(Qt());F.PostgrestBuilder=o.default;const r=s(Jt());return F.PostgrestError=r.default,F.default={PostgrestClient:e.default,PostgrestQueryBuilder:t.default,PostgrestFilterBuilder:n.default,PostgrestTransformBuilder:i.default,PostgrestBuilder:o.default,PostgrestError:r.default},F}var Is=Cs();const Ms=vs(Is),{PostgrestClient:Bs,PostgrestQueryBuilder:_i,PostgrestFilterBuilder:ki,PostgrestTransformBuilder:Ei,PostgrestBuilder:Ti,PostgrestError:Di}=Ms;class $s{static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"&&process.versions&&process.versions.node){const t=parseInt(process.versions.node.split(".")[0]);return t>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${t} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${t} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const n=this.getWebSocketConstructor();return new n(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const Ps="2.15.1",Ls=`realtime-js/${Ps}`,As="1.0.0",st=1e4,Os=1e3,js=100;var Le;(function(s){s[s.connecting=0]="connecting",s[s.open=1]="open",s[s.closing=2]="closing",s[s.closed=3]="closed"})(Le||(Le={}));var H;(function(s){s.closed="closed",s.errored="errored",s.joined="joined",s.joining="joining",s.leaving="leaving"})(H||(H={}));var G;(function(s){s.close="phx_close",s.error="phx_error",s.join="phx_join",s.reply="phx_reply",s.leave="phx_leave",s.access_token="access_token"})(G||(G={}));var nt;(function(s){s.websocket="websocket"})(nt||(nt={}));var de;(function(s){s.Connecting="connecting",s.Open="open",s.Closing="closing",s.Closed="closed"})(de||(de={}));class Rs{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),n=new TextDecoder;return this._decodeBroadcast(e,t,n)}_decodeBroadcast(e,t,n){const i=t.getUint8(1),o=t.getUint8(2);let r=this.HEADER_LENGTH+2;const a=n.decode(e.slice(r,r+i));r=r+i;const l=n.decode(e.slice(r,r+o));r=r+o;const c=JSON.parse(n.decode(e.slice(r,e.byteLength)));return{ref:null,topic:a,event:l,payload:c}}}class es{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var O;(function(s){s.abstime="abstime",s.bool="bool",s.date="date",s.daterange="daterange",s.float4="float4",s.float8="float8",s.int2="int2",s.int4="int4",s.int4range="int4range",s.int8="int8",s.int8range="int8range",s.json="json",s.jsonb="jsonb",s.money="money",s.numeric="numeric",s.oid="oid",s.reltime="reltime",s.text="text",s.time="time",s.timestamp="timestamp",s.timestamptz="timestamptz",s.timetz="timetz",s.tsrange="tsrange",s.tstzrange="tstzrange"})(O||(O={}));const Bt=(s,e,t={})=>{var n;const i=(n=t.skipTypes)!==null&&n!==void 0?n:[];return Object.keys(e).reduce((o,r)=>(o[r]=Hs(r,s,e,i),o),{})},Hs=(s,e,t,n)=>{const i=e.find(a=>a.name===s),o=i?.type,r=t[s];return o&&!n.includes(o)?ts(o,r):it(r)},ts=(s,e)=>{if(s.charAt(0)==="_"){const t=s.slice(1,s.length);return Ws(e,t)}switch(s){case O.bool:return Ns(e);case O.float4:case O.float8:case O.int2:case O.int4:case O.int8:case O.numeric:case O.oid:return Fs(e);case O.json:case O.jsonb:return Us(e);case O.timestamp:return qs(e);case O.abstime:case O.date:case O.daterange:case O.int4range:case O.int8range:case O.money:case O.reltime:case O.text:case O.time:case O.timestamptz:case O.timetz:case O.tsrange:case O.tstzrange:return it(e);default:return it(e)}},it=s=>s,Ns=s=>{switch(s){case"t":return!0;case"f":return!1;default:return s}},Fs=s=>{if(typeof s=="string"){const e=parseFloat(s);if(!Number.isNaN(e))return e}return s},Us=s=>{if(typeof s=="string")try{return JSON.parse(s)}catch(e){return console.log(`JSON parse error: ${e}`),s}return s},Ws=(s,e)=>{if(typeof s!="string")return s;const t=s.length-1,n=s[t];if(s[0]==="{"&&n==="}"){let o;const r=s.slice(1,t);try{o=JSON.parse("["+r+"]")}catch{o=r?r.split(","):[]}return o.map(a=>ts(e,a))}return s},qs=s=>typeof s=="string"?s.replace(" ","T"):s,ss=s=>{let e=s;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")+"/api/broadcast"};class Ye{constructor(e,t,n={},i=st){this.channel=e,this.event=t,this.payload=n,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var n;return this._hasReceived(e)&&t((n=this.receivedResp)===null||n===void 0?void 0:n.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var $t;(function(s){s.SYNC="sync",s.JOIN="join",s.LEAVE="leave"})($t||($t={}));class Ae{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const n=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(n.state,{},i=>{const{onJoin:o,onLeave:r,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Ae.syncState(this.state,i,o,r),this.pendingDiffs.forEach(l=>{this.state=Ae.syncDiff(this.state,l,o,r)}),this.pendingDiffs=[],a()}),this.channel._on(n.diff,{},i=>{const{onJoin:o,onLeave:r,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(i):(this.state=Ae.syncDiff(this.state,i,o,r),a())}),this.onJoin((i,o,r)=>{this.channel._trigger("presence",{event:"join",key:i,currentPresences:o,newPresences:r})}),this.onLeave((i,o,r)=>{this.channel._trigger("presence",{event:"leave",key:i,currentPresences:o,leftPresences:r})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,n,i){const o=this.cloneDeep(e),r=this.transformState(t),a={},l={};return this.map(o,(c,d)=>{r[c]||(l[c]=d)}),this.map(r,(c,d)=>{const u=o[c];if(u){const h=d.map(g=>g.presence_ref),m=u.map(g=>g.presence_ref),f=d.filter(g=>m.indexOf(g.presence_ref)<0),v=u.filter(g=>h.indexOf(g.presence_ref)<0);f.length>0&&(a[c]=f),v.length>0&&(l[c]=v)}else a[c]=d}),this.syncDiff(o,{joins:a,leaves:l},n,i)}static syncDiff(e,t,n,i){const{joins:o,leaves:r}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return n||(n=()=>{}),i||(i=()=>{}),this.map(o,(a,l)=>{var c;const d=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),d.length>0){const u=e[a].map(m=>m.presence_ref),h=d.filter(m=>u.indexOf(m.presence_ref)<0);e[a].unshift(...h)}n(a,d,l)}),this.map(r,(a,l)=>{let c=e[a];if(!c)return;const d=l.map(u=>u.presence_ref);c=c.filter(u=>d.indexOf(u.presence_ref)<0),e[a]=c,i(a,c,l),c.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(n=>t(n,e[n]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,n)=>{const i=e[n];return"metas"in i?t[n]=i.metas.map(o=>(o.presence_ref=o.phx_ref,delete o.phx_ref,delete o.phx_ref_prev,o)):t[n]=i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Pt;(function(s){s.ALL="*",s.INSERT="INSERT",s.UPDATE="UPDATE",s.DELETE="DELETE"})(Pt||(Pt={}));var Oe;(function(s){s.BROADCAST="broadcast",s.PRESENCE="presence",s.POSTGRES_CHANGES="postgres_changes",s.SYSTEM="system"})(Oe||(Oe={}));var Z;(function(s){s.SUBSCRIBED="SUBSCRIBED",s.TIMED_OUT="TIMED_OUT",s.CLOSED="CLOSED",s.CHANNEL_ERROR="CHANNEL_ERROR"})(Z||(Z={}));class mt{constructor(e,t={config:{}},n){this.topic=e,this.params=t,this.socket=n,this.bindings={},this.state=H.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Ye(this,G.join,this.params,this.timeout),this.rejoinTimer=new es(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=H.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=H.closed,this.socket._remove(this)}),this._onError(i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=H.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=H.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=H.errored,this.rejoinTimer.scheduleTimeout())}),this._on(G.reply,{},(i,o)=>{this._trigger(this._replyEventName(o),i)}),this.presence=new Ae(this),this.broadcastEndpointURL=ss(this.socket.endPoint),this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var n,i;if(this.socket.isConnected()||this.socket.connect(),this.state==H.closed){const{config:{broadcast:o,presence:r,private:a}}=this.params,l=(i=(n=this.bindings.postgres_changes)===null||n===void 0?void 0:n.map(h=>h.filter))!==null&&i!==void 0?i:[],c=!!this.bindings[Oe.PRESENCE]&&this.bindings[Oe.PRESENCE].length>0,d={},u={broadcast:o,presence:Object.assign(Object.assign({},r),{enabled:c}),postgres_changes:l,private:a};this.socket.accessTokenValue&&(d.access_token=this.socket.accessTokenValue),this._onError(h=>e?.(Z.CHANNEL_ERROR,h)),this._onClose(()=>e?.(Z.CLOSED)),this.updateJoinPayload(Object.assign({config:u},d)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:h})=>{var m;if(this.socket.setAuth(),h===void 0){e?.(Z.SUBSCRIBED);return}else{const f=this.bindings.postgres_changes,v=(m=f?.length)!==null&&m!==void 0?m:0,g=[];for(let S=0;S<v;S++){const b=f[S],{filter:{event:p,schema:y,table:_,filter:k}}=b,w=h&&h[S];if(w&&w.event===p&&w.schema===y&&w.table===_&&w.filter===k)g.push(Object.assign(Object.assign({},b),{id:w.id}));else{this.unsubscribe(),this.state=H.errored,e?.(Z.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=g,e&&e(Z.SUBSCRIBED);return}}).receive("error",h=>{this.state=H.errored,e?.(Z.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(h).join(", ")||"error")))}).receive("timeout",()=>{e?.(Z.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,n){return this.state===H.joined&&e===Oe.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,n)}async send(e,t={}){var n,i;if(!this._canPush()&&e.type==="broadcast"){const{event:o,payload:r}=e,l={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:o,payload:r,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(n=t.timeout)!==null&&n!==void 0?n:this.timeout);return await((i=c.body)===null||i===void 0?void 0:i.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(o=>{var r,a,l;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(r=this.params)===null||r===void 0?void 0:r.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&o("ok"),c.receive("ok",()=>o("ok")),c.receive("error",()=>o("error")),c.receive("timeout",()=>o("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=H.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(G.close,"leave",this._joinRef())};this.joinPush.destroy();let n=null;return new Promise(i=>{n=new Ye(this,G.leave,{},e),n.receive("ok",()=>{t(),i("ok")}).receive("timeout",()=>{t(),i("timed out")}).receive("error",()=>{i("error")}),n.send(),this._canPush()||n.trigger("ok",{})}).finally(()=>{n?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=H.closed,this.bindings={}}async _fetchWithTimeout(e,t,n){const i=new AbortController,o=setTimeout(()=>i.abort(),n),r=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(o),r}_push(e,t,n=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new Ye(this,e,t,n);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>js){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,n){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,n){var i,o;const r=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:d}=G;if(n&&[a,l,c,d].indexOf(r)>=0&&n!==this._joinRef())return;let h=this._onMessage(r,t,n);if(t&&!h)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(r)?(i=this.bindings.postgres_changes)===null||i===void 0||i.filter(m=>{var f,v,g;return((f=m.filter)===null||f===void 0?void 0:f.event)==="*"||((g=(v=m.filter)===null||v===void 0?void 0:v.event)===null||g===void 0?void 0:g.toLocaleLowerCase())===r}).map(m=>m.callback(h,n)):(o=this.bindings[r])===null||o===void 0||o.filter(m=>{var f,v,g,S,b,p;if(["broadcast","presence","postgres_changes"].includes(r))if("id"in m){const y=m.id,_=(f=m.filter)===null||f===void 0?void 0:f.event;return y&&((v=t.ids)===null||v===void 0?void 0:v.includes(y))&&(_==="*"||_?.toLocaleLowerCase()===((g=t.data)===null||g===void 0?void 0:g.type.toLocaleLowerCase()))}else{const y=(b=(S=m?.filter)===null||S===void 0?void 0:S.event)===null||b===void 0?void 0:b.toLocaleLowerCase();return y==="*"||y===((p=t?.event)===null||p===void 0?void 0:p.toLocaleLowerCase())}else return m.type.toLocaleLowerCase()===r}).map(m=>{if(typeof h=="object"&&"ids"in h){const f=h.data,{schema:v,table:g,commit_timestamp:S,type:b,errors:p}=f;h=Object.assign(Object.assign({},{schema:v,table:g,commit_timestamp:S,eventType:b,new:{},old:{},errors:p}),this._getPayloadRecords(f))}m.callback(h,n)})}_isClosed(){return this.state===H.closed}_isJoined(){return this.state===H.joined}_isJoining(){return this.state===H.joining}_isLeaving(){return this.state===H.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,n){const i=e.toLocaleLowerCase(),o={type:i,filter:t,callback:n};return this.bindings[i]?this.bindings[i].push(o):this.bindings[i]=[o],this}_off(e,t){const n=e.toLocaleLowerCase();return this.bindings[n]&&(this.bindings[n]=this.bindings[n].filter(i=>{var o;return!(((o=i.type)===null||o===void 0?void 0:o.toLocaleLowerCase())===n&&mt.isEqual(i.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(G.close,{},e)}_onError(e){this._on(G.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=H.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=Bt(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=Bt(e.columns,e.old_record)),t}}const Lt=()=>{},Fe={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Vs=[1e3,2e3,5e3,1e4],Gs=1e4,Ks=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Ys{constructor(e,t){var n;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=st,this.transport=null,this.heartbeatIntervalMs=Fe.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Lt,this.ref=0,this.reconnectTimer=null,this.logger=Lt,this.conn=null,this.sendBuffer=[],this.serializer=new Rs,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=i=>{let o;return i?o=i:typeof fetch>"u"?o=(...r)=>z(async()=>{const{default:a}=await Promise.resolve().then(()=>xe);return{default:a}},void 0).then(({default:a})=>a(...r)).catch(a=>{throw new Error(`Failed to load @supabase/node-fetch: ${a.message}. This is required for HTTP requests in Node.js environments without native fetch.`)}):o=fetch,(...r)=>o(...r)},!(!((n=t?.params)===null||n===void 0)&&n.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${nt.websocket}`,this.httpEndpoint=ss(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=$s.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:As}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const n=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(n),this._setConnectionState("disconnected")},e?this.conn.close(e,t??""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,n){this.logger(e,t,n)}connectionState(){switch(this.conn&&this.conn.readyState){case Le.connecting:return de.Connecting;case Le.open:return de.Open;case Le.closing:return de.Closing;default:return de.Closed}}isConnected(){return this.connectionState()===de.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const n=`realtime:${e}`,i=this.getChannels().find(o=>o.topic===n);if(i)return i;{const o=new mt(`realtime:${e}`,t,this);return this.channels.push(o),o}}push(e){const{topic:t,event:n,payload:i,ref:o}=e,r=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${n} (${o})`,i),this.isConnected()?r():this.sendBuffer.push(r)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var e;if(!this.isConnected()){this.heartbeatCallback("disconnected");return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.heartbeatCallback("timeout"),this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Os,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},Fe.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatCallback("sent"),this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(n=>n.topic===e&&(n._isJoined()||n._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{t.topic==="phoenix"&&t.event==="phx_reply"&&this.heartbeatCallback(t.payload.status==="ok"?"ok":"error"),t.ref&&t.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:n,event:i,payload:o,ref:r}=t,a=r?`(${r})`:"",l=o.status||"";this.log("receive",`${l} ${n} ${i} ${a}`.trim(),o),this.channels.filter(c=>c._isMember(n)).forEach(c=>c._trigger(i,o,r)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(G.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const n=e.match(/\?/)?"&":"?",i=new URLSearchParams(t);return`${e}${n}${i}`}_workerObjectUrl(e){let t;if(e)t=e;else{const n=new Blob([Ks],{type:"application/javascript"});t=URL.createObjectURL(n)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t;e?t=e:this.accessToken?t=await this.accessToken():t=this.accessTokenValue,this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(n=>{const i={access_token:t,version:Ls};t&&n.updateJoinPayload(i),n.joinedOnce&&n._isJoined()&&n._push(G.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(n=>{try{n(t)}catch(i){this.log("error",`error in ${e} callback`,i)}})}catch(n){this.log("error",`error triggering ${e} callbacks`,n)}}_setupReconnectionTimer(){this.reconnectTimer=new es(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Fe.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,n,i,o,r,a,l,c;if(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(n=e?.timeout)!==null&&n!==void 0?n:st,this.heartbeatIntervalMs=(i=e?.heartbeatIntervalMs)!==null&&i!==void 0?i:Fe.HEARTBEAT_INTERVAL,this.worker=(o=e?.worker)!==null&&o!==void 0?o:!1,this.accessToken=(r=e?.accessToken)!==null&&r!==void 0?r:null,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(a=e?.reconnectAfterMs)!==null&&a!==void 0?a:(d=>Vs[d-1]||Gs),this.encode=(l=e?.encode)!==null&&l!==void 0?l:((d,u)=>u(JSON.stringify(d))),this.decode=(c=e?.decode)!==null&&c!==void 0?c:this.serializer.decode.bind(this.serializer),this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}}class gt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function N(s){return typeof s=="object"&&s!==null&&"__isStorageError"in s}class zs extends gt{constructor(e,t,n){super(e),this.name="StorageApiError",this.status=t,this.statusCode=n}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class ot extends gt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var Js=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};const ns=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>z(async()=>{const{default:n}=await Promise.resolve().then(()=>xe);return{default:n}},void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)},Qs=()=>Js(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield z(()=>Promise.resolve().then(()=>xe),void 0)).Response:Response}),rt=s=>{if(Array.isArray(s))return s.map(t=>rt(t));if(typeof s=="function"||s!==Object(s))return s;const e={};return Object.entries(s).forEach(([t,n])=>{const i=t.replace(/([-_][a-z])/gi,o=>o.toUpperCase().replace(/[-_]/g,""));e[i]=rt(n)}),e},Xs=s=>{if(typeof s!="object"||s===null)return!1;const e=Object.getPrototypeOf(s);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in s)&&!(Symbol.iterator in s)};var ue=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};const ze=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),Zs=(s,e,t)=>ue(void 0,void 0,void 0,function*(){const n=yield Qs();s instanceof n&&!t?.noResolveJson?s.json().then(i=>{const o=s.status||500,r=i?.statusCode||o+"";e(new zs(ze(i),o,r))}).catch(i=>{e(new ot(ze(i),i))}):e(new ot(ze(s),s))}),en=(s,e,t,n)=>{const i={method:s,headers:e?.headers||{}};return s==="GET"||!n?i:(Xs(n)?(i.headers=Object.assign({"Content-Type":"application/json"},e?.headers),i.body=JSON.stringify(n)):i.body=n,e?.duplex&&(i.duplex=e.duplex),Object.assign(Object.assign({},i),t))};function Re(s,e,t,n,i,o){return ue(this,void 0,void 0,function*(){return new Promise((r,a)=>{s(t,en(e,n,i,o)).then(l=>{if(!l.ok)throw l;return n?.noResolveJson?l:l.json()}).then(l=>r(l)).catch(l=>Zs(l,a,n))})})}function Ve(s,e,t,n){return ue(this,void 0,void 0,function*(){return Re(s,"GET",e,t,n)})}function Y(s,e,t,n,i){return ue(this,void 0,void 0,function*(){return Re(s,"POST",e,n,i,t)})}function at(s,e,t,n,i){return ue(this,void 0,void 0,function*(){return Re(s,"PUT",e,n,i,t)})}function tn(s,e,t,n){return ue(this,void 0,void 0,function*(){return Re(s,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),n)})}function is(s,e,t,n,i){return ue(this,void 0,void 0,function*(){return Re(s,"DELETE",e,n,i,t)})}var U=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};const sn={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},At={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class nn{constructor(e,t={},n,i){this.url=e,this.headers=t,this.bucketId=n,this.fetch=ns(i)}uploadOrUpdate(e,t,n,i){return U(this,void 0,void 0,function*(){try{let o;const r=Object.assign(Object.assign({},At),i);let a=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(r.upsert)});const l=r.metadata;typeof Blob<"u"&&n instanceof Blob?(o=new FormData,o.append("cacheControl",r.cacheControl),l&&o.append("metadata",this.encodeMetadata(l)),o.append("",n)):typeof FormData<"u"&&n instanceof FormData?(o=n,o.append("cacheControl",r.cacheControl),l&&o.append("metadata",this.encodeMetadata(l))):(o=n,a["cache-control"]=`max-age=${r.cacheControl}`,a["content-type"]=r.contentType,l&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(l)))),i?.headers&&(a=Object.assign(Object.assign({},a),i.headers));const c=this._removeEmptyFolders(t),d=this._getFinalPath(c),u=yield(e=="PUT"?at:Y)(this.fetch,`${this.url}/object/${d}`,o,Object.assign({headers:a},r?.duplex?{duplex:r.duplex}:{}));return{data:{path:c,id:u.Id,fullPath:u.Key},error:null}}catch(o){if(N(o))return{data:null,error:o};throw o}})}upload(e,t,n){return U(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,n)})}uploadToSignedUrl(e,t,n,i){return U(this,void 0,void 0,function*(){const o=this._removeEmptyFolders(e),r=this._getFinalPath(o),a=new URL(this.url+`/object/upload/sign/${r}`);a.searchParams.set("token",t);try{let l;const c=Object.assign({upsert:At.upsert},i),d=Object.assign(Object.assign({},this.headers),{"x-upsert":String(c.upsert)});typeof Blob<"u"&&n instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",n)):typeof FormData<"u"&&n instanceof FormData?(l=n,l.append("cacheControl",c.cacheControl)):(l=n,d["cache-control"]=`max-age=${c.cacheControl}`,d["content-type"]=c.contentType);const u=yield at(this.fetch,a.toString(),l,{headers:d});return{data:{path:o,fullPath:u.Key},error:null}}catch(l){if(N(l))return{data:null,error:l};throw l}})}createSignedUploadUrl(e,t){return U(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e);const i=Object.assign({},this.headers);t?.upsert&&(i["x-upsert"]="true");const o=yield Y(this.fetch,`${this.url}/object/upload/sign/${n}`,{},{headers:i}),r=new URL(this.url+o.url),a=r.searchParams.get("token");if(!a)throw new gt("No token returned by API");return{data:{signedUrl:r.toString(),path:e,token:a},error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}update(e,t,n){return U(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,n)})}move(e,t,n){return U(this,void 0,void 0,function*(){try{return{data:yield Y(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:n?.destinationBucket},{headers:this.headers}),error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}copy(e,t,n){return U(this,void 0,void 0,function*(){try{return{data:{path:(yield Y(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:n?.destinationBucket},{headers:this.headers})).Key},error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}createSignedUrl(e,t,n){return U(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e),o=yield Y(this.fetch,`${this.url}/object/sign/${i}`,Object.assign({expiresIn:t},n?.transform?{transform:n.transform}:{}),{headers:this.headers});const r=n?.download?`&download=${n.download===!0?"":n.download}`:"";return o={signedUrl:encodeURI(`${this.url}${o.signedURL}${r}`)},{data:o,error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}createSignedUrls(e,t,n){return U(this,void 0,void 0,function*(){try{const i=yield Y(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),o=n?.download?`&download=${n.download===!0?"":n.download}`:"";return{data:i.map(r=>Object.assign(Object.assign({},r),{signedUrl:r.signedURL?encodeURI(`${this.url}${r.signedURL}${o}`):null})),error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}download(e,t){return U(this,void 0,void 0,function*(){const i=typeof t?.transform<"u"?"render/image/authenticated":"object",o=this.transformOptsToQueryString(t?.transform||{}),r=o?`?${o}`:"";try{const a=this._getFinalPath(e);return{data:yield(yield Ve(this.fetch,`${this.url}/${i}/${a}${r}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(a){if(N(a))return{data:null,error:a};throw a}})}info(e){return U(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const n=yield Ve(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:rt(n),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}exists(e){return U(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield tn(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(n){if(N(n)&&n instanceof ot){const i=n.originalError;if([400,404].includes(i?.status))return{data:!1,error:n}}throw n}})}getPublicUrl(e,t){const n=this._getFinalPath(e),i=[],o=t?.download?`download=${t.download===!0?"":t.download}`:"";o!==""&&i.push(o);const a=typeof t?.transform<"u"?"render/image":"object",l=this.transformOptsToQueryString(t?.transform||{});l!==""&&i.push(l);let c=i.join("&");return c!==""&&(c=`?${c}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${n}${c}`)}}}remove(e){return U(this,void 0,void 0,function*(){try{return{data:yield is(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}list(e,t,n){return U(this,void 0,void 0,function*(){try{const i=Object.assign(Object.assign(Object.assign({},sn),t),{prefix:e||""});return{data:yield Y(this.fetch,`${this.url}/object/list/${this.bucketId}`,i,{headers:this.headers},n),error:null}}catch(i){if(N(i))return{data:null,error:i};throw i}})}listV2(e,t){return U(this,void 0,void 0,function*(){try{const n=Object.assign({},e);return{data:yield Y(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,n,{headers:this.headers},t),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const on="2.11.0",rn={"X-Client-Info":`storage-js/${on}`};var we=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};class an{constructor(e,t={},n,i){const o=new URL(e);i?.useNewHostname&&/supabase\.(co|in|red)$/.test(o.hostname)&&!o.hostname.includes("storage.supabase.")&&(o.hostname=o.hostname.replace("supabase.","storage.supabase.")),this.url=o.href,this.headers=Object.assign(Object.assign({},rn),t),this.fetch=ns(n)}listBuckets(){return we(this,void 0,void 0,function*(){try{return{data:yield Ve(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(N(e))return{data:null,error:e};throw e}})}getBucket(e){return we(this,void 0,void 0,function*(){try{return{data:yield Ve(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return we(this,void 0,void 0,function*(){try{return{data:yield Y(this.fetch,`${this.url}/bucket`,{id:e,name:e,type:t.type,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}updateBucket(e,t){return we(this,void 0,void 0,function*(){try{return{data:yield at(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(N(n))return{data:null,error:n};throw n}})}emptyBucket(e){return we(this,void 0,void 0,function*(){try{return{data:yield Y(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}deleteBucket(e){return we(this,void 0,void 0,function*(){try{return{data:yield is(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(N(t))return{data:null,error:t};throw t}})}}class ln extends an{constructor(e,t={},n,i){super(e,t,n,i)}from(e){return new nn(this.url,this.headers,e,this.fetch)}}const cn="2.55.0";let Pe="";typeof Deno<"u"?Pe="deno":typeof document<"u"?Pe="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Pe="react-native":Pe="node";const dn={"X-Client-Info":`supabase-js-${Pe}/${cn}`},un={headers:dn},hn={schema:"public"},pn={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},fn={};var mn=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};const gn=s=>{let e;return s?e=s:typeof fetch>"u"?e=Yt:e=fetch,(...t)=>e(...t)},yn=()=>typeof Headers>"u"?zt:Headers,vn=(s,e,t)=>{const n=gn(t),i=yn();return(o,r)=>mn(void 0,void 0,void 0,function*(){var a;const l=(a=yield e())!==null&&a!==void 0?a:s;let c=new i(r?.headers);return c.has("apikey")||c.set("apikey",s),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),n(o,Object.assign(Object.assign({},r),{headers:c}))})};var wn=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};function bn(s){return s.endsWith("/")?s:s+"/"}function Sn(s,e){var t,n;const{db:i,auth:o,realtime:r,global:a}=s,{db:l,auth:c,realtime:d,global:u}=e,h={db:Object.assign(Object.assign({},l),i),auth:Object.assign(Object.assign({},c),o),realtime:Object.assign(Object.assign({},d),r),storage:{},global:Object.assign(Object.assign(Object.assign({},u),a),{headers:Object.assign(Object.assign({},(t=u?.headers)!==null&&t!==void 0?t:{}),(n=a?.headers)!==null&&n!==void 0?n:{})}),accessToken:()=>wn(this,void 0,void 0,function*(){return""})};return s.accessToken?h.accessToken=s.accessToken:delete h.accessToken,h}const os="2.71.1",Ee=30*1e3,lt=3,Je=lt*Ee,_n="http://localhost:9999",kn="supabase.auth.token",En={"X-Client-Info":`gotrue-js/${os}`},ct="X-Supabase-Api-Version",rs={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Tn=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Dn=600*1e3;class yt extends Error{constructor(e,t,n){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=n}}function B(s){return typeof s=="object"&&s!==null&&"__isAuthError"in s}class xn extends yt{constructor(e,t,n){super(e,t,n),this.name="AuthApiError",this.status=t,this.code=n}}function Cn(s){return B(s)&&s.name==="AuthApiError"}class as extends yt{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class oe extends yt{constructor(e,t,n,i){super(e,n,i),this.name=t,this.status=n}}class ne extends oe{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function In(s){return B(s)&&s.name==="AuthSessionMissingError"}class Ue extends oe{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class We extends oe{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class qe extends oe{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Mn(s){return B(s)&&s.name==="AuthImplicitGrantRedirectError"}class Ot extends oe{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class dt extends oe{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Qe(s){return B(s)&&s.name==="AuthRetryableFetchError"}class jt extends oe{constructor(e,t,n){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=n}}class ut extends oe{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Ge="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Rt=` 	
\r=`.split(""),Bn=(()=>{const s=new Array(128);for(let e=0;e<s.length;e+=1)s[e]=-1;for(let e=0;e<Rt.length;e+=1)s[Rt[e].charCodeAt(0)]=-2;for(let e=0;e<Ge.length;e+=1)s[Ge[e].charCodeAt(0)]=e;return s})();function Ht(s,e,t){if(s!==null)for(e.queue=e.queue<<8|s,e.queuedBits+=8;e.queuedBits>=6;){const n=e.queue>>e.queuedBits-6&63;t(Ge[n]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const n=e.queue>>e.queuedBits-6&63;t(Ge[n]),e.queuedBits-=6}}function ls(s,e,t){const n=Bn[s];if(n>-1)for(e.queue=e.queue<<6|n,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(n===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(s)}"`)}}function Nt(s){const e=[],t=r=>{e.push(String.fromCodePoint(r))},n={utf8seq:0,codepoint:0},i={queue:0,queuedBits:0},o=r=>{Ln(r,n,t)};for(let r=0;r<s.length;r+=1)ls(s.charCodeAt(r),i,o);return e.join("")}function $n(s,e){if(s<=127){e(s);return}else if(s<=2047){e(192|s>>6),e(128|s&63);return}else if(s<=65535){e(224|s>>12),e(128|s>>6&63),e(128|s&63);return}else if(s<=1114111){e(240|s>>18),e(128|s>>12&63),e(128|s>>6&63),e(128|s&63);return}throw new Error(`Unrecognized Unicode codepoint: ${s.toString(16)}`)}function Pn(s,e){for(let t=0;t<s.length;t+=1){let n=s.charCodeAt(t);if(n>55295&&n<=56319){const i=(n-55296)*1024&65535;n=(s.charCodeAt(t+1)-56320&65535|i)+65536,t+=1}$n(n,e)}}function Ln(s,e,t){if(e.utf8seq===0){if(s<=127){t(s);return}for(let n=1;n<6;n+=1)if((s>>7-n&1)===0){e.utf8seq=n;break}if(e.utf8seq===2)e.codepoint=s&31;else if(e.utf8seq===3)e.codepoint=s&15;else if(e.utf8seq===4)e.codepoint=s&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(s<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|s&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function An(s){const e=[],t={queue:0,queuedBits:0},n=i=>{e.push(i)};for(let i=0;i<s.length;i+=1)ls(s.charCodeAt(i),t,n);return new Uint8Array(e)}function On(s){const e=[];return Pn(s,t=>e.push(t)),new Uint8Array(e)}function jn(s){const e=[],t={queue:0,queuedBits:0},n=i=>{e.push(i)};return s.forEach(i=>Ht(i,t,n)),Ht(null,t,n),e.join("")}function Rn(s){return Math.round(Date.now()/1e3)+s}function Hn(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(s){const e=Math.random()*16|0;return(s=="x"?e:e&3|8).toString(16)})}const V=()=>typeof window<"u"&&typeof document<"u",ae={tested:!1,writable:!1},cs=()=>{if(!V())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(ae.tested)return ae.writable;const s=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(s,s),globalThis.localStorage.removeItem(s),ae.tested=!0,ae.writable=!0}catch{ae.tested=!0,ae.writable=!1}return ae.writable};function Nn(s){const e={},t=new URL(s);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((i,o)=>{e[o]=i})}catch{}return t.searchParams.forEach((n,i)=>{e[i]=n}),e}const ds=s=>{let e;return s?e=s:typeof fetch>"u"?e=(...t)=>z(async()=>{const{default:n}=await Promise.resolve().then(()=>xe);return{default:n}},void 0).then(({default:n})=>n(...t)):e=fetch,(...t)=>e(...t)},Fn=s=>typeof s=="object"&&s!==null&&"status"in s&&"ok"in s&&"json"in s&&typeof s.json=="function",Te=async(s,e,t)=>{await s.setItem(e,JSON.stringify(t))},le=async(s,e)=>{const t=await s.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},se=async(s,e)=>{await s.removeItem(e)};class Ke{constructor(){this.promise=new Ke.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Ke.promiseConstructor=Promise;function Xe(s){const e=s.split(".");if(e.length!==3)throw new ut("Invalid JWT structure");for(let n=0;n<e.length;n++)if(!Tn.test(e[n]))throw new ut("JWT not in base64url format");return{header:JSON.parse(Nt(e[0])),payload:JSON.parse(Nt(e[1])),signature:An(e[2]),raw:{header:e[0],payload:e[1]}}}async function Un(s){return await new Promise(e=>{setTimeout(()=>e(null),s)})}function Wn(s,e){return new Promise((n,i)=>{(async()=>{for(let o=0;o<1/0;o++)try{const r=await s(o);if(!e(o,null,r)){n(r);return}}catch(r){if(!e(o,r)){i(r);return}}})()})}function qn(s){return("0"+s.toString(16)).substr(-2)}function Vn(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",n=t.length;let i="";for(let o=0;o<56;o++)i+=t.charAt(Math.floor(Math.random()*n));return i}return crypto.getRandomValues(e),Array.from(e,qn).join("")}async function Gn(s){const t=new TextEncoder().encode(s),n=await crypto.subtle.digest("SHA-256",t),i=new Uint8Array(n);return Array.from(i).map(o=>String.fromCharCode(o)).join("")}async function Kn(s){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),s;const t=await Gn(s);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function be(s,e,t=!1){const n=Vn();let i=n;t&&(i+="/PASSWORD_RECOVERY"),await Te(s,`${e}-code-verifier`,i);const o=await Kn(n);return[o,n===o?"plain":"s256"]}const Yn=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function zn(s){const e=s.headers.get(ct);if(!e||!e.match(Yn))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Jn(s){if(!s)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(s<=e)throw new Error("JWT has expired")}function Qn(s){switch(s){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Xn=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Se(s){if(!Xn.test(s))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Ze(){const s={};return new Proxy(s,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const n=t.toString();if(n==="Symbol(Symbol.toPrimitive)"||n==="Symbol(Symbol.toStringTag)"||n==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Ft(s){return JSON.parse(JSON.stringify(s))}var Zn=function(s,e){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(s);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(s,n[i])&&(t[n[i]]=s[n[i]]);return t};const ce=s=>s.msg||s.message||s.error_description||s.error||JSON.stringify(s),ei=[502,503,504];async function Ut(s){var e;if(!Fn(s))throw new dt(ce(s),0);if(ei.includes(s.status))throw new dt(ce(s),s.status);let t;try{t=await s.json()}catch(o){throw new as(ce(o),o)}let n;const i=zn(s);if(i&&i.getTime()>=rs["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?n=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(n=t.error_code),n){if(n==="weak_password")throw new jt(ce(t),s.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(n==="session_not_found")throw new ne}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((o,r)=>o&&typeof r=="string",!0))throw new jt(ce(t),s.status,t.weak_password.reasons);throw new xn(ce(t),s.status||500,n)}const ti=(s,e,t,n)=>{const i={method:s,headers:e?.headers||{}};return s==="GET"?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),i.body=JSON.stringify(n),Object.assign(Object.assign({},i),t))};async function $(s,e,t,n){var i;const o=Object.assign({},n?.headers);o[ct]||(o[ct]=rs["2024-01-01"].name),n?.jwt&&(o.Authorization=`Bearer ${n.jwt}`);const r=(i=n?.query)!==null&&i!==void 0?i:{};n?.redirectTo&&(r.redirect_to=n.redirectTo);const a=Object.keys(r).length?"?"+new URLSearchParams(r).toString():"",l=await si(s,e,t+a,{headers:o,noResolveJson:n?.noResolveJson},{},n?.body);return n?.xform?n?.xform(l):{data:Object.assign({},l),error:null}}async function si(s,e,t,n,i,o){const r=ti(e,n,i,o);let a;try{a=await s(t,Object.assign({},r))}catch(l){throw console.error(l),new dt(ce(l),0)}if(a.ok||await Ut(a),n?.noResolveJson)return a;try{return await a.json()}catch(l){await Ut(l)}}function X(s){var e;let t=null;ri(s)&&(t=Object.assign({},s),s.expires_at||(t.expires_at=Rn(s.expires_in)));const n=(e=s.user)!==null&&e!==void 0?e:s;return{data:{session:t,user:n},error:null}}function Wt(s){const e=X(s);return!e.error&&s.weak_password&&typeof s.weak_password=="object"&&Array.isArray(s.weak_password.reasons)&&s.weak_password.reasons.length&&s.weak_password.message&&typeof s.weak_password.message=="string"&&s.weak_password.reasons.reduce((t,n)=>t&&typeof n=="string",!0)&&(e.data.weak_password=s.weak_password),e}function ie(s){var e;return{data:{user:(e=s.user)!==null&&e!==void 0?e:s},error:null}}function ni(s){return{data:s,error:null}}function ii(s){const{action_link:e,email_otp:t,hashed_token:n,redirect_to:i,verification_type:o}=s,r=Zn(s,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:n,redirect_to:i,verification_type:o},l=Object.assign({},r);return{data:{properties:a,user:l},error:null}}function oi(s){return s}function ri(s){return s.access_token&&s.refresh_token&&s.expires_in}const et=["global","local","others"];var ai=function(s,e){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&e.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(s);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(s,n[i])&&(t[n[i]]=s[n[i]]);return t};class li{constructor({url:e="",headers:t={},fetch:n}){this.url=e,this.headers=t,this.fetch=ds(n),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t=et[0]){if(et.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${et.join(", ")}`);try{return await $(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(n){if(B(n))return{data:null,error:n};throw n}}async inviteUserByEmail(e,t={}){try{return await $(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:ie})}catch(n){if(B(n))return{data:{user:null},error:n};throw n}}async generateLink(e){try{const{options:t}=e,n=ai(e,["options"]),i=Object.assign(Object.assign({},n),t);return"newEmail"in n&&(i.new_email=n?.newEmail,delete i.newEmail),await $(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:ii,redirectTo:t?.redirectTo})}catch(t){if(B(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await $(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:ie})}catch(t){if(B(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,n,i,o,r,a,l;try{const c={nextPage:null,lastPage:0,total:0},d=await $(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(n=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:"",per_page:(o=(i=e?.perPage)===null||i===void 0?void 0:i.toString())!==null&&o!==void 0?o:""},xform:oi});if(d.error)throw d.error;const u=await d.json(),h=(r=d.headers.get("x-total-count"))!==null&&r!==void 0?r:0,m=(l=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return m.length>0&&(m.forEach(f=>{const v=parseInt(f.split(";")[0].split("=")[1].substring(0,1)),g=JSON.parse(f.split(";")[1].split("=")[1]);c[`${g}Page`]=v}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},u),c),error:null}}catch(c){if(B(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){Se(e);try{return await $(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:ie})}catch(t){if(B(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){Se(e);try{return await $(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:ie})}catch(n){if(B(n))return{data:{user:null},error:n};throw n}}async deleteUser(e,t=!1){Se(e);try{return await $(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:ie})}catch(n){if(B(n))return{data:{user:null},error:n};throw n}}async _listFactors(e){Se(e.userId);try{const{data:t,error:n}=await $(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:i=>({data:{factors:i},error:null})});return{data:t,error:n}}catch(t){if(B(t))return{data:null,error:t};throw t}}async _deleteFactor(e){Se(e.userId),Se(e.id);try{return{data:await $(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(B(t))return{data:null,error:t};throw t}}}function qt(s={}){return{getItem:e=>s[e]||null,setItem:(e,t)=>{s[e]=t},removeItem:e=>{delete s[e]}}}function ci(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const _e={debug:!!(globalThis&&cs()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class us extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class di extends us{}async function ui(s,e,t){_e.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",s,e);const n=new globalThis.AbortController;return e>0&&setTimeout(()=>{n.abort(),_e.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",s)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(s,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:n.signal},async i=>{if(i){_e.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",s,i.name);try{return await t()}finally{_e.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",s,i.name)}}else{if(e===0)throw _e.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",s),new di(`Acquiring an exclusive Navigator LockManager lock "${s}" immediately failed`);if(_e.debug)try{const o=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(o,null,"  "))}catch(o){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",o)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}ci();const hi={url:_n,storageKey:kn,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:En,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function Vt(s,e,t){return await t()}const ke={};class je{constructor(e){var t,n;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=je.nextInstanceID,je.nextInstanceID+=1,this.instanceID>0&&V()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const i=Object.assign(Object.assign({},hi),e);if(this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.persistSession=i.persistSession,this.storageKey=i.storageKey,this.autoRefreshToken=i.autoRefreshToken,this.admin=new li({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=ds(i.fetch),this.lock=i.lock||Vt,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,i.lock?this.lock=i.lock:V()&&(!((t=globalThis?.navigator)===null||t===void 0)&&t.locks)?this.lock=ui:this.lock=Vt,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?(i.storage?this.storage=i.storage:cs()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=qt(this.memoryStorage)),i.userStorage&&(this.userStorage=i.userStorage)):(this.memoryStorage={},this.storage=qt(this.memoryStorage)),V()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(n=this.broadcastChannel)===null||n===void 0||n.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o),await this._notifyAllSubscribers(o.data.event,o.data.session,!1)})}this.initialize()}get jwks(){var e,t;return(t=(e=ke[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){ke[this.storageKey]=Object.assign(Object.assign({},ke[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=ke[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){ke[this.storageKey]=Object.assign(Object.assign({},ke[this.storageKey]),{cachedAt:e})}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${os}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=Nn(window.location.href);let n="none";if(this._isImplicitGrantCallback(t)?n="implicit":await this._isPKCECallback(t)&&(n="pkce"),V()&&this.detectSessionInUrl&&n!=="none"){const{data:i,error:o}=await this._getSessionFromURL(t,n);if(o){if(this._debug("#_initialize()","error detecting session from URL",o),Mn(o)){const l=(e=o.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:o}}return await this._removeSession(),{error:o}}const{session:r,redirectType:a}=i;return this._debug("#_initialize()","detected session in URL",r,"redirect type",a),await this._saveSession(r),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",r):await this._notifyAllSubscribers("SIGNED_IN",r)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return B(t)?{error:t}:{error:new as("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,n,i;try{const o=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(n=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&n!==void 0?n:{},gotrue_meta_security:{captcha_token:(i=e?.options)===null||i===void 0?void 0:i.captchaToken}},xform:X}),{data:r,error:a}=o;if(a||!r)return{data:{user:null,session:null},error:a};const l=r.session,c=r.user;return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(o){if(B(o))return{data:{user:null,session:null},error:o};throw o}}async signUp(e){var t,n,i;try{let o;if("email"in e){const{email:d,password:u,options:h}=e;let m=null,f=null;this.flowType==="pkce"&&([m,f]=await be(this.storage,this.storageKey)),o=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:h?.emailRedirectTo,body:{email:d,password:u,data:(t=h?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:h?.captchaToken},code_challenge:m,code_challenge_method:f},xform:X})}else if("phone"in e){const{phone:d,password:u,options:h}=e;o=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:u,data:(n=h?.data)!==null&&n!==void 0?n:{},channel:(i=h?.channel)!==null&&i!==void 0?i:"sms",gotrue_meta_security:{captcha_token:h?.captchaToken}},xform:X})}else throw new We("You must provide either an email or phone number and a password");const{data:r,error:a}=o;if(a||!r)return{data:{user:null,session:null},error:a};const l=r.session,c=r.user;return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(o){if(B(o))return{data:{user:null,session:null},error:o};throw o}}async signInWithPassword(e){try{let t;if("email"in e){const{email:o,password:r,options:a}=e;t=await $(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:o,password:r,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:Wt})}else if("phone"in e){const{phone:o,password:r,options:a}=e;t=await $(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:o,password:r,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:Wt})}else throw new We("You must provide either an email or phone number and a password");const{data:n,error:i}=t;return i?{data:{user:null,session:null},error:i}:!n||!n.session||!n.user?{data:{user:null,session:null},error:new Ue}:(n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),{data:Object.assign({user:n.user,session:n.session},n.weak_password?{weakPassword:n.weak_password}:null),error:i})}catch(t){if(B(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,n,i,o;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(n=e.options)===null||n===void 0?void 0:n.scopes,queryParams:(i=e.options)===null||i===void 0?void 0:i.queryParams,skipBrowserRedirect:(o=e.options)===null||o===void 0?void 0:o.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;if(t==="solana")return await this.signInWithSolana(e);throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}async signInWithSolana(e){var t,n,i,o,r,a,l,c,d,u,h,m;let f,v;if("message"in e)f=e.message,v=e.signature;else{const{chain:g,wallet:S,statement:b,options:p}=e;let y;if(V())if(typeof S=="object")y=S;else{const k=window;if("solana"in k&&typeof k.solana=="object"&&("signIn"in k.solana&&typeof k.solana.signIn=="function"||"signMessage"in k.solana&&typeof k.solana.signMessage=="function"))y=k.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof S!="object"||!p?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");y=S}const _=new URL((t=p?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in y&&y.signIn){const k=await y.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},p?.signInWithSolana),{version:"1",domain:_.host,uri:_.href}),b?{statement:b}:null));let w;if(Array.isArray(k)&&k[0]&&typeof k[0]=="object")w=k[0];else if(k&&typeof k=="object"&&"signedMessage"in k&&"signature"in k)w=k;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in w&&"signature"in w&&(typeof w.signedMessage=="string"||w.signedMessage instanceof Uint8Array)&&w.signature instanceof Uint8Array)f=typeof w.signedMessage=="string"?w.signedMessage:new TextDecoder().decode(w.signedMessage),v=w.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in y)||typeof y.signMessage!="function"||!("publicKey"in y)||typeof y!="object"||!y.publicKey||!("toBase58"in y.publicKey)||typeof y.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");f=[`${_.host} wants you to sign in with your Solana account:`,y.publicKey.toBase58(),...b?["",b,""]:[""],"Version: 1",`URI: ${_.href}`,`Issued At: ${(i=(n=p?.signInWithSolana)===null||n===void 0?void 0:n.issuedAt)!==null&&i!==void 0?i:new Date().toISOString()}`,...!((o=p?.signInWithSolana)===null||o===void 0)&&o.notBefore?[`Not Before: ${p.signInWithSolana.notBefore}`]:[],...!((r=p?.signInWithSolana)===null||r===void 0)&&r.expirationTime?[`Expiration Time: ${p.signInWithSolana.expirationTime}`]:[],...!((a=p?.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${p.signInWithSolana.chainId}`]:[],...!((l=p?.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${p.signInWithSolana.nonce}`]:[],...!((c=p?.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${p.signInWithSolana.requestId}`]:[],...!((u=(d=p?.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||u===void 0)&&u.length?["Resources",...p.signInWithSolana.resources.map(w=>`- ${w}`)]:[]].join(`
`);const k=await y.signMessage(new TextEncoder().encode(f),"utf8");if(!k||!(k instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");v=k}}try{const{data:g,error:S}=await $(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:f,signature:jn(v)},!((h=e.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(m=e.options)===null||m===void 0?void 0:m.captchaToken}}:null),xform:X});if(S)throw S;return!g||!g.session||!g.user?{data:{user:null,session:null},error:new Ue}:(g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),{data:Object.assign({},g),error:S})}catch(g){if(B(g))return{data:{user:null,session:null},error:g};throw g}}async _exchangeCodeForSession(e){const t=await le(this.storage,`${this.storageKey}-code-verifier`),[n,i]=(t??"").split("/");try{const{data:o,error:r}=await $(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:n},xform:X});if(await se(this.storage,`${this.storageKey}-code-verifier`),r)throw r;return!o||!o.session||!o.user?{data:{user:null,session:null,redirectType:null},error:new Ue}:(o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",o.session)),{data:Object.assign(Object.assign({},o),{redirectType:i??null}),error:r})}catch(o){if(B(o))return{data:{user:null,session:null,redirectType:null},error:o};throw o}}async signInWithIdToken(e){try{const{options:t,provider:n,token:i,access_token:o,nonce:r}=e,a=await $(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:n,id_token:i,access_token:o,nonce:r,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:X}),{data:l,error:c}=a;return c?{data:{user:null,session:null},error:c}:!l||!l.session||!l.user?{data:{user:null,session:null},error:new Ue}:(l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),{data:l,error:c})}catch(t){if(B(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,n,i,o,r;try{if("email"in e){const{email:a,options:l}=e;let c=null,d=null;this.flowType==="pkce"&&([c,d]=await be(this.storage,this.storageKey));const{error:u}=await $(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l?.data)!==null&&t!==void 0?t:{},create_user:(n=l?.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},code_challenge:c,code_challenge_method:d},redirectTo:l?.emailRedirectTo});return{data:{user:null,session:null},error:u}}if("phone"in e){const{phone:a,options:l}=e,{data:c,error:d}=await $(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(i=l?.data)!==null&&i!==void 0?i:{},create_user:(o=l?.shouldCreateUser)!==null&&o!==void 0?o:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},channel:(r=l?.channel)!==null&&r!==void 0?r:"sms"}});return{data:{user:null,session:null,messageId:c?.message_id},error:d}}throw new We("You must provide either an email or phone number.")}catch(a){if(B(a))return{data:{user:null,session:null},error:a};throw a}}async verifyOtp(e){var t,n;try{let i,o;"options"in e&&(i=(t=e.options)===null||t===void 0?void 0:t.redirectTo,o=(n=e.options)===null||n===void 0?void 0:n.captchaToken);const{data:r,error:a}=await $(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:o}}),redirectTo:i,xform:X});if(a)throw a;if(!r)throw new Error("An error occurred on token verification.");const l=r.session,c=r.user;return l?.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),{data:{user:c,session:l},error:null}}catch(i){if(B(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithSSO(e){var t,n,i;try{let o=null,r=null;return this.flowType==="pkce"&&([o,r]=await be(this.storage,this.storageKey)),await $(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&n!==void 0?n:void 0}),!((i=e?.options)===null||i===void 0)&&i.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:r}),headers:this.headers,xform:ni})}catch(o){if(B(o))return{data:null,error:o};throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:n}=e;if(n)throw n;if(!t)throw new ne;const{error:i}=await $(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:i}})}catch(e){if(B(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:n,type:i,options:o}=e,{error:r}=await $(this.fetch,"POST",t,{headers:this.headers,body:{email:n,type:i,gotrue_meta_security:{captcha_token:o?.captchaToken}},redirectTo:o?.emailRedirectTo});return{data:{user:null,session:null},error:r}}else if("phone"in e){const{phone:n,type:i,options:o}=e,{data:r,error:a}=await $(this.fetch,"POST",t,{headers:this.headers,body:{phone:n,type:i,gotrue_meta_security:{captcha_token:o?.captchaToken}}});return{data:{user:null,session:null,messageId:r?.message_id},error:a}}throw new We("You must provide either an email or phone number and a type")}catch(t){if(B(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const n=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),i=(async()=>(await n,await t()))();return this.pendingInLock.push((async()=>{try{await i}catch{}})()),i}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const n=t();for(this.pendingInLock.push((async()=>{try{await n}catch{}})()),await n;this.pendingInLock.length;){const i=[...this.pendingInLock];await Promise.all(i),this.pendingInLock.splice(0,i.length)}return await n}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await le(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const n=e.expires_at?e.expires_at*1e3-Date.now()<Je:!1;if(this._debug("#__loadSession()",`session has${n?"":" not"} expired`,"expires_at",e.expires_at),!n){if(this.userStorage){const r=await le(this.userStorage,this.storageKey+"-user");r?.user?e.user=r.user:e.user=Ze()}if(this.storage.isServer&&e.user){let r=this.suppressGetSessionWarning;e=new Proxy(e,{get:(l,c,d)=>(!r&&c==="user"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),r=!0,this.suppressGetSessionWarning=!0),Reflect.get(l,c,d))})}return{data:{session:e},error:null}}const{session:i,error:o}=await this._callRefreshToken(e.refresh_token);return o?{data:{session:null},error:o}:{data:{session:i},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await $(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:ie}):await this._useSession(async t=>{var n,i,o;const{data:r,error:a}=t;if(a)throw a;return!(!((n=r.session)===null||n===void 0)&&n.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new ne}:await $(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(o=(i=r.session)===null||i===void 0?void 0:i.access_token)!==null&&o!==void 0?o:void 0,xform:ie})})}catch(t){if(B(t))return In(t)&&(await this._removeSession(),await se(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async n=>{const{data:i,error:o}=n;if(o)throw o;if(!i.session)throw new ne;const r=i.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await be(this.storage,this.storageKey));const{data:c,error:d}=await $(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:r.access_token,xform:ie});if(d)throw d;return r.user=c.user,await this._saveSession(r),await this._notifyAllSubscribers("USER_UPDATED",r),{data:{user:r.user},error:null}})}catch(n){if(B(n))return{data:{user:null},error:n};throw n}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new ne;const t=Date.now()/1e3;let n=t,i=!0,o=null;const{payload:r}=Xe(e.access_token);if(r.exp&&(n=r.exp,i=n<=t),i){const{session:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return{data:{user:null,session:null},error:l};if(!a)return{data:{user:null,session:null},error:null};o=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;o={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:n-t,expires_at:n},await this._saveSession(o),await this._notifyAllSubscribers("SIGNED_IN",o)}return{data:{user:o.user,session:o},error:null}}catch(t){if(B(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var n;if(!e){const{data:r,error:a}=t;if(a)throw a;e=(n=r.session)!==null&&n!==void 0?n:void 0}if(!e?.refresh_token)throw new ne;const{session:i,error:o}=await this._callRefreshToken(e.refresh_token);return o?{data:{user:null,session:null},error:o}:i?{data:{user:i.user,session:i},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(B(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!V())throw new qe("No browser detected.");if(e.error||e.error_description||e.error_code)throw new qe(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Ot("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new qe("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Ot("No code detected.");const{data:b,error:p}=await this._exchangeCodeForSession(e.code);if(p)throw p;const y=new URL(window.location.href);return y.searchParams.delete("code"),window.history.replaceState(window.history.state,"",y.toString()),{data:{session:b.session,redirectType:null},error:null}}const{provider_token:n,provider_refresh_token:i,access_token:o,refresh_token:r,expires_in:a,expires_at:l,token_type:c}=e;if(!o||!a||!r||!c)throw new qe("No session defined in URL");const d=Math.round(Date.now()/1e3),u=parseInt(a);let h=d+u;l&&(h=parseInt(l));const m=h-d;m*1e3<=Ee&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${m}s, should have been closer to ${u}s`);const f=h-u;d-f>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",f,h,d):d-f<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",f,h,d);const{data:v,error:g}=await this._getUser(o);if(g)throw g;const S={provider_token:n,provider_refresh_token:i,access_token:o,expires_in:u,expires_at:h,refresh_token:r,token_type:c,user:v.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:S,redirectType:e.type},error:null}}catch(n){if(B(n))return{data:{session:null,redirectType:null},error:n};throw n}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await le(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var n;const{data:i,error:o}=t;if(o)return{error:o};const r=(n=i.session)===null||n===void 0?void 0:n.access_token;if(r){const{error:a}=await this.admin.signOut(r,e);if(a&&!(Cn(a)&&(a.status===404||a.status===401||a.status===403)))return{error:a}}return e!=="others"&&(await this._removeSession(),await se(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=Hn(),n={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,n),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:n}}}async _emitInitialSession(e){return await this._useSession(async t=>{var n,i;try{const{data:{session:o},error:r}=t;if(r)throw r;await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",o)),this._debug("INITIAL_SESSION","callback id",e,"session",o)}catch(o){await((i=this.stateChangeEmitters.get(e))===null||i===void 0?void 0:i.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",o),console.error(o)}})}async resetPasswordForEmail(e,t={}){let n=null,i=null;this.flowType==="pkce"&&([n,i]=await be(this.storage,this.storageKey,!0));try{return await $(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:n,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(o){if(B(o))return{data:null,error:o};throw o}}async getUserIdentities(){var e;try{const{data:t,error:n}=await this.getUser();if(n)throw n;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(B(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:n,error:i}=await this._useSession(async o=>{var r,a,l,c,d;const{data:u,error:h}=o;if(h)throw h;const m=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(r=e.options)===null||r===void 0?void 0:r.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await $(this.fetch,"GET",m,{headers:this.headers,jwt:(d=(c=u.session)===null||c===void 0?void 0:c.access_token)!==null&&d!==void 0?d:void 0})});if(i)throw i;return V()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(n?.url),{data:{provider:e.provider,url:n?.url},error:null}}catch(n){if(B(n))return{data:{provider:e.provider,url:null},error:n};throw n}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var n,i;const{data:o,error:r}=t;if(r)throw r;return await $(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(i=(n=o.session)===null||n===void 0?void 0:n.access_token)!==null&&i!==void 0?i:void 0})})}catch(t){if(B(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const n=Date.now();return await Wn(async i=>(i>0&&await Un(200*Math.pow(2,i-1)),this._debug(t,"refreshing attempt",i),await $(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:X})),(i,o)=>{const r=200*Math.pow(2,i);return o&&Qe(o)&&Date.now()+r-n<Ee})}catch(n){if(this._debug(t,"error",n),B(n))return{data:{session:null,user:null},error:n};throw n}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const n=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",n),V()&&!t.skipBrowserRedirect&&window.location.assign(n),{data:{provider:e,url:n},error:null}}async _recoverAndRefresh(){var e,t;const n="#_recoverAndRefresh()";this._debug(n,"begin");try{const i=await le(this.storage,this.storageKey);if(i&&this.userStorage){let r=await le(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!r&&(r={user:i.user},await Te(this.userStorage,this.storageKey+"-user",r)),i.user=(e=r?.user)!==null&&e!==void 0?e:Ze()}else if(i&&!i.user&&!i.user){const r=await le(this.storage,this.storageKey+"-user");r&&r?.user?(i.user=r.user,await se(this.storage,this.storageKey+"-user"),await Te(this.storage,this.storageKey,i)):i.user=Ze()}if(this._debug(n,"session from storage",i),!this._isValidSession(i)){this._debug(n,"session is not valid"),i!==null&&await this._removeSession();return}const o=((t=i.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Je;if(this._debug(n,`session has${o?"":" not"} expired with margin of ${Je}s`),o){if(this.autoRefreshToken&&i.refresh_token){const{error:r}=await this._callRefreshToken(i.refresh_token);r&&(console.error(r),Qe(r)||(this._debug(n,"refresh failed with a non-retryable error, removing the session",r),await this._removeSession()))}}else if(i.user&&i.user.__isUserNotAvailableProxy===!0)try{const{data:r,error:a}=await this._getUser(i.access_token);!a&&r?.user?(i.user=r.user,await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)):this._debug(n,"could not get user data, skipping SIGNED_IN notification")}catch(r){console.error("Error getting user data:",r),this._debug(n,"error getting user data, skipping SIGNED_IN notification",r)}else await this._notifyAllSubscribers("SIGNED_IN",i)}catch(i){this._debug(n,"error",i),console.error(i);return}finally{this._debug(n,"end")}}async _callRefreshToken(e){var t,n;if(!e)throw new ne;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new Ke;const{data:o,error:r}=await this._refreshAccessToken(e);if(r)throw r;if(!o.session)throw new ne;await this._saveSession(o.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",o.session);const a={session:o.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(o){if(this._debug(i,"error",o),B(o)){const r={session:null,error:o};return Qe(o)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(r),r}throw(n=this.refreshingDeferred)===null||n===void 0||n.reject(o),o}finally{this.refreshingDeferred=null,this._debug(i,"end")}}async _notifyAllSubscribers(e,t,n=!0){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${n}`);try{this.broadcastChannel&&n&&this.broadcastChannel.postMessage({event:e,session:t});const o=[],r=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){o.push(l)}});if(await Promise.all(r),o.length>0){for(let a=0;a<o.length;a+=1)console.error(o[a]);throw o[0]}}finally{this._debug(i,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),n=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!n&&t.user&&await Te(this.userStorage,this.storageKey+"-user",{user:t.user});const i=Object.assign({},t);delete i.user;const o=Ft(i);await Te(this.storage,this.storageKey,o)}else{const i=Ft(t);await Te(this.storage,this.storageKey,i)}}async _removeSession(){this._debug("#_removeSession()"),await se(this.storage,this.storageKey),await se(this.storage,this.storageKey+"-code-verifier"),await se(this.storage,this.storageKey+"-user"),this.userStorage&&await se(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&V()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Ee);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:n}}=t;if(!n||!n.refresh_token||!n.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const i=Math.floor((n.expires_at*1e3-e)/Ee);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts ${Ee}ms, refresh threshold is ${lt} ticks`),i<=lt&&await this._callRefreshToken(n.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof us)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!V()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,n){const i=[`provider=${encodeURIComponent(t)}`];if(n?.redirectTo&&i.push(`redirect_to=${encodeURIComponent(n.redirectTo)}`),n?.scopes&&i.push(`scopes=${encodeURIComponent(n.scopes)}`),this.flowType==="pkce"){const[o,r]=await be(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(o)}`,code_challenge_method:`${encodeURIComponent(r)}`});i.push(a.toString())}if(n?.queryParams){const o=new URLSearchParams(n.queryParams);i.push(o.toString())}return n?.skipBrowserRedirect&&i.push(`skip_http_redirect=${n.skipBrowserRedirect}`),`${e}?${i.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var n;const{data:i,error:o}=t;return o?{data:null,error:o}:await $(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(n=i?.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(B(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var n,i;const{data:o,error:r}=t;if(r)return{data:null,error:r};const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:l,error:c}=await $(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(n=o?.session)===null||n===void 0?void 0:n.access_token});return c?{data:null,error:c}:(e.factorType==="totp"&&(!((i=l?.totp)===null||i===void 0)&&i.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),{data:l,error:null})})}catch(t){if(B(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var n;const{data:i,error:o}=t;if(o)return{data:null,error:o};const{data:r,error:a}=await $(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(n=i?.session)===null||n===void 0?void 0:n.access_token});return a?{data:null,error:a}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+r.expires_in},r)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",r),{data:r,error:a})})}catch(t){if(B(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var n;const{data:i,error:o}=t;return o?{data:null,error:o}:await $(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(n=i?.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(B(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:n}=await this._challenge({factorId:e.factorId});return n?{data:null,error:n}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const n=e?.factors||[],i=n.filter(r=>r.factor_type==="totp"&&r.status==="verified"),o=n.filter(r=>r.factor_type==="phone"&&r.status==="verified");return{data:{all:n,totp:i,phone:o},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,n;const{data:{session:i},error:o}=e;if(o)return{data:null,error:o};if(!i)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:r}=Xe(i.access_token);let a=null;r.aal&&(a=r.aal);let l=a;((n=(t=i.user.factors)===null||t===void 0?void 0:t.filter(u=>u.status==="verified"))!==null&&n!==void 0?n:[]).length>0&&(l="aal2");const d=r.amr||[];return{data:{currentLevel:a,nextLevel:l,currentAuthenticationMethods:d},error:null}}))}async fetchJwk(e,t={keys:[]}){let n=t.keys.find(a=>a.kid===e);if(n)return n;const i=Date.now();if(n=this.jwks.keys.find(a=>a.kid===e),n&&this.jwks_cached_at+Dn>i)return n;const{data:o,error:r}=await $(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(r)throw r;return!o.keys||o.keys.length===0||(this.jwks=o,this.jwks_cached_at=i,n=o.keys.find(a=>a.kid===e),!n)?null:n}async getClaims(e,t={}){try{let n=e;if(!n){const{data:m,error:f}=await this.getSession();if(f||!m.session)return{data:null,error:f};n=m.session.access_token}const{header:i,payload:o,signature:r,raw:{header:a,payload:l}}=Xe(n);t?.allowExpired||Jn(o.exp);const c=!i.alg||i.alg.startsWith("HS")||!i.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(i.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!c){const{error:m}=await this.getUser(n);if(m)throw m;return{data:{claims:o,header:i,signature:r},error:null}}const d=Qn(i.alg),u=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,u,r,On(`${a}.${l}`)))throw new ut("Invalid JWT signature");return{data:{claims:o,header:i,signature:r},error:null}}catch(n){if(B(n))return{data:null,error:n};throw n}}}je.nextInstanceID=0;const pi=je;class fi extends pi{constructor(e){super(e)}}var mi=function(s,e,t,n){function i(o){return o instanceof t?o:new t(function(r){r(o)})}return new(t||(t=Promise))(function(o,r){function a(d){try{c(n.next(d))}catch(u){r(u)}}function l(d){try{c(n.throw(d))}catch(u){r(u)}}function c(d){d.done?o(d.value):i(d.value).then(a,l)}c((n=n.apply(s,e||[])).next())})};class gi{constructor(e,t,n){var i,o,r;if(this.supabaseUrl=e,this.supabaseKey=t,!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const a=bn(e),l=new URL(a);this.realtimeUrl=new URL("realtime/v1",l),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",l),this.storageUrl=new URL("storage/v1",l),this.functionsUrl=new URL("functions/v1",l);const c=`sb-${l.hostname.split(".")[0]}-auth-token`,d={db:hn,realtime:fn,auth:Object.assign(Object.assign({},pn),{storageKey:c}),global:un},u=Sn(n??{},d);this.storageKey=(i=u.auth.storageKey)!==null&&i!==void 0?i:"",this.headers=(o=u.global.headers)!==null&&o!==void 0?o:{},u.accessToken?(this.accessToken=u.accessToken,this.auth=new Proxy({},{get:(h,m)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(m)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((r=u.auth)!==null&&r!==void 0?r:{},this.headers,u.global.fetch),this.fetch=vn(t,this._getAccessToken.bind(this),u.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},u.realtime)),this.rest=new Bs(new URL("rest/v1",l).href,{headers:this.headers,schema:u.db.schema,fetch:this.fetch}),this.storage=new ln(this.storageUrl.href,this.headers,this.fetch,n?.storage),u.accessToken||this._listenForAuthEvents()}get functions(){return new ys(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},n={}){return this.rest.rpc(e,t,n)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return mi(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:n}=yield this.auth.getSession();return(t=(e=n.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:this.supabaseKey})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:i,storageKey:o,flowType:r,lock:a,debug:l},c,d){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new fi({url:this.authUrl.href,headers:Object.assign(Object.assign({},u),c),storageKey:o,autoRefreshToken:e,persistSession:t,detectSessionInUrl:n,storage:i,flowType:r,lock:a,debug:l,fetch:d,hasCustomAuthorizationHeader:"Authorization"in this.headers})}_initRealtimeClient(e){return new Ys(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,n)=>{this._handleTokenChanged(t,"CLIENT",n?.access_token)})}_handleTokenChanged(e,t,n){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==n?this.changedAccessToken=n:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const yi=(s,e,t)=>new gi(s,e,t);function vi(){if(typeof window<"u"||typeof process>"u")return!1;const s=process.version;if(s==null)return!1;const e=s.match(/^v(\d+)\./);return e?parseInt(e[1],10)<=18:!1}vi()&&console.warn("⚠️  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Gt=yi("https://iuwjdacxbirhmsglcbxp.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1d2pkYWN4YmlyaG1zZ2xjYnhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NTIxNDAsImV4cCI6MjA2NDAyODE0MH0.iSjbvGVpM3zOWCGpg5HrQp37PjJCmiHIwVQLgc2LgcE");let J=null,$e=null;async function Q(){return J||$e||($e=(async()=>{try{const{data:s}=await Gt.auth.getClaims(),e=s&&s.sub;if(e)return J=e,console.debug("[auth] userId (claims):",J),J;const{data:{user:t},error:n}=await Gt.auth.getUser();return n?(console.warn("[auth] getUser() error:",n.message||n),null):(J=t&&t.id?t.id:null,J&&console.debug("[auth] userId (user):",J),J)}catch(s){return console.warn("[auth] getUserId error:",s&&s.message?s.message:s),null}finally{$e=null}})(),$e)}const ee={progressFill:null,progressLabel:null,monthlyGoalInput:null,init(){this.progressFill=document.querySelector(".chart-progress-fill")||document.querySelector(".progress-fill"),this.progressLabel=document.querySelector(".chart-progress-label")||document.querySelector(".progress-label"),this.monthlyGoalInput=document.getElementById("monthlyGoalInput")},refresh(){this.init()}};function vt(){if(typeof window<"u"&&window.app&&window.app.monthlyGoal)return window.app.monthlyGoal;const s=localStorage.getItem("monthlyGoal");return s?parseInt(s,10):2e4}async function hs(s){typeof window<"u"&&window.app&&(window.app.monthlyGoal=s,window.app.saveSettingsToSupabase&&await window.app.saveSettingsToSupabase()),localStorage.setItem("monthlyGoal",s),typeof window<"u"&&window.app&&window.app.updateStats&&window.app.updateStats()}function ht(){const s=ee.monthlyGoalInput||document.getElementById("monthlyGoalInput");s&&(s.value=vt(),s.addEventListener("input",e=>{const t=parseInt(e.target.value,10);!isNaN(t)&&t>0&&hs(t)}))}typeof window<"u"&&(window.pendingConfetti=!1,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ee.init(),ht()}):(ee.init(),ht()));function ps(s,e,t=!1){const n=ee.progressFill||document.querySelector(".chart-progress-fill")||document.querySelector(".progress-fill"),i=ee.progressLabel||document.querySelector(".chart-progress-label")||document.querySelector(".progress-label");if(!n||!i)return;const o=Math.round(s/e*100),r=Math.min(o,100);n.dataset.animating==="true"&&(n.dataset.animating="false"),n.classList.remove("loading"),t?requestAnimationFrame(()=>{n.style.transition="width 0.8s cubic-bezier(0.4, 0, 0.2, 1)",i.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",n.dataset.animating="true",n.style.width=r+"%",Kt(i,o),setTimeout(()=>{n.dataset.animating="false",typeof window<"u"&&window.app&&!window.app.initialAnimationComplete&&(window.app.initialAnimationComplete=!0)},850)}):(n.style.transition="none",i.style.transition="none",n.style.width=r+"%",n.offsetHeight,n.style.transition="width 0.8s cubic-bezier(0.4, 0, 0.2, 1)",i.style.transition="all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",Kt(i,o));const a=n.closest(".progress-card")||n.closest(".chart-progress-bar");o>=100?(n.classList.add("full"),o>100&&a?a.classList.add("overachievement"):a&&a.classList.remove("overachievement")):(n.classList.remove("full"),a&&a.classList.remove("overachievement")),o>0?n.classList.add("active"):n.classList.remove("active");const l=window.app&&window.app.currencyFormat?" NOK":" kr",c=o<10?o.toFixed(1):Math.round(o);i.textContent=`${c}% av ${e.toLocaleString("no-NO")}${l}`,n.title=`${s.toLocaleString("no-NO")}${l} av ${e.toLocaleString("no-NO")}${l}`}function Kt(s,e){s.classList.remove("low-progress","medium-progress","high-progress","overachievement"),e>100?(s.classList.add("overachievement"),s.setAttribute("aria-label",`Mål oppnådd! ${e.toFixed(1)}% av målet`)):e>=75?(s.classList.add("high-progress"),s.setAttribute("aria-label",`Nær målet: ${e.toFixed(1)}% av målet`)):e>=25?(s.classList.add("medium-progress"),s.setAttribute("aria-label",`Fremdrift: ${e.toFixed(1)}% av målet`)):(s.classList.add("low-progress"),s.setAttribute("aria-label",`Tidlig fremdrift: ${e.toFixed(1)}% av målet`)),requestAnimationFrame(()=>{s.offsetHeight,window.getComputedStyle(s).textAlign!=="center"&&(s.style.textAlign="center")})}typeof window<"u"&&(window.updateProgressBar=ps,window.getMonthlyGoal=vt,window.setMonthlyGoal=hs,window.domCache=ee);const xi={PAUSE_THRESHOLD:5.5,PAUSE_DEDUCTION:.5,MONTHS:["januar","februar","mars","april","mai","juni","juli","august","september","oktober","november","desember"],WEEKDAYS:["søndag","mandag","tirsdag","onsdag","torsdag","fredag","lørdag"],PRESET_WAGE_RATES:{"-1":129.91,"-2":132.9,1:184.54,2:185.38,3:187.46,4:193.05,5:210.81,6:256.14},orgSettings:{break_policy:"fixed_0_5_over_5_5h"},PRESET_BONUSES:{weekday:[{from:"18:00",to:"21:00",rate:22},{from:"21:00",to:"23:59",rate:45}],saturday:[{from:"13:00",to:"15:00",rate:45},{from:"15:00",to:"18:00",rate:55},{from:"18:00",to:"23:59",rate:110}],sunday:[{from:"00:00",to:"23:59",rate:115}]},shifts:[],currentMonth:new Date().getMonth()+1,currentYear:new Date().getFullYear(),currentWageLevel:1,usePreset:!0,customWage:200,customBonuses:{},currentView:"dashboard",pauseDeduction:!0,fullMinuteRange:!1,directTimeInput:!1,monthlyGoal:2e4,shiftView:"list",calendarDisplayMode:"money",selectedDate:null,userShifts:[],formState:{},initialAnimationComplete:!1,drillDownMode:!1,selectedWeek:null,taxDeductionEnabled:!1,taxPercentage:0,payrollDay:15,dashboardView:"default",nextShiftTimer:null,lastRenderedMonth:null,lastRenderedYear:null,lastRenderedShiftsKey:"",monthNavigationTimeout:null,employees:[],selectedEmployeeId:null,employeeCache:new Map,employeesLoading:!1,employeesError:null,async getAuthHeaders(){try{const{data:{session:s}}=await window.supa.auth.getSession(),e=s?.access_token;return{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}}catch{return{"Content-Type":"application/json"}}},async init(){try{const i=await this.getAuthHeaders?.(),o=await fetch(`${window.CONFIG.apiBase}/org-settings`,{headers:i});if(o.ok){const r=await o.json();r&&r.break_policy&&(this.orgSettings={break_policy:r.break_policy})}}catch{}this.selectedDates=[],ee.init();const s=ee.progressFill;s&&(s.classList.add("loading"),s.style.width="0%",s.style.transition="none"),this.initializeEmployeeState(),this.loadEmployeesForShiftForms(),this.populateTimeSelects();try{await this.loadFromSupabase()}catch(i){console.error("loadFromSupabase failed:",i),this.loadFromLocalStorage()}const e=localStorage.getItem("dashboardView");e&&(e==="stats"||e==="default")&&(this.dashboardView=e),this.applyDashboardView();const t=document.getElementById("dashboardToggleBtn");if(t){t.classList.toggle("active",this.dashboardView==="stats");const i=t.querySelector(".toggle-text");i&&(i.textContent=this.dashboardView==="stats"?"Std.":"Stat."),t.setAttribute("aria-label",this.dashboardView==="stats"?"Bytt til standardvisning":"Bytt til statistikkvisning")}this.shifts=[...this.userShifts],this.setupBreakDeductionEventListeners(),document.getElementById("fullMinuteRangeToggle").addEventListener("change",i=>{i.target.checked&&this.directTimeInput&&(this.directTimeInput=!1,document.getElementById("directTimeInputToggle").checked=!1),this.fullMinuteRange=i.target.checked;const o={startHour:document.getElementById("startHour")?.value||"",startMinute:document.getElementById("startMinute")?.value||"",endHour:document.getElementById("endHour")?.value||"",endMinute:document.getElementById("endMinute")?.value||""};this.populateTimeSelects(),setTimeout(()=>{if(o.startHour&&(document.getElementById("startHour").value=o.startHour),o.startMinute){const r=document.getElementById("startMinute");r.querySelector(`option[value="${o.startMinute}"]`)&&(r.value=o.startMinute)}if(o.endHour&&(document.getElementById("endHour").value=o.endHour),o.endMinute){const r=document.getElementById("endMinute");r.querySelector(`option[value="${o.endMinute}"]`)&&(r.value=o.endMinute)}},50),this.saveSettingsToSupabase()}),document.getElementById("directTimeInputToggle").addEventListener("change",i=>{i.target.checked&&this.fullMinuteRange&&(this.fullMinuteRange=!1,document.getElementById("fullMinuteRangeToggle").checked=!1),this.directTimeInput=i.target.checked,this.populateTimeSelects(),this.saveSettingsToSupabase()}),this.setupFormStateListeners(),this.setupNewSettingsListeners(),this.restoreFormState(),setTimeout(()=>{this.updateDisplay(!0)},100),this.shiftView=this.defaultShiftsView,this.switchShiftView(this.shiftView),window.addEventListener("resize",()=>{document.body.classList.contains("chatbox-view")||this.updateStats(!1)}),window.visualViewport&&window.visualViewport.addEventListener("resize",()=>{document.body.classList.contains("chatbox-view")||this.updateStats(!1)});const n=document.querySelector(".header");if(n&&window.ResizeObserver){let i=n.getBoundingClientRect().height;new ResizeObserver(r=>{const a=r[0].target.getBoundingClientRect().height;Math.abs(a-i)>1&&(i=a,this.updateStats(!1))}).observe(n)}window.addEventListener("load",()=>{this.initialAnimationComplete||this.updateStats(!1)}),ht(),this.checkAndShowRecurringIntro(),window.addEventListener("beforeunload",()=>{this.cleanup()})},async saveOrgSettings(){try{const s=document.getElementById("breakPolicySelect");if(!s)return;const e=s.value,t=await this.getAuthHeaders(),n=await fetch(`${window.CONFIG.apiBase}/org-settings`,{method:"PUT",headers:t,body:JSON.stringify({break_policy:e})});if(n.ok){const i=await n.json();this.orgSettings={break_policy:i.break_policy},window.showToast&&window.showToast("Lagret","success"),this.updateOrgSettingsUI(),this.currentView==="employees"&&await this.fetchAndDisplayEmployeeShifts?.()}else{const i=await n.json().catch(()=>({}));throw new Error(i.error||"Kunne ikke lagre")}}catch(s){console.error("saveOrgSettings error",s),window.showToast&&window.showToast("Kunne ikke lagre","error")}},onOrgWageCaregiverToggle(){const s=document.getElementById("orgIsWageCaregiverToggle");this.isWageCaregiver=!!(s&&s.checked),this.updateOrgSettingsUI(),this.updateTabBarVisibility();const e=document.getElementById("isWageCaregiverToggle");e&&(e.checked=this.isWageCaregiver),this.saveSettingsToSupabase()},updateOrgSettingsUI(){const s=!this.isWageCaregiver,e=document.getElementById("orgBreakPolicySection"),t=document.getElementById("breakPolicySelect");[e].forEach(n=>{n&&(n.style.opacity=s?"0.5":"1")}),t&&(t.disabled=s)},populateTimeSelects(){const s=document.getElementById("startHour"),e=document.getElementById("endHour"),t=document.getElementById("startMinute"),n=document.getElementById("endMinute"),i=document.getElementById("recurringStartHour"),o=document.getElementById("recurringEndHour"),r=document.getElementById("recurringStartMinute"),a=document.getElementById("recurringEndMinute");if(this.directTimeInput)this.replaceTimeDropdownsWithInputs();else{this.ensureTimeDropdowns(),s.innerHTML='<option value="">Fra time</option>',e.innerHTML='<option value="">Til time</option>',t.innerHTML='<option value="">Fra minutt</option>',n.innerHTML='<option value="">Til minutt</option>',i&&(i.innerHTML='<option value="">Fra time</option>',o.innerHTML='<option value="">Til time</option>',r.innerHTML='<option value="">Fra minutt</option>',a.innerHTML='<option value="">Til minutt</option>');for(let l=0;l<=23;l++){const c=String(l).padStart(2,"0");s.innerHTML+=`<option value="${c}">${c}</option>`,e.innerHTML+=`<option value="${c}">${c}</option>`,i&&(i.innerHTML+=`<option value="${c}">${c}</option>`,o.innerHTML+=`<option value="${c}">${c}</option>`)}if(this.fullMinuteRange)for(let l=0;l<60;l++){const c=String(l).padStart(2,"0"),d=l===0?" selected":"";t.innerHTML+=`<option value="${c}"${d}>${c}</option>`,n.innerHTML+=`<option value="${c}"${d}>${c}</option>`,r&&(r.innerHTML+=`<option value="${c}"${d}>${c}</option>`,a.innerHTML+=`<option value="${c}"${d}>${c}</option>`)}else["00","15","30","45"].forEach((l,c)=>{const d=c===0?" selected":"";t.innerHTML+=`<option value="${l}"${d}>${l}</option>`,n.innerHTML+=`<option value="${l}"${d}>${l}</option>`,r&&(r.innerHTML+=`<option value="${l}"${d}>${l}</option>`,a.innerHTML+=`<option value="${l}"${d}>${l}</option>`)})}},replaceTimeDropdownsWithInputs(){[{id:"startHour",placeholder:"Fra time (HH)"},{id:"startMinute",placeholder:"Fra minutt (MM)"},{id:"endHour",placeholder:"Til time (HH)"},{id:"endMinute",placeholder:"Til minutt (MM)"},{id:"recurringStartHour",placeholder:"Fra time (HH)"},{id:"recurringStartMinute",placeholder:"Fra minutt (MM)"},{id:"recurringEndHour",placeholder:"Til time (HH)"},{id:"recurringEndMinute",placeholder:"Til minutt (MM)"}].forEach(e=>{const t=document.getElementById(e.id);if(t&&t.tagName==="SELECT"){const n=t.value,i=document.createElement("input");i.type="text",i.id=e.id,i.className="form-control time-input",i.placeholder=e.placeholder,i.maxLength=2,i.pattern="[0-9]{2}",i.value=n,i.addEventListener("input",o=>{let r=o.target.value.replace(/\D/g,"");if(r.length>2&&(r=r.slice(0,2)),e.id.includes("Hour")){const a=parseInt(r);r.length===2&&a>23&&(r=r.slice(0,1))}else{const a=parseInt(r);r.length===2&&a>59&&(r=r.slice(0,1))}o.target.value=r}),i.addEventListener("blur",o=>{o.target.value.length===1&&(o.target.value="0"+o.target.value)}),t.replaceWith(i)}})},ensureTimeDropdowns(){["startHour","startMinute","endHour","endMinute","recurringStartHour","recurringStartMinute","recurringEndHour","recurringEndMinute"].forEach(e=>{const t=document.getElementById(e);if(t&&t.tagName==="INPUT"){t.value;const n=document.createElement("select");n.id=e,n.className="form-control",t.replaceWith(n)}})},async loadEmployeesForShiftForms(){try{this.employees.length===0&&await this.loadEmployees(),this.populateEmployeeSelectors(),this.populateEmployeeFilterBar()}catch(s){console.error("Error loading employees for shift forms:",s)}},populateEmployeeSelectors(){["employeeSelect","recurringEmployeeSelect","editEmployeeSelect"].forEach(e=>{const t=document.getElementById(e);if(t){for(;t.children.length>1;)t.removeChild(t.lastChild);this.employees.forEach(n=>{if(n.archived_at)return;const i=document.createElement("option");i.value=n.id,i.textContent=n.name,t.appendChild(i)})}}),this.toggleEmployeeSelectorsVisibility(this.currentView==="employees")},toggleEmployeeSelectorsVisibility(s){["employeeSelect","recurringEmployeeSelect"].forEach(e=>{const t=document.getElementById(e);if(!t)return;const n=t.closest(".form-group")||t.parentElement;n&&(n.style.display="none")})},populateEmployeeFilterBar(){const s=document.getElementById("employeeFilterBar");if(s){s.style.display="none";const e=s.querySelector(".filter-scroll-container");e&&(e.innerHTML="")}},createFilterChip(s,e,t,n){const i=document.createElement("button");i.className=`filter-chip ${n?"active":""}`,i.setAttribute("data-employee-id",s),i.setAttribute("aria-label",`Filter by ${e}`);const o=document.createElement("span");if(o.textContent=e,i.appendChild(o),t&&s){const r=document.createElement("span");r.className="filter-chip-color",r.style.backgroundColor=t,i.insertBefore(r,o)}return i.addEventListener("click",()=>{this.handleEmployeeFilter(s)}),i},handleEmployeeFilter(s){const e=s||null;this.selectedEmployeeId=e,document.querySelectorAll(".filter-chip").forEach(n=>{const i=n.getAttribute("data-employee-id");n.classList.toggle("active",i===(e||""))}),this.currentView==="employees"?this.fetchAndDisplayEmployeeShifts?.():this.applyEmployeeFilter(),e?localStorage.setItem("selectedEmployeeId",e):localStorage.removeItem("selectedEmployeeId"),this.updateEmployeeAssignmentUIInModal?.()},updateEmployeeAssignmentUIInModal(){const s="selectedEmployeePill",e=document.getElementById(s),t=document.getElementById("employeeSelect"),n=document.getElementById("recurringEmployeeSelect"),i=t?.closest(".form-group"),o=n?.closest(".form-group"),r=this.currentView==="employees",a=this.selectedEmployeeId!==null;if(a&&(t&&(t.value=this.selectedEmployeeId),n&&(n.value=this.selectedEmployeeId)),i&&(i.style.display="none"),o&&(o.style.display="none"),!r){e&&e.remove();return}const l=document.getElementById("addShiftModal");if(!l)return;let c=e;if(!c){c=document.createElement("div"),c.id=s,c.style.display="none",c.style.marginBottom="16px",c.innerHTML=`
                <div class="form-group">
                  <label>Ansatt</label>
                  <div class="selected-employee-pill" style="display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--surface)">
                    <span class="color-dot" style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#888"></span>
                    <span class="name"></span>
                  </div>
                </div>`;const u=l.querySelector("#shiftForm");u?.insertBefore(c,u.firstChild?.nextSibling?.nextSibling||u.firstChild)}const d=this.getSelectedEmployee?.()||null;if(a&&d){c.style.display="";const u=c.querySelector(".name"),h=c.querySelector(".color-dot");u&&(u.textContent=d.name),h&&(h.style.background=d.display_color||"#888");const m=c.querySelector(".selected-employee-pill");m&&!m.dataset.boundEdit&&(m.style.cursor="pointer",m.setAttribute("role","button"),m.setAttribute("tabindex","0"),m.title="Rediger ansatt",m.addEventListener("click",f=>{try{f.preventDefault(),f.stopPropagation()}catch{}const v=this.getSelectedEmployee?.();v&&this.showEditEmployeeModal(v)}),m.addEventListener("keydown",f=>{if(f.key==="Enter"||f.key===" "){f.preventDefault();const v=this.getSelectedEmployee?.();v&&this.showEditEmployeeModal(v)}}),m.dataset.boundEdit="1")}else c.style.display="none"},applyEmployeeFilter(){if(this.currentView==="employees"){this.fetchAndDisplayEmployeeShifts?.(),this.updateEmployeeAssignmentUIInModal?.();return}this.shifts=[...this.userShifts],this.updateDisplay()},initializeEmployeeState(){const s=localStorage.getItem("selectedEmployeeId");s&&(this.selectedEmployeeId=s)},openAddShiftModal(s=null,e=null){this.closeShiftDetails(),this.closeSettings(!1),this.closeProfile(),this.closeProfileDropdown();const t=document.querySelector(".floating-action-bar"),n=document.querySelector(".floating-action-bar-backdrop");t&&(t.style.display="none"),n&&(n.style.display="none");const i=document.getElementById("startHour");i&&i.tagName==="SELECT"&&!i.options.length?this.populateTimeSelects():i||this.populateTimeSelects(),document.getElementById("dateGrid").childElementCount?s!==null||e!==null?this.populateDateGrid(s,e):this.populateDateGrid(s,e):this.populateDateGrid(s,e);const o=document.getElementById("addShiftModal");o.style.display="flex",o.classList.add("active"),this.selectedDates=[],document.querySelectorAll("#dateGrid .date-cell").forEach(a=>a.classList.remove("selected")),this.updateSelectedDatesInfo(),document.getElementById("shiftForm").reset(),this.switchAddShiftTab("simple"),this.populateEmployeeSelectors(),this.updateEmployeeAssignmentUIInModal()},updateSelectedDatesInfo(){const s=document.getElementById("selectedDatesInfo"),e=document.getElementById("selectedDatesCount");if(!s||!e)return;const t=this.selectedDates?this.selectedDates.length:0;t>0?(e.textContent=t,s.style.display="block"):s.style.display="none"},switchAddShiftTab(s){document.getElementById("addShiftModal").querySelectorAll(".tab-btn").forEach((o,r)=>{const a=r===0,l=s==="simple"&&a||s==="recurring"&&!a;o.classList.toggle("active",l)});const n=document.getElementById("simpleFields"),i=document.getElementById("recurringFields");s==="simple"?(n.classList.add("active"),i.classList.remove("active")):(n.classList.remove("active"),i.classList.add("active")),this.toggleEmployeeSelectorsVisibility(this.currentView==="employees"),this.updateEmployeeAssignmentUIInModal?.()},closeAddShiftModal(){const s=document.getElementById("addShiftModal");s.style.display="none",s.classList.remove("active");const e=document.querySelector(".floating-action-bar"),t=document.querySelector(".floating-action-bar-backdrop");e&&(e.style.display=""),t&&(t.style.display="")},async addShift(){const s=document.getElementById("recurringFields");if(s&&s.classList.contains("active")){const t=uuidv4(),n=parseInt(document.getElementById("recurringFrequency").value,10),i=document.getElementById("recurringStartDate").value,o=parseFloat(document.getElementById("recurringDurationYears").value),r=document.getElementById("recurringStartHour").value,a=document.getElementById("recurringStartMinute").value||"00",l=document.getElementById("recurringEndHour").value,c=document.getElementById("recurringEndMinute").value||"00",d=this.selectedEmployeeId;if(!i||!n||!o||!r||!l){window.ErrorHelper?window.ErrorHelper.showError("Vennligst fyll ut alle påkrevde felt for å opprette en vaktserie.",{type:"warning",duration:4e3}):alert("Vennligst fyll ut alle påkrevde felt for å opprette en vaktserie.");const w=document.querySelector('.btn-primary[onclick="app.addShift()"]');w&&(w.style.background="var(--danger)",w.style.transform="scale(0.95)",w.style.transition="all 0.2s ease",setTimeout(()=>{w.style.background="",w.style.transform="scale(1)"},1e3));return}const u=new Date(i),h=u.getDay(),m=[new Date(u)];let f=new Date(u);const v=new Date(u);for(v.setMonth(v.getMonth()+Math.floor(o*12));f=new Date(f),f.setDate(f.getDate()+n*7),!(f>v);)m.push(new Date(f));const S=`Du er i ferd med å opprette ${m.length} gjentakende vakter.

Vil du fortsette?`;if(!confirm(S)){const w=document.querySelector('.btn-primary[onclick="app.addShift()"]');w&&(w.style.transform="scale(1)",w.style.transition="transform 0.1s ease");return}const b=document.querySelector('.btn-primary[onclick="app.addShift()"]');b&&(b.style.transform="scale(0.95)",b.style.transition="transform 0.1s ease",setTimeout(()=>{b.style.transform="scale(1)"},100));const{data:p}=await window.supa.auth.getClaims();if(!!!p){alert("Autentiseringsfeil");return}const _=await Q();if(!_){console.warn("[auth] Missing userId, skipping query");return}console.debug("[auth] using userId:",_);for(const w of m){const E=`${w.getFullYear()}-${(w.getMonth()+1).toString().padStart(2,"0")}-${w.getDate().toString().padStart(2,"0")}`;if(d){const{data:{session:x}}=await window.supa.auth.getSession(),T={Authorization:`Bearer ${x.access_token}`,"Content-Type":"application/json"},I=await fetch(`${window.CONFIG.apiBase}/employee-shifts`,{method:"POST",headers:T,body:JSON.stringify({employee_id:d,shift_date:E,start_time:`${r}:${a}`,end_time:`${l}:${c}`})});if(!I.ok){const D=await I.json().catch(()=>({}));console.error("Gjentakende API-feil:",D);continue}}else{const x={user_id:_,shift_date:E,start_time:`${r}:${a}`,end_time:`${l}:${c}`,shift_type:h===0?2:h===6?1:0,series_id:t},{data:T,error:I}=await window.supa.from("user_shifts").insert(x).select().single();if(I){console.error("Gjentakende feil:",I);continue}this.userShifts.push({id:T.id,date:new Date(w),startTime:`${r}:${a}`,endTime:`${l}:${c}`,type:h===0?2:h===6?1:0,seriesId:t})}}this.shifts=[...this.userShifts],this.refreshUI(this.shifts),this.closeAddShiftModal();const k=document.querySelector(".add-btn");k&&(k.style.transform="scale(1.1)",k.style.background="var(--success)",k.style.transition="all 0.3s ease",setTimeout(()=>{k.style.transform="scale(1)",k.style.background=""},500));return}try{if(!this.selectedDates||this.selectedDates.length===0){window.ErrorHelper?window.ErrorHelper.showError("Vennligst velg en dato før du lagrer vakten.",{type:"warning",duration:4e3}):alert("Vennligst velg en dato før du lagrer vakten.");const u=document.querySelector('.btn-primary[onclick="app.addShift()"]');u&&(u.style.background="var(--danger)",u.style.transform="scale(0.95)",u.style.transition="all 0.2s ease",setTimeout(()=>{u.style.background="",u.style.transform="scale(1)"},1e3));return}const t=document.getElementById("startHour").value,n=document.getElementById("startMinute").value||"00",i=document.getElementById("endHour").value,o=document.getElementById("endMinute").value||"00",r=this.selectedEmployeeId;if(!t||!i){window.ErrorHelper?window.ErrorHelper.showError("Vennligst fyll ut arbeidstid (start- og sluttidspunkt).",{type:"warning",duration:4e3}):alert("Vennligst fyll ut arbeidstid (start- og sluttidspunkt).");const u=document.querySelector('.btn-primary[onclick="app.addShift()"]');u&&(u.style.background="var(--danger)",u.style.transform="scale(0.95)",u.style.transition="all 0.2s ease",setTimeout(()=>{u.style.background="",u.style.transform="scale(1)"},1e3));return}const{data:a}=await window.supa.auth.getClaims();if(!!!a){console.error("addShift: Authentication error"),alert("Feil ved autentisering");return}const c=await Q();if(!c){console.warn("[auth] Missing userId, skipping query");return}console.debug("[auth] using userId:",c);const d=[];for(const u of this.selectedDates){const h=u.getDay(),m=h===0?2:h===6?1:0,f={date:new Date(u),startTime:`${t}:${n}`,endTime:`${i}:${o}`,type:m},v=`${f.date.getFullYear()}-${(f.date.getMonth()+1).toString().padStart(2,"0")}-${f.date.getDate().toString().padStart(2,"0")}`;if(r){const{data:{session:g}}=await window.supa.auth.getSession(),S={Authorization:`Bearer ${g.access_token}`,"Content-Type":"application/json"},b=await fetch(`${window.CONFIG.apiBase}/employee-shifts`,{method:"POST",headers:S,body:JSON.stringify({employee_id:r,shift_date:v,start_time:f.startTime,end_time:f.endTime})});if(!b.ok){const p=await b.json().catch(()=>({}));console.error("addShift: Employee-shift API error:",p),alert(`Kunne ikke lagre vakt for ${v}: ${p.error||b.statusText}`);continue}}else{const g={user_id:c,shift_date:v,start_time:f.startTime,end_time:f.endTime,shift_type:f.type},{data:S,error:b}=await window.supa.from("user_shifts").insert(g).select().single();if(b){console.error("addShift: Database error when saving shift:",b),alert(`Kunne ikke lagre vakt for ${v}: ${b.message}`);continue}f.id=S.id,this.userShifts.push(f),d.push(f)}f.employee_id=r,f.employee=r?this.employees.find(g=>g.id===r):null}if(r?await this.fetchAndDisplayEmployeeShifts?.():(this.shifts=[...this.userShifts],this.refreshUI(this.shifts)),document.getElementById("shiftForm").reset(),this.selectedDates=[],document.querySelectorAll(".date-cell").forEach(u=>{u.classList.remove("selected")}),this.updateSelectedDatesInfo(),this.clearFormState(),d.length>0){const u=document.querySelector(".add-btn");u&&(u.style.transform="scale(1.1)",u.style.background="var(--success)",u.style.transition="all 0.3s ease",setTimeout(()=>{u.style.transform="scale(1)",u.style.background=""},500))}}catch(t){console.error("addShift: Critical error:",t),alert(`En uventet feil oppstod: ${t.message}`)}},getISOWeekNumber(s){const e=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())),t=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-t);const n=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-n)/864e5+1)/7)},getWeekDateRange(s,e){const t=new Date(Date.UTC(e,0,4)),n=t.getUTCDay()||7,i=new Date(t);i.setUTCDate(t.getUTCDate()-n+1);const o=new Date(i);o.setUTCDate(i.getUTCDate()+(s-1)*7);const r=new Date(o);r.setUTCDate(o.getUTCDate()+6);const a=new Date(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate()),l=new Date(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate());return{startDate:a,endDate:l}},enterDrillDownMode(s){console.log("Entering drill-down mode for week:",s),this.clearAllTooltips(),this.drillDownMode=!0,this.selectedWeek=s,this.updateWeeklyHoursChart(),this.updateDisplay(!1)},exitDrillDownMode(){console.log("Exiting drill-down mode"),this.clearAllTooltips();const s=document.querySelector(".chart-hours-value-card"),e=document.querySelector(".chart-shifts-count-card");s&&(s.classList.remove("has-tooltip","tooltip-active"),s.removeAttribute("data-tooltip"),this.removeWageCardTooltip(s)),e&&(e.classList.remove("has-tooltip","tooltip-active"),e.removeAttribute("data-tooltip"),this.removeWageCardTooltip(e));const t=document.getElementById("wageCardTooltip");t&&t.classList.remove("show"),this.drillDownMode=!1,this.selectedWeek=null,this.removeBackButton(),this.updateWeeklyHoursChart(),this.updateDisplay(!1)},isInDrillDownMode(){return this.drillDownMode&&this.selectedWeek!==null},clearAllTooltips(){this.hideChartTooltip&&this.hideChartTooltip();const s=document.getElementById("chartTooltip");s&&s.classList.remove("show"),document.querySelectorAll(".chart-bar.tooltip-active").forEach(t=>{t.classList.remove("tooltip-active")})},addBackButton(){this.removeBackButton();const s=document.querySelector(".chart-progress-bar");if(!s)return;const e=document.createElement("div");e.className="progress-bar-wrapper",e.id="progressBarWrapper",s.parentNode.insertBefore(e,s),e.appendChild(s);const n=document.createElement("button");n.id="drillDownBackButton",n.className="drill-down-back-button",n.innerHTML=`
            <svg class="back-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            <span>Uke ${this.selectedWeek}</span>
        `,n.setAttribute("aria-label",`Tilbake til ukeoversikt fra uke ${this.selectedWeek}`),n.addEventListener("click",i=>{i.stopPropagation(),this.exitDrillDownMode()}),e.appendChild(n)},removeBackButton(){const s=document.getElementById("progressBarWrapper"),e=document.getElementById("drillDownBackButton");if(s){const t=s.querySelector(".chart-progress-bar"),n=s.parentNode;t&&n&&n.insertBefore(t,s),s.remove()}else e&&e.remove()},getShiftsForWeek(s){const{startDate:e,endDate:t}=this.getWeekDateRange(s,this.currentYear);return this.shifts.filter(i=>{const o=new Date(i.date);return o>=e&&o<=t}).map(i=>{const o=i.date.getMonth()===this.currentMonth-1&&i.date.getFullYear()===this.currentYear;return{...i,isCurrentMonth:o}})},getDailyDataForWeek(s){const e=this.getShiftsForWeek(s),t={};let n=0,i=0,o=0,r=0;return e.forEach(a=>{const l=a.date.getDay();t[l]||(t[l]={hours:0,earnings:0,shifts:[],date:new Date(a.date),hasCurrentMonthShifts:!1,hasAdjacentMonthShifts:!1});const c=this.calculateShift(a);t[l].hours+=c.hours,t[l].earnings+=c.total,t[l].shifts.push(a),a.isCurrentMonth?(t[l].hasCurrentMonthShifts=!0,o+=c.hours,r+=c.total):t[l].hasAdjacentMonthShifts=!0,n+=c.hours,i+=c.total}),{dailyData:t,totalWeekHours:n,totalWeekEarnings:i,totalCurrentMonthHours:o,totalCurrentMonthEarnings:r,weekNumber:s}},getDaysWithShifts(s){const{dailyData:e}=this.getDailyDataForWeek(s);return Object.keys(e).map(t=>parseInt(t)).sort((t,n)=>t===0?1:n===0?-1:t-n)},populateDateGrid(s=null,e=null){const t=document.getElementById("dateGrid");if(!t)return;const n=e!==null?e:this.currentYear,i=s!==null?s-1:this.currentMonth-1,o=new Date(n,i,1),r=new Date(o),a=o.getDay()===0?6:o.getDay()-1;r.setDate(r.getDate()-a),t.innerHTML="";const l=this.shifts.filter(u=>u.date.getMonth()===i&&u.date.getFullYear()===n),c=new Set;l.forEach(u=>{c.add(u.date.getDate())});const d=document.createElement("div");d.textContent="",d.className="week-number header",t.appendChild(d),["M","T","O","T","F","L","S"].forEach(u=>{const h=document.createElement("div");h.textContent=u,h.style.cssText="font-weight:600;font-size:12px;color:var(--text-secondary);text-align:center;padding:8px;",t.appendChild(h)});for(let u=0;u<42;u++){if(u%7===0){const g=new Date(r);g.setDate(r.getDate()+u);const S=this.getISOWeekNumber(g),b=document.createElement("div");b.className="week-number",b.textContent=S,t.appendChild(b)}const h=new Date(r);h.setDate(r.getDate()+u);const m=document.createElement("div");m.className="date-cell";const f=document.createElement("div");if(f.className="date-cell-content",f.textContent=h.getDate(),h.getMonth()===i&&c.has(h.getDate())){const g=document.createElement("div");g.className="shift-indicator-dot",f.appendChild(g),m.classList.add("has-shift")}const v=new Date;if(h.getDate()===v.getDate()&&h.getMonth()===v.getMonth()&&h.getFullYear()===v.getFullYear()&&m.classList.add("current-date"),m.appendChild(f),h.getMonth()!==i)m.classList.add("disabled");else{if(this.selectedDates&&this.selectedDates.length>0){const g=h.toDateString();this.selectedDates.some(b=>b.toDateString()===g)&&m.classList.add("selected")}m.addEventListener("click",()=>{this.selectedDates||(this.selectedDates=[]);const g=h.toDateString(),S=this.selectedDates.findIndex(b=>b.toDateString()===g);S>=0?(this.selectedDates.splice(S,1),m.classList.remove("selected")):(this.selectedDates.push(new Date(h)),m.classList.add("selected")),this.updateSelectedDatesInfo(),this.saveFormState()})}t.appendChild(m)}},changeMonth(s){this.currentMonth=s,this.debouncedUpdateDisplay(!0)},navigateToPreviousMonth(){let s=this.currentMonth-1,e=this.currentYear;s<1&&(s=12,e=this.currentYear-1),this.currentMonth=s,this.currentYear=e,this.debouncedUpdateDisplay(!0)},navigateToNextMonth(){let s=this.currentMonth+1,e=this.currentYear;s>12&&(s=1,e=this.currentYear+1),this.currentMonth=s,this.currentYear=e,this.debouncedUpdateDisplay(!0)},debouncedUpdateDisplay(s=!1){this.monthNavigationTimeout&&clearTimeout(this.monthNavigationTimeout),ee.refresh();const e=document.querySelector(".chart-progress-fill")||document.querySelector(".progress-fill");e&&(e.dataset.animating="false",e.classList.remove("loading"));const n=window.innerWidth<=768?150:100;this.monthNavigationTimeout=setTimeout(()=>{this.updateDisplay(s),this.monthNavigationTimeout=null},n)},async loadFromSupabase(){const{data:s}=await window.supa.auth.getClaims();if(!!!s){this.setDefaultSettings(),this.updateDisplay();return}const t=await Q();if(!t){console.warn("[auth] Missing userId, skipping query");return}console.debug("[auth] using userId:",t);try{const{data:n,error:i}=await window.supa.from("user_shifts").select("*").eq("user_id",t);i?console.error("Error fetching shifts from Supabase:",i):(this.userShifts=(n||[]).map(a=>({id:a.id,date:new Date(a.shift_date+"T00:00:00.000Z"),startTime:a.start_time,endTime:a.end_time,type:a.shift_type,seriesId:a.series_id||null,employee_id:null,employee:null})),this.shifts=[...this.userShifts]);const{data:o,error:r}=await window.supa.from("user_settings").select("*").eq("user_id",t).single();if(r&&r.code!=="PGRST116")console.error("Error fetching settings from Supabase:",r),this.setDefaultSettings();else if(o){this.usePreset=o.use_preset!==!1,this.customWage=o.custom_wage||200,this.currentWageLevel=o.wage_level||o.current_wage_level||1;const a=o.custom_bonuses||{};this.customBonuses={weekday:a.weekday||[],saturday:a.saturday||[],sunday:a.sunday||[]},this.currentMonth=new Date().getMonth()+1,this.currentYear=o.current_year||new Date().getFullYear(),this.pauseDeduction=o.pause_deduction||!1,this.pauseDeductionEnabled=o.pause_deduction_enabled!==!1,this.pauseDeductionMethod=o.pause_deduction_method||"proportional",this.pauseThresholdHours=parseFloat(o.pause_threshold_hours)||5.5,this.pauseDeductionMinutes=parseInt(o.pause_deduction_minutes)||30,this.auditBreakCalculations=!0,this.fullMinuteRange=o.full_minute_range||!1,this.directTimeInput=o.direct_time_input||!1,this.monthlyGoal=o.monthly_goal||2e4,this.hasSeenRecurringIntro=o.has_seen_recurring_intro||!1,this.currencyFormat=o.currency_format||!1,this.defaultShiftsView=o.default_shifts_view||"list",this.taxDeductionEnabled=o.tax_deduction_enabled===!0,this.taxPercentage=parseFloat(o.tax_percentage)||0,this.payrollDay=parseInt(o.payroll_day)||15,this.isWageCaregiver=o.is_wage_caregiver===!0}else this.setDefaultSettings();this.updateSettingsUI(),this.updateTabBarVisibility()}catch(n){console.error("Error in loadFromSupabase:",n),this.setDefaultSettings()}},setDefaultSettings(){this.usePreset=!0,this.customWage=200,this.currentWageLevel=1,this.customBonuses={weekday:[],saturday:[],sunday:[]},this.taxDeductionEnabled=!1,this.taxPercentage=0,this.payrollDay=15,this.isWageCaregiver=!1,this.currentMonth=new Date().getMonth()+1,this.currentYear=new Date().getFullYear(),this.pauseDeduction=!1,this.pauseDeductionEnabled=!0,this.pauseDeductionMethod="proportional",this.pauseThresholdHours=5.5,this.pauseDeductionMinutes=30,this.auditBreakCalculations=!0,this.fullMinuteRange=!1,this.directTimeInput=!1,this.monthlyGoal=2e4,this.hasSeenRecurringIntro=!1,this.currencyFormat=!1,this.defaultShiftsView="list"},setTestCustomBonuses(){this.customBonuses={weekday:[{from:"18:00",to:"22:00",rate:25}],saturday:[{from:"13:00",to:"18:00",rate:50}],sunday:[{from:"00:00",to:"23:59",rate:100}]},this.populateCustomBonusSlots()},updateSettingsUI(){const s=document.getElementById("usePresetToggle");s&&(s.checked=this.usePreset);const e=document.getElementById("wageSelect");e&&(e.value=this.currentWageLevel);const t=document.getElementById("customWageInput");t&&(t.value=this.customWage);const n=document.getElementById("pauseDeductionEnabledToggle");n&&(n.checked=this.pauseDeductionEnabled);const i=document.getElementById("pauseDeductionMethodSelect");if(i){const v=this.orgSettings?.break_policy,g=v==="fixed_0_5_over_5_5h"?"end_of_shift":v==="none"?"none":this.pauseDeductionMethod;i.value=g}const o=document.getElementById("pauseThresholdInput");o&&(o.value=this.pauseThresholdHours);const r=document.getElementById("pauseDeductionMinutesInput");r&&(r.value=this.pauseDeductionMinutes),this.toggleBreakDeductionSections(),this.updateMethodExplanation();const a=document.getElementById("taxDeductionToggle");a&&(a.checked=this.taxDeductionEnabled);const l=document.getElementById("taxPercentageInput");l&&(l.value=this.taxPercentage);const c=document.getElementById("payrollDayInput");c&&(c.value=this.payrollDay),this.toggleTaxPercentageSection();const d=document.getElementById("fullMinuteRangeToggle");d&&(d.checked=this.fullMinuteRange);const u=document.getElementById("directTimeInputToggle");u&&(u.checked=this.directTimeInput);const h=document.getElementById("currencyFormatToggle");h&&(h.checked=this.currencyFormat);const m=document.getElementById("defaultShiftsViewToggle");m&&(m.checked=this.defaultShiftsView==="calendar");const f=document.getElementById("isWageCaregiverToggle");f&&(f.checked=this.isWageCaregiver),this.updateTabBarVisibility(),this.togglePresetSections(),this.usePreset||setTimeout(()=>{this.populateCustomBonusSlots()},100)},togglePresetSections(){const s=document.getElementById("presetWageSection"),e=document.getElementById("customWageSection");s&&e&&(this.usePreset?(s.style.display="block",e.style.display="none"):(s.style.display="none",e.style.display="block",setTimeout(()=>{this.populateCustomBonusSlots()},100)))},async saveSettingsToSupabase(){const{data:s}=await window.supa.auth.getClaims();if(!!!s)return;const t=await Q();if(!t){console.warn("[auth] Missing userId, skipping query");return}console.debug("[auth] using userId:",t);try{const{data:n}=await window.supa.from("user_settings").select("*").eq("user_id",t).single(),i={user_id:t,updated_at:new Date().toISOString()};n?("use_preset"in n&&(i.use_preset=this.usePreset),"wage_level"in n&&(i.wage_level=this.currentWageLevel),"current_wage_level"in n&&(i.current_wage_level=this.currentWageLevel),"custom_wage"in n&&(i.custom_wage=this.customWage),"current_year"in n&&(i.current_year=this.currentYear),"pause_deduction"in n&&(i.pause_deduction=this.pauseDeduction),"full_minute_range"in n&&(i.full_minute_range=this.fullMinuteRange),"direct_time_input"in n&&(i.direct_time_input=this.directTimeInput),"monthly_goal"in n&&(i.monthly_goal=this.monthlyGoal),"has_seen_recurring_intro"in n&&(i.has_seen_recurring_intro=this.hasSeenRecurringIntro),"currency_format"in n&&(i.currency_format=this.currencyFormat),"default_shifts_view"in n&&(i.default_shifts_view=this.defaultShiftsView),"custom_bonuses"in n&&(i.custom_bonuses=this.customBonuses||{}),"tax_deduction_enabled"in n&&(i.tax_deduction_enabled=this.taxDeductionEnabled),"tax_percentage"in n&&(i.tax_percentage=this.taxPercentage),"payroll_day"in n&&(i.payroll_day=this.payrollDay),"is_wage_caregiver"in n&&(i.is_wage_caregiver=this.isWageCaregiver),i.pause_deduction_enabled=this.pauseDeductionEnabled,i.pause_deduction_method=this.pauseDeductionMethod,i.pause_threshold_hours=this.pauseThresholdHours,i.pause_deduction_minutes=this.pauseDeductionMinutes,i.audit_break_calculations=this.auditBreakCalculations,i.is_wage_caregiver=this.isWageCaregiver,console.log("Saving tax deduction settings:",{has_tax_enabled_column:"tax_deduction_enabled"in n,has_tax_percentage_column:"tax_percentage"in n,saving_enabled:this.taxDeductionEnabled,saving_percentage:this.taxPercentage})):(i.use_preset=this.usePreset,i.wage_level=this.currentWageLevel,i.custom_wage=this.customWage,i.current_year=this.currentYear,i.pause_deduction=this.pauseDeduction,i.pause_deduction_enabled=this.pauseDeductionEnabled,i.pause_deduction_method=this.pauseDeductionMethod,i.pause_threshold_hours=this.pauseThresholdHours,i.pause_deduction_minutes=this.pauseDeductionMinutes,i.audit_break_calculations=this.auditBreakCalculations,i.full_minute_range=this.fullMinuteRange,i.direct_time_input=this.directTimeInput,i.monthly_goal=this.monthlyGoal,i.has_seen_recurring_intro=this.hasSeenRecurringIntro,i.currency_format=this.currencyFormat,i.default_shifts_view=this.defaultShiftsView,i.custom_bonuses=this.customBonuses||{},i.tax_deduction_enabled=this.taxDeductionEnabled,i.tax_percentage=this.taxPercentage,i.payroll_day=this.payrollDay,i.is_wage_caregiver=this.isWageCaregiver);const{error:o}=await window.supa.from("user_settings").upsert(i,{onConflict:"user_id"});if(o){console.error("Error saving settings to Supabase:",o);const r={user_id:t,updated_at:new Date().toISOString()},{error:a}=await window.supa.from("user_settings").upsert(r,{onConflict:"user_id"});a&&console.error("Even minimal save failed:",a)}}catch(n){console.error("Error in saveSettingsToSupabase:",n)}},loadFromLocalStorage(){try{const s=localStorage.getItem("lønnsberegnerSettings");if(s){const e=JSON.parse(s);this.usePreset=e.usePreset!==!1,this.customWage=e.customWage||200,this.currentWageLevel=e.currentWageLevel||1,this.customBonuses=e.customBonuses||{},this.currentMonth=new Date().getMonth()+1,this.pauseDeduction=e.pauseDeduction!==!1,this.pauseDeductionEnabled=e.pauseDeductionEnabled!==!1,this.pauseDeductionMethod=e.pauseDeductionMethod||"proportional",this.pauseThresholdHours=parseFloat(e.pauseThresholdHours)||5.5,this.pauseDeductionMinutes=parseInt(e.pauseDeductionMinutes)||30,this.auditBreakCalculations=!0,this.fullMinuteRange=e.fullMinuteRange||!1,this.directTimeInput=e.directTimeInput||!1,this.monthlyGoal=e.monthlyGoal||2e4,this.hasSeenRecurringIntro=e.hasSeenRecurringIntro||!1,this.currencyFormat=e.currencyFormat||!1,this.defaultShiftsView=e.defaultShiftsView||"list",this.taxDeductionEnabled=e.taxDeductionEnabled||!1,this.taxPercentage=e.taxPercentage||0,this.payrollDay=parseInt(e.payrollDay)||15,this.isWageCaregiver=e.isWageCaregiver||!1,this.updateSettingsUI(),this.updateTabBarVisibility()}else this.setDefaultSettings()}catch(s){console.error("Error loading from localStorage:",s),this.setDefaultSettings()}},saveFormState(){const s={selectedDates:this.selectedDates?this.selectedDates.map(e=>e.toISOString()):[],startHour:document.getElementById("startHour")?.value||"",startMinute:document.getElementById("startMinute")?.value||"",endHour:document.getElementById("endHour")?.value||"",endMinute:document.getElementById("endMinute")?.value||""};this.formState=s,localStorage.setItem("vaktberegnerFormState",JSON.stringify(s))},restoreFormState(){try{const s=localStorage.getItem("vaktberegnerFormState");if(s){const e=JSON.parse(s);if(e.selectedDates&&e.selectedDates.length>0?(this.selectedDates=[],e.selectedDates.forEach(t=>{const n=new Date(t),i=n.getMonth()+1,o=n.getFullYear();if(i===this.currentMonth&&o===this.currentYear){this.selectedDates.push(n);const r=n.getDate();document.querySelectorAll(".date-cell").forEach(l=>{const c=l.querySelector(".date-cell-content");c&&c.textContent==r&&!l.classList.contains("disabled")&&l.classList.add("selected")})}})):this.selectedDates=[],e.selectedDate&&(!e.selectedDates||e.selectedDates.length===0)){const t=new Date(e.selectedDate),n=t.getMonth()+1,i=t.getFullYear();if(n===this.currentMonth&&i===this.currentYear){this.selectedDates=[t];const o=t.getDate();document.querySelectorAll(".date-cell").forEach(a=>{const l=a.querySelector(".date-cell-content");l&&l.textContent==o&&!a.classList.contains("disabled")&&a.classList.add("selected")})}}setTimeout(()=>{const t=document.getElementById("startHour"),n=document.getElementById("startMinute"),i=document.getElementById("endHour"),o=document.getElementById("endMinute");t&&e.startHour&&(t.value=e.startHour),n&&e.startMinute&&(n.value=e.startMinute),i&&e.endHour&&(i.value=e.endHour),o&&e.endMinute&&(o.value=e.endMinute)},100),this.formState=e,this.updateSelectedDatesInfo()}}catch(s){console.error("Error restoring form state:",s)}},clearFormState(){this.formState={},localStorage.removeItem("vaktberegnerFormState")},setupFormStateListeners(){["startHour","startMinute","endHour","endMinute"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{this.saveFormState()})})},async switchSettingsTab(s){const e=document.getElementById("settingsModal");if(!e)return;const t=e.querySelector(".tab-nav .tab-btn.active");if((t?.dataset?.tab||(t?.textContent?.trim()==="Lønn"?"wage":t?.textContent?.trim()==="UI"?"interface":t?.textContent?.trim()==="Bedrift"?"org":t?.textContent?.trim()==="Data"?"data":null))==="wage"&&!this.usePreset&&s!=="wage"&&await this.saveCustomBonusesSilent(),e.querySelectorAll(".tab-nav .tab-btn").forEach(r=>{const a=r.dataset?.tab||(r.textContent?.trim()==="Lønn"?"wage":r.textContent?.trim()==="UI"?"interface":r.textContent?.trim()==="Bedrift"?"org":r.textContent?.trim()==="Data"?"data":"");r.classList.toggle("active",a===s)}),["wageTab","interfaceTab","orgTab","dataTab"].forEach(r=>{const a=document.getElementById(r);a&&a.classList.toggle("active",r===`${s}Tab`)}),s==="wage"&&!this.usePreset&&setTimeout(()=>this.populateCustomBonusSlots(),100),s==="data"&&setTimeout(()=>this.setupExportPeriodOptions(),100),s==="org"){const r=document.getElementById("breakPolicySelect");r&&this.orgSettings?.break_policy&&(r.value=this.orgSettings.break_policy),r&&!r._immediateSaveBound&&(r.addEventListener("change",async()=>{await this.saveOrgSettings()}),r._immediateSaveBound=!0);const a=document.getElementById("orgIsWageCaregiverToggle");if(a){a.checked=!!this.isWageCaregiver,a.disabled=!1,a.onchange=()=>this.onOrgWageCaregiverToggle();const l=document.querySelector("#orgIsWageCaregiverToggle + .toggle-slider");l&&(l.style.cursor="pointer",l.onclick=c=>{c.preventDefault(),a.checked=!a.checked,this.onOrgWageCaregiverToggle()})}this.updateOrgSettingsUI()}},switchSettingsTabSync(s){this.switchSettingsTab(s).catch(console.error)},async togglePreset(){const s=!this.usePreset;this.usePreset=document.getElementById("usePresetToggle").checked,s&&this.usePreset&&await this.saveCustomBonusesSilent(),this.togglePresetSections(),this.saveSettingsToSupabase(),this.updateDisplay()},toggleTaxDeduction(){const s=document.getElementById("taxDeductionToggle");this.taxDeductionEnabled=s.checked,this.toggleTaxPercentageSection(),this.saveSettingsToSupabase(),this.updateDisplay()},toggleTaxPercentageSection(){const s=document.getElementById("taxPercentageSection");s?this.taxDeductionEnabled?s.style.display="block":s.style.display="none":console.log("Tax percentage section element not found - modal may not be loaded yet")},updateTaxPercentage(s){const e=parseFloat(s)||0;e<0?this.taxPercentage=0:e>100?this.taxPercentage=100:this.taxPercentage=e;const t=document.getElementById("taxPercentageInput");t&&(t.value=this.taxPercentage),this.saveSettingsToSupabase(),this.updateDisplay()},updateTaxDeductionUI(){const s=document.getElementById("taxDeductionToggle"),e=document.getElementById("taxPercentageInput"),t=document.getElementById("taxPercentageSection");if(s&&(s.checked=this.taxDeductionEnabled),e&&(e.value=this.taxPercentage,console.log("Set input to:",this.taxPercentage)),t){const n=this.taxDeductionEnabled;t.style.display=n?"block":"none",console.log("Set section visibility to:",n?"visible":"hidden")}},updatePayrollDay(s){const e=parseInt(s);isNaN(e)||e<1||e>31?(console.warn("Invalid payroll day:",s,"Using default value 15"),this.payrollDay=15):this.payrollDay=e;const t=document.getElementById("payrollDayInput");t&&(t.value=this.payrollDay),this.saveSettingsToSupabase(),this.updateDisplay()},getNextPayrollDate(){const s=new Date,e=s.getFullYear(),t=s.getMonth();s.getDate();let n=new Date(e,t,this.payrollDay);n<=s&&(n=new Date(e,t+1,this.payrollDay));const i=n.getMonth(),o=new Date(n.getFullYear(),i+1,0).getDate();this.payrollDay>o&&n.setDate(o);const r=n.getDay();return r===0?n.setDate(n.getDate()-2):r===6&&n.setDate(n.getDate()-1),n},getLastPayrollDate(s){const e=new Date(s);e.setMonth(e.getMonth()-1);const t=e.getMonth(),n=new Date(e.getFullYear(),t+1,0).getDate();this.payrollDay>n&&e.setDate(n);const i=e.getDay();return i===0?e.setDate(e.getDate()-2):i===6&&e.setDate(e.getDate()-1),e},getPayrollDateForMonth(s,e){let t=new Date(e,s-1,this.payrollDay);const n=t.getMonth(),i=new Date(t.getFullYear(),n+1,0).getDate();this.payrollDay>i&&t.setDate(i);const o=t.getDay();return o===0?t.setDate(t.getDate()-2):o===6&&t.setDate(t.getDate()-1),t},populateCustomBonusSlots(){["weekday","saturday","sunday"].forEach(e=>{const t=document.getElementById(`${e}BonusSlots`);if(!t){console.error(`Container ${e}BonusSlots not found`);return}t.innerHTML="",(this.customBonuses&&this.customBonuses[e]||[]).forEach(i=>{const o=document.createElement("div");o.className="bonus-slot",o.innerHTML=`
                    <input type="time" class="form-control" value="${i.from}">
                    <input type="time" class="form-control" value="${i.to}">
                    <input type="number" class="form-control" placeholder="kr/t" value="${i.rate}">
                    <button class="btn btn-icon btn-danger remove-bonus" title="Fjern dette tillegget">×</button>
                `,o.querySelectorAll("input").forEach(l=>{l.addEventListener("change",()=>{this.autoSaveCustomBonuses()})});const a=o.querySelector(".remove-bonus");a&&a.addEventListener("click",l=>{l.stopPropagation(),this.removeBonusSlot(a)}),t.appendChild(o)})})},addBonusSlot(s){const e=document.getElementById(`${s}BonusSlots`);if(!e){console.error(`Container ${s}BonusSlots not found`);return}const t=document.createElement("div");t.className="bonus-slot",t.innerHTML=`
            <div class="time-input-group">
                <label class="time-label">Fra:</label>
                <input type="time" class="form-control" placeholder="--:--" title="Angi starttid (timer:minutter)">
            </div>
            <div class="time-input-group">
                <label class="time-label">Til:</label>
                <input type="time" class="form-control" placeholder="--:--" title="Angi sluttid (timer:minutter)">
            </div>
            <div class="rate-input-group">
                <input type="number" class="form-control" placeholder="kr/t" title="Angi tilleggssats i kroner per time">
            </div>
            <button class="btn btn-icon btn-danger remove-bonus" title="Fjern dette tillegget">×</button>
        `,t.querySelectorAll("input").forEach(o=>{o.addEventListener("change",()=>{this.autoSaveCustomBonuses()})});const i=t.querySelector(".remove-bonus");i&&i.addEventListener("click",o=>{o.stopPropagation(),this.removeBonusSlot(i)}),e.appendChild(t)},removeBonusSlot(s){s.closest(".bonus-slot").remove(),this.usePreset||this.saveCustomBonusesSilent().catch(console.error)},autoSaveCustomBonuses(){this.usePreset||(this.autoSaveTimeout&&(clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=null),this.autoSaveTimeout=setTimeout(()=>{this.saveCustomBonusesSilent().catch(console.error),this.autoSaveTimeout=null},5e3))},showSaveStatus(s){let e=document.getElementById("bonus-save-status");e||(e=document.createElement("div"),e.id="bonus-save-status",e.style.cssText=`
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-primary);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 12px 16px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px var(--shadow-blue);
                transition: all 0.3s var(--ease-default);
                opacity: 0;
                transform: translateX(100%);
            `,document.body.appendChild(e)),e.textContent=s,e.style.opacity="1",e.style.transform="translateX(0)",setTimeout(()=>{e.style.opacity="0",e.style.transform="translateX(100%)"},3e3)},async openSettings(){this.closeShiftDetails(),this.closeProfileDropdown(),this.closeProfile();const s=document.querySelector(".floating-action-bar"),e=document.querySelector(".floating-action-bar-backdrop");s&&(s.style.display="none"),e&&(e.style.display="none");const t=document.getElementById("settingsModal");t&&(this.updateSettingsUI(),this.switchSettingsTabSync("wage"),setTimeout(()=>{this.updateTaxDeductionUI()},50),t.style.display="flex",this.usePreset||setTimeout(()=>{this.populateCustomBonusSlots()},100))},async openPaydateSettings(){this.closeShiftDetails(),this.closeProfileDropdown(),this.closeProfile();const s=document.querySelector(".floating-action-bar"),e=document.querySelector(".floating-action-bar-backdrop");s&&(s.style.display="none"),e&&(e.style.display="none");const t=document.getElementById("settingsModal");t&&(this.updateSettingsUI(),this.switchSettingsTabSync("wage"),setTimeout(()=>{this.updateTaxDeductionUI()},50),t.style.display="flex",this.usePreset||setTimeout(()=>{this.populateCustomBonusSlots()},100),setTimeout(()=>{const n=document.getElementById("payrollDayInput");n&&(n.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{n.focus(),n.select()},300))},150))},async closeSettings(s=!0){const e=document.getElementById("settingsModal");e&&e.style.display!=="none"&&s&&(this.usePreset||await this.saveCustomBonusesSilent(),this.saveSettingsToSupabase()),e&&(e.style.display="none");const n=document.querySelector(".floating-action-bar"),i=document.querySelector(".floating-action-bar-backdrop");n&&(n.style.display=""),i&&(i.style.display=""),this.closeProfileDropdown()},toggleDashboardView(){const s=document.getElementById("dashboardToggleBtn");if(!s)return;this.dashboardView=this.dashboardView==="default"?"stats":"default",s.classList.toggle("active",this.dashboardView==="stats");const e=s.querySelector(".toggle-text");e&&(e.textContent=this.dashboardView==="stats"?"Std.":"Stat."),s.setAttribute("aria-label",this.dashboardView==="stats"?"Bytt til standardvisning":"Bytt til statistikkvisning"),this.applyDashboardView(),localStorage.setItem("dashboardView",this.dashboardView)},applyDashboardView(){const s=document.body,e=document.querySelector(".dashboard-content"),t=document.querySelector(".statistics-section"),n=document.getElementById("weeklyHoursChart");if(this.dashboardView==="stats"){s.classList.add("stats-view"),console.log("Body classes after adding stats-view:",s.className);const i=document.querySelector(".total-card"),o=document.querySelector(".next-shift-card"),r=document.querySelector(".next-payroll-card");if(i&&(i.style.display="none",console.log("Manually hid total card")),o&&(o.style.display="none",console.log("Manually hid next shift card")),r&&(r.style.display="none",console.log("Manually hid next payroll card")),n&&e&&!e.contains(n)){const a=document.createElement("div");a.className="dashboard-stats-container",a.style.order="1",a.appendChild(n),e.appendChild(a)}console.log("Applied stats view - stats card replaces dashboard content")}else{s.classList.remove("stats-view");const i=document.querySelector(".total-card"),o=document.querySelector(".next-shift-card"),r=document.querySelector(".next-payroll-card");if(i&&(i.style.display="",console.log("Showed total card")),o&&(o.style.display="",console.log("Showed next shift card")),r&&(r.style.display="",console.log("Showed next payroll card")),n&&t){const a=t.querySelector(".statistics-content"),l=document.querySelector(".dashboard-stats-container");l&&a&&(a.appendChild(n),l.remove())}console.log("Applied default view - stats card moved back to statistics section")}},toggleProfileDropdown(){const s=document.getElementById("profileDropdown");if(!s)return;s.classList.contains("show")?this.closeProfileDropdown():this.openProfileDropdown()},openProfileDropdown(){const s=document.getElementById("profileDropdown");s&&(this.closeShiftDetails(),s.style.display="block",s.offsetHeight,s.classList.add("show"),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside.bind(this)),document.addEventListener("keydown",this.handleDropdownKeydown.bind(this))},0))},closeProfileDropdown(){const s=document.getElementById("profileDropdown");s&&(s.classList.remove("show"),setTimeout(()=>{s.classList.contains("show")||(s.style.display="none")},200),document.removeEventListener("click",this.handleClickOutside.bind(this)),document.removeEventListener("keydown",this.handleDropdownKeydown.bind(this)))},handleClickOutside(s){const e=document.getElementById("profileDropdown"),t=document.querySelector(".user-profile-btn");!e||!t||!e.contains(s.target)&&!t.contains(s.target)&&this.closeProfileDropdown()},handleDropdownKeydown(s){const e=document.getElementById("profileDropdown");if(!(!e||!e.classList.contains("show"))&&s.key==="Escape"){this.closeProfileDropdown();const t=document.querySelector(".user-profile-btn");t&&t.focus()}},openProfile(){this.closeProfileDropdown(),this.closeSettings(!1),this.closeShiftDetails();const s=document.querySelector(".floating-action-bar"),e=document.querySelector(".floating-action-bar-backdrop");s&&(s.style.display="none"),e&&(e.style.display="none");const t=document.getElementById("profileModal");if(t){this.loadProfileData(),this.initProfileAvatarControls(),t.style.display="flex",t.classList.add("active");const n=o=>{o.key==="Escape"&&this.closeProfile()};document.addEventListener("keydown",n),t.keydownHandler=n;const i=o=>{o.target===t&&this.closeProfile()};t.addEventListener("click",i),t.clickOutsideHandler=i}},closeProfile(){const s=document.getElementById("profileModal");if(s){s.style.display="none",s.classList.remove("active"),s.keydownHandler&&(document.removeEventListener("keydown",s.keydownHandler),s.keydownHandler=null),s.clickOutsideHandler&&(s.removeEventListener("click",s.clickOutsideHandler),s.clickOutsideHandler=null);const e=document.querySelector(".floating-action-bar"),t=document.querySelector(".floating-action-bar-backdrop");e&&(e.style.display=""),t&&(t.style.display="")}},closeStatDetails(){const s=document.querySelector(".stat-detail-modal"),e=document.querySelector(".stat-expanded"),t=document.querySelector(".stat-backdrop");s&&(s.style.display="none",s.remove()),e&&e.classList.remove("expanded"),t&&t.remove(),this.statDetailsKeydownHandler&&(document.removeEventListener("keydown",this.statDetailsKeydownHandler),this.statDetailsKeydownHandler=null)},handleLogout(){this.closeProfileDropdown(),window.chatbox&&window.chatbox.clear&&window.chatbox.clear(),typeof window.logout=="function"&&window.logout()},async loadUserNickname(){try{const{data:{user:s}}=await window.supa.auth.getUser();if(!s)return;const e=document.getElementById("userNickname");if(e){const t=s.user_metadata?.first_name||s.email?.split("@")[0]||"Bruker";e.textContent=t}window.chatbox&&window.chatbox.updatePlaceholder&&window.chatbox.updatePlaceholder()}catch(s){console.error("Error loading user nickname:",s);const e=document.getElementById("userNickname");e&&(e.textContent="Bruker"),window.chatbox&&window.chatbox.updatePlaceholder&&window.chatbox.updatePlaceholder()}},saveToLocalStorage(){try{const s={usePreset:this.usePreset,customWage:this.customWage,currentWageLevel:this.currentWageLevel,customBonuses:this.customBonuses,pauseDeduction:this.pauseDeduction,pauseDeductionEnabled:this.pauseDeductionEnabled,pauseDeductionMethod:this.pauseDeductionMethod,pauseThresholdHours:this.pauseThresholdHours,pauseDeductionMinutes:this.pauseDeductionMinutes,auditBreakCalculations:this.auditBreakCalculations,fullMinuteRange:this.fullMinuteRange,directTimeInput:this.directTimeInput,hasSeenRecurringIntro:this.hasSeenRecurringIntro,currencyFormat:this.currencyFormat,defaultShiftsView:this.defaultShiftsView,taxDeductionEnabled:this.taxDeductionEnabled,taxPercentage:this.taxPercentage,isWageCaregiver:this.isWageCaregiver};localStorage.setItem("lønnsberegnerSettings",JSON.stringify(s))}catch(s){console.error("Error saving to localStorage",s)}},getCurrentWageRate(){return this.usePreset?this.PRESET_WAGE_RATES[this.currentWageLevel]:this.customWage},getWageRateForShift(s){const e=Number(s?.hourly_wage_snapshot);return!Number.isNaN(e)&&e>0?e:this.getCurrentWageRate()},getCurrentBonuses(){if(this.usePreset)return this.PRESET_BONUSES;{const s=this.customBonuses||{};return{weekday:s.weekday||[],saturday:s.saturday||[],sunday:s.sunday||[]}}},refreshUI(s){console.log("Refreshing all UI components after shift changes"),this.showUIRefreshLoading(),setTimeout(()=>{try{this.renderShiftTable(s),this.updateWeekCards(s),this.updatePayrollCard(s),this.updateStats(),this.updateWeeklyHoursChart(),this.updateShiftCalendar(),this.updateNextShiftCard(),this.populateDateGrid(),this.updateHeader(),this.startNextShiftTimer(),console.log("UI refresh completed successfully")}catch(e){console.error("Error during UI refresh:",e)}finally{this.hideUIRefreshLoading()}},50)},updateDisplay(s=!1){this.updateHeader(),this.updateNextShiftCard(),this.updateNextPayrollCard(),this.updateStats(s),this.updateWeeklyHoursChart(),this.updateShiftList(),this.updateShiftCalendar(),this.populateDateGrid(),this.startNextShiftTimer(),this.currentView==="employees"&&(this.fetchAndDisplayEmployeeShifts?.(),this.renderEmployeeWorkSummary?.()),this.currentView==="stats"&&this.renderCurrentUserWorkSummary?.()},showUIRefreshLoading(){const s=document.querySelector(".dashboard-content"),e=document.querySelector(".statistics-content");if(s&&!s.querySelector(".refresh-loading-overlay")){const t=this.createLoadingOverlay("Oppdaterer...");t.classList.add("refresh-loading-overlay"),s.appendChild(t)}if(e&&!e.querySelector(".refresh-loading-overlay")){const t=this.createLoadingOverlay("Oppdaterer...");t.classList.add("refresh-loading-overlay"),e.appendChild(t)}},hideUIRefreshLoading(){document.querySelectorAll(".refresh-loading-overlay").forEach(e=>e.remove())},createLoadingOverlay(s="Laster..."){const e=document.createElement("div");e.className="loading-overlay",e.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: inherit;
        `;const t=document.createElement("div");t.className="loading-spinner",t.style.cssText=`
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
        `;const n=document.createElement("div");n.style.cssText=`
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        `;const i=document.createElement("span");return i.textContent=s,t.appendChild(n),t.appendChild(i),e.appendChild(t),e},renderShiftTable(s){this.updateShiftList()},updateWeekCards(s){const e=this.shifts.filter(n=>n.date.getMonth()===this.currentMonth-1&&n.date.getFullYear()===this.currentYear),t={};e.forEach(n=>{const i=this.getISOWeekNumber(n.date);t[i]||(t[i]={hours:0,earnings:0,shifts:[]});const o=this.calculateShift(n);t[i].hours+=o.hours,t[i].earnings+=o.total,t[i].shifts.push(n)}),this.updateWeeklyHoursChart(),console.log("Week cards updated with data for",Object.keys(t).length,"weeks")},updatePayrollCard(s){this.updateNextPayrollCard(),console.log("Payroll card updated via existing updateNextPayrollCard function")},updateHeader(){const s=this.MONTHS[this.currentMonth-1].charAt(0).toUpperCase()+this.MONTHS[this.currentMonth-1].slice(1);document.getElementById("currentMonth").textContent=`${s} ${this.currentYear}`;const e=document.getElementById("currentMonthDashboard");e&&(e.textContent=`${s} ${this.currentYear}`);const t=document.getElementById("monthNavDisplayNav");t&&(t.textContent=`${s} ${this.currentYear}`);const n=document.querySelector(".total-label");if(n){const i=new Date;this.currentMonth===i.getMonth()+1&&this.currentYear===i.getFullYear()?n.textContent="Brutto":n.textContent=`Brutto (${s.toLowerCase()})`}this.updateCurrentMonthLabel()},updateStats(s=!1){if(this.isInDrillDownMode()){this.updateDrillDownStats(s);return}let e=0,t=0,n=0;const i=this.shifts.filter(v=>v.date.getMonth()===this.currentMonth-1&&v.date.getFullYear()===this.currentYear);i.forEach(v=>{const g=this.calculateShift(v);e+=g.hours,t+=g.baseWage,n+=g.bonus});const o=t+n,r=this.taxDeductionEnabled?o*(1-this.taxPercentage/100):o,a=document.getElementById("totalAmount"),l=document.getElementById("totalHours");a&&(a.textContent=this.formatCurrency(r)),l&&(l.textContent=e.toFixed(1));const c=document.getElementById("shiftCount");c&&(c.textContent=i.length);const d=document.querySelector(".shifts-count-label");d&&(d.textContent="vakter");const u=document.getElementById("totalSecondaryInfo");u&&(this.taxDeductionEnabled?u.innerHTML=`
                    <div class="secondary-info-content">
                        <span class="bonus-amount">${this.formatCurrency(o)}</span>
                        <span class="before-tax-text">før skatt</span>
                    </div>
                `:u.innerHTML=`
                    <div class="secondary-info-content">
                        <span class="bonus-amount">${this.formatCurrency(n)}</span>
                        <span class="before-tax-text">i tillegg</span>
                    </div>
                `);const h=document.getElementById("headerShiftCount");h&&(h.textContent=i.length),this.updateLastUpdatedTime();const m=document.querySelector(".total-label");if(m){const v=this.taxDeductionEnabled?"Netto":"Brutto",g=this.currentMonth===1?12:this.currentMonth-1,S=this.currentMonth===1?this.currentYear-1:this.currentYear,b=this.shifts.filter(k=>k.date.getMonth()===g-1&&k.date.getFullYear()===S);let p=0;b.forEach(k=>{p+=this.calculateShift(k).total});const y=this.taxDeductionEnabled?p*(1-this.taxPercentage/100):p;let _=0;if(y>0&&(_=(r-y)/y*100),Math.abs(_)>.1){const k=_>=0?"▲":"▼",w=this.MONTHS[g-1];m.textContent=`${v} ${k} ${Math.abs(_).toFixed(1)}% vs. ${w}`}else m.textContent=v}const f=vt();ps(r,f,s)},updateDrillDownStats(s=!1){const{totalCurrentMonthHours:e,totalCurrentMonthEarnings:t,totalWeekHours:n,totalWeekEarnings:i}=this.getDailyDataForWeek(this.selectedWeek),o=n>e||i>t,r=this.shifts.filter(v=>v.date.getMonth()===this.currentMonth-1&&v.date.getFullYear()===this.currentYear);let a=0;r.forEach(v=>{const g=this.calculateShift(v);a+=g.hours}),document.getElementById("totalHours").textContent=e.toFixed(2);const l=document.querySelector(".chart-hours-value-card");if(l)if(o){const v=n-e,g=`Kun timer for ${this.MONTHS[this.currentMonth-1]} er med i utregningen. Ekskludert: ${v.toFixed(1)} timer fra andre måneder.`;l.classList.add("has-tooltip"),l.setAttribute("data-tooltip",g),this.setupWageCardTooltip(l)}else l.classList.remove("has-tooltip"),l.removeAttribute("data-tooltip"),this.removeWageCardTooltip(l);const c=document.getElementById("shiftCount"),d=document.querySelector(".shifts-count-label"),u=document.querySelector(".chart-shifts-count-card");if(c&&d&&u){const v=this.taxDeductionEnabled?t*(1-this.taxPercentage/100):t;if(c.textContent=this.formatCurrency(v).replace(" kr",""),d.textContent="kroner",o){const g=n-e,S=i-t,b=this.taxDeductionEnabled?S*(1-this.taxPercentage/100):S,p=`Kun vakter for ${this.MONTHS[this.currentMonth-1]} er med i utregningen. Ekskludert: ${g.toFixed(1)} timer (${this.formatCurrency(b)}) fra andre måneder.`;u.classList.add("has-tooltip"),u.setAttribute("data-tooltip",p),this.setupWageCardTooltip(u)}else u.classList.remove("has-tooltip"),u.removeAttribute("data-tooltip"),this.removeWageCardTooltip(u)}const h=a>0?e/a*100:0,m=document.querySelector(".chart-progress-label");if(m){const v=h<10?h.toFixed(1):Math.round(h);m.textContent=`${v}% av ${a.toFixed(1)} timer`}const f=document.querySelector(".chart-progress-fill");if(f){const v=Math.min(h,100);s?requestAnimationFrame(()=>{f.style.transition="width 0.8s cubic-bezier(0.4, 0, 0.2, 1)",f.style.width=v+"%"}):(f.style.transition="none",f.style.width=v+"%",f.offsetHeight,f.style.transition="width 0.8s cubic-bezier(0.4, 0, 0.2, 1)"),h>=100?f.classList.add("full"):f.classList.remove("full"),h>0?f.classList.add("active"):f.classList.remove("active")}},setupWageCardTooltip(s){if(!s||s.hasTooltipListener)return;const e=document.getElementById("wageCardTooltip");if(!e)return;const t=i=>{const o=s.getAttribute("data-tooltip");if(!o)return;const r=document.getElementById("wageTooltipContent");r&&(r.textContent=o);const a=s.getBoundingClientRect(),l=window.innerWidth,c=window.innerHeight,d=document.querySelector(".chart-stats-section")||document.querySelector(".chart-hours-section")||s.closest(".weekly-hours-chart-card"),u=d?d.getBoundingClientRect():a,m=l>768?Math.min(240,u.width-32):Math.min(280,l-32),f=70,v=12,g=document.querySelector(".chart-hours-value-card"),S=document.querySelector(".chart-shifts-count-card");let b=a.left+a.width/2-m/2,p;if(g&&S){const I=g.getBoundingClientRect(),P=S.getBoundingClientRect().top-I.bottom,C=I.bottom+P/2-f/2;P>=f+v*2?p=C:p=I.bottom+v}else p=a.top-f-v;const y=u.left+v,_=u.right-v;b<y?b=y:b+m>_&&(b=_-m),p<v&&(p=v),p+f>c-v&&(p=c-f-v);const k=document.querySelector(".back-button");if(k){const I=k.getBoundingClientRect();p+f>I.top-v&&(p=I.top-f-v,p<v&&g&&(p=g.getBoundingClientRect().top-f-v,p<v&&(p=v)))}const E=e.parentElement.getBoundingClientRect(),x=b-E.left,T=p-E.top;e.style.left=`${x}px`,e.style.top=`${T}px`,e.classList.add("show"),s.classList.add("tooltip-active")},n=()=>{e.classList.remove("show"),s.classList.remove("tooltip-active")};s.addEventListener("click",i=>{i.stopPropagation(),s.classList.contains("tooltip-active")?n():(document.querySelectorAll(".chart-hours-value-card.tooltip-active, .chart-shifts-count-card.tooltip-active").forEach(o=>{o!==s&&o.classList.remove("tooltip-active")}),t())}),s.hasTooltipListener=!0,s.wageTooltipHideFunction=n,this.wageTooltipGlobalListener||(this.wageTooltipGlobalListener=i=>{const o=i.target.closest(".chart-hours-value-card, .chart-shifts-count-card"),r=i.target.closest(".wage-card-tooltip");o||r||document.querySelectorAll(".chart-hours-value-card.tooltip-active, .chart-shifts-count-card.tooltip-active").forEach(a=>{a.wageTooltipHideFunction&&a.wageTooltipHideFunction()})},document.addEventListener("click",this.wageTooltipGlobalListener))},removeWageCardTooltip(s){!s||!s.hasTooltipListener||(s.wageTooltipHideFunction&&s.wageTooltipHideFunction(),s.hasTooltipListener=!1,s.wageTooltipHideFunction=null)},updateWeeklyHoursChart(){const s=document.getElementById("chartBars"),e=document.getElementById("chartLabels"),t=document.getElementById("chartTooltip");if(!s||!e)return;if(this.isInDrillDownMode()){this.renderDailyChart(s,e,t);return}const n=this.shifts.filter(g=>g.date.getMonth()===this.currentMonth-1&&g.date.getFullYear()===this.currentYear),i={};let o=0;n.forEach(g=>{const S=this.getISOWeekNumber(g.date);i[S]||(i[S]={hours:0,earnings:0,shifts:[]});const b=this.calculateShift(g);i[S].hours+=b.hours,i[S].earnings+=b.total,i[S].shifts.push(g),o+=b.hours});const r=new Date(this.currentYear,this.currentMonth-1,1),a=new Date(this.currentYear,this.currentMonth,0),l=new Set;for(let g=new Date(r);g<=a;g.setDate(g.getDate()+1))l.add(this.getISOWeekNumber(g));const c=Array.from(l).sort((g,S)=>g-S);if(c.length===0){const g=new Date(this.currentYear,this.currentMonth-1,1),S=new Date(this.currentYear,this.currentMonth,0);for(let b=new Date(g);b<=S;b.setDate(b.getDate()+1)){const p=this.getISOWeekNumber(b);c.includes(p)||c.push(p)}c.sort((b,p)=>b-p)}const d=Math.max(...c.map(g=>i[g]?.hours||0),1),u=new Date,h=this.getISOWeekNumber(u),m=this.currentMonth===u.getMonth()+1&&this.currentYear===u.getFullYear(),f=c.reduce((g,S)=>{const b=i[S]?.hours||0,p=i[g]?.hours||0;return b>p?S:g},c[0]);this.removeBackButton(),this.clearAllTooltips(),s.innerHTML="",e.innerHTML="",s.style.setProperty("--total-weeks",c.length),e.style.setProperty("--total-weeks",c.length),s.offsetHeight;const v=()=>{t.classList.remove("show")};if(this.hideChartTooltip=v,c.forEach((g,S)=>{const b=i[g]||{hours:0,earnings:0},p=b.hours,y=b.earnings,_=d>0?p/d*100:0,k=o>0?p/o*100:0,w=document.createElement("div");w.className="chart-bar",p>0&&w.classList.add("has-data"),g===f&&p>0&&w.classList.add("highest"),m&&g===h?(w.classList.add("current-week"),w.setAttribute("aria-label",`Uke ${g} (Inneværende uke): ${p.toFixed(1)} timer, ${this.formatCurrency(y)}`)):w.setAttribute("aria-label",`Uke ${g}: ${p.toFixed(1)} timer, ${this.formatCurrency(y)}`);let E=136;window.innerWidth<=360?E=86:window.innerWidth<=480?E=102:window.innerWidth<=767?E=116:window.innerWidth>=768&&(E=150);const x=Math.max(2,_/100*E);w.style.setProperty("--bar-height",`${x}px`),w.setAttribute("data-week",g),w.setAttribute("data-hours",p.toFixed(1)),w.setAttribute("data-earnings",y.toFixed(0)),w.setAttribute("data-percentage",k.toFixed(1)),s.appendChild(w),requestAnimationFrame(()=>{w.style.animation="none",w.offsetHeight,w.style.animation="barGrowth 0.25s ease-out forwards"});const T=document.createElement("div");T.className="chart-bar-value";let I;if(p>0?window.innerWidth<=429?I=`${Math.round(p)}t`:I=`${p.toFixed(1)}t`:I="",T.textContent=I,w.appendChild(T),p>0){const P=this;w.addEventListener("click",C=>{C.stopPropagation(),v(),P.enterDrillDownMode(g)})}const D=document.createElement("div");D.className="chart-label",m&&g===h&&D.classList.add("current-week"),D.textContent=g.toString(),e.appendChild(D)}),d===0){const g=document.createElement("div");g.className="chart-empty-message",g.style.cssText=`
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: var(--text-secondary);
                font-size: 12px;
                font-weight: 500;
                opacity: 0.6;
                text-align: center;
                pointer-events: none;
            `,g.textContent="Ingen vakter registrert denne måneden",s.appendChild(g)}if(!this.chartTooltipGlobalListener){const g=this;this.chartTooltipGlobalListener=S=>{const b=document.querySelector(".chart-container"),p=S.target.closest(".chart-bar");S.target.closest(".chart-tooltip")||p||b&&!b.contains(S.target)&&g.hideChartTooltip&&g.hideChartTooltip()},document.addEventListener("click",this.chartTooltipGlobalListener)}},renderDailyChart(s,e,t){const{dailyData:n,totalWeekHours:i,totalWeekEarnings:o}=this.getDailyDataForWeek(this.selectedWeek);this.addBackButton();const r=this.getDaysWithShifts(this.selectedWeek);if(r.length===0){s.innerHTML='<div class="chart-empty-message" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-secondary); font-size: 12px; font-weight: 500; opacity: 0.6; text-align: center; pointer-events: none;">Ingen vakter denne uken</div>',e.innerHTML="";return}s.innerHTML="",e.innerHTML="",this.clearAllTooltips(),s.style.setProperty("--total-weeks",r.length),e.style.setProperty("--total-weeks",r.length),s.offsetHeight;const a=Math.max(...r.map(f=>n[f]?.hours||0),1),l=new Date;this.currentMonth===l.getMonth()+1&&(this.currentYear,l.getFullYear());const{startDate:c,endDate:d}=this.getWeekDateRange(this.selectedWeek,this.currentYear),u=["S","M","T","O","T","F","L"];let h=null;const m=()=>{t.classList.remove("show"),h&&(h.classList.remove("tooltip-active"),h=null)};this.hideChartTooltip=m,r.forEach((f,v)=>{const g=n[f],S=g.hours,b=g.earnings,p=a>0?S/a*100:0,y=document.createElement("div");y.className="chart-bar",y.classList.add("has-data"),g.hasAdjacentMonthShifts&&!g.hasCurrentMonthShifts&&y.classList.add("adjacent-month");const _=new Date(c);f===0?_.setDate(c.getDate()+6):_.setDate(c.getDate()+(f-1));const k=_.getDate()===l.getDate()&&_.getMonth()===l.getMonth()&&_.getFullYear()===l.getFullYear();k?(y.classList.add("current-week"),y.setAttribute("aria-label",`${this.WEEKDAYS[f]} (I dag): ${S.toFixed(2)} timer, ${this.formatCurrency(b)}`)):y.setAttribute("aria-label",`${this.WEEKDAYS[f]}: ${S.toFixed(2)} timer, ${this.formatCurrency(b)}`);let w=136;window.innerWidth<=360?w=86:window.innerWidth<=480?w=102:window.innerWidth<=767?w=116:window.innerWidth>=768&&(w=150);const E=Math.max(2,p/100*w);y.style.setProperty("--bar-height",`${E}px`),y.setAttribute("data-day",f),y.setAttribute("data-hours",S.toFixed(1)),y.setAttribute("data-earnings",b.toFixed(0)),s.appendChild(y),requestAnimationFrame(()=>{y.style.animation="none",y.offsetHeight,y.style.animation="barGrowth 0.25s ease-out forwards"});const x=document.createElement("div");x.className="chart-bar-value";let T;window.innerWidth<=429?T=`${S.toFixed(2)}t`:T=`${S.toFixed(2)}t`,x.textContent=T,y.appendChild(x);const I=M=>{const A=y.querySelector(".chart-bar-value"),j=y.getBoundingClientRect(),L=t.parentElement.getBoundingClientRect(),R=document.getElementById("tooltipContent");if(R){const pe=this.WEEKDAYS[f],Ie=g.date.toLocaleDateString("no-NO",{day:"numeric",month:"short"});R.innerHTML=`
                        <span class="chart-tooltip-line">${pe} ${Ie}</span>
                        <span class="chart-tooltip-line">${S.toFixed(2).replace(".",",")}t</span>
                        <span class="chart-tooltip-line">${this.formatCurrency(b)}</span>
                    `}const he=140,Ce=80,K=6;let W=null;A&&(W=A.getBoundingClientRect());let te;W?te=W.left-L.left+W.width/2-he/2:te=j.left-L.left+j.width/2-he/2,te=Math.max(K,Math.min(te,L.width-he-K));let q;W?q=W.top-L.top-Ce-K:q=j.top-L.top-Ce-K,q<K&&(W?q=W.bottom-L.top+K:q=j.bottom-L.top+K),t.style.left=`${te}px`,t.style.top=`${q}px`,t.classList.add("show"),y.classList.add("tooltip-active"),h=y};let D=0,P=null;y.addEventListener("click",M=>{if(M.stopPropagation(),D++,D===1)P=setTimeout(()=>{y.classList.contains("tooltip-active")?m():(h&&h!==y&&h.classList.remove("tooltip-active"),I()),D=0},300);else if(D===2){clearTimeout(P),D=0,console.log("Double-click detected on daily chart bar for day:",f),m();const A=g.shifts;A&&A.length>0?(console.log("Opening shift details for shift ID:",A[0].id),this.showShiftDetails(A[0].id)):console.log("No shifts found for this day")}});const C=document.createElement("div");C.className="chart-label",k&&C.classList.add("current-week"),C.textContent=u[f],e.appendChild(C)})},updateShiftList(){this.shifts.forEach((r,a)=>{});const s=document.getElementById("shiftList"),e=this.shifts.filter(r=>r.date.getMonth()===this.currentMonth-1&&r.date.getFullYear()===this.currentYear);if(e.length===0){s.innerHTML=`
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <p>Ingen vakter registrert ennå</p>
                </div>
            `;return}const t=e.sort((r,a)=>r.date-a.date),n={};t.forEach(r=>{const a=this.getISOWeekNumber(r.date);n[a]||(n[a]=[]),n[a].push(r)});const i=[];Object.keys(n).sort((r,a)=>r-a).forEach((r,a)=>{const l=n[r];let c=0;l.forEach(d=>{const u=this.calculateShift(d);c+=u.total}),i.push(`
                <div class="week-separator">
                    <div class="week-separator-line"></div>
                    <div class="week-separator-content">
                        <div class="week-separator-left">
                            <span class="week-separator-week">Uke ${r}</span>
                            <svg class="week-separator-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="week-separator-right">
                            <svg class="week-separator-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <span class="week-separator-total">${this.formatCurrency(c)}</span>
                        </div>
                    </div>
                    <div class="week-separator-line"></div>
                </div>
            `),l.forEach(d=>{const u=this.calculateShift(d),h=d.date.getDate(),m=this.WEEKDAYS[d.date.getDay()],f=d.type===0?"weekday":d.type===1?"saturday":"sunday",v=d.seriesId?'<span class="series-badge">Serie</span>':"",S=this.shiftHasOverlaps(d)?`
                    <span class="shift-warning-indicator" title="Denne vakten overlapper med andre vakter">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </span>
                `:"",b=new Date,y=d.date.getDate()===b.getDate()&&d.date.getMonth()===b.getMonth()&&d.date.getFullYear()===b.getFullYear()?" current-date":"",_=d.employee?`
                    <span class="employee-chip" style="background-color: ${d.employee.display_color||"#6b7280"}">
                        <span class="employee-chip-color" style="background-color: ${d.employee.display_color||"#6b7280"}"></span>
                        <span class="employee-chip-name">${d.employee.name}</span>
                    </span>
                `:"";i.push(`
                    <div class="shift-item ${f}${y}" data-shift-id="${d.id}" style="cursor: pointer;">
                        <div class="shift-info">
                            <div class="shift-date">
                                <span class="shift-date-number">${h}. ${this.MONTHS[d.date.getMonth()]}</span>
                                <span class="shift-date-separator"></span>
                                <span class="shift-date-weekday">${m}${v}${S}</span>
                            </div>
                            <div class="shift-details">
                                <div class="shift-time-with-hours">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span>${d.startTime} - ${d.endTime}</span>
                                    <span class="shift-time-arrow">→</span>
                                    <span>${this.formatHours(u.totalHours)}</span>
                                    ${_}
                                </div>
                            </div>
                        </div>
                        <div class="shift-amount-wrapper">
                            <div class="shift-total">${this.formatCurrency(u.total)}</div>
                            <div class="shift-breakdown">
                                ${this.formatCurrencyShort(u.baseWage)} + ${this.formatCurrencyShort(u.bonus)}
                            </div>
                        </div>
                    </div>
                `)})}),s.innerHTML=i.join("")},updateShiftCalendar(){if(this.shiftView!=="calendar")return;const s=this.getMonthShiftsKey();this.lastRenderedMonth!==this.currentMonth||this.lastRenderedYear!==this.currentYear||this.lastRenderedShiftsKey!==s?this.renderShiftCalendar():this.updateCalendarCells()},updateLastUpdatedTime(){const s=document.getElementById("lastUpdatedTime");if(s){const t=new Date().toLocaleTimeString("no-NO",{hour:"2-digit",minute:"2-digit"});s.textContent=t}},updateNextShiftCard(){const s=document.getElementById("nextShiftCard");if(!s)return;if(this.currentView==="employees"){s.style.display="none";return}const e=new Date,t=e.getMonth()+1,n=e.getFullYear();s.style.display="block";const i=document.getElementById("nextShiftContent");if(i&&!i.dataset.populated){const c=i.querySelector(".skeleton");c&&(c.style.display="block")}if(this.currentMonth!==t||this.currentYear!==n){this.displayBestShiftCard(),this.stopNextShiftTimer();return}const o=this.shifts.find(c=>{const d=new Date(c.date);if(d.toDateString()===e.toDateString()){const[u,h]=c.startTime.split(":").map(Number),[m,f]=c.endTime.split(":").map(Number),v=new Date(d);v.setHours(u,h,0,0);const g=new Date(d);return g.setHours(m,f,0,0),g<v&&g.setDate(g.getDate()+1),e>=v&&e<=g}return!1});if(o){this.displayCurrentShiftCard(o,e);return}const r=this.shifts.filter(c=>{const d=new Date(c.date);if(d>e)return!0;if(d.toDateString()===e.toDateString()){const[u,h]=c.startTime.split(":").map(Number),m=new Date(d);return m.setHours(u,h,0,0),m>e}return!1});r.sort((c,d)=>{const u=new Date(c.date),h=new Date(d.date);if(u.getTime()!==h.getTime())return u-h;const[m,f]=c.startTime.split(":").map(Number),[v,g]=d.startTime.split(":").map(Number);return m*60+f-(v*60+g)});const a=document.getElementById("nextShiftContent"),l=document.getElementById("nextShiftEmpty");if(r.length===0){const c=this.shifts.filter(d=>{const u=new Date(d.date);if(u<e)return!0;if(u.toDateString()===e.toDateString()){const[h,m]=d.endTime.split(":").map(Number),f=new Date(u);return f.setHours(h,m,0,0),h<parseInt(d.startTime.split(":")[0])&&f.setDate(f.getDate()+1),e>f}return!1});if(c.sort((d,u)=>{const h=new Date(d.date),m=new Date(u.date);if(h.getTime()!==m.getTime())return m-h;const[f,v]=d.endTime.split(":").map(Number),[g,S]=u.endTime.split(":").map(Number);return g*60+S-(f*60+v)}),c.length===0){a.style.display="none",l.style.display="flex";const d=l.querySelector(".empty-message");d&&(d.textContent="Ingen kommende vakter"),this.stopNextShiftTimer()}else{a.style.display="flex",l.style.display="none";const d=c[0],u=this.calculateShift(d),h=new Date(d.date),m=this.WEEKDAYS[h.getDay()],f=h.getDate(),v=this.MONTHS[h.getMonth()],g=d.seriesId?'<span class="series-badge">Serie</span>':"",S=this.getISOWeekNumber(e),b=this.getISOWeekNumber(h),p=S===b&&h.getFullYear()===e.getFullYear();let y;if(h.toDateString()===e.toDateString())y=`I dag${g}`;else{const E=new Date(e);E.setDate(e.getDate()+1),h.toDateString()===E.toDateString()?y=`I morgen${g}`:p?y=`${m.charAt(0).toUpperCase()+m.slice(1)}${g}`:y=`${f}. ${v}${g}`}const _=d.type===0?"weekday":d.type===1?"saturday":"sunday",w=this.shiftHasOverlaps(d)?`
                    <span class="shift-warning-indicator" title="Denne vakten overlapper med andre vakter">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </span>
                `:"";a.innerHTML=`
                    <div class="shift-item ${_}" data-shift-id="${d.id}" style="cursor: pointer; position: relative;">
                        <div class="next-shift-badge">Siste</div>
                        <div class="shift-info">
                            <div class="shift-date">
                                <span class="shift-date-weekday">${y}${w}</span>
                            </div>
                            <div class="shift-details">
                                <div class="shift-time-with-hours">
                                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span>${d.startTime} - ${d.endTime}</span>
                                    <span class="shift-time-arrow">→</span>
                                    <span>${this.formatHours(u.totalHours)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="shift-amount-wrapper">
                            <div class="shift-total">${this.formatCurrency(u.total)}</div>
                            <div class="shift-breakdown">
                                ${this.formatCurrencyShort(u.baseWage)} + ${this.formatCurrencyShort(u.bonus)}
                            </div>
                        </div>
                    </div>
                `,this.stopNextShiftTimer()}}else{a.style.display="flex",l.style.display="none";const c=a.querySelector(".skeleton");c&&(c.style.display="none"),a.dataset.populated="1";const d=r[0],u=this.calculateShift(d),h=new Date(d.date),m=this.WEEKDAYS[h.getDay()],f=h.getDate(),v=this.MONTHS[h.getMonth()],g=new Date(e),S=new Date(e);S.setDate(e.getDate()+1);const b=d.type===0?"weekday":d.type===1?"saturday":"sunday",p=d.seriesId?'<span class="series-badge">Serie</span>':"",y=this.getISOWeekNumber(e),_=this.getISOWeekNumber(h),k=y===_&&h.getFullYear()===e.getFullYear();let w;h.toDateString()===g.toDateString()?w=`I dag${p}`:h.toDateString()===S.toDateString()?w=`I morgen${p}`:k?w=`${m.charAt(0).toUpperCase()+m.slice(1)}${p}`:w=`${f}. ${v}${p}`;let E="";if(h.toDateString()===g.toDateString()){const[C,M]=d.startTime.split(":").map(Number),A=new Date(h);A.setHours(C,M,0,0);const j=A-e,re=Math.floor(j/(1e3*60*60)),L=Math.floor(j%(1e3*60*60)/(1e3*60)),R=Math.floor(j%(1e3*60)/1e3);re>0?E=` <span class="countdown-wrapper">(<span class="countdown-hours">${re}t</span> <span class="countdown-minutes">${L}m</span> <span class="countdown-seconds">${R}s</span>)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens"><span class="countdown-hours">${re}t</span> <span class="countdown-minutes">${L}m</span> <span class="countdown-seconds">${R}s</span></span>`:L>0?E=` <span class="countdown-wrapper">(<span class="countdown-minutes">${L}m</span> <span class="countdown-seconds">${R}s</span>)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens"><span class="countdown-minutes">${L}m</span> <span class="countdown-seconds">${R}s</span></span>`:R>0?E=` <span class="countdown-wrapper">(<span class="countdown-seconds">${R}s</span>)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens"><span class="countdown-seconds">${R}s</span></span>`:(E=' <span class="countdown-wrapper">(starter nå)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens">starter nå</span>',this.stopNextShiftTimer())}const T=this.shiftHasOverlaps(d)?`
                <span class="shift-warning-indicator" title="Denne vakten overlapper med andre vakter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </span>
            `:"",I=h.toDateString()===g.toDateString(),D=h.toDateString()===S.toDateString(),P=I||D?" active":"";a.innerHTML=`
                <div class="shift-item ${b}${P}" data-shift-id="${d.id}" style="cursor: pointer; position: relative;">
                    <div class="next-shift-badge">Neste</div>
                    <div class="shift-info">
                        <div class="shift-date">
                            <span class="shift-date-weekday">${w}${T}</span>
                            <span class="shift-countdown-timer">  ${E}</span>
                        </div>
                        <div class="shift-details">
                            <div class="shift-time-with-hours">
                                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span>${d.startTime} - ${d.endTime}</span>
                                <span class="shift-time-arrow">→</span>
                                <span>${this.formatHours(u.totalHours)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="shift-amount-wrapper">
                        <div class="shift-total">${this.formatCurrency(u.total)}</div>
                        <div class="shift-breakdown">
                            ${this.formatCurrencyShort(u.baseWage)} + ${this.formatCurrencyShort(u.bonus)}
                        </div>
                    </div>
                </div>
            `}},displayCurrentShiftCard(s,e){const t=document.getElementById("nextShiftContent"),n=document.getElementById("nextShiftEmpty");t.style.display="flex",n.style.display="none";const i=this.calculateCurrentShiftEarnings(s,e),o=this.calculateShift(s),r=new Date(s.date),a=this.WEEKDAYS[r.getDay()],l=r.getDate(),c=this.MONTHS[r.getMonth()],d=this.getISOWeekNumber(e),u=this.getISOWeekNumber(r),h=d===u&&r.getFullYear()===e.getFullYear();let m;r.toDateString()===e.toDateString()?m="I dag":h?m=`${a.charAt(0).toUpperCase()+a.slice(1)}`:m=`${l}. ${c}`;const[f,v]=s.startTime.split(":").map(Number),[g,S]=s.endTime.split(":").map(Number),b=new Date(r);b.setHours(f,v,0,0);const p=new Date(r);p.setHours(g,S,0,0),p<b&&p.setDate(p.getDate()+1);const y=p-e,_=Math.floor(y/(1e3*60*60)),k=Math.floor(y%(1e3*60*60)/(1e3*60)),w=Math.floor(y%(1e3*60)/1e3);let E="";_>0?E=`<span class="countdown-wrapper">(<span class="countdown-hours">${_}t</span> <span class="countdown-minutes">${k}m</span> <span class="countdown-seconds">${w}s</span>)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens"><span class="countdown-hours">${_}t</span><span class="countdown-minutes">${k}m</span><span class="countdown-seconds">${w}s</span></span>`:k>0?E=`<span class="countdown-wrapper">(<span class="countdown-minutes">${k}m</span> <span class="countdown-seconds">${w}s</span>)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens"><span class="countdown-minutes">${k}m</span><span class="countdown-seconds">${w}s</span></span>`:w>0?E=`<span class="countdown-wrapper">(<span class="countdown-seconds">${w}s</span>)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens"><span class="countdown-seconds">${w}s</span></span>`:E='<span class="countdown-wrapper">(Ferdig)</span><span class="countdown-dot-separator"> • </span><span class="countdown-no-parens">Ferdig</span>';const x=s.type===0?"weekday":s.type===1?"saturday":"sunday",T=s.seriesId?'<span class="series-badge">Serie</span>':"",D=this.shiftHasOverlaps(s)?`
            <span class="shift-warning-indicator" title="Denne vakten overlapper med andre vakter">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </span>
        `:"";t.innerHTML=`
            <div class="shift-item ${x} active" data-shift-id="${s.id}" style="cursor: pointer; position: relative;">
                <div class="next-shift-badge">NÅ</div>
                <div class="shift-info">
                    <div class="shift-date">
                        <span class="shift-date-weekday">${m}${T}${D}</span>
                        <span class="shift-countdown-timer">  ${E}</span>
                    </div>
                    <div class="shift-details">
                        <div class="shift-time-with-hours">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span>${s.startTime} - ${s.endTime}</span>
                            <span class="shift-time-arrow">→</span>
                            <span>${this.formatHours(o.totalHours)}</span>
                        </div>
                    </div>
                </div>
                <div class="shift-amount-wrapper">
                    <div class="shift-total">${this.formatCurrencyDetailed(i.totalEarned)}</div>
                    <div class="shift-breakdown">
                        ${this.formatCurrencyDetailed(i.baseEarned)} + ${this.formatCurrencyDetailed(i.bonusEarned)}
                    </div>
                </div>
            </div>
        `},calculateCurrentShiftEarnings(s,e){const t=new Date(s.date),[n,i]=s.startTime.split(":").map(Number),o=new Date(t);o.setHours(n,i,0,0);const a=(e-o)/(1e3*60*60),l=this.getWageRateForShift(s),d=typeof s?.hourly_wage_snapshot=="number"||!!s?.employee_id||!!s?.employee?this.PRESET_BONUSES:this.getCurrentBonuses(),u=s.type===0?"weekday":s.type===1?"saturday":"sunday",h=d[u]||[],m=a*l,f=`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`,v=this.calculateBonusWithSeconds(s.startTime,f,h);return{totalHours:a,baseEarned:m,bonusEarned:v,totalEarned:m+v}},startNextShiftTimer(){this.stopNextShiftTimer();const s=new Date,e=s.getMonth()+1,t=s.getFullYear();if(this.currentMonth===e&&this.currentYear===t){const n=new Date;this.shifts.filter(o=>{const r=new Date(o.date);if(r.toDateString()===n.toDateString()){const[a,l]=o.startTime.split(":").map(Number),[c,d]=o.endTime.split(":").map(Number),u=new Date(r);u.setHours(a,l,0,0);const h=new Date(r);return h.setHours(c,d,0,0),h<u&&h.setDate(h.getDate()+1),s>=u&&s<=h||u>s}return!1}).length>0&&(this.nextShiftTimer=setInterval(()=>{this.updateNextShiftCard()},1e3))}},stopNextShiftTimer(){this.nextShiftTimer&&(clearInterval(this.nextShiftTimer),this.nextShiftTimer=null)},displayBestShiftCard(){const s=document.getElementById("nextShiftContent"),e=document.getElementById("nextShiftEmpty");if(!s||!e)return;const t=this.shifts.filter(y=>y.date.getMonth()===this.currentMonth-1&&y.date.getFullYear()===this.currentYear);if(t.length===0){s.style.display="none",e.style.display="flex";const y=e.querySelector(".empty-message");y&&(y.textContent="Ingen vakter registrert");return}const n=t.map(y=>{const _=this.calculateShift(y);return{shift:y,earnings:_.total,calculation:_}});n.sort((y,_)=>{if(_.earnings!==y.earnings)return _.earnings-y.earnings;const k=new Date(y.shift.date),w=new Date(_.shift.date);if(k.getTime()!==w.getTime())return k-w;const[E,x]=y.shift.startTime.split(":").map(Number),[T,I]=_.shift.startTime.split(":").map(Number);return E*60+x-(T*60+I)});const i=n[0],o=i.shift,r=i.calculation;s.style.display="flex",e.style.display="none";const a=new Date(o.date),l=this.WEEKDAYS[a.getDay()],c=a.getDate(),d=this.MONTHS[a.getMonth()],u=new Date,h=this.getISOWeekNumber(u),m=this.getISOWeekNumber(a),f=h===m&&a.getFullYear()===u.getFullYear();let v;if(a.toDateString()===u.toDateString())v="I dag";else{const y=new Date(u);y.setDate(u.getDate()+1),a.toDateString()===y.toDateString()?v="I morgen":f?v=`${l.charAt(0).toUpperCase()+l.slice(1)}`:v=`${c}. ${d}`}const g=o.type===0?"weekday":o.type===1?"saturday":"sunday",S=o.seriesId?'<span class="series-badge">Serie</span>':"",p=this.shiftHasOverlaps(o)?`
            <span class="shift-warning-indicator" title="Denne vakten overlapper med andre vakter">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </span>
        `:"";s.innerHTML=`
            <div class="shift-item ${g}" data-shift-id="${o.id}" style="cursor: pointer; position: relative;">
                <div class="next-shift-badge">Beste</div>
                <div class="shift-info">
                    <div class="shift-date">
                        <span class="shift-date-weekday">${v}${S}${p}</span>
                    </div>
                    <div class="shift-details">
                        <div class="shift-time-with-hours">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span>${o.startTime} - ${o.endTime}</span>
                            <span class="shift-time-arrow">→</span>
                            <span>${this.formatHours(r.totalHours)}</span>
                        </div>
                    </div>
                </div>
                <div class="shift-amount-wrapper">
                    <div class="shift-total">${this.formatCurrency(r.total)}</div>
                    <div class="shift-breakdown">
                        ${this.formatCurrencyShort(r.baseWage)} + ${this.formatCurrencyShort(r.bonus)}
                    </div>
                </div>
            </div>
        `},updateNextPayrollCard(){const s=document.getElementById("nextPayrollCard");if(!s)return;const e=document.getElementById("nextPayrollContent"),t=document.getElementById("nextPayrollEmpty");if(!e||!t)return;if(this.currentView==="employees"){s.style.display="none";return}const n=e.querySelector(".skeleton");if(n&&!e.dataset.populated&&(n.style.display="block"),e&&!e.dataset.populated){const M=e.querySelector(".skeleton");M&&(M.style.display="block")}const i=this.currentMonth,o=this.currentYear,r=new Date,a=r.getMonth()+1,l=r.getFullYear(),c=i===a&&o===l;let d,u=i;c?(d=this.getNextPayrollDate(),u=d.getMonth()+1,d.getFullYear()):d=this.getPayrollDateForMonth(i,o);let h=i-1,m=o;h<1&&(h=12,m=o-1);let f=h,v=m;c&&u!==i&&(f=i,v=o);const g=this.shifts.filter(M=>M.date.getMonth()===f-1&&M.date.getFullYear()===v);if(g.length===0){e.style.display="none",t.style.display="flex";return}let S=0,b=0,p=0;g.forEach(M=>{const A=this.calculateShift(M);S+=A.total,b+=A.baseWage,p+=A.bonus});const y=this.taxDeductionEnabled?S*(1-this.taxPercentage/100):S,k=`Opptjent i ${this.MONTHS[f-1]}`,w=d.getDate(),E=this.MONTHS[d.getMonth()],x=`${w}. ${E}`;let T;if(c){const M=Math.ceil((d-r)/864e5);M===0?T="I dag":M===1?T="I morgen":T=`Om ${M} dager`}else T=x;const D=!(d<r)&&c&&Math.ceil((d-r)/(1e3*60*60*24))<=7?" active":"";e.style.display="flex",t.style.display="none";const P=e.querySelector(".skeleton");P&&(P.style.display="none"),e.dataset.populated="1",e.innerHTML=`
            <div class="payroll-item${D}" style="cursor: pointer; position: relative;">
                <div class="next-payroll-badge">Lønn</div>
                <div class="shift-info">
                    <div class="shift-date">
                        <span class="shift-countdown-timer">${k}</span>
                    </div>
                    <div class="shift-details">
                        <div class="shift-time-with-hours">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                            <span>${T}</span>
                        </div>
                    </div>
                </div>
                <div class="shift-amount-wrapper">
                    <div class="shift-total">${this.formatCurrency(y)}</div>
                    <div class="shift-breakdown">
                        ${this.taxDeductionEnabled?`${this.formatCurrencyShort(S)} - ${this.formatCurrencyShort(S-y)}`:`${this.formatCurrencyShort(b)} + ${this.formatCurrencyShort(p)}`}
                    </div>
                </div>
            </div>
        `;const C=e.querySelector(".payroll-item");C&&C.addEventListener("click",M=>{M.stopPropagation(),this.openPaydateSettings()})},cleanup(){this.stopNextShiftTimer(),this.monthNavigationTimeout&&(clearTimeout(this.monthNavigationTimeout),this.monthNavigationTimeout=null),this.chartTooltipGlobalListener&&(document.removeEventListener("click",this.chartTooltipGlobalListener),this.chartTooltipGlobalListener=null),this.wageTooltipGlobalListener&&(document.removeEventListener("click",this.wageTooltipGlobalListener),this.wageTooltipGlobalListener=null)},getPerformanceStats(){return{monthNavigationActive:!!this.monthNavigationTimeout,currentMonth:this.currentMonth,currentYear:this.currentYear}},renderShiftCalendar(){const s=document.getElementById("shiftCalendar");if(!s)return;const e=this.currentYear,t=this.currentMonth-1,n=new Date(e,t,1),i=new Date(e,t+1,0),o=new Date(n),r=n.getDay()===0?6:n.getDay()-1;o.setDate(o.getDate()-r),s.innerHTML="";const a=document.createElement("div");a.className="calendar-header",["M","T","O","T","F","L","S"].forEach(m=>{const f=document.createElement("div");f.textContent=m,f.className="calendar-day-header",a.appendChild(f)}),s.appendChild(a);const l=this.shifts.filter(m=>m.date.getMonth()===t&&m.date.getFullYear()===e),c={};l.forEach(m=>{const f=m.date.getDate();c[f]||(c[f]=[]),c[f].push(m)});const d=new Date(i),u=Math.ceil((d.getTime()-o.getTime())/(1e3*60*60*24))+1,h=Math.ceil(u/7);for(let m=0;m<h;m++){const f=new Date(o);f.setDate(o.getDate()+m*7);const v=this.getISOWeekNumber(f),g=document.createElement("div");g.className="week-separator";const S=document.createElement("div");S.className="week-number-on-separator",S.textContent=v,g.appendChild(S),s.appendChild(g);const b=document.createElement("div");b.className="calendar-grid";for(let p=0;p<7;p++){const y=new Date(o);y.setDate(o.getDate()+m*7+p);const _=document.createElement("div");_.className="calendar-cell";const k=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,"0")}-${String(y.getDate()).padStart(2,"0")}`;_.setAttribute("data-date",k),y.getMonth()!==t&&_.classList.add("other-month"),this.calendarDisplayMode==="hours"&&_.classList.add("hours-mode");const w=new Date;y.getDate()===w.getDate()&&y.getMonth()===w.getMonth()&&y.getFullYear()===w.getFullYear()&&_.classList.add("current-date");const E=document.createElement("div");E.className="calendar-cell-content";const x=document.createElement("div");x.className="calendar-day-number",x.textContent=y.getDate(),E.appendChild(x);const T=c[y.getDate()]||[];let I=0,D=0,P=0;if(T.forEach(C=>{if(y.getMonth()===t){const M=this.calculateShift(C);I+=M.baseWage,D+=M.bonus,P+=M.totalHours}}),this.calendarDisplayMode==="money"&&I+D>0||this.calendarDisplayMode==="hours"&&T.length>0){const C=document.createElement("div");if(C.className="calendar-shift-data",this.calendarDisplayMode==="money"){const L=document.createElement("div");L.className="calendar-total",L.textContent=this.formatCurrencyCalendar(I+D),C.appendChild(L)}else{const L=document.createElement("div");L.className="calendar-hours-display";let R=1/0,he=-1/0,Ce="",K="",W=!1;T.forEach(pe=>{const Ie=this.timeToMinutes(pe.startTime);let He=this.timeToMinutes(pe.endTime),wt=!1;He<Ie&&(He+=1440,wt=!0),Ie<R&&(R=Ie,Ce=pe.startTime),He>he&&(he=He,K=pe.endTime,W=wt)});let te=this.formatTimeShort(K);W&&(te+="*");const q=document.createElement("div");q.className="calendar-total calendar-hours-total",W&&(q.title="* indicates the shift ends the next day"),q.innerHTML=`${this.formatTimeShort(Ce)} -<br>${te}`,L.appendChild(q),C.appendChild(L)}const M=document.createElement("div");M.className="calendar-employee-chips";const A=new Map;T.forEach(L=>{L.employee&&!A.has(L.employee.id)&&A.set(L.employee.id,L.employee)}),A.forEach(L=>{const R=document.createElement("div");R.className="calendar-employee-chip",R.style.backgroundColor=L.display_color||"#6b7280",R.textContent=L.name.substring(0,2).toUpperCase(),R.title=L.name,M.appendChild(R)}),A.size>0&&E.appendChild(M),E.appendChild(C),_.classList.add("has-shifts"),_.style.cursor="pointer";let j=0,re=null;_.onclick=L=>{L.stopPropagation(),j++,j===1?re=setTimeout(()=>{T.length>0&&this.showShiftDetails(T[0].id),j=0},300):j===2&&(clearTimeout(re),j=0,console.log("Double-click detected on calendar cell with shifts"),T.length>0?(console.log("Opening shift details for shift ID:",T[0].id),this.showShiftDetails(T[0].id)):console.log("No shifts found for this calendar cell"))}}else y.getMonth()===t&&(_.classList.add("empty-date"),_.style.cursor="pointer",_.onclick=C=>{C.stopPropagation(),this.openAddShiftModalWithDate(y)});_.appendChild(E),b.appendChild(_)}s.appendChild(b)}this.lastRenderedMonth=this.currentMonth,this.lastRenderedYear=this.currentYear,this.lastRenderedShiftsKey=this.getMonthShiftsKey()},updateCalendarCells(){const s=document.querySelectorAll(".calendar-cell"),e=this.currentMonth-1,t=this.currentYear,n=this.shifts.filter(o=>o.date.getMonth()===e&&o.date.getFullYear()===t),i={};n.forEach(o=>{const r=o.date.getDate();i[r]||(i[r]=[]),i[r].push(o)}),s.forEach(o=>{const r=o.getAttribute("data-date");if(!r)return;const[a,l,c]=r.split("-").map(p=>parseInt(p,10)),d=new Date(a,l-1,c),u=o.querySelector(".calendar-cell-content");if(!u)return;const h=u.querySelector(".calendar-shift-data");h&&h.remove(),o.classList.remove("has-shifts","empty-date");const m=i[d.getDate()]||[],f=d.getMonth()===e,v=f?m:[];this.calendarDisplayMode==="hours"?o.classList.add("hours-mode"):o.classList.remove("hours-mode");let g=0,S=0,b=0;if(v.forEach(p=>{const y=this.calculateShift(p);g+=y.baseWage,S+=y.bonus,b+=y.totalHours}),this.calendarDisplayMode==="money"&&g+S>0||this.calendarDisplayMode==="hours"&&v.length>0){const p=document.createElement("div");if(p.className="calendar-shift-data",this.calendarDisplayMode==="money"){const k=document.createElement("div");k.className="calendar-total",k.textContent=this.formatCurrencyCalendar(g+S),p.appendChild(k)}else{const k=document.createElement("div");k.className="calendar-hours-display";let w=1/0,E=-1/0,x="",T="",I=!1;v.forEach(C=>{const M=this.timeToMinutes(C.startTime);let A=this.timeToMinutes(C.endTime),j=!1;A<M&&(A+=1440,j=!0),M<w&&(w=M,x=C.startTime),A>E&&(E=A,T=C.endTime,I=j)});let D=this.formatTimeShort(T);I&&(D+="*");const P=document.createElement("div");P.className="calendar-total calendar-hours-total",I&&(P.title="* indicates the shift ends the next day"),P.innerHTML=`${this.formatTimeShort(x)} -<br>${D}`,k.appendChild(P),p.appendChild(k)}u.appendChild(p),o.classList.add("has-shifts"),o.style.cursor="pointer";let y=0,_=null;o.onclick=k=>{k.stopPropagation(),y++,y===1?_=setTimeout(()=>{v.length>0&&this.showShiftDetails(v[0].id),y=0},300):y===2&&(clearTimeout(_),y=0,console.log("Double-click detected on updated calendar cell with shifts"),v.length>0?(console.log("Opening shift details for shift ID:",v[0].id),this.showShiftDetails(v[0].id)):console.log("No shifts found for this updated calendar cell"))}}else f?(o.classList.add("empty-date"),o.style.cursor="pointer",o.onclick=p=>{p.stopPropagation(),this.openAddShiftModalWithDate(d)}):(o.onclick=null,o.style.cursor="default")})},switchShiftView(s){this.shiftView=s,document.querySelectorAll(".view-toggle .tab-btn").forEach((o,r)=>{const a=r===0,l=s==="list"&&a||s==="calendar"&&!a;o.classList.toggle("active",l)});const t=document.getElementById("shiftList"),n=document.getElementById("shiftCalendar"),i=document.querySelector(".calendar-display-toggle");if(!(!t||!n)&&(s==="calendar"?(t.style.display="none",n.style.display="flex",i&&(i.style.display="flex"),this.updateShiftCalendar()):(t.style.display="flex",n.style.display="none",i&&(i.style.display="none")),this.currentView==="employees")){this.ensureMonthPickerVisibility?.();const o=document.querySelector(".employees-container");o&&(o.style.display="block");const r=document.getElementById("employeeCarouselContainer");r&&(r.style.display="block")}},switchCalendarDisplay(s){this.calendarDisplayMode=s,document.querySelectorAll(".calendar-toggle-btn").forEach(t=>{const n=s==="money"&&t.textContent==="Lønn"||s==="hours"&&t.textContent==="Varighet";t.classList.toggle("active",n)}),this.shiftView==="calendar"&&this.updateCalendarCells()},showShiftDetails(s){const e=this.shifts.find(E=>E.id===s);if(!e)return;this.closeStatDetails(),this.closeSettings(!1);const t=document.querySelector(".floating-action-bar"),n=document.querySelector(".floating-action-bar-backdrop");t&&(t.style.display="none"),n&&(n.style.display="none");const i=document.querySelector(".header");i&&i.classList.add("hidden");const o=document.createElement("div");o.className="backdrop-blur",o.onclick=()=>this.closeShiftDetails(),document.body.appendChild(o),o.offsetHeight,o.classList.add("active"),this.shiftDetailsKeydownHandler=E=>{E.key==="Escape"&&this.closeShiftDetails()},document.addEventListener("keydown",this.shiftDetailsKeydownHandler);const r=document.createElement("div");r.className="breakdown-modal shift-detail-modal",r.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: min(95vw, 500px);
            max-height: 85vh;
            background: var(--bg-primary);
            border-radius: 24px;
            box-shadow: 0 20px 60px var(--shadow-blue);
            z-index: 1200;
            opacity: 0;
            transition: all 0.4s var(--ease-default);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        `;const a=document.createElement("div");a.className="breakdown-title-container",a.style.cssText=`
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 24px 24px 0 24px;
            flex-shrink: 0;
        `;const l=document.createElement("div");l.className="breakdown-title-icon",l.innerHTML='<svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>',l.style.cssText=`
            color: var(--accent3);
            opacity: 0.8;
        `;const c=document.createElement("h3");c.className="breakdown-title",c.textContent="Vaktdetaljer",c.style.cssText=`
            color: var(--accent3);
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        `,a.appendChild(l),a.appendChild(c),r.appendChild(a);const d=document.createElement("div");d.className="shift-detail-content";const u=`
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 24px 24px 24px;
            padding-bottom: 80px;
            gap: 16px;
            overflow-y: auto;
        `,h=`
            opacity: 0;
            animation: slideInFromBottom 0.6s var(--ease-default) 0.3s forwards;
        `;d.style.cssText=`${h} ${u}`;const m=this.calculateShift(e),f=this.WEEKDAYS[e.date.getDay()],v=this.MONTHS[e.date.getMonth()],g=`${f} ${e.date.getDate()}. ${v}`,S=this.shifts.indexOf(e),b=this.getWageRateForShift(e);d.innerHTML=`
            <div class="detail-section">
                <div class="detail-label">Dato</div>
                <div class="detail-value">${g}</div>
            </div>

            <div class="detail-section">
                <div class="detail-label">Tid</div>
                <div class="detail-value">${e.startTime} - ${e.endTime} (${m.totalHours.toFixed(2)}t)</div>
            </div>

            <div class="detail-section">
                <div class="detail-label">Timelønn for denne vakten</div>
                <div class="detail-value">${this.formatCurrency(b)}</div>
            </div>

            <div class="detail-section">
                <div class="detail-label">Grunnlønn</div>
                <div class="detail-value accent">${this.formatCurrency(m.baseWage)}</div>
            </div>

            ${m.bonus>0?`
            <div class="detail-section">
                <div class="detail-label">Tillegg</div>
                <div class="detail-value accent">${this.formatCurrency(m.bonus)}</div>
            </div>
            `:""}

            <div class="detail-section total">
                <div class="detail-label">Total</div>
                <div class="detail-value accent large">${this.formatCurrency(m.total)}</div>
            </div>


        `,r.appendChild(d);const p=document.createElement("div");p.className="modal-fixed-footer",p.style.cssText=`
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-radius: 0 0 24px 24px;
        `;const y=document.createElement("div");y.style.cssText=`
            display: flex;
            gap: 12px;
            align-items: center;
        `;const _=document.createElement("button");_.className="btn btn-secondary edit-shift-btn",_.setAttribute("data-shift-id",e.id),_.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
        `,_.innerHTML=`
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Rediger
        `;const k=document.createElement("button");if(k.className="btn btn-danger delete-shift-btn",k.setAttribute("data-shift-index",S),k.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
        `,k.innerHTML=`
            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            Vakt
        `,_.addEventListener("click",E=>{E.stopPropagation();const x=E.target.closest("button").getAttribute("data-shift-id");this.editShift(x)}),k.addEventListener("click",async E=>{E.stopPropagation();const x=parseInt(E.target.closest("button").getAttribute("data-shift-index"));await this.deleteShift(x)&&this.closeShiftDetails()}),y.appendChild(_),y.appendChild(k),e.seriesId){const E=document.createElement("button");E.className="btn btn-warning delete-series-btn",E.style.cssText=`
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 12px 16px;
            `,E.innerHTML=`
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
                Serie
            `,E.addEventListener("click",async x=>{x.stopPropagation(),confirm("Vil du slette hele serien?")&&await this.deleteSeries(e.seriesId)&&this.closeShiftDetails()}),y.appendChild(E)}const w=document.createElement("button");w.className="btn btn-secondary modal-close-bottom",w.style.cssText=`
            background: rgba(255, 102, 153, 0.1);
            border: 1px solid rgba(255, 102, 153, 0.3);
            color: var(--danger);
            transition: all 0.2s var(--ease-default);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 0;
            font-weight: 500;
            padding: 0;
            gap: 0;
        `,w.innerHTML=`
            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        `,w.onclick=E=>{E.stopPropagation(),this.closeShiftDetails()},p.appendChild(y),p.appendChild(w),r.appendChild(p),document.body.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translate(-50%, -50%) scale(1)"})},closeShiftDetails(){const s=document.querySelector(".shift-detail-modal"),e=document.querySelector(".backdrop-blur"),t=document.querySelector(".header");t&&t.classList.remove("hidden"),this.shiftDetailsKeydownHandler&&(document.removeEventListener("keydown",this.shiftDetailsKeydownHandler),this.shiftDetailsKeydownHandler=null);const n=document.querySelector(".floating-action-bar"),i=document.querySelector(".floating-action-bar-backdrop");n&&(n.style.display=""),i&&(i.style.display=""),e&&(e.style.pointerEvents="none",e.onclick=null),s&&(s.style.opacity="0",s.style.transform="translate(-50%, -50%) scale(0.8)",setTimeout(()=>{s.parentNode&&s.remove()},300)),e&&setTimeout(()=>{e.classList.remove("active"),setTimeout(()=>{e.parentNode&&e.remove()},350)},100)},async deleteSeries(s){try{const{data:e,error:t}=await window.supa.from("user_shifts").delete().match({series_id:s});return t?(console.error("Feil ved sletting av serie:",t),alert("Kunne ikke slette serien"),!1):(this.userShifts=this.userShifts.filter(n=>n.seriesId!==s),this.shifts=this.shifts.filter(n=>n.seriesId!==s),this.updateDisplay(),alert("Serien er slettet"),!0)}catch(e){return console.error("deleteSeries error:",e),alert("En uventet feil oppstod"),!1}},async loadProfileData(){try{const{data:{user:s}}=await window.supa.auth.getUser();if(!s)return;const e=document.getElementById("profileName"),t=document.getElementById("profileEmail");e&&(e.value=s.user_metadata?.first_name||""),t&&(t.value=s.email||"");let n="";try{const{data:{session:l}}=await window.supa.auth.getSession(),c=l?.access_token;if(c){const d=await fetch(`${window.CONFIG.apiBase}/settings`,{headers:{Authorization:`Bearer ${c}`}});d.ok&&(n=(await d.json())?.profile_picture_url||"")}}catch{}if(!n)try{const{data:l}=await window.supa.from("user_settings").select("profile_picture_url").eq("user_id",s.id).maybeSingle();n=l?.profile_picture_url||""}catch{}n||(n=s.user_metadata?.avatar_url||"");const i=document.getElementById("profileAvatarImage"),o=document.getElementById("profileAvatarPlaceholder"),r=document.getElementById("userAvatarImg"),a=document.querySelector(".profile-icon");n&&i?(i.src=n,i.onload=()=>{i.style.display="block",o&&(o.style.display="none")},r&&(r.src=n,r.style.display="block"),a&&(a.style.display="none")):(i&&(i.style.display="none"),o&&(o.style.display=""),r&&(r.style.display="none"),a&&(a.style.display=""))}catch(s){console.error("Error loading profile data:",s)}},async updateProfile(){try{const{data:{user:s}}=await window.supa.auth.getUser();if(!s)return;const e=document.getElementById("profileName"),t=document.getElementById("profile-update-msg"),n=e?.value||"";if(!n.trim()){t&&(t.style.color="var(--danger)",t.textContent="Fornavn er påkrevd");return}const{error:i}=await window.supa.auth.updateUser({data:{first_name:n.trim()}});if(i){console.error("Error updating profile:",i),t&&(t.style.color="var(--danger)",t.textContent="Feil ved oppdatering av profil");return}t&&(t.style.color="var(--success)",t.textContent="Profil oppdatert!",setTimeout(()=>{t.textContent=""},3e3)),this.loadUserNickname()}catch(s){console.error("Error updating profile:",s);const e=document.getElementById("profile-update-msg");e&&(e.style.color="var(--danger)",e.textContent="Kunne ikke oppdatere profil")}},initProfileAvatarControls(){const s=document.getElementById("profileAvatarChooseBtn"),e=document.getElementById("profileAvatarRemoveBtn"),t=document.getElementById("profileAvatarInput");s&&t&&(s.onclick=()=>t.click()),t&&(t.onchange=async n=>{const i=n.target.files&&n.target.files[0];i&&(await this.openCropperWithFile(i),t.value="")}),e&&(e.onclick=()=>this.removeProfileAvatar())},async openCropperWithFile(s){try{const e=document.getElementById("cropModal"),t=document.getElementById("cropImage");if(!e||!t)return;this._cropObjectUrl&&(URL.revokeObjectURL(this._cropObjectUrl),this._cropObjectUrl=null);const n=URL.createObjectURL(s);this._cropObjectUrl=n,t.src=n,e.style.display="flex",e.classList.add("active"),await new Promise(a=>setTimeout(a,10)),this.cropper&&(this.cropper.destroy(),this.cropper=null);const i=window.Cropper||await(async()=>{try{const a=await z(()=>import("https://unpkg.com/cropperjs@1.6.2/dist/cropper.esm.js"),[]);return a?.default||a?.Cropper||null}catch{return null}})();if(!i)throw new Error("Cropper library not available");this.cropper=new i(t,{aspectRatio:1,viewMode:1,dragMode:"move",guides:!0,background:!1,autoCropArea:1,responsive:!0,checkOrientation:!1,movable:!0,zoomable:!0,scalable:!1,rotatable:!1,minCropBoxWidth:64,minCropBoxHeight:64,ready:()=>{const a=document.getElementById("cropZoomSlider");if(a){const d=this.cropper.getImageData().ratio||1;a.value=d,a.oninput=()=>this.cropper.zoomTo(parseFloat(a.value))}const l=document.getElementById("zoomInBtn"),c=document.getElementById("zoomOutBtn");l&&(l.onclick=()=>this.cropper.zoom(.05)),c&&(c.onclick=()=>this.cropper.zoom(-.05)),t.classList.add("loaded"),this.addMobileTouchEnhancements()}});const o=document.getElementById("confirmCropBtn"),r=document.getElementById("cancelCropBtn");o&&(o.onclick=()=>this.confirmAvatarCrop()),r&&(r.onclick=()=>this.cancelAvatarCrop())}catch(e){console.error("openCropperWithFile error",e),this.showUploadError("Kunne ikke åpne beskjæring")}},async confirmAvatarCrop(){try{if(!this.cropper)return;this.showProfilePictureProgress(!0),this.updateProfilePictureProgress(10,"Behandler...");const s=this.cropper.getCroppedCanvas({width:512,height:512,imageSmoothingQuality:"high"});if(!s)throw new Error("Canvas not available");const e=await new Promise(a=>s.toBlob(a,"image/jpeg",.9));if(!e)throw new Error("Kunne ikke lage bilde");this.updateProfilePictureProgress(30,"Lagrer...");const t=await this.saveAvatarBlob(e);this.updateProfilePictureProgress(90,"Oppdaterer profil...");try{const{data:{session:a}}=await window.supa.auth.getSession(),l=a?.access_token;l&&await fetch(`${window.CONFIG.apiBase}/settings`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({profile_picture_url:t})})}catch{}try{const{data:a}=await window.supa.auth.getClaims(),l=await Q();if(!l){console.warn("[auth] Missing userId, skipping query");return}if(console.debug("[auth] using userId:",l),l){const{error:c}=await window.supa.from("user_settings").update({profile_picture_url:t}).eq("user_id",l);c&&await window.supa.from("user_settings").upsert({user_id:l,profile_picture_url:t},{onConflict:"user_id"})}}catch{}await window.supa.auth.updateUser({data:{avatar_url:t}});const n=document.getElementById("profileAvatarImage"),i=document.getElementById("profileAvatarPlaceholder"),o=document.getElementById("userAvatarImg");n&&(n.onload=()=>{n.style.display="block"},n.onerror=()=>{n.style.display="none"},n.src=t),i&&(i.style.display="none"),o&&(o.onload=()=>{o.style.display="block"},o.onerror=()=>{o.style.display="none"},o.src=t);const r=document.querySelector(".profile-icon");r&&(r.style.display="none"),this.updateProfilePictureProgress(100,"Ferdig"),this.cancelAvatarCrop(!0)}catch(s){console.error("confirmAvatarCrop error",s),this.showUploadError("Kunne ikke lagre profilbilde")}finally{this.showProfilePictureProgress(!1)}},cancelAvatarCrop(s=!1){const e=document.getElementById("cropModal");if(this.cropper){try{this.cropper.destroy()}catch{}this.cropper=null}(!s&&e||e)&&(e.classList.remove("active"),e.style.display="none"),this._cropObjectUrl&&(URL.revokeObjectURL(this._cropObjectUrl),this._cropObjectUrl=null)},async saveAvatarBlob(s){try{const e=await new Promise((i,o)=>{const r=new FileReader;r.onload=()=>{const l=r.result.split(",")[1]||"";i(l)},r.onerror=()=>o(new Error("Kunne ikke lese bilde")),r.readAsDataURL(s)}),{data:{session:t}}=await window.supa.auth.getSession(),n=t?.access_token;if(n){const i=await fetch(`${window.CONFIG.apiBase}/user/avatar`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({image_base64:e})}),o=await i.json();if(i.ok&&o?.url)return o.url}}catch(e){console.warn("Backend upload failed; trying client storage.",e)}try{const{data:e}=await window.supa.auth.getClaims(),t=await Q();if(!t){console.warn("[auth] Missing userId, skipping query");return}if(console.debug("[auth] using userId:",t),!t)throw new Error("Ingen bruker");if(window.supa.storage&&window.supa.storage.from){const n=window.supa.storage.from("profile-pictures"),i=`${t}/profile_${Date.now()}.jpg`,{error:o}=await n.upload(i,s,{contentType:"image/jpeg",upsert:!0});if(o)throw o;const{data:r}=n.getPublicUrl(i);if(r?.publicUrl)return r.publicUrl}}catch(e){console.warn("Supabase Storage upload failed or not available; using data URL.",e)}return await new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=()=>t(new Error("Kunne ikke lese bilde")),n.readAsDataURL(s)})},async removeProfileAvatar(){try{try{const{data:{session:i}}=await window.supa.auth.getSession(),o=i?.access_token;o&&await fetch(`${window.CONFIG.apiBase}/settings`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({profile_picture_url:null})})}catch{}try{const{data:i}=await window.supa.auth.getClaims(),o=await Q();if(!o){console.warn("[auth] Missing userId, skipping query");return}console.debug("[auth] using userId:",o),o&&await window.supa.from("user_settings").update({profile_picture_url:null}).eq("user_id",o)}catch{}await window.supa.auth.updateUser({data:{avatar_url:null}});const s=document.getElementById("profileAvatarImage"),e=document.getElementById("profileAvatarPlaceholder"),t=document.getElementById("userAvatarImg");s&&(s.style.display="none"),e&&(e.style.display=""),t&&(t.style.display="none");const n=document.querySelector(".profile-icon");n&&(n.style.display="")}catch(s){console.error("removeProfileAvatar error",s),this.showUploadError("Kunne ikke fjerne profilbilde")}},showUploadError(s){this.showProfilePictureProgress(!1);const e=document.getElementById("profile-update-msg");e&&(e.style.color="var(--danger)",e.textContent=s,setTimeout(()=>{e.textContent=""},5e3))},showProfilePictureProgress(s){const e=document.getElementById("profilePictureProgress");e&&(e.style.display=s?"flex":"none")},updateProfilePictureProgress(s,e){const t=document.getElementById("profilePictureProgressFill"),n=document.getElementById("profilePictureProgressText");t&&(t.style.width=s+"%"),n&&(n.textContent=e)},addMobileTouchEnhancements(){if(!this.cropper)return;const s=document.querySelector("#cropModal .cropper-container");if(!s)return;let e=0,t=!1;const n=r=>{if(r.touches.length===2){t=!0;const a=r.touches[0],l=r.touches[1];e=Math.sqrt(Math.pow(l.clientX-a.clientX,2)+Math.pow(l.clientY-a.clientY,2)),r.preventDefault()}},i=r=>{if(t&&r.touches.length===2){const a=r.touches[0],l=r.touches[1],c=Math.sqrt(Math.pow(l.clientX-a.clientX,2)+Math.pow(l.clientY-a.clientY,2));if(e>0){const d=c/e,u=this.cropper.getCanvasData(),m=this.cropper.getImageData()?.naturalWidth||1,f=u.width/m,v=Math.max(.2,Math.min(3,f*d));this.cropper.zoomTo(v);const g=document.getElementById("cropZoomSlider");g&&(g.value=String(v))}e=c,r.preventDefault()}},o=r=>{r.touches.length<2&&(t=!1,e=0)};if(s.addEventListener("touchstart",n,{passive:!1}),s.addEventListener("touchmove",i,{passive:!1}),s.addEventListener("touchend",o,{passive:!1}),this.touchEventListeners={touchstart:n,touchmove:i,touchend:o,element:s},"vibrate"in navigator){const r=this.cropper.crop.bind(this.cropper);this.cropper.crop=(...a)=>(navigator.vibrate(10),r(...a))}s.style.touchAction="none",s.style.userSelect="none",s.style.webkitUserSelect="none"},removeMobileTouchEnhancements(){if(this.touchEventListeners){const{element:s,touchstart:e,touchmove:t,touchend:n}=this.touchEventListeners;s.removeEventListener("touchstart",e),s.removeEventListener("touchmove",t),s.removeEventListener("touchend",n),this.touchEventListeners=null}},calculateShift(s){const e=this.timeToMinutes(s.startTime);let t=this.timeToMinutes(s.endTime);t<e?t+=1440:t===e&&(console.warn("Shift has same start and end time",{startTime:s.startTime,endTime:s.endTime}),t+=1440);const n=(t-e)/60;if(n<=0)return console.error("Invalid shift duration",{startTime:s.startTime,endTime:s.endTime,durationHours:n}),{hours:0,totalHours:0,paidHours:0,pauseDeducted:!1,baseWage:0,bonus:0,total:0,breakDeduction:null};const i=this.getWageRateForShift(s),o=this.getCurrentBonuses(),r=this.calculateLegalBreakDeduction(s,i,o,e,t);let a=n,l=t,c=0,d=0;if(r.shouldDeduct&&(r.method==="proportional"||r.method==="base_only")){const u=this.calculateAdjustedWages(r,i);c=u.baseWage,d=u.bonus,a=u.totalHours}else{r.shouldDeduct&&(a-=r.deductionHours,l=r.adjustedEndMinutes),c=a*i;const u=s.type===0?"weekday":s.type===1?"saturday":"sunday",h=o[u]||[],m=Math.floor(l/60)%24,f=`${String(m).padStart(2,"0")}:${(l%60).toString().padStart(2,"0")}`;d=this.calculateBonus(s.startTime,f,h),n>5.5&&console.log("Traditional calculation (client):",{method:r.method,originalHours:n,paidHours:a,baseWage:c,bonus:d,total:c+d})}return{hours:parseFloat(a.toFixed(2)),totalHours:parseFloat(n.toFixed(2)),paidHours:parseFloat(a.toFixed(2)),pauseDeducted:r.shouldDeduct,baseWage:c,bonus:d,total:c+d,breakDeduction:r.auditTrail}},calculateLegalBreakDeduction(s,e,t,n,i){const o=(i-n)/60,r={enabled:this.pauseDeductionEnabled!==!1,method:this.pauseDeductionMethod||"proportional",thresholdHours:this.pauseThresholdHours||5.5,deductionMinutes:this.pauseDeductionMinutes||30,auditEnabled:this.auditBreakCalculations!==!1};if(!r.enabled||o<=r.thresholdHours)return{shouldDeduct:!1,deductionHours:0,adjustedEndMinutes:i,auditTrail:r.auditEnabled?{originalDuration:o,thresholdHours:r.thresholdHours,method:r.method,reason:r.enabled?"Shift duration below threshold":"Break deduction disabled",wagePeriods:[],deductedHours:0,complianceNotes:[]}:null};const a=r.deductionMinutes/60,l=this.calculateWagePeriods(s,e,t,n,i);let c=null;switch(r.method){case"none":c={deductionHours:0,adjustedEndMinutes:i,deductionDetails:"No break deduction applied - paid pause"};break;case"proportional":c=this.applyProportionalDeduction(l,a,n,i);break;case"base_only":c=this.applyBaseOnlyDeduction(l,a,n,i);break;case"end_of_shift":default:c={deductionHours:a,adjustedEndMinutes:i-r.deductionMinutes,deductionDetails:"Break deducted from end of shift (legacy method)"};break}let d=null;return r.auditEnabled&&(d={originalDuration:o,thresholdHours:r.thresholdHours,method:r.method,deductionMinutes:r.deductionMinutes,wagePeriods:l,deductedHours:c.deductionHours,deductionDetails:c.deductionDetails,complianceNotes:[]},r.method==="end_of_shift"&&d.complianceNotes.push("WARNING: End-of-shift deduction may not comply with labor laws in all jurisdictions")),{shouldDeduct:r.method!=="none",deductionHours:c.deductionHours,adjustedEndMinutes:c.adjustedEndMinutes,method:r.method,auditTrail:d}},calculateWagePeriods(s,e,t,n,i){const o=[],r=d=>d===0?"sunday":d===6?"saturday":"weekday",a=(d,u,h)=>{if(u<=d)return;const m=t[h]||[];let f=[{start:d,end:u,bonuses:[]}];for(const v of m){const g=this.timeToMinutes(v.from);let S=this.timeToMinutes(v.to);S<=g&&(S+=1440);const b=Math.max(d,g),p=Math.min(u,S);if(p<=b)continue;const y=[];for(const _ of f){if(_.end<=b||_.start>=p){y.push(_);continue}_.start<b&&y.push({start:_.start,end:b,bonuses:[..._.bonuses]});const k=Math.max(_.start,b),w=Math.min(_.end,p);w>k&&y.push({start:k,end:w,bonuses:[..._.bonuses,v]}),_.end>p&&y.push({start:p,end:_.end,bonuses:[..._.bonuses]})}f=y}for(const v of f){const g=(v.end-v.start)/60;if(g<=0)continue;const S=v.bonuses.reduce((b,p)=>b+p.rate,0);o.push({startMinutes:v.start,endMinutes:v.end,durationHours:g,wageRate:e,bonusRate:S,totalRate:e+S,type:S>0?"bonus":"base",bonuses:v.bonuses})}},l=s?.date instanceof Date?s.date.getDay():s?.type===2?0:s?.type===1?6:1,c=Math.min(i,1440);if(a(n,c,r(l)),i>1440){const d=(l+1)%7;a(0,i-1440,r(d))}return o},testBreakDeductionMethods(){console.log("Testing break deduction methods...");const s={startTime:"16:00",endTime:"22:00",type:1},e=["proportional","base_only","end_of_shift","none"],t={};for(const r of e){const a=this.pauseDeductionMethod,l=this.pauseDeductionEnabled;this.pauseDeductionMethod=r,this.pauseDeductionEnabled=r!=="none";const c=this.calculateShift(s);t[r]={total:c.total,baseWage:c.baseWage,bonus:c.bonus,paidHours:c.paidHours,pauseDeducted:c.pauseDeducted},this.pauseDeductionMethod=a,this.pauseDeductionEnabled=l}console.table(t);const n=1400,i=Object.values(t).map(r=>r.total),o=Math.max(...i);return o>n?console.error("❌ DOUBLING DETECTED! Max total:",o,"Expected max:",n):console.log("✅ No doubling detected. Max total:",o,"Expected max:",n),t},async testBreakDeductionColumns(){const{data:s}=await window.supa.auth.getClaims();if(!!!s){console.log("❌ Not logged in");return}try{const{data:t,error:n}=await window.supa.from("user_settings").select("*").eq("user_id",user.id).single();if(n){console.error("❌ Error fetching settings:",n);return}const i=["pause_deduction_enabled","pause_deduction_method","pause_threshold_hours","pause_deduction_minutes","audit_break_calculations"]}catch(t){console.error("❌ Error checking columns:",t)}},applyProportionalDeduction(s,e,t,n){const i=(n-t)/60;let o=e,r=0;const a=[];for(const l of s){if(o<=0)break;const c=l.durationHours/i,d=Math.min(e*c,o);d>0&&(r+=d,o-=d,a.push(`${d.toFixed(2)}h from ${l.type} rate (${l.totalRate} kr/h)`))}return{deductionHours:r,adjustedEndMinutes:n-r*60,deductionDetails:`Proportional deduction: ${a.join(", ")}`}},applyBaseOnlyDeduction(s,e,t,n){let i=e,o=0;const r=s.filter(l=>l.bonusRate===0),a=[];if(r.length===0){const l=[...s].sort((u,h)=>u.bonusRate-h.bonusRate),c=l[0].bonusRate,d=l.filter(u=>u.bonusRate===c);for(const u of d){if(i<=0)break;const h=Math.min(u.durationHours,i);o+=h,i-=h,a.push(`${h.toFixed(2)}h from lowest bonus rate (${u.totalRate} kr/h)`)}}else for(const l of r){if(i<=0)break;const c=Math.min(l.durationHours,i);o+=c,i-=c,a.push(`${c.toFixed(2)}h from base rate (${l.wageRate} kr/h)`)}return{deductionHours:o,adjustedEndMinutes:n-o*60,deductionDetails:`Base-only deduction: ${a.join(", ")}`}},calculateAdjustedWages(s,e){let t=0,n=0,i=0;if(!s.auditTrail||!s.auditTrail.wagePeriods)return{baseWage:0,bonus:0,totalHours:0};const o=s.auditTrail.wagePeriods,r=s.method,a=s.deductionHours;if(r==="proportional"){const l=o.reduce((c,d)=>c+d.durationHours,0);for(const c of o){const d=c.durationHours/l,u=a*d,h=Math.max(0,c.durationHours-u);i+=h,t+=h*c.wageRate,n+=h*c.bonusRate}}else if(r==="base_only"){let l=a;const c=o.filter(u=>u.bonusRate===0),d=o.filter(u=>u.bonusRate>0);for(const u of c){const h=Math.min(u.durationHours,l),m=u.durationHours-h;l-=h,i+=m,t+=m*u.wageRate}for(const u of d)i+=u.durationHours,t+=u.durationHours*u.wageRate,n+=u.durationHours*u.bonusRate}return{baseWage:parseFloat(t.toFixed(2)),bonus:parseFloat(n.toFixed(2)),totalHours:parseFloat(i.toFixed(2))}},setupBreakDeductionEventListeners(){const s=document.getElementById("pauseDeductionEnabledToggle");s?s.addEventListener("change",i=>{this.pauseDeductionEnabled=i.target.checked,this.toggleBreakDeductionSections(),this.updateDisplay(),this.saveSettingsToSupabase()}):console.warn("pauseDeductionEnabledToggle element not found");const e=document.getElementById("pauseDeductionMethodSelect");e?e.addEventListener("change",i=>{this.pauseDeductionMethod=i.target.value,this.updateMethodExplanation(),this.updateDisplay(),this.saveSettingsToSupabase()}):console.warn("pauseDeductionMethodSelect element not found");const t=document.getElementById("pauseThresholdInput");t&&t.addEventListener("change",i=>{this.pauseThresholdHours=parseFloat(i.target.value)||5.5,this.updateDisplay(),this.saveSettingsToSupabase()});const n=document.getElementById("pauseDeductionMinutesInput");n&&n.addEventListener("change",i=>{this.pauseDeductionMinutes=parseInt(i.target.value)||30,this.updateDisplay(),this.saveSettingsToSupabase()})},toggleBreakDeductionSections(){const s=document.getElementById("pauseDeductionEnabledToggle");if(s){const e=s.closest(".form-group");e&&(this.pauseDeductionEnabled?e.classList.remove("break-settings-disabled"):e.classList.add("break-settings-disabled"))}},updateMethodExplanation(){["proportionalInfo","baseOnlyInfo","endOfShiftInfo","noneInfo"].forEach(n=>{const i=document.getElementById(n);i&&(i.style.display="none")});let e="proportionalInfo";switch(this.pauseDeductionMethod){case"proportional":e="proportionalInfo";break;case"base_only":e="baseOnlyInfo";break;case"end_of_shift":e="endOfShiftInfo";break;case"none":e="noneInfo";break}const t=document.getElementById(e);t&&(t.style.display="block")},timeToMinutes(s){const[e,t]=s.split(":").map(Number);return e*60+t},minutesToTime(s){const e=s%1440,t=Math.floor(e/60),n=e%60;return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},timeToSeconds(s){const e=s.split(":").map(Number),t=e[0],n=e[1],i=e[2]||0;return t*3600+n*60+i},calculateBonus(s,e,t){let n=0;const i=this.timeToMinutes(s);let o=this.timeToMinutes(e);o<=i&&(o+=1440);for(const r of t){const a=this.timeToMinutes(r.from);let l=this.timeToMinutes(r.to);l<=a&&(l+=1440);const c=this.calculateOverlap(i,o,a,l);n+=c/60*r.rate}return n},calculateBonusWithSeconds(s,e,t){let n=0;const i=this.timeToSeconds(s);let o=this.timeToSeconds(e);o<=i&&(o+=24*3600);for(const r of t){const a=this.timeToSeconds(r.from);let l=this.timeToSeconds(r.to);l<=a&&(l+=24*3600);const c=this.calculateOverlap(i,o,a,l);n+=c/3600*r.rate}return n},calculateOverlap(s,e,t,n){const i=Math.max(s,t),o=Math.min(e,n);return Math.max(0,o-i)},shiftsOverlap(s,e){const t=new Date(s.date),n=new Date(e.date),i=this.timeToMinutes(s.startTime);let o=this.timeToMinutes(s.endTime);const r=this.timeToMinutes(e.startTime);let a=this.timeToMinutes(e.endTime);if(o<i&&(o+=1440),a<r&&(a+=1440),t.getTime()===n.getTime())return this.calculateOverlap(i,o,r,a)>0;const l=new Date(t);if(l.setDate(l.getDate()+1),l.getTime()===n.getTime()&&o>1440)return o-1440>r;const c=new Date(n);return c.setDate(c.getDate()+1),c.getTime()===t.getTime()&&a>1440?a-1440>i:!1},getOverlappingShifts(s){return this.shifts.filter(e=>e.id===s.id?!1:this.shiftsOverlap(s,e))},shiftHasOverlaps(s){return this.getOverlappingShifts(s).length>0},testOverlapDetection(){console.log("Testing overlap detection...");const s={id:"test1",date:new Date("2024-01-15"),startTime:"09:00",endTime:"17:00",type:0},e={id:"test2",date:new Date("2024-01-15"),startTime:"16:00",endTime:"22:00",type:0},t={id:"test3",date:new Date("2024-01-15"),startTime:"23:00",endTime:"07:00",type:0},n={id:"test4",date:new Date("2024-01-16"),startTime:"06:00",endTime:"14:00",type:0};console.log("Shift1 and Shift2 overlap (same day):",this.shiftsOverlap(s,e)),console.log("Shift3 and Shift4 overlap (midnight crossing):",this.shiftsOverlap(t,n)),console.log("Shift1 and Shift4 overlap (no overlap):",this.shiftsOverlap(s,n)),console.log("Overlap detection test completed.")},addTestPayrollShifts(){console.log("Adding test payroll shifts...");const s=new Date,e=s.getMonth(),t=s.getFullYear(),n=e===0?11:e-1,i=e===0?t-1:t,o=[{id:"test-payroll-1",date:new Date(i,n,5),startTime:"09:00",endTime:"17:00",type:0,seriesId:null},{id:"test-payroll-2",date:new Date(i,n,12),startTime:"10:00",endTime:"18:00",type:0,seriesId:null},{id:"test-payroll-3",date:new Date(i,n,19),startTime:"08:00",endTime:"16:00",type:1,seriesId:null},{id:"test-payroll-4",date:new Date(i,n,26),startTime:"09:00",endTime:"17:00",type:0,seriesId:null}];o.forEach(r=>{this.shifts.push(r)}),console.log(`Added ${o.length} test shifts for payroll card testing`),this.updateDisplay()},addTestOverlappingShifts(){console.log("Adding test overlapping shifts...");const s=new Date,e=new Date(s);e.setDate(s.getDate()+1),[{id:"test-overlap-1",date:new Date(s),startTime:"09:00",endTime:"17:00",type:0,seriesId:null},{id:"test-overlap-2",date:new Date(s),startTime:"16:00",endTime:"22:00",type:0,seriesId:null},{id:"test-overlap-3",date:new Date(s),startTime:"23:00",endTime:"07:00",type:0,seriesId:null},{id:"test-overlap-4",date:new Date(e),startTime:"06:00",endTime:"14:00",type:0,seriesId:null}].forEach(n=>{this.shifts.push(n)}),this.refreshUI(),console.log("Test overlapping shifts added. Check the shift list for warning indicators.")},formatCurrency(s){const e=this.currencyFormat?" NOK":" kr";return Math.round(s).toLocaleString("nb-NO")+e},formatCurrencyShort(s){return Math.round(s).toLocaleString("nb-NO")},formatCurrencyCalendar(s){return Math.round(s).toLocaleString("nb-NO")},formatCurrencyDetailed(s){const e=this.currencyFormat?" NOK":" kr";return s.toFixed(2).replace(".",",")+e},renderEmployeeWorkSummary(){try{const s=document.getElementById("employeeWorkSummary")||document.getElementById("employeesContent");if(!s)return;const e=this.getSelectedEmployee?.();if(!e){s.id==="employeeWorkSummary"&&(s.innerHTML="");return}const t=this.orgSettings?.break_policy,n=t==="proportional_across_periods"?"proportional":t==="from_base_rate"?"base_only":t==="fixed_0_5_over_5_5h"?"end_of_shift":t==="none"?"none":this.pauseDeductionMethod,i=this.pauseDeductionMethod,o=this.pauseDeductionEnabled;let r=!1;const a=()=>{r||(this.pauseDeductionMethod=i,this.pauseDeductionEnabled=o,r=!0)};this.pauseDeductionMethod=n,this.pauseDeductionEnabled=!0;const l=(this.shifts||[]).filter(p=>p.employee_id===e.id&&p.date.getMonth()===this.currentMonth-1&&p.date.getFullYear()===this.currentYear),c=new Map,d=new Map,u=p=>{if(p==="23:59")return"24";const[y,_]=p.split(":");return _==="00"?`${parseInt(y,10)}`:`${y}:${_}`};for(const p of l){const y=this.timeToMinutes(p.startTime);let _=this.timeToMinutes(p.endTime);_<=y&&(_+=1440);const k=this.getWageRateForShift(p),w=this.PRESET_BONUSES,E=this.calculateLegalBreakDeduction(p,k,w,y,_);let x;if(E?.shouldDeduct&&(E.method==="proportional"||E.method==="base_only"))x=this.calculateAdjustedWages(E,k).totalHours;else{const D=(_-y)/60;x=E?.shouldDeduct?Math.max(0,D-(E.deductionHours||0)):D}const T=c.get(k)||{hours:0,rate:k,pay:0};T.hours+=x,T.pay=T.hours*T.rate,c.set(k,T);let I=[];if(E?.method==="end_of_shift"&&E.shouldDeduct?I=this.calculateWagePeriods(p,k,w,y,E.adjustedEndMinutes):E?.auditTrail?.wagePeriods&&E.auditTrail.wagePeriods.length>0?I=E.auditTrail.wagePeriods.map(D=>({...D})):I=this.calculateWagePeriods(p,k,w,y,_),E?.shouldDeduct&&E.method==="proportional"){const D=I.reduce((C,M)=>C+M.durationHours,0)||1,P=E.deductionHours||0;I=I.map(C=>{const M=P*(C.durationHours/D);return{...C,durationHours:Math.max(0,C.durationHours-M)}})}for(const D of I){if(!D||D.durationHours<=0)continue;const P=D.durationHours;for(const C of D.bonuses||[]){const M=`${C.from}-${C.to}|${C.rate}`,A=`UB ${u(C.from)}-${u(C.to)}`,j=d.get(M)||{label:A,rate:C.rate,hours:0,pay:0,sortKey:this.timeToMinutes(C.from)};j.hours+=P,j.pay=j.hours*j.rate,d.set(M,j)}}}const h=Array.from(c.values()).sort((p,y)=>p.rate-y.rate).map(p=>({label:"Grunnlønn",rate:p.rate,hours:p.hours,pay:p.pay,group:"base"})),m=Array.from(d.values()).sort((p,y)=>p.sortKey-y.sortKey||p.rate-y.rate).map(p=>({label:p.label,rate:p.rate,hours:p.hours,pay:p.pay,group:"ub"})),f=[...h,...m],v=f.map(p=>`
                <tr>
                    <td class="col-type">${p.label}</td>
                    <td class="col-rate">${this.formatCurrencyDetailed(p.rate)}</td>
                    <td class="col-hours">${p.hours.toFixed(2).replace(".",",")} t</td>
                    <td class="col-pay">${this.formatCurrencyDetailed(p.pay)}</td>
                </tr>
            `).join(""),g=h.reduce((p,y)=>p+y.hours,0),S=f.reduce((p,y)=>p+y.pay,0),b=`
                <div class="employee-work-summary-header">
                    <h3 style="margin:0 0 12px 0;">${e.name}</h3>
                </div>
                <div class="employee-work-summary-table-wrapper">
                    <table class="employee-work-summary-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Sats</th>
                                <th>Timer</th>
                                <th>Beløp</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${v||'<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);padding:16px;">Ingen vakter i valgt måned</td></tr>'}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td>Totalt</td>
                                <td></td>
                                <td>${g.toFixed(2).replace(".",",")} t</td>
                                <td>${this.formatCurrencyDetailed(S)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;s.id==="employeeWorkSummary"?s.innerHTML=b:s.innerHTML=`<div class="employee-work-summary" id="employeeWorkSummary">${b}</div>`,a()}catch(s){console.error("Error rendering employee work summary:",s);try{this.pauseDeductionMethod=this.pauseDeductionMethod??this.pauseDeductionMethod}finally{}}},renderCurrentUserWorkSummary(){try{const s=document.getElementById("weeklyHoursChart"),e=s?s.parentElement:null,t=document.querySelector(".statistics-content"),n=e||t;if(!n)return;let i=document.getElementById("currentUserWorkSummary");i?i.parentElement!==n&&(i.parentElement.removeChild(i),n.appendChild(i)):(i=document.createElement("div"),i.id="currentUserWorkSummary",i.style.marginTop="16px",n.appendChild(i));const o=(this.shifts||[]).filter(b=>b.date.getMonth()===this.currentMonth-1&&b.date.getFullYear()===this.currentYear);if(o.length===0){i.innerHTML=`
                    <div class="employee-work-summary">
                        <div class="employee-work-summary-header">
                            <h3 style="margin:0 0 12px 0;">${document.getElementById("userNickname")?.textContent||"Min oversikt"}</h3>
                        </div>
                        <div class="employee-work-summary-table-wrapper">
                            <table class="employee-work-summary-table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Sats</th>
                                        <th>Timer</th>
                                        <th>Beløp</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" style="text-align:center;color:var(--text-secondary);padding:16px;">Ingen vakter i valgt måned</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td>Totalt</td>
                                        <td></td>
                                        <td>0,00 t</td>
                                        <td>${this.formatCurrencyDetailed(0)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;return}const r=this.getCurrentBonuses(),a=new Map,l=new Map,c=b=>{if(b==="23:59")return"24";const[p,y]=b.split(":");return y==="00"?`${parseInt(p,10)}`:`${p}:${y}`};for(const b of o){const p=this.timeToMinutes(b.startTime);let y=this.timeToMinutes(b.endTime);y<=p&&(y+=1440);const _=this.getWageRateForShift(b),k=this.calculateLegalBreakDeduction(b,_,r,p,y);let w;if(k?.shouldDeduct&&(k.method==="proportional"||k.method==="base_only"))w=this.calculateAdjustedWages(k,_).totalHours;else{const T=(y-p)/60;w=k?.shouldDeduct?Math.max(0,T-(k.deductionHours||0)):T}const E=a.get(_)||{hours:0,rate:_,pay:0};E.hours+=w,E.pay=E.hours*E.rate,a.set(_,E);let x=[];if(k?.method==="end_of_shift"&&k.shouldDeduct?x=this.calculateWagePeriods(b,_,r,p,k.adjustedEndMinutes):k?.auditTrail?.wagePeriods&&k.auditTrail.wagePeriods.length>0?x=k.auditTrail.wagePeriods.map(T=>({...T})):x=this.calculateWagePeriods(b,_,r,p,y),k?.shouldDeduct&&k.method==="proportional"){const T=x.reduce((D,P)=>D+P.durationHours,0)||1,I=k.deductionHours||0;x=x.map(D=>{const P=I*(D.durationHours/T);return{...D,durationHours:Math.max(0,D.durationHours-P)}})}for(const T of x){if(!T||T.durationHours<=0)continue;const I=T.durationHours;for(const D of T.bonuses||[]){const P=`${D.from}-${D.to}|${D.rate}`,C=`UB ${c(D.from)}-${c(D.to)}`,M=l.get(P)||{label:C,rate:D.rate,hours:0,pay:0,sortKey:this.timeToMinutes(D.from)};M.hours+=I,M.pay=M.hours*M.rate,l.set(P,M)}}}const d=Array.from(a.values()).sort((b,p)=>b.rate-p.rate).map(b=>({label:"Grunnlønn",rate:b.rate,hours:b.hours,pay:b.pay,group:"base"})),u=Array.from(l.values()).sort((b,p)=>b.sortKey-p.sortKey||b.rate-p.rate).map(b=>({label:b.label,rate:b.rate,hours:b.hours,pay:b.pay,group:"ub"})),h=[...d,...u],m=h.map(b=>`
                <tr>
                    <td class="col-type">${b.label}</td>
                    <td class="col-rate">${this.formatCurrencyDetailed(b.rate)}</td>
                    <td class="col-hours">${b.hours.toFixed(2).replace(".",",")} t</td>
                    <td class="col-pay">${this.formatCurrencyDetailed(b.pay)}</td>
                </tr>
            `).join(""),f=d.reduce((b,p)=>b+p.hours,0),v=h.reduce((b,p)=>b+p.pay,0),S=`
                <div class="employee-work-summary">
                    <div class="employee-work-summary-header">
                        <h3 style="margin:0 0 12px 0;">${document.getElementById("userNickname")?.textContent||"Min oversikt"}</h3>
                    </div>
                    <div class="employee-work-summary-table-wrapper">
                        <table class="employee-work-summary-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Sats</th>
                                    <th>Timer</th>
                                    <th>Beløp</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${m||'<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);padding:16px;">Ingen vakter i valgt måned</td></tr>'}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>Totalt</td>
                                    <td></td>
                                    <td>${f.toFixed(2).replace(".",",")} t</td>
                                    <td>${this.formatCurrencyDetailed(v)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;i.innerHTML=S}catch(s){console.error("Error rendering current user work summary:",s)}},formatHours(s){return s.toFixed(2).replace(".",",")+"t"},formatTimeShort(s){const[e,t]=s.split(":");return t==="00"?e:s},updateWageLevel(s){this.currentWageLevel=parseInt(s),this.updateDisplay(),this.saveSettingsToSupabase()},updateCustomWage(s){this.customWage=parseFloat(s)||200,this.updateDisplay(),this.saveSettingsToSupabase()},captureCustomBonusesFromUI(){const s={};return["weekday","saturday","sunday"].forEach(t=>{s[t]=[];const n=document.getElementById(`${t}BonusSlots`);n&&n.querySelectorAll(".bonus-slot").forEach((o,r)=>{const a=o.querySelectorAll("input");if(a.length>=3){const l=a[0].value,c=a[1].value,d=a[2].value;s[t].push({from:l,to:c,rate:parseFloat(d)||0})}})}),s},async saveCustomBonuses(){const s=this.captureCustomBonusesFromUI(),e={};["weekday","saturday","sunday"].forEach(t=>{e[t]=[],s[t]&&s[t].forEach(n=>{n.from&&n.to&&n.rate&&!isNaN(n.rate)&&n.rate>0&&e[t].push({from:n.from,to:n.to,rate:parseFloat(n.rate)})})}),this.customBonuses=e,this.showSaveStatus("Lagrer tillegg...");try{this.updateDisplay(),await this.saveSettingsToSupabase(),this.saveToLocalStorage(),this.showSaveStatus("Tillegg lagret ✓"),alert("Tillegg lagret!")}catch(t){console.error("Error saving custom bonuses:",t),this.showSaveStatus("Feil ved lagring!"),alert("Feil ved lagring av tillegg!")}},async saveCustomBonusesSilent(){try{const s=this.captureCustomBonusesFromUI(),e={};["weekday","saturday","sunday"].forEach(t=>{e[t]=[],s[t]&&s[t].forEach(n=>{n.from&&n.to&&n.rate&&!isNaN(n.rate)&&n.rate>0&&e[t].push({from:n.from,to:n.to,rate:parseFloat(n.rate)})})}),this.customBonuses=e,this.updateDisplay(),await this.saveSettingsToSupabase(),this.saveToLocalStorage()}catch(s){console.error("Error in saveCustomBonusesSilent:",s)}},async deleteShift(s){const e=this.shifts[s];if(e.seriesId&&confirm("Denne vakten er del av en serie. Vil du slette hele serien?"))return await this.deleteSeries(e.seriesId);const t=this.shifts[s];if(!t||!t.id||!confirm("Er du sikker på at du vil slette denne vakten?"))return!1;try{const{data:n}=await window.supa.auth.getClaims();if(!!!n)return alert("Du er ikke innlogget"),!1;const{error:o}=await window.supa.from("user_shifts").delete().eq("id",t.id);if(o)return console.error("Error deleting shift:",o),alert("Kunne ikke slette vakt fra databasen"),!1;this.shifts.splice(s,1);const r=this.userShifts.findIndex(a=>a.id===t.id);return r!==-1&&this.userShifts.splice(r,1),this.refreshUI(this.shifts),!0}catch(n){return console.error("Error in deleteShift:",n),alert("En feil oppstod ved sletting av vakt"),!1}},async clearAllShifts(){if(confirm("Er du sikker på at du vil slette alle vakter? Dette kan ikke angres."))try{const{data:s}=await window.supa.auth.getClaims(),e=await Q();if(!e){console.warn("[auth] Missing userId, skipping query");return}if(console.debug("[auth] using userId:",e),!e)return;const{error:t}=await window.supa.from("user_shifts").delete().eq("user_id",e);if(t){console.error("Error deleting shifts:",t),alert("Kunne ikke slette vakter fra databasen");return}this.shifts=[],this.userShifts=[],this.updateDisplay(),window.chatbox&&window.chatbox.clear&&window.chatbox.clear(),alert("Alle vakter er slettet")}catch(s){console.error("Error in clearAllShifts:",s),alert("En feil oppstod ved sletting av vakter")}},async clearAllData(){if(confirm("Er du sikker på at du vil slette alle vakter og innstillinger? Dette kan ikke angres."))try{const{data:s}=await window.supa.auth.getClaims(),e=await Q();if(!e){console.warn("[auth] Missing userId, skipping query");return}if(console.debug("[auth] using userId:",e),!e)return;const{error:t}=await window.supa.from("user_shifts").delete().eq("user_id",e);t&&console.error("Error deleting shifts:",t);const{error:n}=await window.supa.from("user_settings").delete().eq("user_id",e);n&&console.error("Error deleting settings:",n),this.shifts=[],this.userShifts=[],this.setDefaultSettings(),this.updateSettingsUI(),this.updateDisplay(),window.chatbox&&window.chatbox.clear&&window.chatbox.clear(),alert("Alle data er slettet")}catch(s){console.error("Error in clearAllData:",s),alert("En feil oppstod ved sletting av data")}},editShift(s){const e=this.shifts.find(t=>t.id===s);if(!e){console.error("Shift not found:",s);return}this.editingShift=e,this.closeShiftDetails(),this.toggleEmployeeSelectorsVisibility(this.currentView==="employees"),setTimeout(()=>{this.openEditModal(e)},200)},openEditModal(s){const e=document.getElementById("editShiftModal");if(e){e.style.display="flex",e.classList.add("active"),this.populateEditForm(s),this.updateEmployeeAssignmentUIInEditModal?.(s);const t=document.querySelector(".header");t&&t.classList.add("hidden");const n=document.querySelector(".floating-action-bar"),i=document.querySelector(".floating-action-bar-backdrop");n&&(n.style.display="none"),i&&(i.style.display="none");const o=e.querySelector(".modal-backdrop");o&&(o.onclick=()=>this.closeEditShift());const r=a=>{a.key==="Escape"&&this.closeEditShift()};document.addEventListener("keydown",r),e.dataset.keydownHandler="attached"}},closeEditShift(){const s=document.getElementById("editShiftModal");if(s){s.style.display="none",s.classList.remove("active");const e=document.querySelector(".header");e&&e.classList.remove("hidden"),s.dataset.keydownHandler&&(document.removeEventListener("keydown",i=>{i.key==="Escape"&&this.closeEditShift()}),delete s.dataset.keydownHandler);const t=document.querySelector(".floating-action-bar"),n=document.querySelector(".floating-action-bar-backdrop");t&&(t.style.display=""),n&&(n.style.display=""),this.editingShift=null,this.editSelectedDate=null,document.getElementById("editShiftForm").reset(),document.querySelectorAll("#editDateGrid .date-cell").forEach(i=>{i.classList.remove("selected")})}},populateEditForm(s){this.populateEditTimeSelects(),this.populateEditDateGrid(),this.editSelectedDate=new Date(s.date);const[e,t]=s.startTime.split(":"),[n,i]=s.endTime.split(":");document.getElementById("editStartHour").value=e,document.getElementById("editStartMinute").value=t||"00",document.getElementById("editEndHour").value=n,document.getElementById("editEndMinute").value=i||"00",this.populateEmployeeSelectors();const o=document.getElementById("editEmployeeSelect");o&&s.employee_id&&(o.value=s.employee_id),setTimeout(()=>{const r=s.date.getDate(),a=document.querySelector(`#editDateGrid .date-cell[data-day="${r}"]`);a&&a.classList.add("selected")},100)},updateEmployeeAssignmentUIInEditModal(s){try{const e=document.getElementById("editShiftModal");if(!e)return;const t=e.querySelector("#editShiftForm");if(!t)return;const n=document.getElementById("editSelectedEmployeePill");if(n&&n.remove(),!(this.currentView==="employees"))return;const o=this.selectedEmployeeId||s?.employee_id||null,r=o&&this.employees.find(c=>c.id===o)||null,a=e.querySelector("#editEmployeeSelect"),l=a?.closest(".form-group")||a?.parentElement;if(l&&(l.style.display="none"),r){const c=document.createElement("div");c.id="editSelectedEmployeePill",c.className="selected-employee-pill",c.style.cssText="display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:9999px;background:var(--bg-secondary);border:1px solid var(--border-color);margin:8px 0;";const d=document.createElement("span");d.style.cssText=`width:10px;height:10px;border-radius:9999px;background:${this.getEmployeeDisplayColor?.(r)||r.display_color||"#999"};display:inline-block;`;const u=document.createElement("span");u.textContent=r.name,u.style.fontWeight="600",c.appendChild(d),c.appendChild(u),t.insertBefore(c,t.firstChild),a&&(a.value=r.id),c.dataset.boundEdit||(c.style.cursor="pointer",c.setAttribute("role","button"),c.setAttribute("tabindex","0"),c.title="Rediger ansatt",c.addEventListener("click",h=>{try{h.preventDefault(),h.stopPropagation()}catch{}this.showEditEmployeeModal(r)}),c.addEventListener("keydown",h=>{(h.key==="Enter"||h.key===" ")&&(h.preventDefault(),this.showEditEmployeeModal(r))}),c.dataset.boundEdit="1")}}catch(e){console.warn("updateEmployeeAssignmentUIInEditModal error:",e)}},populateEditTimeSelects(){if(this.directTimeInput)this.replaceEditTimeDropdownsWithInputs();else{this.ensureEditTimeDropdowns();const s=Array.from({length:24},(t,n)=>`<option value="${n.toString().padStart(2,"0")}">${n.toString().padStart(2,"0")}</option>`).join("");let e;this.fullMinuteRange?e=Array.from({length:60},(t,n)=>`<option value="${n.toString().padStart(2,"0")}">${n.toString().padStart(2,"0")}</option>`).join(""):e=["00","15","30","45"].map(t=>`<option value="${t}">${t}</option>`).join(""),document.getElementById("editStartHour").innerHTML='<option value="">Fra time</option>'+s,document.getElementById("editStartMinute").innerHTML='<option value="">Fra minutt</option>'+e,document.getElementById("editEndHour").innerHTML='<option value="">Til time</option>'+s,document.getElementById("editEndMinute").innerHTML='<option value="">Til minutt</option>'+e}},replaceEditTimeDropdownsWithInputs(){[{id:"editStartHour",placeholder:"Fra time (HH)"},{id:"editStartMinute",placeholder:"Fra minutt (MM)"},{id:"editEndHour",placeholder:"Til time (HH)"},{id:"editEndMinute",placeholder:"Til minutt (MM)"}].forEach(e=>{const t=document.getElementById(e.id);if(t&&t.tagName==="SELECT"){const n=t.value,i=document.createElement("input");i.type="text",i.id=e.id,i.className="form-control time-input",i.placeholder=e.placeholder,i.maxLength=2,i.pattern="[0-9]{2}",i.value=n,i.addEventListener("input",o=>{let r=o.target.value.replace(/\D/g,"");if(r.length>2&&(r=r.slice(0,2)),e.id.includes("Hour")){const a=parseInt(r);r.length===2&&a>23&&(r=r.slice(0,1))}else{const a=parseInt(r);r.length===2&&a>59&&(r=r.slice(0,1))}o.target.value=r}),i.addEventListener("blur",o=>{o.target.value.length===1&&(o.target.value="0"+o.target.value)}),t.replaceWith(i)}})},ensureEditTimeDropdowns(){["editStartHour","editStartMinute","editEndHour","editEndMinute"].forEach(e=>{const t=document.getElementById(e);if(t&&t.tagName==="INPUT"){t.value;const n=document.createElement("select");n.id=e,n.className="form-control",t.replaceWith(n)}})},populateEditDateGrid(){const s=document.getElementById("editDateGrid");if(!s)return;s.innerHTML="";const e=this.currentYear,t=this.currentMonth-1,n=new Date(e,t,1),i=new Date(n),o=n.getDay()===0?6:n.getDay()-1;i.setDate(i.getDate()-o);const r=this.shifts.filter(c=>c.date.getMonth()===t&&c.date.getFullYear()===e),a=new Set;r.forEach(c=>{a.add(c.date.getDate())});const l=document.createElement("div");l.textContent="",l.className="week-number header",s.appendChild(l),["M","T","O","T","F","L","S"].forEach(c=>{const d=document.createElement("div");d.textContent=c,d.style.cssText="font-weight:600;font-size:12px;color:var(--text-secondary);text-align:center;padding:8px;",s.appendChild(d)});for(let c=0;c<42;c++){if(c%7===0){const f=new Date(i);f.setDate(i.getDate()+c);const v=this.getISOWeekNumber(f),g=document.createElement("div");g.className="week-number",g.textContent=v,s.appendChild(g)}const d=new Date(i);d.setDate(i.getDate()+c);const u=document.createElement("div");u.className="date-cell";const h=document.createElement("div");if(h.className="date-cell-content",h.textContent=d.getDate(),d.getMonth()===t&&a.has(d.getDate())){const f=document.createElement("div");f.className="shift-indicator-dot",h.appendChild(f),u.classList.add("has-shift")}const m=new Date;if(d.getDate()===m.getDate()&&d.getMonth()===m.getMonth()&&d.getFullYear()===m.getFullYear()&&u.classList.add("current-date"),u.appendChild(h),u.dataset.day=d.getDate(),d.getMonth()!==t)u.classList.add("disabled");else{const f=d.getDay();f===0?u.classList.add("sunday"):f===6?u.classList.add("saturday"):u.classList.add("weekday"),u.addEventListener("click",()=>{document.querySelectorAll("#editDateGrid .date-cell").forEach(v=>v.classList.remove("selected")),u.classList.add("selected"),this.editSelectedDate=new Date(d)})}s.appendChild(u)}},async updateShift(){if(!this.editingShift){console.error("No shift being edited"),alert("Ingen vakt valgt for redigering");return}try{if(!this.editSelectedDate){alert("Vennligst velg en dato");return}const s=document.getElementById("editStartHour").value,e=document.getElementById("editStartMinute").value||"00",t=document.getElementById("editEndHour").value,n=document.getElementById("editEndMinute").value||"00";if(!s||!t){alert("Vennligst fyll ut arbeidstid");return}const i=`${this.editSelectedDate.getFullYear()}-${(this.editSelectedDate.getMonth()+1).toString().padStart(2,"0")}-${this.editSelectedDate.getDate().toString().padStart(2,"0")}`,o=`${s}:${e}`,r=`${t}:${n}`;if(this.currentView==="employees"){const{data:{session:g}}=await window.supa.auth.getSession();if(!g){alert("Du er ikke innlogget");return}const S={Authorization:`Bearer ${g.access_token}`,"Content-Type":"application/json"},b=document.getElementById("editEmployeeSelect"),p=b&&b.value||null,y={shift_date:i,start_time:o,end_time:r};p&&(y.employee_id=p);let _=this.editingShift?.id||null;if(!_){const w=this.editingShift?.date instanceof Date?`${this.editingShift.date.getFullYear()}-${String(this.editingShift.date.getMonth()+1).padStart(2,"0")}-${String(this.editingShift.date.getDate()).padStart(2,"0")}`:i,E=this.editingShift?.employee_id||p||this.selectedEmployeeId||null;if(!E){alert("Kunne ikke finne ansatt for vakten. Oppdater siden og prøv igjen.");return}const x=new URLSearchParams({from:w,to:w,limit:"200",employee_id:E,bust:String(Date.now())}),T=await fetch(`${window.CONFIG.apiBase}/employee-shifts?${x.toString()}`,{headers:S,cache:"no-store"});if(!T.ok){alert("Kunne ikke hente eksisterende vakt for oppdatering.");return}const{shifts:I=[]}=await T.json().catch(()=>({shifts:[]})),D=this.editingShift?.startTime,P=this.editingShift?.endTime;let C=I.find(M=>M.start_time===D&&M.end_time===P);if(!C&&I.length===1&&(C=I[0]),!C||!C.id){alert("Fant ikke vakten å oppdatere. Last inn på nytt og prøv igjen.");return}_=C.id}const k=await fetch(`${window.CONFIG.apiBase}/employee-shifts/${_}`,{method:"PUT",headers:S,body:JSON.stringify(y)});if(!k.ok){const w=await k.json().catch(()=>({}));console.error("updateShift (employee) failed:",w),alert(w.error||"Kunne ikke oppdatere vakt");return}await this.fetchAndDisplayEmployeeShifts?.(),this.closeEditShift(),alert("Vakt oppdatert!");return}const{data:a}=await window.supa.auth.getClaims();if(!!!a){alert("Feil ved autentisering");return}const c=this.editSelectedDate.getDay(),d=c===0?2:c===6?1:0,u={shift_date:i,start_time:o,end_time:r,shift_type:d,series_id:null},{data:h,error:m}=await window.supa.from("user_shifts").update(u).eq("id",this.editingShift.id).eq("user_id",user.id).select().single();if(m){console.error("updateShift: Database error when updating shift:",m),alert(`Kunne ikke oppdatere vakt i databasen: ${m.message}`);return}const f=this.editingShift;f.date=new Date(this.editSelectedDate),f.startTime=o,f.endTime=r,f.type=d,f.seriesId=null;const v=this.userShifts.findIndex(g=>g.id===f.id);v!==-1&&(this.userShifts[v]={...f}),this.shifts=[...this.userShifts],this.refreshUI(this.shifts),this.closeEditShift(),alert("Vakt oppdatert!")}catch(s){console.error("updateShift: Critical error:",s),alert(`En uventet feil oppstod: ${s.message}`)}},showRecurringIntroduction(){this.closeSettings(!1),this.closeAddShiftModal(),this.closeEditShift(),document.body.insertAdjacentHTML("beforeend",`
            <div id="recurringIntroModal" class="modal" style="display: flex;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">✨ Ny funksjon: Gjentakende vakter</h2>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="margin-bottom: 16px;">
                            <p style="margin-bottom: 12px; font-size: 15px;">Vi har lagt til en ny måte å legge inn faste vakter på!</p>

                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--accent); font-size: 14px;">Slik fungerer det:</h4>
                                <ul style="margin: 0; padding-left: 16px; line-height: 1.4; font-size: 14px; text-align: left;">
                                    <li>Trykk på "Legg til vakt"-knappen</li>
                                    <li>Velg "Gjentakende" i stedet for "Enkel"</li>
                                    <li>Bestem hvor ofte vakten gjentas</li>
                                    <li>Systemet legger til alle vaktene automatisk</li>
                                </ul>
                            </div>

                            <div style="background: var(--accent-light); padding: 12px; border-radius: 8px; border-left: 4px solid var(--accent);">
                                <p style="margin: 0; font-weight: 500; color: var(--text-primary); line-height: 1.4; font-size: 14px;">
                                    💡 <strong>Tips:</strong> Har du en fast vakt som gjentar seg?
                                    Bruk "Gjentakende" funksjonen så slipper du å legge inn den samme vakten gang på gang!
                                </p>
                            </div>
                        </div>

                        <div class="form-actions" style="margin-top: 16px;">
                            <button class="btn btn-primary" onclick="app.dismissRecurringIntro()" style="width: 100%; max-width: 200px; margin: 0 auto; display: block;">
                                Forstått, takk!
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `),this.recurringIntroKeyHandler=e=>{e.key==="Escape"&&this.dismissRecurringIntro()},document.addEventListener("keydown",this.recurringIntroKeyHandler)},async dismissRecurringIntro(){this.hasSeenRecurringIntro||(this.hasSeenRecurringIntro=!0,this.saveToLocalStorage(),await this.saveSettingsToSupabase());const s=document.getElementById("recurringIntroModal");s&&s.remove(),this.recurringIntroKeyHandler&&(document.removeEventListener("keydown",this.recurringIntroKeyHandler),this.recurringIntroKeyHandler=null)},checkAndShowRecurringIntro(){if(!this.hasSeenRecurringIntro&&(this.userShifts.length>0||this.userShifts.length===0)){const e=this.userShifts.length>0?1500:5e3;setTimeout(()=>{this.showRecurringIntroduction()},e)}},setupTabBarEventListeners(){document.querySelectorAll(".tab-bar .tab-btn[data-view]").forEach(e=>{e.addEventListener("click",t=>{const n=e.getAttribute("data-view");n&&this.switchToView(n)})})},switchToView(s){if(!new Set(["dashboard","stats","chatgpt","employees"]).has(s)){console.warn("switchToView: ignoring invalid view",s);return}if(document.querySelectorAll(".tab-btn").forEach(n=>{n.classList.toggle("active",n.getAttribute("data-view")===s)}),s!=="dashboard"){const n=document.querySelector(".total-card"),i=document.querySelector(".next-shift-card"),o=document.querySelector(".next-payroll-card"),r=document.querySelector(".dashboard-month-nav"),a=document.querySelector(".floating-action-bar");n&&(n.style.display="none"),i&&(i.style.display="none"),o&&(o.style.display="none"),r&&(r.style.display="none"),a&&(a.style.display="none")}switch(this.cleanupAllViews(),s){case"dashboard":this.showDashboardView();break;case"stats":this.showStatsView();break;case"chatgpt":this.showChatGPTView();break;case"employees":this.showEmployeesView();break}},cleanupAllViews(){document.body.classList.remove("stats-view","chatbox-view","employees-view"),this.employeeCarousel&&this.employeeCarousel.cleanup?.();const e=document.querySelector(".chatbox-container"),t=document.querySelector(".employees-container"),n=document.querySelector(".dashboard-stats-container");if(e){e.style.display="none";const i=document.getElementById("chatboxPill"),o=document.getElementById("chatboxExpandedContent"),r=document.getElementById("chatboxClose");i&&i.classList.remove("expanded"),o&&(o.style.display="none"),r&&(r.style.display="none")}if(t&&(t.style.display="none"),n){const i=document.getElementById("weeklyHoursChart"),o=document.querySelector(".statistics-section");if(i&&o){const r=o.querySelector(".statistics-content");r&&(r.appendChild(i),console.log("Moved chart back to statistics section during cleanup"))}n.remove()}this.ensureMonthPickerVisibility()},ensureMonthPickerVisibility(){const s=document.querySelector(".dashboard-month-nav");s&&(s.style.display="flex",s.style.visibility="visible",s.style.opacity="1",s.style.position="relative",s.style.left="auto",s.style.height="auto",s.style.width="auto")},showDashboardView(){document.body.classList.remove("stats-view","chatbox-view","employees-view"),this.currentView="dashboard",this.selectedEmployeeId=null,localStorage.removeItem("selectedEmployeeId"),this.shifts=[...this.userShifts];const e=document.querySelector(".total-card"),t=document.querySelector(".next-shift-card"),n=document.querySelector(".next-payroll-card"),i=document.querySelector(".floating-action-bar"),o=document.querySelector(".chatbox-container");if(e&&(e.style.display=""),t&&(t.style.display=""),n&&(n.style.display=""),this.ensureMonthPickerVisibility(),i&&(i.style.display="flex"),o){o.style.display="none";const a=document.getElementById("chatboxPill"),l=document.getElementById("chatboxExpandedContent");a&&a.classList.remove("expanded"),l&&(l.style.display="none")}const r=document.querySelector(".dashboard-stats-container");if(r){const a=document.getElementById("weeklyHoursChart"),l=document.querySelector(".statistics-section");if(a&&l){const c=l.querySelector(".statistics-content");c&&(c.appendChild(a),console.log("Moved chart back to statistics section from dashboard view"))}r.remove()}this.updateDisplay()},async fetchAndDisplayEmployeeShifts(){try{const{data:{session:s}}=await window.supa.auth.getSession();if(!s){console.warn("No session for employee-shifts fetch");return}const e={Authorization:`Bearer ${s.access_token}`},t=new URLSearchParams;this.selectedEmployeeId&&t.set("employee_id",this.selectedEmployeeId);const n=`${this.currentYear}-${String(this.currentMonth).padStart(2,"0")}-01`,i=new Date(this.currentYear,this.currentMonth,0),o=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`;t.set("from",n),t.set("to",o),t.set("limit","200"),t.set("bust",String(Date.now()));const r=await fetch(`${window.CONFIG.apiBase}/employee-shifts?${t.toString()}`,{headers:e,cache:"no-store"});if(!r.ok){const l=await r.json().catch(()=>({}));console.error("Failed to fetch employee shifts:",l);return}const{shifts:a}=await r.json();this.shifts=(a||[]).map(l=>({id:l.id,date:new Date(l.shift_date+"T00:00:00.000Z"),startTime:l.start_time,endTime:l.end_time,type:(()=>{const c=new Date(l.shift_date+"T00:00:00Z").getDay();return c===0?2:c===6?1:0})(),seriesId:null,employee_id:l.employee_id,employee:this.employees.find(c=>c.id===l.employee_id)||null,hourly_wage_snapshot:Number(l.hourly_wage_snapshot)})),this.updateHeader(),this.updateStats(!1),this.updateWeeklyHoursChart(),this.updateShiftList(),this.updateShiftCalendar(),this.currentView==="employees"&&this.renderEmployeeWorkSummary?.()}catch(s){console.error("fetchAndDisplayEmployeeShifts error:",s)}},showStatsView(){const s=document.body;s.classList.remove("chatbox-view","employees-view"),s.classList.add("stats-view"),this.currentView="stats",this.selectedEmployeeId=null,localStorage.removeItem("selectedEmployeeId"),this.shifts=[...this.userShifts],this.dashboardView="stats",this.applyDashboardView(),this.updateDisplay()},showChatGPTView(){const s=document.body;s.classList.remove("stats-view","employees-view"),s.classList.add("chatbox-view"),this.currentView="chatgpt",this.selectedEmployeeId=null,localStorage.removeItem("selectedEmployeeId"),this.shifts=[...this.userShifts];const e=document.querySelector(".chatbox-container");e&&(e.style.display="block"),this.ensureMonthPickerVisibility(),this.expandChatboxForTabView(),this.updateDisplay()},expandChatboxForTabView(){const s=document.getElementById("chatboxPill"),e=document.getElementById("chatboxExpandedContent"),t=document.getElementById("chatboxClose"),n=document.getElementById("chatboxLog");if(s&&e){s.classList.add("expanded"),e.style.display="block",t&&(t.style.display="block"),n&&n.children.length===0&&this.addChatGreetingMessage();const i=document.getElementById("chatboxInput");i&&setTimeout(()=>{i.focus()},100)}},addChatGreetingMessage(){const s=document.getElementById("chatboxLog");if(!s)return;const e=document.getElementById("userNickname"),n=`Hei ${e?e.textContent:"Bruker"}! 👋

Jeg er LønnAI, din personlige assistent for vaktregistrering. Jeg kan hjelpe deg med å:

• Registrere enkelvakter
• Opprette vaktserier
• Svare på spørsmål om lønn og tillegg
• Gi tips om effektiv vaktplanlegging

Hva kan jeg hjelpe deg med i dag?`;if(window.chatbox&&window.chatbox.appendMessage)window.chatbox.appendMessage("assistant",n,{streaming:!0,streamSpeed:25});else{const i=document.createElement("div");if(i.className="chatbox-message assistant",typeof streamText=="function")i.innerHTML="",s.appendChild(i),streamText(i,n,25);else{if(typeof marked<"u"&&typeof DOMPurify<"u"){const o=DOMPurify.sanitize(marked.parse(n));i.innerHTML=o}else i.textContent=n;s.appendChild(i)}setTimeout(()=>{s.scrollTop=s.scrollHeight},50)}},showEmployeesView(){const s=document.body;s.classList.remove("stats-view","chatbox-view"),s.classList.add("employees-view"),this.ensureMonthPickerVisibility();try{const e=document.querySelector(".total-card"),t=document.querySelector(".next-shift-card"),n=document.querySelector(".next-payroll-card");e&&(e.style.display="none"),t&&(t.style.display="none"),n&&(n.style.display="none")}catch(e){console.warn("Could not hide dashboard cards in employees view",e)}this.showEmployeesPlaceholder(),this.employees.length===0&&!this.employeesLoading&&this.loadEmployees().catch(e=>{console.error("Failed to load employees:",e)}),this.currentView="employees",this.shifts=[],this.updateDisplay(),this.fetchAndDisplayEmployeeShifts?.(),this.employeeCarousel&&this.employeeCarousel.preloadAvatars?.()},showEmployeesPlaceholder(){let s=document.querySelector(".employees-container");if(!s){s=document.createElement("div"),s.className="employees-container",s.innerHTML=`
                <div class="employees-header">
                    <h2>Ansatte</h2>
                    <div class="employees-summary" id="employeesSummary"></div>
                </div>
                <div class="employee-carousel-container" id="employeeCarouselContainer">
                    <!-- Employee carousel will be rendered here -->
                </div>
                <div class="employees-content" id="employeesContent">
                    <div class="employee-work-summary" id="employeeWorkSummary"></div>
                </div>
            `;const e=document.querySelector(".tab-bar-container");e&&e.parentNode.insertBefore(s,e.nextSibling)}s.style.display="block",this.initializeEmployeeCarousel()},async initializeEmployeeCarousel(){try{const s=document.getElementById("employeeCarouselContainer");if(!s)return;const{EmployeeCarousel:e}=await z(async()=>{const{EmployeeCarousel:t}=await import("./employeeCarousel-DHwHiZ0-.js");return{EmployeeCarousel:t}},__vite__mapDeps([0,1,2,3,4]));this.employeeCarousel&&this.employeeCarousel.destroy(),this.employeeCarousel=new e(s,this),this.employees.length===0&&!this.employeesLoading&&await this.loadEmployees(),this.updateEmployeesSummary()}catch(s){console.error("Error initializing employee carousel:",s)}},updateEmployeeCarousel(){this.employeeCarousel&&this.employeeCarousel.update(),this.updateEmployeesSummary()},updateEmployeesSummary(){const s=document.getElementById("employeesSummary");if(!s)return;const e=this.employees.filter(n=>!n.archived_at);this.getSelectedEmployee();const t=`${e.length} aktive ansatte`;s.textContent=t,this.currentView==="employees"&&this.renderEmployeeWorkSummary?.()},updateTabBarVisibility(){const s=document.getElementById("tabAnsatte");s&&(s.style.display=this.isWageCaregiver?"flex":"none")},setupChatboxCloseOverride(){const s=document.getElementById("chatboxClose");if(s){const e=s.cloneNode(!0);s.parentNode.replaceChild(e,s),e.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault(),this.switchToView("dashboard")})}},toggleWageCaregiver(){const s=document.getElementById("isWageCaregiverToggle");s&&(this.isWageCaregiver=s.checked,this.saveSettingsToSupabase(),this.saveToLocalStorage(),this.updateTabBarVisibility())},exportData(s){try{const e={shifts:this.shifts.map(t=>({id:t.id,date:t.date.toISOString(),startTime:t.startTime,endTime:t.endTime,type:t.type,seriesId:t.seriesId||null})),settings:{usePreset:this.usePreset,customWage:this.customWage,currentWageLevel:this.currentWageLevel,customBonuses:this.customBonuses,pauseDeduction:this.pauseDeduction,fullMinuteRange:this.fullMinuteRange,directTimeInput:this.directTimeInput,monthlyGoal:this.monthlyGoal,currencyFormat:this.currencyFormat},exportDate:new Date().toISOString(),version:"1.0"};s==="csv"?this.exportAsCSV(e):s==="pdf"?this.exportAsPDF(e):this.exportAsJSON(e)}catch(e){console.error("Error exporting data:",e),alert("Kunne ikke eksportere data. Prøv igjen.")}},exportAsCSV(s){const e=[["Dato","Dag","Start","Slutt","Timer","Grunnlønn","Tillegg","Totalt","Type","Serie"].join(","),...s.shifts.map(t=>{const n=new Date(t.date),i=this.calculateShift({...t,date:n});return[n.toLocaleDateString("no-NO"),this.WEEKDAYS[n.getDay()],t.startTime,t.endTime,i.hours.toFixed(2),i.baseWage.toFixed(2),i.bonus.toFixed(2),i.total.toFixed(2),t.type===0?"Ukedag":t.type===1?"Lørdag":"Søndag",t.seriesId?"Ja":"Nei"].join(",")})].join(`
`);this.downloadFile(e,"vaktdata.csv","text/csv")},exportAsJSON(s){const e=JSON.stringify(s,null,2);this.downloadFile(e,"vaktdata.json","application/json")},exportAsPDF(s){try{if(typeof window.jspdf?.jsPDF!="function"){alert("PDF-biblioteket (jsPDF) ble ikke funnet. Prøv å laste siden på nytt.");return}const{jsPDF:e}=window.jspdf,t=new e;t.setProperties({title:"Vaktrapport",subject:"Lønn og vaktdetaljer",author:"Vaktkalkulator",creator:"Vaktkalkulator"});const n=new Date().toLocaleDateString("no-NO",{year:"numeric",month:"long",day:"numeric"}),i=s.shifts.map(w=>({...w,date:new Date(w.date)}));let o=0,r=0,a=0,l=0;const c={weekday:0,saturday:0,sunday:0},d=i.map(w=>{const E=this.calculateShift(w);o+=E.hours,r+=E.total,a+=E.bonus,l+=E.baseWage;const x=w.type===0?"weekday":w.type===1?"saturday":"sunday";return c[x]++,{...w,calc:E}});d.sort((w,E)=>w.date-E.date);let u=20;const h=20,m=190,f=210,v=297,g=w=>u+w>v-20?(t.addPage(),u=20,!0):!1;if(t.setFontSize(20),t.setFont("helvetica","bold"),t.text("Vaktrapport",h,u),u+=15,t.setFontSize(10),t.setFont("helvetica","normal"),t.text(`Eksportert: ${n}`,h,u),u+=10,d.length>0){const w=d[0].date,E=d[d.length-1].date,x=`Periode: ${w.toLocaleDateString("no-NO")} - ${E.toLocaleDateString("no-NO")}`;t.text(x,h,u),u+=15}g(60),t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Sammendrag",h,u),u+=10,t.setFontSize(10),t.setFont("helvetica","normal"),[["Totalt antall vakter:",i.length.toString()],["Totale timer:",o.toFixed(2)+" timer"],["Total grunnlønn:",this.formatCurrencyShort(l)+" kr"],["Totale tillegg:",this.formatCurrencyShort(a)+" kr"],["Total lønn:",this.formatCurrencyShort(r)+" kr"],["",""],["Vakter per type:",""],["  Ukedager:",c.weekday.toString()],["  Lørdager:",c.saturday.toString()],["  Søndager/helligdager:",c.sunday.toString()]].forEach(([w,E])=>{w&&(t.text(w,h,u),E&&t.text(E,h+60,u)),u+=5}),u+=10,g(50),t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Detaljert vaktliste",h,u),u+=10,t.setFontSize(8),t.setFont("helvetica","bold");const b=["Dato","Dag","Start","Slutt","Timer","Grunnlønn","Tillegg","Totalt"],p=[25,20,15,15,15,25,25,25],y=[h];for(let w=1;w<p.length;w++)y.push(y[w-1]+p[w-1]);b.forEach((w,E)=>{t.text(w,y[E],u)}),u+=5,t.setLineWidth(.5),t.line(h,u,m,u),u+=5,t.setFont("helvetica","normal"),d.forEach(w=>{g(8),[w.date.toLocaleDateString("no-NO"),this.WEEKDAYS[w.date.getDay()].substring(0,3),w.startTime,w.endTime,w.calc.hours.toFixed(2),this.formatCurrencyShort(w.calc.baseWage),this.formatCurrencyShort(w.calc.bonus),this.formatCurrencyShort(w.calc.total)].forEach((x,T)=>{t.text(x,y[T],u)}),u+=5}),u+=5,t.setLineWidth(.5),t.line(h,u,m,u),u+=5,t.setFont("helvetica","bold"),t.text("Sum:",y[0],u),t.text(o.toFixed(2),y[4],u),t.text(this.formatCurrencyShort(l),y[5],u),t.text(this.formatCurrencyShort(a),y[6],u),t.text(this.formatCurrencyShort(r),y[7],u);const _=t.internal.getNumberOfPages();for(let w=1;w<=_;w++)t.setPage(w),t.setFontSize(8),t.setFont("helvetica","normal"),t.text(`Side ${w} av ${_}`,m-20,v-10),t.text("Generert av Vaktkalkulator",h,v-10);const k=`vaktrapport_${new Date().toISOString().split("T")[0]}.pdf`;t.save(k)}catch(e){console.error("Error generating PDF:",e),alert("Kunne ikke generere PDF. Prøv igjen eller bruk CSV-eksport.")}},downloadFile(s,e,t){const n=new Blob([s],{type:t}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)},async importData(){const e=document.getElementById("importFile").files[0];if(!e){alert("Velg en fil å importere");return}const t=new FileReader;t.onload=async n=>{try{const i=n.target.result;if(e.name.endsWith(".json")){const o=JSON.parse(i);await this.importFromJSON(o)}else if(e.name.endsWith(".csv"))await this.importFromCSV(i);else{alert("Ikke støttet filformat. Bruk JSON eller CSV.");return}alert("Data importert successfully!"),this.updateDisplay()}catch(i){console.error("Error importing data:",i),alert("Kunne ikke importere data. Sjekk filformatet.")}},t.readAsText(e)},detectDuplicateShifts(s){const e=[],t=[];return s.forEach(n=>{const i=this.createShiftKey(n);this.shifts.some(r=>{const a=this.createShiftKey(r);return i===a})?t.push(n):e.push(n)}),{newShifts:e,duplicates:t}},createShiftKey(s){return`${`${s.date.getFullYear()}-${(s.date.getMonth()+1).toString().padStart(2,"0")}-${s.date.getDate().toString().padStart(2,"0")}`}_${s.startTime}_${s.endTime}_${s.type}`},getMonthShiftsKey(){const s=this.currentMonth-1,e=this.currentYear;return this.shifts.filter(n=>n.date.getMonth()===s&&n.date.getFullYear()===e).map(n=>this.createShiftKey(n)).join("|")},async saveImportedShiftsToSupabase(s){try{const{data:e}=await window.supa.auth.getClaims();if(!!!e)throw new Error("Du er ikke innlogget");const n=s.map(r=>{const a=`${r.date.getFullYear()}-${(r.date.getMonth()+1).toString().padStart(2,"0")}-${r.date.getDate().toString().padStart(2,"0")}`;return{user_id:user.id,shift_date:a,start_time:r.startTime,end_time:r.endTime,shift_type:r.type,series_id:r.seriesId||null}}),{data:i,error:o}=await window.supa.from("user_shifts").insert(n).select();if(o)throw console.error("Error saving imported shifts to Supabase:",o),new Error(`Kunne ikke lagre importerte vakter: ${o.message}`);i.forEach((r,a)=>{s[a].id=r.id})}catch(e){throw console.error("Error in saveImportedShiftsToSupabase:",e),e}},async importFromJSON(s){if(s.shifts&&Array.isArray(s.shifts)){const e=s.shifts.map(i=>({...i,date:new Date(i.date)}));e.forEach(i=>{i.id||(i.id=Date.now()+Math.random())});const{newShifts:t,duplicates:n}=this.detectDuplicateShifts(e);if(n.length>0){const i=n.length;if(!confirm(`Fant ${i} duplikat vakter som allerede eksisterer. Vil du fortsatt importere de ${t.length} nye vaktene?`))return}t.length>0&&(await this.saveImportedShiftsToSupabase(t),this.shifts=[...this.shifts,...t],this.userShifts=[...this.userShifts,...t])}s.settings&&confirm("Vil du også importere innstillinger? Dette vil overskrive dine nåværende innstillinger.")&&(Object.assign(this,s.settings),this.saveSettingsToSupabase(),this.updateSettingsUI())},async importFromCSV(s){const e=s.split(`
`),t=[];for(let o=1;o<e.length;o++){const r=e[o].trim();if(!r)continue;const a=r.split(",");if(a.length>=6){const l=a[0].split("."),c=new Date(parseInt(l[2]),parseInt(l[1])-1,parseInt(l[0])),d={id:Date.now()+Math.random(),date:c,startTime:a[2],endTime:a[3],type:a[8]==="Ukedag"?0:a[8]==="Lørdag"?1:2,seriesId:a[9]==="Ja"?"imported-series":null};t.push(d)}}const{newShifts:n,duplicates:i}=this.detectDuplicateShifts(t);if(i.length>0){const o=i.length;if(!confirm(`Fant ${o} duplikat vakter som allerede eksisterer. Vil du fortsatt importere de ${n.length} nye vaktene?`))return}n.length>0&&(await this.saveImportedShiftsToSupabase(n),this.shifts=[...this.shifts,...n],this.userShifts=[...this.userShifts,...n])},setupNewSettingsListeners(){const s=document.getElementById("currencyFormatToggle");s&&s.addEventListener("change",()=>{this.currencyFormat=s.checked,this.saveSettingsToSupabase(),this.updateDisplay()});const e=document.getElementById("defaultShiftsViewToggle");e&&e.addEventListener("change",()=>{this.defaultShiftsView=e.checked?"calendar":"list",this.saveSettingsToSupabase()});const t=document.getElementById("isWageCaregiverToggle"),n=document.querySelector("#isWageCaregiverToggle + .toggle-slider");t&&t.addEventListener("change",()=>{this.toggleWageCaregiver()}),t&&n&&n.addEventListener("click",i=>{i.preventDefault(),t.checked=!t.checked,this.toggleWageCaregiver()}),this.setupTabBarEventListeners(),this.setupChatboxCloseOverride()},setupExportPeriodOptions(){this.updateCurrentMonthLabel();const s=document.querySelectorAll('input[name="exportPeriod"]'),e=document.getElementById("customPeriodSection");s.forEach(n=>{n.addEventListener("change",()=>{if(n.value==="custom"){e.style.display="block";const i=document.getElementById("exportStartDate"),o=document.getElementById("exportEndDate");if(!i.value){const r=new Date,a=new Date(r.getFullYear(),r.getMonth(),1);i.value=a.toISOString().split("T")[0]}if(!o.value){const r=new Date,a=new Date(r.getFullYear(),r.getMonth()+1,0);o.value=a.toISOString().split("T")[0]}}else e.style.display="none"})});const t=document.querySelector('input[name="exportPeriod"]:checked');t&&t.value==="custom"&&(e.style.display="block")},updateCurrentMonthLabel(){const s=document.getElementById("currentMonthLabel");if(s){const e=this.MONTHS[this.currentMonth-1];s.textContent=`${e.charAt(0).toUpperCase()+e.slice(1)} ${this.currentYear}`}},exportDataWithPeriod(s){try{const e=document.querySelector('input[name="exportPeriod"]:checked');if(!e){alert("Vennligst velg en periode for eksport først.");return}const t=e.value;let n=[...this.shifts];if(t==="current")n=this.shifts.filter(o=>o.date.getMonth()===this.currentMonth-1&&o.date.getFullYear()===this.currentYear);else if(t==="custom"){const o=document.getElementById("exportStartDate").value,r=document.getElementById("exportEndDate").value;if(!o||!r){alert("Vennligst fyll ut både start- og sluttdato for egendefinert periode.");return}const a=new Date(o),l=new Date(r);if(a>l){alert("Startdato må være før sluttdato.");return}n=this.shifts.filter(c=>{const d=new Date(c.date);return d>=a&&d<=l})}if(n.length===0){alert("Ingen vakter funnet for den valgte perioden.");return}const i={shifts:n.map(o=>({id:o.id,date:o.date.toISOString(),startTime:o.startTime,endTime:o.endTime,type:o.type,seriesId:o.seriesId||null})),settings:{usePreset:this.usePreset,customWage:this.customWage,currentWageLevel:this.currentWageLevel,customBonuses:this.customBonuses,pauseDeduction:this.pauseDeduction,fullMinuteRange:this.fullMinuteRange,directTimeInput:this.directTimeInput,monthlyGoal:this.monthlyGoal,currencyFormat:this.currencyFormat},exportDate:new Date().toISOString(),exportPeriod:t,version:"1.0"};s==="csv"?this.exportAsCSV(i):s==="pdf"?this.exportAsPDF(i):this.exportAsJSON(i)}catch(e){console.error("Error exporting data:",e),alert("Kunne ikke eksportere data. Prøv igjen.")}},async importDataFromDataTab(){const s=document.getElementById("importFileData"),e=s.files[0];if(!e){alert("Velg en fil å importere");return}const t=new FileReader;t.onload=async n=>{try{const i=n.target.result;if(e.name.endsWith(".json")){const o=JSON.parse(i);await this.importFromJSON(o)}else if(e.name.endsWith(".csv"))await this.importFromCSV(i);else{alert("Ikke støttet filformat. Bruk JSON eller CSV.");return}alert("Data importert successfully!"),this.updateDisplay(),s.value=""}catch(i){console.error("Error importing data:",i),alert("Kunne ikke importere data. Sjekk filformatet.")}},t.readAsText(e)},openAddShiftModalWithDate(s){if(!s){this.openAddShiftModal();return}const e=new Date(s),t=e.getMonth()+1,n=e.getFullYear();this.openAddShiftModal(t,n),this.selectedDates=[new Date(e)],setTimeout(()=>{document.querySelectorAll("#dateGrid .date-cell").forEach(o=>{o.classList.remove("selected");const r=o.querySelector(".date-cell-content");r&&parseInt(r.textContent)===e.getDate()&&!o.classList.contains("disabled")&&o.classList.add("selected")}),this.updateSelectedDatesInfo()},10)},initializeEmployeeState(){try{const e=new URLSearchParams(window.location.search).get("employee"),t=localStorage.getItem("selectedEmployeeId");e!==null?this.selectedEmployeeId=e==="all"?null:e:t!==null&&this.currentView==="employees"?this.selectedEmployeeId=t==="null"?null:t:this.selectedEmployeeId=null,this.employeeCache.clear()}catch(s){console.error("Error initializing employee state:",s),this.selectedEmployeeId=null}},setSelectedEmployee(s){try{this.selectedEmployeeId=s,localStorage.setItem("selectedEmployeeId",s===null?"null":s);const e=new URL(window.location);s===null?e.searchParams.set("employee","all"):e.searchParams.set("employee",s),window.history.replaceState({},"",e),this.onEmployeeSelectionChange()}catch(e){console.error("Error setting selected employee:",e)}},getSelectedEmployee(){return this.selectedEmployeeId===null?null:this.employees.find(s=>s.id===this.selectedEmployeeId)||null},isEmployeeSelected(s){return this.selectedEmployeeId===s},isAllEmployeesSelected(){return this.selectedEmployeeId===null},onEmployeeSelectionChange(){console.log("Employee selection changed to:",this.selectedEmployeeId),this.applyEmployeeFilter?.(),this.updateEmployeeCarousel?.(),this.updateShiftList?.(),this.updateStats?.()},getEmployeeCache(s,e){const t=this.employeeCache.get(s);return t?t[e]:void 0},setEmployeeCache(s,e,t){this.employeeCache.has(s)||this.employeeCache.set(s,{}),this.employeeCache.get(s)[e]=t},clearEmployeeCache(s){this.employeeCache.delete(s)},clearAllEmployeeCaches(){this.employeeCache.clear()},async loadEmployees(s=!1){try{this.employeesLoading=!0,this.employeesError=null;const{employeeService:e}=await z(async()=>{const{employeeService:n}=await import("./employeeService-caDyaWb2.js");return{employeeService:n}},[]),t=await e.fetchEmployees(s);this.employees=t,this.onEmployeesLoaded()}catch(e){console.error("Error loading employees:",e),this.employeesError=e.message,this.employees=[]}finally{this.employeesLoading=!1}},onEmployeesLoaded(){console.log("Employees loaded:",this.employees.length),this.updateEmployeeCarousel?.(),this.selectedEmployeeId&&!this.employees.find(s=>s.id===this.selectedEmployeeId)&&(console.warn('Selected employee no longer exists, resetting to "All"'),this.selectedEmployeeId=null),this.populateEmployeeFilterBar(),this.applyEmployeeFilter(),this.populateEmployeeSelectors(),this.updateEmployeeModals?.()},updateEmployeeModals(){console.log("Updating employee modals with new data")},async showCreateEmployeeModal(){try{const{EmployeeModal:s}=await z(async()=>{const{EmployeeModal:e}=await import("./employeeModal-B0VnrISH.js");return{EmployeeModal:e}},__vite__mapDeps([5,1,2,3,4]));this.employeeModal||(this.employeeModal=new s(this)),await this.employeeModal.showCreate()}catch(s){console.error("Error showing create employee modal:",s)}},async showEditEmployeeModal(s){try{const{EmployeeModal:e}=await z(async()=>{const{EmployeeModal:t}=await import("./employeeModal-B0VnrISH.js");return{EmployeeModal:t}},__vite__mapDeps([5,1,2,3,4]));this.employeeModal||(this.employeeModal=new e(this)),await this.employeeModal.showEdit(s)}catch(e){console.error("Error showing edit employee modal:",e)}},getEmployeeInitials(s){if(!s?.name)return"?";const e=s.name.trim().split(/\s+/);return e.length===1?e[0].substring(0,2).toUpperCase():(e[0][0]+e[e.length-1][0]).toUpperCase()},getEmployeeDisplayColor(s){return s?.display_color||"#6366f1"},async openCsvExportModal(s=null){const e=document.getElementById("csvExportModal");if(!e)return;if(this.employees.length===0&&!this.employeesLoading)try{await this.loadEmployees()}catch(l){console.warn("Could not load employees for CSV export:",l)}const t=document.getElementById("csvExportEmployeeSelect");if(t){t.innerHTML='<option value="">Alle ansatte</option>';const l=this.employees||[];l.filter(c=>!c.archived_at).forEach(c=>{const d=document.createElement("option");d.value=c.id,d.textContent=c.name,s&&c.id===s&&(d.selected=!0),t.appendChild(d)}),l.length===0&&console.info("No employees available for selection")}const n=new Date,i=new Date(n.getFullYear(),n.getMonth(),1),o=new Date(n.getFullYear(),n.getMonth()+1,0),r=document.getElementById("csvExportFromDate"),a=document.getElementById("csvExportToDate");r&&(r.value=i.toISOString().split("T")[0]),a&&(a.value=o.toISOString().split("T")[0]),e.classList.add("active")},closeCsvExportModal(){const s=document.getElementById("csvExportModal");s&&s.classList.remove("active")},async exportCsvReport(){try{const s=document.getElementById("csvExportEmployeeSelect")?.value||"",e=document.getElementById("csvExportFromDate")?.value||"",t=document.getElementById("csvExportToDate")?.value||"",n=new URLSearchParams;s&&n.append("employee_id",s),e&&n.append("from",e),t&&n.append("to",t);const o=`${window.CONFIG?.apiBase||window.location.origin}/reports/wages?${n.toString()}`;let r=null;try{const{data:{session:m}}=await window.supa.auth.getSession();r=m?.access_token}catch(m){console.error("Failed to get auth session:",m)}if(!r){alert("Du må være innlogget for å eksportere data");return}const a=await fetch(o,{method:"GET",headers:{Authorization:`Bearer ${r}`}});if(!a.ok)throw new Error(`Export failed: ${a.statusText}`);const l=await a.blob(),c=window.URL.createObjectURL(l),d=document.createElement("a");d.style.display="none",d.href=c;const u=new Date().toISOString().split("T")[0],h=s?document.getElementById("csvExportEmployeeSelect")?.options[document.getElementById("csvExportEmployeeSelect")?.selectedIndex]?.text.replace(/[^a-zA-Z0-9]/g,"_"):"alle_ansatte";d.download=`lønnsrapport_${h}_${u}.csv`,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(c),document.body.removeChild(d),this.closeCsvExportModal(),this.showNotification("CSV-rapport lastet ned","success")}catch(s){console.error("CSV export error:",s),alert("Kunne ikke eksportere CSV: "+s.message)}},showNotification(s,e="info"){const t=document.createElement("div");t.className=`notification notification-${e}`,t.textContent=s,t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${e==="success"?"#10b981":"#3b82f6"};
            color: white;
            border-radius: 8px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOut 0.3s ease-out",setTimeout(()=>{document.body.removeChild(t)},300)},3e3)}};export{xi as app};
